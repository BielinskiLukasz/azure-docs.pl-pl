<properties 
   pageTitle="Visual Studio での Azure クラウド サービスまたは仮想マシンのデバッグ | Microsoft Azure"
   description="Visual Studio でのクラウド サービスまたは仮想マシンのデバッグ"
   services="visual-studio-online"
   documentationCenter="na"
   authors="TomArcher"
   manager="douge"
   editor="tlee" />
<tags 
   ms.service="visual-studio-online"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="multiple"
   ms.workload="na"
   ms.date="10/28/2015"
   ms.author="tarcher" />

# Visual Studio での Azure クラウド サービスまたは仮想マシンのデバッグ

Visual Studio には、Azure クラウド サービスと仮想マシンのデバッグに役立つさまざまなオプションがあります。



## ローカル コンピューターでクラウド サービスをデバッグする

Azure コンピューティング エミュレーターを使用してローカル コンピューターでクラウド サービスをデバッグすれば、時間とコストの節約になります。 サービスをデプロイする前にローカルでデバッグすると、コンピューティング時間の料金を支払うことなく、信頼性とパフォーマンスを改善できます。 ただし、一部には Azure でクラウド サービスを実行した場合にのみ発生するエラーもあります。 サービスを発行し、デバッガーをロール インスタンスにアタッチするときに、リモート デバッグを有効にすると、このようなエラーをデバッグできます。

エミュレーターは、Azure コンピューティング サービスをシミュレートし、ローカル環境で動作するので、クラウド サービスのテストとデバッグを行ってからデプロイすることができます。 エミュレーターでは、ロール インスタンスのライフサイクルが処理され、ローカル ストレージなどのシミュレートされるリソースにアクセスできます。 Visual Studio でサービスをデバッグまたは実行すると、エミュレーターがバックグラウンド アプリケーションとして自動的に起動され、サービスがエミュレーターにデプロイされます。 エミュレーターを使用すると、ローカル環境で実行されているサービスを表示できます。 完全バージョンまたは Express バージョンのエミュレーターを実行できます (Azure 2.3 以降は、Express バージョンのエミュレーターが既定です)。参照してください [Emulator Express を使用して実行し、クラウド サービスをローカルでデバッグする](https://msdn.microsoft.com/library/dn339018.aspx)です。

### ローカル コンピューターでクラウド サービスをデバッグするには

1. メニュー バー **デバッグ**, 、**[デバッグ開始]** Azure クラウド サービス プロジェクトを実行します。 または、F5 キーを押します。 コンピューティング エミュレーターが起動することを示すメッセージが表示されます。 エミュレーターが起動すると、システム トレイ アイコンでそのことを確認できます。

    ![Azure emulator in the system tray](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC783828.png)

1. 通知領域にある Azure アイコンのショートカット メニューを開きをクリックし、コンピューティング エミュレーターのユーザー インターフェイスを表示 **[コンピューティング エミュレーター UI**します。

    UI の左側にあるウィンドウには、現在コンピューティング エミュレーターにデプロイされているサービスと各サービスが実行しているロール インスタンスが表示されます。 サービスまたはロールを選択すると、右ペインにライフサイクル情報、ログ情報、および診断情報を表示できます。 含まれているウィンドウの上部余白にフォーカスを置くと、ウィンドウが右ペイン全体に拡大します。

1. アプリケーションをステップ実行コマンドをクリックして、 **デバッグ** メニューと、コードにブレークポイントを設定します。 デバッガーでのアプリケーションのステップ実行に合わせてウィンドウが更新され、アプリケーションの現在の状態が表示されます。 デバッグを停止すると、アプリケーション デプロイは削除されます。アプリケーションに Web ロールが含まれており、Web ブラウザーを起動するようにスタートアップ アクションのプロパティが設定されている場合、Visual Studio によって Web アプリケーションがブラウザーで起動されます。サービス構成でロールのインスタンスの数を変更した場合、クラウド サービスを停止し、デバッグを再開して、これらの新しいロール インスタンスをデバッグできるようにする必要があります。

    **注:** を実行しているか、サービスのデバッグを停止すると、ローカル計算エミュレーターおよびストレージ エミュレーターは停止しません。 これらは、通知領域から明示的に停止する必要があります。


## Azure でクラウド サービスをデバッグする

リモート コンピューターからクラウド サービスをデバッグするには、ロール インスタンスを実行する仮想マシンに必要なサービス (msvsmon.exe など) をインストールするために、クラウド サービスのデプロイ時にデバッグ機能を明示的に有効にする必要があります。 サービスを発行するときにリモート デバッグを有効にしなかった場合、リモート デバッグを有効にしてサービスを再発行する必要があります。

クラウド サービスのリモート デバッグを有効にしても、パフォーマンスが低下したり、追加料金が発生したりすることはありません。 運用サービスでは、サービスを利用すクライアントに悪影響が生じる可能性があるため、リモート デバッグを使用しないでください。

>[AZURE.NOTE] 有効にできます Visual Studio からクラウド サービスの公開時に **IntelliTrace** の .NET Framework 4 または .NET Framework 4.5 を対象とするそのサービスの役割です。 使用して **IntelliTrace**, 、過去にロール インスタンスで発生したイベントを確認し、その時点からコンテキストを再現できます。 参照してください [IntelliTrace および Visual Studio で発行済みのクラウド サービスのデバッグ](http://go.microsoft.com/fwlink/?LinkID=623016) と [IntelliTrace を使用した](https://msdn.microsoft.com/library/dd264915.aspx)します。

### クラウド サービスのリモート デバッグを有効にするには

1. Azure プロジェクトのショートカット メニューを開き、をクリックし、 **発行**します。

1. 選択、 **ステージング** 環境と **デバッグ** 構成します。

    これは、単なるガイドラインです。 運用環境でテスト環境を実行することもできます。 ただし、運用環境でリモート デバッグを有効にすると、ユーザーに悪影響が生じる可能性があります。 リリース構成も選択できますが、デバッグ構成の方がデバッグは簡単です。

    ![Choose the Debug configuration](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746717.gif)

1. 通常の手順に従いますが、選択、 **すべてのロールのリモート デバッガーを有効にする** ] チェック ボックス、 **の詳細設定** ] タブをクリックします。

    ![Debug Configuration](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746718.gif)

### Azure でクラウド サービスにデバッガーをアタッチするには

1. サーバー エクスプ ローラーで、クラウド サービスのノードを展開します。

1. をクリックし、アタッチ、ロールまたはロール インスタンスのショートカット メニューを開いて **[デバッガーの**です。

    ロールをデバッグすると、Visual Studio デバッガーによって、そのロールの各インスタンスにアタッチされます。 デバッガーは、コード行を実行し、ブレーク ポイントのいずれかの条件を満たす最初のロール インスタンスのブレーク ポイントで停止します。 インスタンスをデバッグすると、その特定のインスタンスがコード行を実行してブレーク ポイントの条件を満たす場合にのみ、デバッガーがそのインスタンスにのみアタッチし、ブレーク ポイントで停止します。

    ![Attach Debugger](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746719.gif)

1. デバッガーがインスタンスにアタッチした後は、通常どおりにデバッグします。デバッガーは、ロールに適したホスト プロセスに自動的にアタッチします。 ロール応じて、w3wp.exe、WaWorkerHost.exe、または WaIISHost.exe にアタッチします。 デバッガーがアタッチされるプロセスを検証するには、サーバー エクスプローラーでインスタンス ノードを展開します。 参照してください [Azure ロール アーキテクチャ](http://blogs.msdn.com/b/kwill/archive/2011/05/05/windows-azure-role-architecture.aspx) Azure のプロセスの詳細についてです。

    ![Select code type dialog box](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718346.png)

1. デバッガーがアタッチされているプロセスを確認するには、メニュー バーの [デバッグ]、[Windows]、[プロセス] を選択して、[プロセス] ダイアログ ボックスを開きます (キーボード: Ctrl + Alt + Z)。特定のプロセスをデタッチするには、ショートカット メニューを開き、[プロセスのデタッチ] をクリックします。 または、サーバー エクスプローラーでインスタンス ノードを特定し、プロセスを検索し、ショートカット メニューを開き、[プロセスのデタッチ] をクリックします。

    ![Debug Processes](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC690787.gif)

>[AZURE.WARNING] リモート時、ブレークポイントで長時間停止しないようにデバッグします。 Azure では、プロセスの停止時間が数分を超えるとプロセスを応答不能と見なし、そのインスタンスへのトラフィック送信を停止します。 停止時間が長くなると、msvsmon.exe はプロセスからデタッチされます。

インスタンスまたはロールのすべてのプロセスからデバッガーをデタッチするには、デバッグ対象のロールまたはインスタンスのショートカット メニューを開き、[デバッガーのデタッチ] をクリックします。

## Azure でのリモート デバッグの制限

Azure SDK 2.3 以降、リモート デバッグには次の制限があります。

- リモート デバッグを有効にすると、インスタンス数が 25 を超えるロールではクラウド サービスを発行できません。

- デバッガーで使用されるポートは、30400 ～ 30424、31400 ～ 31424、および 32400 ～ 32424 です。 これらのポートを使用しようとすると、サービスの発行はできず、次のいずれかのエラー メッセージが Azure のアクティビティ ログに出力されます。 

    - .csdef ファイルに対して .cscfg ファイルを検証しているときにエラーが発生しました。 
    ロール 'ロール' エンドポイント Microsoft.WindowsAzure.Plugins.RemoteDebugger.Connector の予約されたポート範囲 '範囲' は、定義済みのポートまたは範囲と重複しています。
    - 割り当てに失敗しました。 後で再試行するか、VM のサイズまたはロール インスタンスの数を減らすか、別のリージョンにデプロイしてみてください。


## Azure 仮想マシンをデバッグする

Azure 仮想マシンで実行されているプログラムをデバッグするには、Visual Studio のサーバー エクスプローラーを使用します。 Azure 仮想マシンでリモート デバッグを有効にすると、仮想マシンにリモート デバッグ拡張機能がインストールされます。 インストール後は、仮想マシンのプロセスにアタッチし、通常どおりデバッグすることができます。

>[AZURE.NOTE] Azure リソース マネージャー スタックを使って作成された仮想マシンは、Visual Studio 2015 のクラウド エクスプ ローラーを使用して、リモートでデバッグできます。 詳細については、次を参照してください。 [クラウド エクスプ ローラーでの Azure リソースの管理](http://go.microsoft.com/fwlink/?LinkId=623031)します。

### Azure 仮想マシンをデバッグするには

1. サーバー エクスプローラーで、Virtual Machines ノードを展開し、デバッグする仮想マシンのノードを選択します。

1. コンテキスト メニューを開き、をクリックして **デバッグを有効にする**です。 仮想マシンでデバッグを有効にする] をクリックする場合を確認するメッセージが表示されたら **はい**します。

    仮想マシンにリモート デバッグ拡張機能がインストールされ、デバッグが有効になります。

    ![Virtual machine enable debugging command](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746720.png)

    ![Azure activity log](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746721.png)

1. リモート デバッグ拡張機能では、インストールが終了すると、仮想マシンのコンテキスト メニューを開き] をクリックして **デバッガーを接続しています.**

    Azure は、仮想マシンのプロセスの一覧を取得し、[プロセスにアタッチ] ダイアログ ボックスに表示します。

    ![Attach debugger command](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746722.png)

1.  **プロセスにアタッチする** ダイアログ ボックスで、] をクリックして **選択** コードをデバッグする対象の型のみを表示する結果の一覧に制限します。 32 ビットまたは 64 ビット マネージ コードとネイティブ コードのいずれかまたは両方をデバッグできます。

    ![Select code type dialog box](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718346.png)

1. クリックして、仮想マシン上でデバッグするプロセス] をオン **アタッチ**します。 たとえば、仮想マシンで Web アプリをデバッグする場合は、w3wp.exe プロセスを選択できます。 参照してください [1 つのデバッグまたは Visual Studio での複数のプロセス](https://msdn.microsoft.com/library/jj919165.aspx) と [Azure ロール アーキテクチャ](http://blogs.msdn.com/b/kwill/archive/2011/05/05/windows-azure-role-architecture.aspx) の詳細。

## デバッグ用の Web プロジェクトと仮想マシンを作成する

Azure プロジェクトを発行する前に、デバッグとテストのシナリオをサポートし、テストおよびモニタリング プログラムをインストールできる環境でテストすることをお勧めします。 実行方法の 1 つは、仮想マシンでアプリケーションをリモート デバッグすることです。

Visual Studio ASP.NET プロジェクトでは、アプリケーションのテストに使用できる便利な仮想マシンを作成するオプションを用意しています。 仮想マシンには、一般的な必要なエンドポイント (PowerShell、リモート デスクトップ、WebDeploy など) が含まれています。

### デバッグ用の Web プロジェクトと仮想マシンを作成するには

1. Visual Studio で、新しい ASP.NET Web アプリケーションを作成します。

1. [新しい ASP.NET プロジェクト] ダイアログ ボックスの [Azure のセクションでは、次のように選択します。 **仮想マシン** ボックスの一覧にします。 ままにして、 **リモート リソースを作成する** チェック ボックスをオンします。 クリックして **OK** を続行します。

     **Azure の仮想マシンの作成** ] ダイアログ ボックスが表示されます。


    ![Create ASP.NET web project dialog box](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746723.png)

    **Note:** You'll be asked to sign in to your Azure account if you're not already signed in.

1. 仮想マシンのさまざまな設定を選択し、クリックして **OK**します。 参照してください [仮想マシン]( http://go.microsoft.com/fwlink/?LinkId=623033) の詳細。

    DNS 名として入力した名前は、仮想マシンの名前になります。 

    ![Create virtual machine on Azure dialog box](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746724.png)

    Azure によって仮想マシンが作成され、エンドポイント (リモート デスクトップや Web 配置など) のプロビジョニングと構成が行われます。



1. 仮想マシンの構成が完了したら、サーバー エクスプローラーで仮想マシンのノードを選択します。

1. コンテキスト メニューを開き、をクリックして **デバッグを有効にする**です。 仮想マシンでデバッグを有効にする] をクリックする場合を確認するメッセージが表示されたら **はい**します。 

    仮想マシンにリモート デバッグ拡張機能がインストールされ、デバッグが有効になります。

    ![Virtual machine enable debugging command](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746720.png)

    ![Azure activity log](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746721.png)

1. 説明したように、プロジェクトを発行 [方法: Web プロジェクトを使用して 1 回のクリックの発行 Visual Studio での展開](https://msdn.microsoft.com/library/dd465337.aspx)します。 仮想マシンでデバッグする必要があるので、 **設定** のページ、 **Web の発行** ウィザードで、 **デバッグ** として構成します。 このように設定することで、デバッグ中もコードのシンボルを使用できます。

    ![Publish settings](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718349.png)

1.  **ファイル発行オプション**, [ **転送先にその他のファイルを削除する** プロジェクトはもっと早い日時に既に配置されている場合。

1. サーバー エクスプ ローラーで、バーチャル マシンのコンテキスト メニューで、プロジェクトの発行後にをクリックして **デバッガーを接続しています.**

    Azure は、仮想マシンのプロセスの一覧を取得し、[プロセスにアタッチ] ダイアログ ボックスに表示します。

    ![Attach debugger command](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC746722.png)

1.  **プロセスにアタッチする** ダイアログ ボックスで、] をクリックして **選択** コードをデバッグする対象の型のみを表示する結果の一覧に制限します。 32 ビットまたは 64 ビット マネージ コードとネイティブ コードのいずれかまたは両方をデバッグできます。

    ![Select code type dialog box](./media/vs-azure-tools-debug-cloud-services-virtual-machines/IC718346.png)

1. クリックして、仮想マシン上でデバッグするプロセス] をオン **アタッチ**します。 たとえば、仮想マシンで Web アプリをデバッグする場合は、w3wp.exe プロセスを選択できます。 参照してください [1 つのデバッグまたは Visual Studio での複数のプロセス](https://msdn.microsoft.com/library/jj919165.aspx) の詳細。

## 次のステップ

- 使用 **Intellitrace** リリース サーバーからの呼び出しとイベントのログを収集します。 参照してください [IntelliTrace および Visual Studio で発行済みのクラウド サービスのデバッグ](http://go.microsoft.com/fwlink/?LinkID=623016)します。
- 使用 **Azure 診断** 開発環境または Azure のロールを実行しているかどうか、ロール内でのコード実行の詳細情報を記録します。 参照してください [Azure 診断を使用したログ データの収集](http://go.microsoft.com/fwlink/p/?LinkId=400450)します。

