<properties
    pageTitle="Azure SQL Database のアクティブ geo レプリケーション"
    description="このトピックでは、SQL Database のアクティブ geo レプリケーションとその使用方法について説明します。"
    services="sql-database"
    documentationCenter="na"
    authors="rothja"
    manager="jeffreyg"
    editor="monicar" />


<tags
    ms.service="sql-database"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="data-management"
    ms.date="10/21/2015"
    ms.author="jroth" />


# Azure SQL Database のアクティブ geo レプリケーション

## 概要

アクティブ geo レプリケーション機能は、同じ Microsoft Azure リージョン内または異なるリージョン間にデータベースの冗長性 (地理的冗長性) を提供するメカニズムを実装します。 アクティブ geo レプリケーションを使用すると、データベースのコミット済みトランザクションが、別のサーバー上にある最大 4 つのデータベース コピーに非同期にレプリケートされます。 元のデータベースは連続コピーのプライマリ データベースになります。 それぞれの連続コピーはオンライン セカンダリ データベースと呼ばれます。 プライマリ データベースによって、コミット済みのトランザクションが各オンライン セカンダリ データベースに非同期にレプリケートされるしくみです。 特定の時点におけるオンライン セカンダリ データは、プライマリ データベースよりもわずかに古い可能性がありますが、プライマリ データベースにコミットされた変更とのトランザクション上の整合性が常に保証されます。 アクティブ geo レプリケーションは、最大 4 つのオンライン セカンダリ、または最大 3 つのオンライン セカンダリと 1 つのオフライン セカンダリをサポートします。

アクティブ geo レプリケーションの主な利点の 1 つは、データベース レベルの障害復旧ソリューションが提供されることです。 アクティブ geo レプリケーションを使用して、Premium サービス階層のユーザー データベースが同じリージョン内または別のリージョンにある別の Microsoft Azure SQL Database サーバー上のデータベースにトランザクションをレプリケートするように構成できます。 リージョン間で冗長性が確保されるため、自然災害、致命的なヒューマン エラー、または悪意のある行為によってデータセンターの機能が完全に失われた場合でも、アプリケーションを復旧できます。

もう 1 つの主なメリットは、オンライン セカンダリ データベースが読み取り可能である点です。 これにより、オンライン セカンダリは、レポート生成などの読み取りワークロードに対してロード バランサーとして機能できます。 オンライン セカンダリは障害復旧に備えて別のリージョンに作成できますが、同じリージョン内の別のサーバーに作成することもできます。 どちらの場合も、オンライン セカンダリ データベースを使用して、複数のリージョンに分散したクライアントにサービスを提供する読み取り専用ワークロードを分散できます。

アクティブ geo レプリケーションを使用できるシナリオは、上記以外にも次のようなものがあります。

- **データベースの移行**: アクティブ geo レプリケーションを使用して、最小限のダウンタイムでデータベースをあるサーバーから別のサーバーにオンラインで移行できます。
- **アプリケーションのアップグレード**: オンライン セカンダリをフェールバック オプションとして使用できます。

ビジネスの継続性を実現するにあたって、データセンター間の冗長性をリレーショナル ストレージに追加することは、ソリューションのほんの一部です。 大規模な障害の後にアプリケーション (サービス) をエンド ツー エンドで復旧するには、そのサービスと依存しているサービスを構成するすべてのコンポーネントを復旧する必要があります。 このようなコンポーネントの例には、クライアント ソフトウェア (カスタム JavaScript が設定されたブラウザーなど)、Web フロント エンド、ストレージ、DNS などがあります。 すべてのコンポーネントが同じ障害に対する復元性を備えており、アプリケーションの目標復旧時間 (RTO) 以内に利用可能になることが重要です。 そのため、依存するサービスをすべて特定し、これらのサービスが提供する保証と機能について把握しておく必要があります。 そのうえで、依存するサービスのフェールオーバー中もサービスが確実に機能するように対策を講じる必要があります。 災害復旧ソリューションの設計に関する詳細については、次を参照してください。 [災害復旧を使用してアクティブな Geo レプリケーション用のクラウド ソリューションの設計](sql-database-designing-cloud-solutions-for-disaster-recover.md)します。

## アクティブ geo レプリケーションの機能

アクティブ geo レプリケーションには、次の重要な機能が用意されています。

- **自動非同期レプリケーション**: オンライン セカンダリ データベースのシードされた後、プライマリ データベースの更新がオンライン セカンダリ データベースに非同期で自動的にコピーされます。 つまり、トランザクションはプライマリ データベースでコミットされた後に、オンライン セカンダリ データベースにコピーされます。 ただし、シード処理後は、オンライン セカンダリ データベースはどの時点においてもトランザクション上の整合性が確保されています。 
    >[AZURE.NOTE] 非同期レプリケーションは、リモートのデータ センターが接続されているワイド エリア ネットワークには付きものの遅延に対応できます。

- **複数のオンライン セカンダリ データベース**: 2 つ以上のオンライン セカンダリ データベースを使用すると、プライマリ データベースとアプリケーションの冗長性が向上し、保護が強化されます。 オンライン セカンダリ データベースが複数存在する場合、オンライン セカンダリ データベースのいずれかに障害が発生しても、アプリケーションは保護された状態が維持されます。 オンライン セカンダリ データベースが 1 つしか存在しない場合に障害が発生すると、新しいオンライン セカンダリ データベースが作成されるまで、アプリケーションは高いリスクにさらされます。

- **読み取り可能なオンライン セカンダリ データベース**: アプリケーションは、プライマリ データベースへのアクセスに使用されているのと同じセキュリティ プリンシパルを使用して、オンライン セカンダリ データベースにアクセスして読み取り専用操作を実行できます。 オンライン セカンダリ データベースでの連続コピー操作は、アプリケーションによるアクセスより優先されます。 また、オンライン セカンダリ データベースでのクエリが原因でテーブルが長時間ロックされると、プライマリ データベースのトランザクションが最終的に失敗する可能性があります。

- **フェールオーバー目的のユーザー制御による終了**: アプリケーションをオンライン セカンダリ データベースにフェールオーバーするには、プライマリ データベースとの連続コピー リレーションシップを終了する必要があります。 連続コピー リレーションシップを終了するには、アプリケーションまたは管理スクリプトを使用するか、ポータルから手動で、明示的な操作を実行する必要があります。 連続コピーの終了後、オンライン セカンダリ データベースはスタンドアロン データベースになります。 プライマリ データベースが読み取り専用データベースでない限り、オンライン セカンダリ データベースは読み取り/書き込み可能なデータベースになります。 2 つの形式の [連続コピー リレーションシップの終了](#termination-of-a-continuous-copy-relationship) このトピックの後半で説明します。

>[AZURE.NOTE] アクティブ geo レプリケーションは、Premium サービス階層のデータベースのみでサポートされています。 これには、プライマリ データベースとオンライン セカンダリ データベースの両方が該当します。 オンライン セカンダリは、プライマリと同じかそれ以上のパフォーマンス レベルに構成されている必要があります。 プライマリ データベースのパフォーマンス レベルに変更を加えても、セカンダリに自動的にレプリケートされません。 すべてのアップグレードは、最初にセカンダリ データベースで実行してから、最後にプライマリで行う必要があります。 パフォーマンス レベルの変更の詳細については、次を参照してください。 [パフォーマンス レベルを変更する](sql-database-scale-up.md)します。 主に 2 つの理由から、オンライン セカンダリは少なくともプライマリと同じサイズにする必要があります。 セカンダリには、レプリケートされたトランザクションをプライマリと同じ速度で処理できるだけの容量が必要です。 セカンダリに少なくとも同じ容量が確保されておらず、受信トランザクションを処理できない場合、遅延が発生し、最終的にプライマリの可用性に悪影響を与える可能性があります。 セカンダリの容量がプライマリと同じでない場合は、フェールオーバーによってアプリケーションのパフォーマンスと可用性が低下する可能性があります。

## 連続コピー リレーションシップの概念

ローカル データの冗長性と操作の復旧は、Azure SQL Database の標準的な機能です。 各データベースには、同じデータセンターに存在する 1 つのプライマリ データベースと 2 つのローカル レプリカ データベースがあり、データセンター内の高可用性を実現しています。 つまり、アクティブ geo レプリケーションのデータベースにも冗長なレプリカが提供されます。 プライマリ データベースとオンライン セカンダリ データベースの両方に 2 つのセカンダリ レプリカが用意されることになります。 ただし、セカンダリ データベースのプライマリ レプリカは連続コピー メカニズムによって直接更新され、アプリケーションによる更新を受け付けることができません。 次の図は、アクティブ geo レプリケーションが 2 つの Azure リージョン間にデータベースの冗長性を拡張する方法を示しています。 プライマリ データベースをホストするリージョンを、プライマリ リージョンと呼びます。 オンライン セカンダリ データベースをホストするリージョンを、セカンダリ リージョンと呼びます。 この図では、北ヨーロッパがプライマリ リージョンで、 西ヨーロッパがセカンダリ リージョンです。

![Continuous copy relationship](./media/sql-database-active-geo-replication/continuous-copy-relationships.gif)

プライマリ データベースが使用できなくなった場合、いずれかのオンライン セカンダリ データベースの連続コピー リレーションシップを終了すると、そのオンライン セカンダリ データベースがスタンドアロン データベースになります。 オンライン セカンダリ データベースは、プライマリ データベースの読み取り専用モードまたは読み取り/書き込みモードを継承し、連続コピーの終了後もモードが維持されます。 たとえば、プライマリ データベースが読み取り専用データベースの場合、連続コピーの終了後、オンライン セカンダリ データベースは読み取り専用データベースになります。 この時点で、アプリケーションをフェールオーバーしてオンライン セカンダリ データベースの使用を継続できます。 データセンターで致命的な障害が発生した場合や、プライマリ リージョンで長時間にわたる停止が発生した場合に復元性を提供するには、少なくとも 1 つのオンライン セカンダリ データベースが別のリージョンに存在する必要があります。

## 連続コピーの作成

既存のデータベースのみを対象として連続コピーを作成できます。 既存のデータベースの連続コピーを作成すると、地理的冗長性を追加するのに役立ちます。 連続コピーは、既存のデータベースを異なる Azure SQL Database サーバーにコピーするためにも作成できます。 作成した後、プライマリ データベースからコピーしたデータをセカンダリ データベースに設定できます。 このプロセスはシード処理と呼ばれます。 シード処理の完了後は、各新規トランザクションがプライマリでコミットされた後でレプリケートされます。

既存のデータベースの継続的なコピーを作成する方法については、次を参照してください。 [Geo レプリケーションを有効にする方法](sql-database-business-continuity-design.md#how-to-enable-geo-replication)します。

## 重要なデータの損失の防止

ワイド エリア ネットワークの遅延は大きいため、連続コピーでは非同期のレプリケーション メカニズムが使用されます。 そのため、障害が発生した場合、部分的なデータ損失が避けられません。 しかし、データ損失が許されないアプリケーションもあります。 重要な更新情報を保護する、アプリケーション開発者が呼び出すことができます、 [sp_wait_for_database_copy_sync](https://msdn.microsoft.com/library/dn467644.aspx) システム プロシージャ、トランザクションのコミット直後にします。 **sp_wait_for_database_copy_sync** を呼び出すと、最後にコミットされたトランザクションがオンライン セカンダリ データベースにレプリケートされるまで、呼び出しスレッドがブロックされます。 このプロシージャは、すべてのキューに置かれたトランザクションがオンライン セカンダリ データベースによって確認されるまで待機します。 **sp_wait_for_database_copy_sync** 対象は、特定の連続コピー リンクです。 プライマリ データベースへの接続権限を持つユーザーが、このプロシージャを呼び出すことができます。
>[AZURE.NOTE] **sp_wait_for_database_copy_sync** プロシージャを呼び出すと、大きな遅延が発生する場合があります。 遅延はキューの長さと使用可能な帯域幅に依存します。 どうしても必要な場合を除き、このプロシージャを呼び出さないようにしてください。

## 連続コピー リレーションシップの終了

連続コピー リレーションシップは、いつでも終了できます。 連続コピー リレーションシップを終了しても、セカンダリ データベースは削除されません。 連続コピー リレーションシップを終了する方法は 2 つあります。

- **計画終了**: データ損失が許されない、計画された運用に適しています。 計画終了は、オンライン セカンダリ データベースのシード処理が完了した後に、プライマリ データベースでのみ実行できます。 計画終了では、最初にプライマリ データベースでコミットされたすべてのトランザクションをオンライン セカンダリ データベースにレプリケートし、その後、連続コピー リレーションシップを終了します。 これにより、セカンダリ データベースでのデータ損失が回避されます。
- **計画外 (強制) 終了**: プライマリ データベースまたは 1 つのオンライン セカンダリ データベースの機能が失われた場合に対応するための方法です。 強制終了は、プライマリ データベースまたはセカンダリ データベースのいずれかで実行できます。 強制終了を実行すると、プライマリ データベースとそれに関連付けられたオンライン セカンダリ データベースの間のレプリケーション関係が失われ、元に戻せなくなります。 また、プライマリ データベースからレプリケートされていないトランザクションもすべて失われます。 強制終了を実行すると、連続コピー リレーションシップは直ちに終了します。 転送中のトランザクションはオンライン セカンダリ データベースにレプリケートされません。 そのため、強制終了では、プライマリ データベースからレプリケートされていないすべてのトランザクション失われて復旧できなくなる場合があります。

>[AZURE.NOTE] プライマリ データベースに連続コピー リレーションシップが 1 つしかない場合、強制終了後、プライマリ データベースの更新情報は保護されなくなります。

連続コピー リレーションシップを終了する方法の詳細については、次を参照してください。 [障害から Azure SQL データベースの回復](sql-database-disaster-recovery.md)します。

## 次のステップ

アクティブ Geo レプリケーションと SQL Database の他のビジネス継続性機能の詳細については、次を参照してください。 [ビジネス継続性の概要](sql-database-business-continuity.md)します。




