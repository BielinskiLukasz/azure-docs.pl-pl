<properties 
    pageTitle="Azure Redis Cache の監視方法" 
    description="Azure Redis Cache のインスタンスの正常性とパフォーマンスを監視する方法を学習する" 
    services="redis-cache" 
    documentationCenter="" 
    authors="steved0x" 
    manager="dwrede" 
    editor=""/>

<tags 
    ms.service="cache" 
    ms.workload="tbd" 
    ms.tgt_pltfrm="cache-redis" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="12/03/2015" 
    ms.author="sdanie"/>


# Azure Redis Cache の監視方法

Azure Redis Cache には、キャッシュのインスタンスを監視するためのオプションがいくつか用意されています。 メトリックの表示、メトリック グラフのスタート画面へのピン留め、監視グラフの日付と時刻の範囲のカスタマイズ、グラフのメトリックの追加と削除、特定の条件が満たされた場合のアラートの設定を行うことができます。 これらのツールによって、Azure Redis Cache インスタンスの正常性を監視し、キャッシュ アプリケーションを管理できます。

キャッシュ診断を有効にすると、Azure Redis Cache インスタンスのメトリックが約 30 秒ごとに収集されます。格納されたメトリックはメトリック グラフに表示され、アラート ルールで評価されます。

キャッシュ メトリックは、Redis を使用して収集 [情報](http://redis.io/commands/info) コマンドです。 各キャッシュ メトリックで使用される各種 INFO コマンドの詳細については、次を参照してください。 [使用可能なメトリックとレポート期間](#available-metrics-and-reporting-intervals)します。

キャッシュ メトリックを表示する [参照](cache-configure.md) でキャッシュ インスタンスを [Azure ポータル](https://portal.azure.com)します。 Azure Redis Cache インスタンスのメトリックは、**[Redis Cache]** ブレードからアクセスします。

![監視][redis-cache-monitor-overview]
>[AZURE.IMPORTANT] 次のメッセージが Azure ポータルで表示されている場合の手順で、 [キャッシュ診断を有効にする](#enable-cache-diagnostics) キャッシュ診断を有効にする] セクションです。
>
>' の監視が無効になります。 ここをクリックして、診断を有効にします '。

キャッシュのメトリックは、**[Redis Cache]** ブレードの **[監視]** グラフと **[使用状況]** グラフに表示されます。 各グラフは、メトリックの追加や削除、レポート期間の変更など、カスタマイズすることができます。 また、**[Redis Cache]** ブレードの **[処理]** セクションには、キャッシュの **[イベント]** と **[アラート ルール]** が表示されます。

## キャッシュ診断の有効化

Azure Redis Cache には診断データをストレージ アカウントに格納する機能が用意されており、任意のツールを使用してそのデータにアクセスしてデータを直接処理できます。 キャッシュ診断を Azure ポータルに収集、格納、および表示するには、ストレージ アカウントを構成する必要があります。 同じリージョンやサブスクリプションにあるキャッシュは同じ診断ストレージ アカウントを共有するため、構成が変更されるとそのリージョンにあるサブスクリプションのすべてのキャッシュに適用されます。

キャッシュ診断を有効化および構成するには、対象のキャッシュ インスタンスの **[Redis Cache]** ブレードに移動します。 診断が有効になっていない場合は、診断のグラフではなくメッセージが表示されます。

![キャッシュ診断の有効化][redis-cache-enable-diagnostics]

監視グラフの 1 つ (**[ヒット数とミス数]** など) をクリックして **[メトリック]** ブレードを表示し、**[診断の設定]** をクリックしてキャッシュ サービス インスタンスの診断設定を有効化および構成します。

![診断設定][redis-cache-diagnostic-settings]

![診断の構成][redis-cache-configure-diagnostics]

**[オン]** ボタンをクリックするとキャッシュ診断が有効になり、診断の構成が表示されます。

**[ストレージ アカウント]** の右側にある矢印をクリックして、診断データを保持するストレージ アカウントを選択します。 パフォーマンス最適化のために、キャッシュと同じリージョンにあるストレージ アカウントを選択します。

診断設定の構成が完了したら、**[保存]** をクリックして構成を保存します。 変更が有効になるまでに数分かかる場合があります。
>[AZURE.IMPORTANT] 同じリージョンやサブスクリプションにあるキャッシュは同じ診断ストレージ アカウントを共有するため、構成が変更されるとそのリージョンにあるサブスクリプションのすべてのキャッシュに適用されます。

格納されたメトリックを表示するで始まる名前を持つストレージ アカウント内のテーブルを調べて `WADMetrics`します。 Azure ポータルの外に格納されたメトリックにアクセスする方法の詳細については、次を参照してください。、 [アクセス Redis Cache の監視データ](https://github.com/rustd/RedisSamples/tree/master/CustomMonitoring) サンプルです。
>[AZURE.NOTE] 選択したストレージ アカウントに格納されているメトリックのみが Azure ポータルに表示されます。 ストレージ アカウントを変更すると、以前に構成されたストレージ アカウント内のデータはダウンロードできますが、Azure ポータルには表示されません。  

## 使用可能なメトリックとレポート期間

キャッシュ メトリックは、**[過去 1 時間]**、**[今日]**、**[過去 1 週間]**、および **[カスタム]** などの期間でレポートが作成されます。 各メトリック グラフの **[メトリック]** ブレードには、グラフ内の各メトリックの平均値、最小値、および最大値が表示され、一部のメトリックでは指定のレポート期間における合計が表示されます。

各メトリックには 2 つのバージョンがあります。 1 つのメトリックを使用するキャッシュのキャッシュ全体のパフォーマンスを測定する [クラスタ リング](cache-how-to-premium-clustering.md), 、2 番目のバージョンを含む、メトリックの `(0 ~ 9 のシャード)` 、キャッシュ内の 1 つのシャードのパフォーマンスを計測する名前にします。 たとえば、キャッシュに 4 つのシャード `キャッシュ ヒット` 全体のキャッシュのヒット数の合計量と `キャッシュ ヒット (シャード 3)` はキャッシュのシャードのヒット数だけです。
>[AZURE.NOTE] キャッシュがアイドル状態で、アクティブなクライアント アプリケーションに接続されていない場合でも、接続されているクライアント、メモリの使用状況、実行中の操作などのキャッシュ アクティビティが表示されることがあります。 これは Azure Redis Cache インスタンスの処理中に普通に発生するアクティビティです。

| メトリック| 説明|
|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| キャッシュ ヒット数| 指定したレポート期間中に、成功したキー検索の数。この値は Redis INFO `keyspace_hits コマンド`します。|
| キャッシュ ミス数| 指定したレポート期間中に、失敗したキー検索の数。この値は Redis INFO `keyspace_misses` コマンドです。キャッシュ ミスは必ずしもキャッシュに問題があるということではありません。たとえば、キャッシュ アサイド プログラミング パターンを使用する場合、アプリケーションはまず項目をキャッシュから検索します。項目が見つからなかった (キャッシュ ミス) 場合は、データベースから項目を取得して、次回使用するためにキャッシュに追加されます。キャッシュ ミスは、キャッシュ アサイド プログラミング パターンでは普通の動作です。キャッシュ ミスの数が予想よりも大きい場合は、キャッシュにデータを入力またはキャッシュからデータを読み取るアプリケーション ロジックを確認してください。項目がメモリ不足のためのキャッシュから削除されている、いくつかのキャッシュ ミスがある可能性がありますが推奨する値のメモリが不足を監視するようになります `Used Memory` または `キーの削除`します。|
| 接続されているクライアント数| 指定したレポート期間中に、キャッシュに接続されるクライアントの数。この値は Redis INFO `connected_clients` コマンドです。接続されるクライアントの上限は 10,000 で、上限に達するとそれ以降のキャッシュへの接続の試行は失敗します。アクティブなクライアント アプリケーションがない場合でも、内部処理や接続によって接続されたクライアントのインスタンスが少数見つかることがあります。|
| 削除されたキー数| 期限を指定したレポート期間中に、キャッシュから削除された項目の数、 `maxmemory` 制限します。この値は Redis INFO `evicted_keys` コマンドです。|
| 期限切れキー数| 指定したレポート期間中に、期限が切れたキャッシュの項目の数。この値は Redis INFO `expired_keys` コマンドです。|
| 取得数| 指定したレポート期間中に、キャッシュから実行された取得操作の数。この値は、次の合計値は Redis INFO からすべてのコマンド: `cmdstat_get`, 、`cmdstat_hget`, 、`cmdstat_hgetall`, 、`cmdstat_hmget`, 、`cmdstat_mget`, 、`cmdstat_getbit`, 、および `cmdstat_getrange`, 、レポート期間中にキャッシュ ヒットとキャッシュ ミスの合計と同じです。|
| Redis サーバーの負荷| Redis サーバーの処理がビジーで、アイドル状態でメッセージを待機していないサイクルの割合。このカウンタが 100 に達すると、Redis サーバーのパフォーマンスが上限に達したことを意味し、これ以上 CPU を高速で処理できないことを表します。Redis サーバーの負荷が高い場合は、クライアントでタイムアウトの例外が表示されます。この場合は、スケールアップまたはデータを複数のキャッシュにパーティション分割することを検討してください。|
| 設定数| 指定したレポート期間中に、キャッシュから実行された設定操作の数。この値は、次の合計値は Redis INFO からすべてのコマンド: `cmdstat_set`, 、`cmdstat_hset`, 、`cmdstat_hmset`, 、`cmdstat_hsetnx`, 、`cmdstat_lset`, 、`cmdstat_mset`, 、`cmdstat_msetnx`, 、`cmdstat_setbit`, 、`cmdstat_setex`, 、`cmdstat_setrange`, 、および `cmdstat_setnx`します。|
| 合計処理数| 指定したレポート期間中に、キャッシュ サーバーによって処理されたコマンドの合計数。この値は Redis INFO `total_commands_processed` コマンドです。Azure Redis Cache をパブリッシュ/サブスクライブにのみ使用する場合があることなしのメトリックに注意してください `キャッシュ ヒット`, 、`キャッシュ ミス`, 、`取得`, 、または `セット`, がありますが、 `操作全体` パブリッシュ/サブスクライブ操作のキャッシュの使用状況を反映するメトリックです。|
| メモリ使用量| 指定したレポート期間中にキャッシュ内のキー/値のペアで使用されるキャッシュ メモリの量 (MB)。この値は Redis INFO `used_memory` コマンドです。これには、メタデータや断片化は含まれません。|
| RSS メモリ使用量| 指定したレポート期間中に使用されるキャッシュ メモリの量 (MB)。これには断片化とメタデータが含まれます。この値は Redis INFO `used_memory_rss` コマンドです。|
| CPU| 指定したレポート期間中に Azure Redis Cache で使用される CPU の割合。この値は、オペレーティング システム `\Processor (_Total) \ % Processor Time` パフォーマンス カウンターです。|
| キャッシュの読み取り| 指定したレポート期間中に、キャッシュから読み取られたデータ量 (KB/秒)。この値は、キャッシュをホストする仮想マシンをサポートするネットワーク インターフェイス カードから派生し、Redis 固有のものではありません。|
| キャッシュの書き込み| 指定したレポート期間中に、キャッシュに書き込まれたデータ量 (KB/秒)。この値は、キャッシュをホストする仮想マシンをサポートするネットワーク インターフェイス カードから派生し、Redis 固有のものではありません。|

## 監視グラフ

**[監視]** セクションには、**[ヒット数とミス数]**、**[取得数と設定数]**、**[接続数]**、および **[コマンド合計数]** のグラフがあります。

![監視グラフ][redis-cache-monitoring-part]

**監視**グラフには次のメトリックが表示されます。

| 監視グラフ| キャッシュ メトリック|
|------------------|-------------------|
| ヒット数とミス数| キャッシュ ヒット数|
| | キャッシュ ミス数|
| 取得数と設定数| 取得数|
| | 設定数|
| 接続| 接続されているクライアント数|
| コマンド合計数| 合計処理数|

メトリックの表示およびこのセクションでは、個々 のグラフをカスタマイズする方法については、次を参照してください。 [メトリックを表示し、メトリック チャートをカスタマイズする方法](#how-to-view-metrics-and-customize-charts) セクションです。

## 使用状況グラフ

**[使用状況]** セクションには、**[Redis サーバーの負荷]**、**[メモリ使用量]**、**[ネットワーク帯域幅]**、および **[CPU 使用率]** のグラフのほか、キャッシュ インスタンスの **[価格レベル]** も表示されます。

![使用状況グラフ][redis-cache-usage-part]

**価格レベル** 表示はキャッシュの価格レベルし、に使用できる [スケール](cache-how-to-scale.md) 別の価格レベルをキャッシュします。

**使用状況**グラフには次のメトリックが表示されます。

| 使用状況グラフ| キャッシュ メトリック|
|-------------------|---------------|
| Redis サーバーの負荷| サーバーの負荷|
| メモリ使用量| メモリ使用量|
| ネットワーク帯域幅| キャッシュの書き込み|
| CPU 使用率| CPU|

メトリックの表示およびこのセクションでは、個々 のグラフをカスタマイズする方法については、次を参照してください。 [メトリックを表示し、メトリック チャートをカスタマイズする方法](#how-to-view-metrics-and-customize-charts) セクションです。

## メトリックの確認方法とグラフのカスタマイズ方法

前のセクションで説明したように、メトリックの概要は **[Redis Cache]** ブレードの**監視**と**使用状況**のグラフで確認できます。 特定のグラフのメトリックの詳細を確認してグラフをカスタマイズするには、**[Redis Cache]** ブレードから希望のグラフを選択して、そのグラフの **[メトリック]** ブレードを表示します。

![[メトリック] ブレード][redis-cache-metric-blade]

グラフに表示されるメトリックに設定されているアラートは、そのグラフの **[メトリック]** ブレードの下部に一覧表示されます。

メトリックを追加または削除する、またはレポートの期間を変更するには、グラフを右クリックして **[グラフの編集]** をクリックします。 **[Redis Cache]** ブレードからグラフを直接編集することもできます。編集するグラフを右クリックして **[グラフの編集]** を選択します。

グラフにメトリックを追加する、またはグラフからメトリックを削除するには、メトリックの名前の横にあるチェックボックスをオンにします。 レポートの期間を変更するには、目的の期間をクリックします。 **グラフの種類**を変更するには、目的のスタイルをクリックします。 必要な変更を加えたら、**[保存]** をクリックします。

![グラフの編集][redis-cache-edit-chart]

**[保存]** をクリックすると、**[メトリック]** ブレードを閉じるまでは変更内容が維持されます。 後でもう一度このブレードを表示するときは、初期のメトリックと期間が表示されます。 グラフをカスタマイズする方法の詳細については、次を参照してください。 [サービス メトリックスを監視](../azure-portal/insights-how-to-customize-monitoring.md)します。

グラフの特定の期間におけるメトリックを表示するには、特定のバーの上か、目的の時間に対応するグラフ上の点にマウス ポインターを置きます。

![グラフの詳細を表示][redis-cache-view-chart-details]

## クラスタリングを使用した Premium キャッシュの監視方法

Premium キャッシュを持つ [クラスタ リング](cache-how-to-premium-clustering.md) を有効に最大 10 個のシャードを持つことができます。 各シャードには独自のメトリックがあり、これらのメトリックが集約されて、キャッシュ全体としてのメトリックが提供されます。 各メトリックには 2 つのバージョンがあります。 1 つのメトリックは、キャッシュ全体を 2 番目のバージョンを含む、メトリックのパフォーマンスを測定 `(0 ~ 9 のシャード)` 、キャッシュ内の 1 つのシャードのパフォーマンスを計測する名前にします。 たとえば、キャッシュに 3 つのシャード `キャッシュ ヒット` 全体のキャッシュのヒット数の合計量と `(シャード 2) のキャッシュ ヒット` はキャッシュのシャードのヒット数だけです。

各監視グラフには、キャッシュ シャードごとのメトリックと、キャッシュの最上位レベルのメトリックが表示されます。

![監視][redis-cache-premium-monitor]

データ ポイントの上にカーソルを合わせると、その時点での詳細が表示されます。

![監視][redis-cache-premium-point-summary]

概して、大きな値はキャッシュの集計値であり、小さい値はシャードの個々のメトリックです。 この例では、3 つのシャードがあり、キャッシュ ヒットはシャード間で均等に分散されます。

![監視][redis-cache-premium-point-shard]

詳細を確認するには、グラフをクリックして **[メトリック]** ブレードで展開ビューを表示してください。

![監視][redis-cache-premium-chart-detail]

既定では、各グラフには個々のシャードのパフォーマンス カウンターと共に、最上位レベルのキャッシュのパフォーマンス カウンターが含まれます。 これらは **[グラフの編集]** ブレードでカスタマイズできます。

![監視][redis-cache-premium-edit]

利用可能なパフォーマンス カウンターの詳細については、次を参照してください。 [使用可能なメトリックとレポート期間](#available-metrics-and-reporting-intervals)します。


## 処理とアラート

**[処理]** セクションには、**[イベント]** セクションと **[アラート ルール]** セクションがあります。

![処理][redis-cache-operations-events]

最近のキャッシュ処理の一覧を確認するには、**[イベント]** グラフをクリックして **[イベント]** ブレードを表示します。 処理の例として、アクセス キーの取得と再生成、アラート ルールのアクティブ化と解決などが挙げられます。 各イベントの詳細については、**[イベント]** ブレードのイベントをクリックします。

イベントの詳細については、次を参照してください。 [イベントの表示と、監査ログ](../azure-portal/insights-debugging-with-events.md)します。

**[アラート ルール]** セクションには、キャッシュ インスタンスのアラートの数が表示されます。 アラート ルールを使用すると、キャッシュ インスタンスを監視して、特定のメトリック値がルールで定義されたしきい値に達するたびに電子メールを受け取るように設定できます。

アラート ルールは約 5 分ごとに評価され、アラート ルールがアクティブになると構成済みの通知が送信されます。 アラート ルールのアクティブ化と通知は瞬時には処理されないため、アクティブ化と通知の送信に数分の遅延が発生する可能性があります。

アラート ルールは、特定の監視グラフの **[メトリック]** ブレードか、**[アラート ルール]** ブレードから確認および設定できます。

アラート ルールには次のプロパティがあります。

| アラート ルールのプロパティ| 説明|
|-------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| リソース| アラート ルールで評価するリソース。Redis Cache からアラート ルールを作成する場合は、キャッシュがリソースになります。|
| 名前| 現在のキャッシュ インスタンスでアラート ルールを一意に識別する名前。|
| 説明| アラート ルールに関する追加の説明。|
| メトリック| アラート ルールで監視するメトリック。キャッシュ メトリックの一覧は、「使用可能なメトリックとレポート期間」を参照してください。|
| 条件| アラート ルールの条件演算子。「より大きい」、「より大きいまたは等しい」、「より小さい」、または「より小さいまたは等しい」を使用できます。|
| しきい値| 条件プロパティで指定した演算子を使用してメトリックと比較する値。この値はメトリックによって、バイト数/秒、バイト数、パーセンテージ、カウント数などと変わります。|
| 期間| アラート ルールの比較に使用する、メトリックの平均値を算出する期間を指定します。たとえば、期間を [過去 1 時間] に設定すると、過去 1 時間のメトリックの平均値が比較に使用されます。アクティビティ内のスパイクによってしきい値が満たされたときに通知を受け取る場合は、短い期間が適しています。継続的なアクティビティがしきい値を超えたときに通知を受け取る場合は、長い期間を指定してください。|
| 電子メール サービスと共同管理者| true に設定すると、アラートが生成された際にサービス管理者と共同管理者が電子メールを受け取ります。|
| 追加の管理者の電子メール アドレス| アラートがアクティブ化された際に通知を受け取る追加の管理者の電子メール アドレス。|

各アラート ルールのアクティブ化の際に送信される通知は 1 通のみです。 一度ルールのしきい値を超えて通知が送信されると、メトリックがしきい値を下回るまでルールは再評価されません。 その後再度メトリックがしきい値を超えると、アラートが再度アクティブ化され、新しい通知が送信されます。

キャッシュ インスタンスのすべてのアラート ルールを表示するには、**[Redis Cache]** ブレードの **[アラート ルール]** パーツをクリックします。 特定のメトリックを使用するアラート ルールのみを表示するには、そのメトリックが含まれるグラフの **[メトリック]** ブレードに移動します。

![アラート ルール][redis-cache-alert-rules]

アラート ルールを追加するには、**[メトリック]** ブレードまたは **[アラート ルール]** ブレードで **[アラートの追加]** をクリックします。

必要なルール条件を **[アラート ルールの追加]** ブレードに入力して **[OK]** をクリックします。

![アラート ルールの追加][redis-cache-add-alert]
>[AZURE.NOTE] **[メトリック]** ブレードで **[アラートの追加]** をクリックしてアラート ルールを作成すると、そのブレードのグラフに表示されるメトリックのみが **[メトリック]** ドロップダウンに表示されます。 **[アラート ルール]** ブレードで **[アラートの追加]** をクリックしてアラート ルールを作成すると、すべてのメトリックを **[メトリック]** ドロップダウンから選択できます。

アラート ルールを保存すると、**[アラート ルール]** ブレードのほか、そのアラート ルールで使用されるメトリックを表示する **[メトリック]** ブレードのすべてのグラフにそのアラート ルールが表示されます。 アラート ルールを編集するには、アラート ルールの名前をクリックして **[ルールの編集]** ブレードを表示します。 **[ルールの編集]** ブレードでは、ルールのプロパティの編集、アラート ルールの削除と無効化、または無効なルールの再有効化を行うことができます。
>[AZURE.NOTE] ルールのプロパティに加えたあらゆる変更が **[アラート ルール]** ブレードや **[メトリック]** ブレードに反映されるまでには時間がかかるア場合があります。

アラート ルールがアクティブになると、アラート ルールの構成によっては電子メールが送信され、**[Redis Cache]** ブレードの **[アラート ルール]** パーツにアラート アイコンが表示されます。

アラート ルールは、アラート条件が true に評価されなくなった時点で解決したと見なされます。 アラート ルールの条件が解決されると、アラート アイコンはチェック マークに置き換えられます。 アラートのアクティブ化と解決方法の詳細については、**[Redis Cache]** ブレードの **[イベント]** パーツをクリックして、**[イベント]** ブレードのイベントを確認します。

Azure でアラートの詳細については、次を参照してください。 [警告通知を受け取る](../azure-portal/insights-receive-alert-notifications.md)します。



[redis-cache-monitor-overview]: ./media/cache-how-to-monitor/redis-cache-monitor-overview.png 
[redis-cache-enable-diagnostics]: ./media/cache-how-to-monitor/redis-cache-enable-diagnostics.png 
[redis-cache-diagnostic-settings]: ./media/cache-how-to-monitor/redis-cache-diagnostic-settings.png 
[redis-cache-configure-diagnostics]: ./media/cache-how-to-monitor/redis-cache-configure-diagnostics.png 
[redis-cache-monitoring-part]: ./media/cache-how-to-monitor/redis-cache-monitoring-part.png 
[redis-cache-usage-part]: ./media/cache-how-to-monitor/redis-cache-usage-part.png 
[redis-cache-metric-blade]: ./media/cache-how-to-monitor/redis-cache-metric-blade.png 
[redis-cache-edit-chart]: ./media/cache-how-to-monitor/redis-cache-edit-chart.png 
[redis-cache-view-chart-details]: ./media/cache-how-to-monitor/redis-cache-view-chart-details.png 
[redis-cache-operations-events]: ./media/cache-how-to-monitor/redis-cache-operations-events.png 
[redis-cache-alert-rules]: ./media/cache-how-to-monitor/redis-cache-alert-rules.png 
[redis-cache-add-alert]: ./media/cache-how-to-monitor/redis-cache-add-alert.png 
[redis-cache-premium-monitor]: ./media/cache-how-to-monitor/redis-cache-premium-monitor.png 
[redis-cache-premium-edit]: ./media/cache-how-to-monitor/redis-cache-premium-edit.png 
[redis-cache-premium-chart-detail]: ./media/cache-how-to-monitor/redis-cache-premium-chart-detail.png 
[redis-cache-premium-point-summary]: ./media/cache-how-to-monitor/redis-cache-premium-point-summary.png 
[redis-cache-premium-point-shard]: ./media/cache-how-to-monitor/redis-cache-premium-point-shard.png 

