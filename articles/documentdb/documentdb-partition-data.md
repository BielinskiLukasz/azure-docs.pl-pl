<properties      
    pageTitle="シャーディングによる DocumentDB のデータのパーティション分割と拡大縮小 | Microsoft Azure"      
    description="シャーディングという手法でデータを拡大縮小する方法を確認します。 シャーディング、DocumentDB でのデータのパーティション分割の方法、ハッシュ パーティション分割と範囲パーティション分割を使用する状況について説明します。"         
    keywords="Scale data, shard, sharding, documentdb, azure, Microsoft azure"
    services="documentdb"      
    authors="arramac"      
    manager="jhubbard"      
    editor="monicar"      
    documentationCenter=""/> 
<tags      
    ms.service="documentdb"      
    ms.workload="data-services"      
    ms.tgt_pltfrm="na"      
    ms.devlang="na"      
    ms.topic="article"      
    ms.date="10/05/2015"      
    ms.author="arramac"/> 

# DocumentDB のデータのパーティション分割と拡大縮小

[Microsoft Azure DocumentDB](../../services/documentdb/) 高速で予測可能なパフォーマンスを実現するために設計されていますが、 *スケール アウト* シームレスなこととして、アプリケーションの規模の拡大します。 DocumentDB は、Web およびモバイル アプリの MSN スイートを強化する User Data Store のように、Microsoft の大規模プロダクション サービスを強化するために利用されてきました。 

一般に呼ば概念でデータを水平パーティション分割によって、DocumentDB アプリケーションのストレージとスループットに関して無限に近い拡張が実現できます **シャーディング**します。  DocumentDB アカウントを拡張する直線的にスタック可能な単位による、コストとも呼ばれます **コレクション**します。 コレクション全体にわたるデータのパーティション分割をいかに適切に行うことができるかは、データの形式とアクセス パターンによって決まります。 

データの拡大縮小に関するこの記事を最後まで読むと、次に挙げる疑問への回答が得られます。   

 - ハッシュ パーティション分割と範囲パーティション分割とは
 - 各パーティション分割手法はどのようなときに使用するのか、またその理由
 - パーティション分割済みのアプリケーションを Azure DocumentDB で構築するには、どうすればいいのか

この記事では、シャーディングの概念についていくつか紹介します。 DocumentDB .NET SDK を使用してデータをパーティション分割するコードを記述する準備ができたら場合を見て [DocumentDB .NET SDK を使用してデータをパーティション分割](documentdb-sharding.md)します。

## コレクション = パーティション

データの拡大縮小とパーティション分割の手法について詳しく説明する前に、コレクションとは何か、また何がコレクションではないのかを理解する必要があります。 既にご存じのように、コレクションとは JSON ドキュメントのコンテナーです。 DocumentDB のコレクションは *論理* 、コンテナーも *物理* コンテナーです。 これらは、ストアド プロシージャやトリガーにとってのトランザクション境界であり、クエリや CRUD 操作へのエントリ ポイントです。 各コレクションは、同じアカウント内の他のコレクションとは共有されない、予約済みの量のスループットが割り当てられます。 そのため、コレクションをさらに追加し、それにドキュメントを分配することで、ストレージとスループットの両方に関してアプリケーションをスケール アウトすることができます。

コレクションは、リレーショナル データベースにおけるテーブルとは異なります。 コレクションは、スキーマを適用しません。 そのため、さまざまなスキーマを持つ、異なる種類のドキュメントを同じコレクション内に格納できます。 ただし、テーブルを扱う場合と同様、1 種類のオブジェクトの格納にコレクションを使用するという選択肢もあります。 何が最善のモデルであるかは、クエリやトランザクションにおいて、データがどのような組み合わせで現れるかによって決まります。

## DocumentDB を使用したパーティション分割

Azure DocumentDB (またはさらに言えば、分散システム) のデータをパーティション分割に使用できる 2 つの方法し、これらは *範囲パーティション分割*, 、および *ハッシュ パーティション分割*します。 として、ドキュメント内の単一の JSON プロパティの名前を選択します。 この操作では、 *パーティション キー*, 、よく自然 ID プロパティ、たとえば"userID"ユーザー ストアまたは IoT シナリオには、"deviceId"です。 時系列データの場合、「timestamp」がパーティション キーとして使用されます。通常、データは時間範囲基準で挿入され、検索されるためです。 1 つのプロパティを使用するのが一般的ですが、ドキュメントによっては別のプロパティになることがあります。たとえば、ユーザー ドキュメントには「id」が、コメントには「ownerUserId」が使用されます。 次の手順は、要求に含まれるパーティション キーを利用し、作成やクエリなど、すべての操作を適切なコレクションにルーティングすることです。

それでは、これらの手法について、もう少し詳しく見ていきましょう。

## 範囲パーティション分割

範囲パーティション分割では、パーティション キーが特定の範囲内にあるかどうかに基づいてパーティションが割り当てられます。 これは一般的でパーティション分割の使用 *タイムスタンプ* プロパティ (たとえば、2015 年 2 月 1 日、2015 年 2 月 2 日までの eventTime)。 

> [AZURE.TIP] クエリがパーティション キーに対して特定の範囲の値に制限されている場合、範囲がパーティション分割を使用する必要があります。

範囲パーティション分割の特殊な事例として、範囲が単一値の場合があります。 通常、これは個別値によるパーティション分割に使用されます。たとえば、スカンジナビアのパーティションにはノルウェー、デンマーク、スウェーデンが含まれます。 

> [AZURE.TIP] 範囲パーティション分割すると、最高水準のマルチ テナント アプリケーションの管理においての制御が用意されています。 複数のテナントを 1 つのコレクションに割り当てることや、1 つのテナントを 1 つのコレクションに、または 1 つのテナントを複数のコレクションにわたって割り当てることもできます。 

## ハッシュ パーティション分割

ハッシュ パーティション分割では、ハッシュ関数の値に基づいてパーティションが割り当てられ、複数のパーティションにわたって要求やデータを均等に分配できます。 この手法は、数多くの異なるクライアントによって生成または消費されるデータのパーティション分割に使用されるのが一般的で、ユーザー プロファイル、カタログ項目、IoT (Internet of Things: モノのインターネット) デバイスの製品利用統計情報データなどの格納に便利です。 

> [AZURE.TIP] ハッシュを列挙するエンティティが多すぎる場合にパーティション分割 (例: ユーザーまたはデバイス) を使用して、要求レートがエンティティ間で比較的均一です。

## 適切なパーティション分割手法を選択する

では、どのパーティション分割手法が自分にとって適切なのでしょうか。 それは、データの種類と普段のアクセス パターンによって決まります。 設計時に適切なパーティション分割手法を選ぶことによって、技術的負債を回避し、データ サイズや要求ボリュームの増大に対処することができます。

- **範囲パーティション分割** これを使用して、パーティションをエージ用の簡単かつ自然なメカニズムによってタイムスタンプと日付のコンテキストでは通常、使用できます。 また、クエリが通常はある時間範囲に制限されている場合、それがパーティション分割の境界と一致することになるので便利です。 また、順序付けも関連付けもされていないデータ セットについて、自然な形でグループ分けや整理ができます。たとえば、テナントを組織ごとにグループ分けする、州をリージョンごとにグループ分けするなどです。 また、範囲は、コレクション間でのデータ移行について、きめ細かく制御することも可能です。 
- **ハッシュ パーティション分割** プロビジョニング済みストレージおよびスループットの効果的な使用のため、要求への統一された負荷分散に適しています。 使用して *コンシス テント ハッシュ* アルゴリズムを追加するか、パーティションを削除するときに移動する必要があるデータの量を最小限に抑えることができます。

選択するパーティション分割手法を 1 つだけに絞る必要はありません。 A *複合* これらの手法のことができます、シナリオによっては便利です。 たとえば、車両の製品利用統計情報データを格納している場合、適切なアプローチとしては、まず管理しやすいデバイス製品利用統計情報データをタイムスタンプの範囲ごとにパーティション分割し、その後、スループットをスケールアウトするために VIN (車両識別番号) に対してサブパーティション分割を行います (範囲ハッシュ複合パーティション分割)。

## パーティション分割済みアプリケーションの開発
DocumentDB でパーティション分割済みアプリケーションを開発する場合、着目すべき 3 つの重要な設計領域があります。

- どのようにして作成および読み取り (クエリを含む) を適切なコレクションにルーティングするか
- 永続化し、別名パーティション解決構成を取得する方法 パーティション マップされます。
- データや要求のボリュームが増大した場合、どのようにしてパーティションを追加または削除するか

それぞれの領域について詳しく見てみましょう。

## 作成およびクエリのルーティング

ハッシュ パーティション分割と範囲パーティション分割のいずれの場合でも、ルーティング ドキュメントの作成は簡単に要求できます。 ドキュメントは、パーティション キーに一致するハッシュ値または範囲値のパーティション上に作成されます。

クエリや読み取りは、通常、パーティション キーが 1 つに制限されているため、クエリは一致するパーティションのみにファン アウトできます。 すべてのデータに対するクエリする必要が *ファンアウト* 複数のパーティションに要求し、結果をマージします。 上位 N 個の結果をフェッチする際など、場合によってはカスタム ロジックを実行して結果をマージすることが必要なクエリもある点に注意してください。

## パーティション マップの管理

パーティション マップを格納する方法、クライアントがそれを読み込み、変更があった場合には更新情報を受け取る方法、さらには複数のクライアントの間でそれを共有する方法について決めておくことも必要です。 パーティション マップの更新が頻繁ではない場合は、単にそれをアプリケーションの構成ファイルに保存することができます。 

それ以外の場合は、任意の永続ストアに保存することができます。 実稼働環境でよく目にする設計パターンは、パーティション マップを JSON としてシリアル化し、それを DocumentDB のコレクション内にも格納するというものです。 クライアントは、再度取得する手間を省くためにマップをキャッシュに格納し、その後は変更がないか定期的にポーリングします。 クライアントがシャード マップを変更する可能性がある場合、そのクライアントが一貫性のある名前付けスキーマを使用しており、また、パーティション マップに対して一貫性のある更新ができるオプティミスティック同時実行制御 (ETag) を使用していることを確認してください。

## パーティションの追加と削除によるデータの拡大縮小

DocumentDB を使用すると、いつでも作成したコレクションを追加し、削除し、それを新しい受信データの格納や既存のコレクション上で利用できるデータの再調整に使用できます。 レビュー、 [制限](documentdb-limits.md) コレクションの数のページです。 このページにある制限を引き上げる場合は、いつでも弊社にお問い合わせください。

範囲パーティション分割での新しいパーティションの追加や削除は単純です。 たとえば、最新データの新しいリージョンや新しい時間範囲を追加するために必要な操作は、パーティション マップに新しいパーティションを追加することだけです。 既存のパーティションを複数のパーティションに分割する、または 2 つのパーティションをマージするには、さらに少しの操作が必要になります。 必要な操作は、次のいずれかです。 

- 読み取りのためにシャードをオフラインにする
- 移行時に、古いパーティション分割構成と新しいパーティション分割構成の両方に読み取りをルーティングする トランザクションおよび整合性レベルの保証は、移行が完了するまで利用できませんので、注意してください。

ハッシュ パーティション分割の場合、パーティションの追加と削除は比較的複雑です。 単純なハッシュ手法はシャッフリングを引き起こし、データの大部分を移動する必要が生じます。 使用して **コンシス テント ハッシュ** ごく一部のデータのみを移動する必要があることを確認します。

比較的簡単にデータの移動を必要とせずに新しいパーティションを追加する「溢れさせ」、データを新しいコレクションには、新旧両方のコレクションに要求をファンアウトし、. ただし、この方法はめったにない状況 (ピーク時のワークロードを溢れさせて、移動できるようになるまでデータを一時的に保持するなど) のみに、その使用を制限する必要があります。

## 次のステップ
この記事では、DocumentDB を使用したデータのパーティション分割の方法に関するいくつかの一般的な手法と、その手法または手法の組み合わせをどのようなときに使用するかについて紹介しました。 

-   次に、これを見て [記事](documentdb-sharding.md) DocumentDB SDK とパーティションの競合回避モジュールを使用してデータをパーティション分割する方法にします。 
-   1 つのダウンロード、 [サポート対象の Sdk](https://msdn.microsoft.com/library/azure/dn781482.aspx)
-   お問い合わせください、 [MSDN のサポート フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=AzureDocumentDB) 質問がある場合。
   


 

