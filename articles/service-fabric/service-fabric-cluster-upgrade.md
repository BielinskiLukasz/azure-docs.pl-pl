<properties
   pageTitle="Service Fabric クラスターのアップグレード | Microsoft Azure"
   description="Service Fabric クラスターを実行しているファブリック コードや構成をアップグレードします。たとえば、証明書のアップグレード、アプリケーション ポートの追加、OS 修正プログラムの適用などを行います。アップグレードを実行しているときに、どのようなことが起きるでしょうか?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/23/2015"
   ms.author="chackdan"/>

# Service Fabric クラスターのアップグレード

Service Fabric クラスターは、お客様が所有するものの、Microsoft が部分的に管理するリソースです。 この記事では、何が自動的に管理され、何をお客様が構成できるかについて説明します。

## 自動的に管理されるクラスター構成

Microsoft は、クラスターで実行されるファブリック コードと構成を保守します。必要に応じて、ソフトウェアへの自動的な監視付きアップグレードを行います。 これらのアップグレードは、コード、構成、またはその両方で行うことができます。 これらのアップグレードによるアプリケーションへの影響がないか最小限であることを確認するために、アップグレードは 3 つのフェーズで行われます。

### フェーズ 1: アップグレードが、すべてのクラスター正常性ポリシーを使用して実行される

このフェーズ中に、アップグレード ドメインが 1 つずつ処理され、クラスターで実行されていたアプリケーションはダウンタイムなしで実行され続けます。 クラスターの正常性ポリシー (ノードの正常性と、クラスターで実行されているすべてのアプリケーションの正常性の組み合わせ) は、アップグレードの実行中、遵守されます。

クラスターの正常性ポリシーが満たされない場合、アップグレードは、ロールバックされます電子メールが送信することは、クラスターのアップグレードをロールバックありましたをで存在する場合、修復アクションを実行しフェーズ 2 別 n 日後に示すサブスクリプションの所有者。 n は、変数です。
インフラの理由のために失敗したアップグレードを除外するさらに数回の同じアップグレードを実行しようとすると、フェーズ 2 に進みますお電子メールが送信された日付から n 日経過後。

クラスターの正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。 このフェーズの最初のアップグレードで成功することも、何回か目の再実行で成功することもあります。 実行が成功した場合、電子メールでの確認はありません。 これは、送信される電子メールが多くなりすぎないようにするためです。電子メールを受信するのは、正常でないことが起きた場合だけです。 ほとんどのクラスターのアップグレードは、アプリケーションの可用性に影響しないと思われます。

カスタムの状態を設定する方法の詳細を参照して、クラスターのポリシー  [クラスターをアップグレードし、正常性パラメーター](service-fabric-cluster-health-parameters.md)します。

### フェーズ 2: アップグレードが、既定の正常性ポリシーだけを使用して実行される

正常性ポリシーは、アップグレードの開始時に正常であったアプリケーションの数が、アップグレード プロセス中も同じ数であり続けるように設定されています。 フェーズ 1 のように、このフェーズ中はアップグレード ドメインが 1 つずつ処理され、クラスターで実行されていたアプリケーションはダウンタイムなしで実行され続けます。 クラスターの正常性ポリシー (ノードの正常性と、クラスターで実行されているすべてのアプリケーションの正常性の組み合わせ) は、アップグレードの実行中、遵守されます。

有効で、クラスターの正常性ポリシーを満たしていない場合、アップグレードは、ロールバックされます電子メールが送信することは、クラスターのアップグレードをロールバックありましたをで存在する場合、修復アクションを実行しフェーズ 3 別 n 日後に示すサブスクリプションの所有者。 n は、変数です。

インフラが原因でアップグレードが失敗したのではないことを確認するために、同じアップグレードが数回試行されます。 リマインダーの電子メールが、n 日の数日前に送信されます。 電子メールの送信日から n 日後に、フェーズ 3 に進みます。 フェーズ 2 で送信された電子メールは、真剣に受け止め、修復操作を実行する必要があります。

クラスターの正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。 このフェーズの最初のアップグレードで成功することも、何回か目の再実行で成功することもあります。 実行が成功した場合、電子メールでの確認はありません。

### フェーズ 3: アップグレードが、アグレッシブな正常性ポリシーを使用して実行される

これらの正常性ポリシーは、アプリケーションの正常性よりもアップグレードの完了のために調整されています。 このフェーズで終了するクラスター アップグレードは、ほとんどありません。 クラスターがこのフェーズで終了する場合は、アプリケーションが正常な状態でなくなったり、可用性が失われたりする確率が高くなります。

他の 2 つのフェーズと同様に、フェーズ 3 でもアップグレード ドメインが 1 つずつ処理されます。

クラスターの有効な正常性ポリシーが満たされない場合は、アップグレードがロールバックされます。インフラが原因で失敗したのではないことを確認するために、同じアップグレードが数回試行され、その後、そのクラスターはサポートやアップグレードを受信しなくなるように固定されます。

この情報を使用電子メールは、修復アクションとサブスクリプションの所有者に送信されます。 フェーズ 3 が失敗した状態にならないすべてのクラスターがされないようにします。

クラスターの正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。 このフェーズの最初のアップグレードで成功することも、何回か目の再実行で成功することもあります。 実行が成功した場合、電子メールでの確認はありません。 .

## お客様が制御するクラスター構成

ライブ クラスターでお客様が変更できる構成は、次のとおりです。

### 証明書

ポータルから、または servicefabric.cluster リソースへの PUT コマンドの発行を通じて、プライマリまたはセカンダリ証明書を簡単に更新できます。

![CertificateUpgrade][CertificateUpgrade]

**注** クラスター リソースを使用する証明書を識別する前に、次の手順を完了している必要があります、それ以外の場合、新しい証明書は使用されません。
1) 新しい証明書を資格情報コンテナーにアップロード - を参照してください [Service Fabric のセキュリティ](service-fabric-cluster-security.md) 手順をそのドキュメントの手順 2 から開始します。
2) 証明書を取得して展開できるように、クラスターを構成するすべての仮想マシンを更新します。 参照してください [このブログの投稿](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx) を説明します。

### アプリケーション ポート

ノードの種類に関連付けられているロード バランサーのリソース プロパティを変更することで、これを行うことができます。 ポータルまたは ARM PowerShell を直接使用することができます。

ノード タイプ内のすべての VM の新しいポートを開くには、以下の操作を行う必要があります。

1. **適切なロード バランサーに新しいプローブを追加する**

    ポータルを使用して、クラスターをデプロイした場合、ノード タイプごとのロード バランサーの名前は "loadBalancer-0"、"loadBalancer-1" のようになります。 ロード バランサー名はリソース グループ (RG) 内でのみ一意であるため、検索は特定の RG の下で行うことをお勧めします。

    ![AddingProbes][AddingProbes]


2. **ロード バランサーに新しい規則を追加する**

    同じロード バランサーに、前の手順で作成したプローブを使用して、新しい規則を追加します。

    ![AddingLBRules][AddingLBRules]


### 配置プロパティ

  ノードの種類ごとに、アプリケーションで使用するカスタム配置プロパティを追加できます。 NodeType は、明示的に追加せずに使用できる、既定のプロパティです。

  >[AZURE.NOTE] 配置プロパティの使用方法の詳細についてを参照してください [配置制約ドキュメント](service-fabric-placement-constraint.md)します。

### 容量メトリック

ノードの種類ごとに、アプリケーションで負荷をレポートするために使用するカスタム容量メトリックを追加できます。 負荷を報告するに対して容量メトリックの使用方法の詳細についてを参照してください [動的な負荷レポートの概要](service-fabric-resource-balancer-dynamic-load-reporting.md)します。

### クラスターを構成する Virtual Machines への OS 修正プログラムの適用
これは、準備中の機能です。 現在の Vm のパッチを適用する責任があります。 時に 1 つ以上の VM を実行しないように、時に、この 1 つの VM を行う必要があります。

### クラスターを構成する Virtual Machines での新しい OS へのアップグレード
使用している OS イメージをアップグレードする必要がある場合は、一度に 1 つずつの VM で、お客様自身がアップグレードを行う必要があります。 現時点では、自動化はできません。


## 次のステップ

- 学習方法 [、クラスターのスケール アップ/ダウン](service-fabric-cluster-scale-up-down.md)
- について学習 [アプリケーションのアップグレード](service-fabric-application-upgrade.md)

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes.png
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png

