<properties
   pageTitle="プロアクティブ メトリック パッキング"
   description="リソース バランサーでのプロアクティブ メトリック パッキングの概要"
   services="service-fabric"
   documentationCenter=".net"
   authors="GaugeField"
   manager="timlt"
   editor=""/>

<tags
   ms.service="Service-Fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="09/03/2015"
   ms.author="masnider"/>

# プロアクティブ メトリック パッキング

Service Fabric リソース バランサーの一般的な構成では、すべてのノードのすべてのメトリックで、メトリックあたりの使用率が等しい状態を実現しようとします。 また、リソース バランサーは、新しいサービス要求を受信したときにサービスのための場所を探します。 新しいサービスのレプリカ (サービスのすべてのパーティションの、すべてのレプリカ) を配置するために十分な空き領域がない場合、リソース バランサーは既存のワークロードを移動することによって領域を作成しようとします。 これは完全に正常な処理ですが、クラスターの使用率とワークロードの断片化のレベルによって、処理に時間がかかることがあります。

たとえば、クラスターの利用率が適正な場合に、既定ロードが大きい (1 つ以上のメトリックでの最大ノード容量など) 新しいサービスを追加しようとすると、新しいサービスを配置するためにリソース バランサーで多数のレプリカの移動が必要になることがあります。 また、サービスがステートフルかつ大規模な場合、データをコピーする必要があるため、必要な移動の実行めに一定の時間を要することがあります。 この両方の要因によって、サービスの新規作成にかかる時間が長くなる可能性があります。 一般的にサービスは、不定期に発生する長い作成時間を許容できるようになっていますが、一部のワークロードは許容範囲が狭く、作成時間をできるだけ短くする必要があります。つまり、安定した状態のリソース バランサーは、新しいワークロードに対して使用可能な領域を十分に確保できる可能性を高めるために、クラスターが "最適化" されていることを確認する必要があります。

プロアクティブ メトリック パッキング (ルール サブタイプ) 最適化) メカニズムは、リソース バランサーの分散、少数のノードにワークロードをパックして、サービスの作成時間を最小限に抑えることが目標のフェーズではなく分散中の配布の一部として実行されます。 メトリックが最適化の対象として構成されている場合、リソース バランサーの目標は、分散に使用される最小平均標準偏差ではなく、最大平均標準偏差を実現することです。

最大偏差では、一部のノードにできるだけ多くのサービスを配置して、できるだけ多くのノードを空に維持します。 さらに、新規サービス配置に関する基本制約の 1 つとして、レプリカは同一のアップグレード ドメインまたは障害ドメインに存在できません。 新規サービスをすばやく追加できることが目標であるため、リソース バランサーは、アップグレード ドメインと障害ドメイン全体での負荷分散の標準偏差 (アップグレード ドメインまたは障害ドメインごとのサービス ロードの合計) が最小限になるようにする必要があります。 結果は、アップグレード ドメインまたは障害ドメインごとの空き領域の量と同じです。 最適化では、アフィニティ、配置の制約、ノード メトリック容量など、システム内のその他すべての制約も考慮されます。

## リソース バランサー クラスターの構成
クラスター マニフェスト内で、次の複数のさまざまな構成値は、リソース バランサーのメトリック パッキング機能の全体的な動作を定義します。

### DefragmentationMetrics – リソース バランサーでプロアクティブ パッキングと最適化を考慮する必要があるメトリックです。

構成されているすべてのメトリック (アクティビティおよび分散しきい値リストなど) がこの一覧で指定されている必要があります。 メトリックが値 "true" を使用して指定されている場合は最適化メトリックとして処理されますが、値 "false" が使用されている場合 (またはこの一覧に指定されていない場合)、最適化の対象として考慮されません。

``` xml
<FabricSettings>
  <Section Name="DefragmentationMetrics">
    <Parameter Name="MetricName1" Value="true"/>
    <Parameter Name="MetricName2" Value="false"/>
  </Section>
</FabricSettings>
```

### 分散しきい値

分散しきい値は、特定のメトリックに関して、リソース バランサーによる (メトリック パッキング ロジックを実行する) 分散フェーズの実行が必要になるクラスターのバランス悪化の程度を指定します。 メトリックが最適化メトリックと見なされる場合、分散しきい値は、アップグレードまたは障害ドメインごとに存在することが許可される、使用率が最大限のノードと最小限のノードとの割合の最小率です。この率を超えるとリソース バランサーはクラスターで最適化を実行します。 アップグレードまたは障害ドメインでこの率がしきい値を下回ると、最適化フェーズが開始されます。

次の図は、あるメトリックの分散しきい値が 10 である場合の 2 つの例を示します。

![分散しきい値][Image1]

この例で、ノードの「使用率」では、ノードの容量によって決定されるノードのサイズを考慮に入れず、指定したメトリックのノードに関して現在レポートされている絶対的な使用量のみを考慮に入れることに注意してください。

メトリックが指定されていない場合、既定値は 1 です。 その場合は、クラスターのすべてのアップグレード ドメインとすべての障害ドメインに空のノードが少なくとも 1 つできるまで、最適化が実行されます。

値 0 は、メトリックが最適化の対象であるかどうかにかかわらず、分散フェーズでこのメトリックを考慮に入れないことを意味します。

コード例は、メトリックの分散しきい値が、クラスター マニフェスト内の FabricSettings 要素を使用して、メトリックごとに構成されていることを示しています。

``` xml
<FabricSettings>
  <Section Name="MetricBalancingThresholds">
    <Parameter Name="MetricName" Value="10"/>
  </Section>
</FabricSettings>
```

<!--Every topic should have next steps and links to the next logical set of content to keep the customer engaged-->
## 次のステップ

詳細については: [リソース バランサーのアーキテクチャ](service-fabric-resource-balancer-architecture.md)

[Image1]: media/service-fabric-resource-balancer-proactive-metric-packing/PMP.png
 
