<properties 
   pageTitle="障害と災害に対する Service Bus アプリケーションの保護 | Microsoft Azure"
   description="発生する可能性がある Service Bus の障害からアプリケーションを保護するために使用できる手法について説明します。"
   services="service-bus"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="tysonn" /> 
<tags 
   ms.service="service-bus"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="09/18/2015"
   ms.author="sethm" />

# Service Bus の障害および災害に対するアプリケーションの保護のベスト プラクティス

ミッション クリティカルなアプリケーションは、予期しない障害や災害が発生した場合でも継続して稼働する必要があります。 このトピックでは、発生する可能性がある Service Bus の障害や災害からアプリケーションを保護するために使用できる手法について説明します。

障害とは、Azure Service Bus が一時的に利用できなくなることです。 障害によって、メッセージング ストアなどの Service Bus の一部のコンポーネント、さらにはデータセンター全体に影響が及ぶ場合があります。 問題が解決されると、Service Bus は再び利用可能になります。 通常、障害によってメッセージなどのデータが失われることはありません。 コンポーネントのエラーの例としては、特定のメッセージング ストアが利用できなくなることが挙げられます。 データセンター全体の障害の例としては、データセンターの電源障害や、データセンターのネットワーク スイッチの障害などがあります。 障害は、数分間から数日間続く場合があります。

災害とは、Service Bus のスケール ユニットまたはデータセンターが永続的に失われることです。 データセンターは、再び利用可能になる場合も、ならない場合もあります。 通常、災害によってメッセージなどのデータの一部またはすべてが失われます。 災害の例としては、火災、洪水、地震があります。

## 現在のアーキテクチャ

Service Bus では、複数のメッセージング ストアを使用して、キューまたはトピックに送信されたメッセージを格納します。 パーティション分割されていないキューまたはトピックは 1 つのメッセージング ストアに割り当てられます。 このメッセージング ストアを使用できない場合、そのキューまたはトピックに対するすべての操作が失敗します。

Service Bus のメッセージング エンティティ (キュー、トピック、リレー) はすべて、データセンターと連携する 1 つのサービスの名前空間に存在します。 Service Bus では、データの自動 geo レプリケーションを有効にすることや、サービスの名前空間が複数のデータセンターにまたがることを許可していません。

## ACS の障害に対する保護

ACS の資格情報を使用している場合に ACS を使用できなくなると、クライアントはトークンを取得できなくなります。 ACS が停止した時点でトークンを取得済みのクライアントは、トークンの期限が切れるまで引き続き Service Bus を使用できます。 トークンの既定の有効期間は 3 時間です。

ACS の障害から保護するには、Shared Access Signature (SAS) トークンを使用します。 この場合、クライアントはシークレット キー付きの自主生成したトークンに署名することで、Service Bus に対して直接認証します。 ACS の呼び出しは必要ありません。 SAS トークンの詳細については、次を参照してください。 [Service Bus 認証][]します。

## メッセージング ストアのエラーからキューおよびトピックを保護する

パーティション分割されていないキューまたはトピックは 1 つのメッセージング ストアに割り当てられます。 このメッセージング ストアを使用できない場合、そのキューまたはトピックに対するすべての操作が失敗します。 一方、パーティション分割されたキューは複数のフラグメントで構成されます。 各フラグメントは異なるメッセージング ストアに格納されます。 パーティション分割されたキューまたはトピックにメッセージが送信されると、Service Bus はそのメッセージをいずれかのフラグメントに割り当てます。 対応するメッセージング ストアを使用できない場合は、可能であれば Service Bus はメッセージを別のフラグメントに書き込みます。 パーティション分割されたエンティティの詳細については、次を参照してください。 [メッセージング エンティティのパーティション分割][]します。

## データセンターの障害や災害から保護する

2 つのデータセンター間でのフェールオーバーを可能にするために、各データセンターに 1 つの Service Bus サービスの名前空間を作成できます。 Service Bus サービス名前空間など **>contosoprimary.servicebus.windows.net** 米国 (北/中央) 地域に配置することがあり、 **contosoSecondary.servicebus.windows.net** 米国 (南部/中央) 地域に配置することがあります。 データセンターの障害発生時にも Service Bus メッセージング エンティティにアクセスできる状態を維持する必要がある場合、両方の名前空間内にそのエンティティを作成します。

詳細については、「Azure データ センター内の Service Bus のエラー」セクションを参照してください。 [非同期メッセージング パターンと高可用性][]します。

## データセンターの障害や災害からリレー エンドポイントを保護する

リレー エンドポイントの geo レプリケーションにより、Service Bus 障害発生時にリレー エンドポイントを公開するサービスにアクセスできるようになります。 geo レプリケーションを実現するには、異なる名前空間内に 2 つのリレー エンドポイントを作成する必要があります。 これらの名前空間が異なるデータセンターに存在し、2 つのエンドポイントに異なる名前が付けられている必要があります。 たとえば、プライマリ エンドポイントに到達できる **contosoPrimary.servicebus.windows.net/myPrimaryService**, 、セカンダリ側は、下にある到達できる一方、 **contosoSecondary.servicebus.windows.net/mySecondaryService**します。

その後、サービスは、両方のエンドポイント上でリッスンし、クライアントはどちらかのエンドポイントを介してサービスを呼び出すことができます。 クライアント アプリケーションは、いずれかのリレー エンドポイントをプライマリ エンドポイントとしてランダムに選択して、アクティブなエンドポイントに要求を送信します。 操作が失敗してエラー コードが表示された場合、このエラーは、リレー エンドポイントを使用できないことを示します。 アプリケーションは、バックアップ エンドポイントへのチャネルを開き、要求を再び発行します。 この時点で、アクティブなエンドポイントとバックアップ エンドポイントの役割が切り替わります。クライアント アプリケーションは、前のアクティブなエンドポイントを新しいバックアップ エンドポイントと見なし、前のバックアップ エンドポイントを新しいアクティブなエンドポイントと見なします。 両方の送信操作が失敗した場合、2 つのエンティティの役割は変更されず、エラーが返されます。

 [Service Bus リレー メッセージを使用した Geo レプリケーション][] サンプル リレーをレプリケートする方法を示します。

## データセンターの障害や災害からキューおよびトピックを保護する

仲介型メッセージングを使用する場合をデータ センターの障害に対する回復力を実現するのには、Service Bus は、2 つのアプローチをサポートしています: *active* と *パッシブ* レプリケーション。 どちらの方法でも、データセンターの障害時に特定のキューまたはトピックにアクセスできる状態を維持する必要がある場合は、両方の名前空間にそのキューまたはトピックを作成します。 両方のエンティティに同じ名前を付けることができます。 たとえば、プライマリ キューに到達できる **contosoPrimary.servicebus.windows.net/myQueue**, 、セカンダリ側は、下にある到達できる一方、 **contosoSecondary.servicebus.windows.net/myQueue**します。

アプリケーションが、送信側から受信側への永続的な通信を必要としない場合、アプリケーションで永続的なクライアント側キューを実装することで、メッセージの消失を防止し、送信側を一時的な Service Bus エラーから保護できます。

## アクティブ レプリケーション

アクティブ レプリケーションでは、すべての操作で両方のサービスの名前空間のエンティティを使用します。 メッセージを送信するクライアントはすべて、同じメッセージのコピーを 2 つ送信します。 最初のコピーがプライマリ エンティティに送信 (たとえば、 **contosoPrimary.servicebus.windows.net/sales**)、セカンダリ エンティティに送信されることは、メッセージの 2 番目のコピー (たとえば、 **contosoSecondary.servicebus.windows.net/sales**)。

クライアントは両方のキューからメッセージを受信します。 受信側はメッセージの 1 つ目のコピーを処理し、2 つ目のコピーは抑制されます。 重複したメッセージを抑制するには、送信側が各メッセージに一意の識別子のタグを付ける必要があります。 メッセージのコピーには、両方とも同じ識別子のタグを付ける必要があります。 使用することができます、 [BrokeredMessage.MessageId][] または [BrokeredMessage.Label][] プロパティ、またはメッセージのタグを付けるためのカスタム プロパティ。 受信側は、既に受信したメッセージの一覧を保持する必要があります。

 [Service Bus の仲介型メッセージを使用した Geo レプリケーション][] サンプルではメッセージング エンティティのアクティブなレプリケーション。

> [AZURE.NOTE] アクティブ レプリケーションの手法には、操作の数が 2 倍に、そのためこのアプローチはコストの増加にもたらすことができます。

## パッシブ レプリケーション

障害のない場合は、パッシブ レプリケーションは 2 つのメッセージング エンティティのうち 1 つのみを使用します。 クライアントは、アクティブなエンティティにメッセージを送信します。 アクティブなエンティティでの操作が失敗し、アクティブなエンティティをホストしているデータセンターが使用できない可能性があることを示すエラー コードが表示された場合、クライアントはメッセージのコピーをバックアップ エンティティに送信します。 この時点で、アクティブなエンティティとバックアップ エンティティの役割が切り替わります。送信側クライアントは、前のアクティブなエンティティを新しいバックアップ エンティティと見なし、前のバックアップ エンティティを新しいアクティブなエンティティと見なします。 両方の送信操作が失敗した場合、2 つのエンティティの役割は変更されず、エラーが返されます。

クライアントは両方のキューからメッセージを受信します。 受信側は同じメッセージのコピーを 2 つ受信する可能性があるので、受信側では重複したメッセージを抑制する必要があります。 アクティブ レプリケーションの説明と同じ方法で重複を抑制することができます。

一般的に、パッシブ レプリケーションではほとんどの場合に操作が 1 つだけ実行されるので、アクティブ レプリケーションよりも経済的です。 遅延、スループット、および金銭的コストは、レプリケーションなしのシナリオと同じです。

パッシブ レプリケーションを使用する場合、次のシナリオではメッセージを喪失したり 2 回受信したりする可能性があります。

-   **メッセージの遅延または喪失**: プライマリ キューに正常に送信されるメッセージ m1 送信者と、キューは使用できなくなり、受信側が m1 を受信する前に仮定します。 送信側が後続のメッセージ m2 をセカンダリ キューに送信します。 プライマリ キューが一時的に使用できない場合、受信側はキューが再び使用可能になった後で m1 を受信します。 災害の場合、受信側は m1 をまったく受信できない可能性があります。

-   **重複した受信**: 送信者がプライマリ キューにメッセージの m を送信することを前提としています。 Service Bus により m が適切に処理されますが、応答の送信に失敗します。 送信操作がタイムアウトになった後で、送信側が m の同一のコピーをセカンダリ キューに送信します。 プライマリ キューが使用不可になる前に受信側が m の 1 つ目のコピーを受信できる場合、受信側は m の両方のコピーをほぼ同時に受信します。 プライマリ キューが使用不可になる前に受信側が m の 1 つ目のコピーを受信できない場合、受信側は m の 2 つ目のコピーのみを最初に受信しますが、プライマリ キューが使用可能になったときに m の 1 つ目のコピーを受信します。

 [Service Bus の仲介型メッセージを使用した Geo レプリケーション][] サンプルではメッセージング エンティティのパッシブ レプリケーション。

## 永続的なクライアント側キュー

アプリケーションで Service Bus エンティティが使用不可になることは許容できるが、メッセージを失うことは許容できない場合、送信側は、Service Bus に送信できないすべてのメッセージをローカルに格納する永続的なクライアント側キューを使用できます。 Service Bus エンティティが再び使用可能になると、バッファー内のすべてのメッセージがそのエンティティに送信されます。  [持続性のあるメッセージの送信者][] サンプルは、MSMQ のヘルプのようなキューを実装します。 代わりに、メッセージをローカル ディスクに書き込むこともできます。

永続的なクライアント側キューではメッセージの順序が保持され、Service Bus エンティティが使用できない場合の例外からクライアント アプリケーションを保護します。 永続的なクライアント側キューは、単純なトランザクションや分散トランザクションと共に使用できます。

## 次のステップ

障害復旧の詳細については、次の記事を参照してください。

- [Azure SQL Database のビジネス継続性][]
- [Azure のビジネス継続性テクニカル ガイダンス][]

  [Service Bus Authentication]: service-bus-authentication-and-authorization.md
  [Partitioning Messaging Entities]: service-bus-partitioning.md
  [Asynchronous Messaging Patterns and High Availability]: https://msdn.microsoft.com/library/azure/dn292562.aspx
  [Geo-replication with Service Bus Relayed Messages]: http://code.msdn.microsoft.com/Geo-replication-with-16dbfecd
  [BrokeredMessage.MessageId]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.messageid.aspx
  [BrokeredMessage.Label]: https://msdn.microsoft.com/library/azure/microsoft.servicebus.messaging.brokeredmessage.label.aspx
  [Geo-replication with Service Bus Brokered Messages]: http://code.msdn.microsoft.com/Geo-replication-with-f5688664
  [Durable Message Sender]: http://code.msdn.microsoft.com/Service-Bus-Durable-Sender-0763230d
  [Azure SQL Database Business Continuity]: https://msdn.microsoft.com/library/azure/hh852669.aspx
  [Azure Business Continuity Technical Guidance]: https://msdn.microsoft.com/library/azure/hh873027.aspx

