<properties
   pageTitle="SQL Data Warehouse | Microsoft Azure でのハッシュ分散と、クエリ パフォーマンスに与える影響"
   description="ソリューションの開発のための Azure SQL Data Warehouse での分散ハッシュ テーブルと、それがクエリ パフォーマンスに与える影響について学習してください。"
   services="sql-data-warehouse"
   documentationCenter="NA"
   authors="jrowlandjones"
   manager="barbkess"
   editor=""/>

<tags
   ms.service="sql-data-warehouse"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="data-services"
   ms.date="09/22/2015"
   ms.author="JRJ@BigBangData.co.uk;barbkess"/>

# SQL Data Warehouse でのハッシュ分散と、クエリ パフォーマンスに与える影響

スマートなハッシュ分散の決定は、クエリ パフォーマンスを向上させるための最も重要な方法の 1 つです。  

実際には、次の 3 つの主な要因があります。

1. データ移動を最小化
2. データ スキューを回避
3. バランスの取れた実行を提供

## データの移動を最小化
データ移動は、テーブルが結合される、またはテーブルでの集計が実行されるときに最もよく起こります。 共有キー上のハッシュ分散テーブルは、この移動を最小化するための最も効果的な方法の 1 つです。

ただし、ハッシュ分散が、移動の最小化で効果的になるには、次の条件がすべて true でなければなりません。

1. 両方のテーブルが、ハッシュ分散され、共有分散 キー上で結合される必要があります。
2. 両方の列のデータ型を一致させる必要があります。
3. 結合する列は等価結合 (たとえば、左テーブルの列の値が、右テーブルの列の値と等しくなる必要がある) でなければなりません。
4. 結合は **いない** 、 `CROSS JOIN`

> [AZURE.NOTE] 使用される列 `JOIN`, 、`GROUP BY`, 、`DISTINCT` と `HAVING` 句の適切なハッシュ列の候補のすべてを作成します。 内の手の形の列に、 `WHERE` 句 **いない** 良好なハッシュ列の候補を作成します。 バランスの取れた実行についてのセクションは、以下を参照してください。

ハッシュ分散キーを含まない列を使用すると、データ移動が、クエリ構文 (`COUNT DISTINCT` と `OVER` 句は共に優れた例) から起こる場合もあります。

> [AZURE.NOTE] ラウンド ロビン テーブルは、通常、データの移動を生成します。 非確定的な形で、テーブル内のデータが割り当てられてしまうため、ほとんどのクエリが完了する前に、最初にデータを移動する必要があります。

## データ スキューを回避
ハッシュ配布が有効的になるには、選択した列が以下のプロパティを示すことが重要です。

1. 列には、かなり多くの値が含まれています。
2. 列が低下しない **データ スキュー**します。

それぞれの値が分散に割り当てられます。 その結果、一意のハッシュ値が生成されるよう、データは妥当な数の値を必要とします。 そうしなければ、不具合なハッシュを取得することになります。 たとえば、分散の数が、値の数を超える場合は、一部の分散が空のままになります。 これは、パフォーマンスの低下を招きます。

同様に、すべてのハッシュされた列の行に同じ値が含まれている場合、データと呼ばれます **傾斜**します。 この極端な例として、1 つのハッシュ値だけが作成されると、結果的に、1 つの分散内のすべての行にその値が入ります。 理想的には、ハッシュされた列の個々の値には、同じ数の行があります。

> [AZURE.NOTE] ラウンド ロビン テーブルでは、スキューの兆候は発生しません。 これは、データが分散の間で均等に格納されるためです。

## バランスの取れた実行を提供
各分散が、同じ量の作業を実行するときに、バランスの取れた実行が実現されます。 超並列処理 (MPP) は、チーム ゲームです。すべてのユーザーは、誰かが勝利者と宣言される前に、ゴールラインを越えなければなりません。 すべての分散が同じ量の作業 (つまり、データ処理) をする場合、クエリのすべては、ほぼ同じ時刻に終了します。 これは、バランスの取れた実行と呼ばれます。

お分かりのように、データ　スキューはバランスの取れた実行に影響します。 また、ハッシュ分散キーの選択も同様です。 クエリの `WHERE` 句で表示される列を選択した場合、クエリのバランスが崩れる可能性があります。  

> [AZURE.NOTE]  `WHERE` 句通常により、最適にパーティション分割に使用される列を識別します。

`WHERE` 句で表示される列の良好な例は、日付 フィールドになります。  日付フィールドは、優れたパーティション分割の列の典型的な例ですが、不具合のあるハッシュ 分散列となることがあります。 通常、データ ウェアハウスのクエリは、日、週や月などの指定した期間です。 日付によるハッシュ分散は、実際にスケーラビリティの制限し、パフォーマンスが低下する恐れがあります。 たとえば、指定した日付範囲が、1 週間、つまり 7 日とすれば、ハッシュの最大数は 7 となり、 1 日につき 1 になります。 これは、分散の 7 つだけデータが含まれていることを意味します。 残りの分散には、データは入っていません。 これは、 7 つの分散のみがデータを処理するので、バランスの取れていないクエリ実行を招きます。

> [AZURE.NOTE] ラウンド ロビン テーブルは、通常、バランスの取れた実行を提供します。 これは、データが分散の間で均等に格納されるためです。

## 推奨事項
パフォーマンスと全体的なクエリ スループットを最大化するには、可能な限り、分散ハッシュ テーブルを次のパターンに従うようにします。

ハッシュ分散キー:

1. クエリで `JOIN`、`GROUP BY`、`DISTINCT`、または `HAVING` 句を使用しているか。
2. `WHERE` 句は使用していないか。
3. 多数の異なる値は、少なくとも、1000 個あるか。
4. 少数の分散にハッシュされる多数の行を不釣合いに持っていないか。
5. NOT NULL と定義されていないか。 NULL 行は 1 つの分散内に集中します。

## 概要

ハッシュ分散は、次のように要約できます。

- ハッシュ関数は決定性があります。 同じ値は、常に、同じ分散に割り当てられます。
- 1 つの列は、分散列として使用されます。 ハッシュ関数は、指名された列を使用して、分散への行割り当てを計算します。
- ハッシュ関数は、それ自身の値ではなく、列の型に基づきます。
- テーブルをハッシュ分散すると、スキューされたテーブルになる場合があります。
- ハッシュ分散テーブルは、一般的に、クエリを解決する際にデータ移動が少なくてすむので、大規模なファクト テーブルのクエリのパフォーマンスが向上します。
- クエリのスループットを向上させる分散ハッシュ列の選択に関する推奨事項を順守します。

> [AZURE.NOTE] SQL Data Warehouse のデータ型の整合性が重要です。 既存のスキーマが一貫して列に同じ型を使用しているか確認します。 これは、分散キーにとって特に重要です。 配布キーのデータ型が同期されないままテーブルが結合されると、不要なデータ移動が発生します。 これは、テーブルが大きく、スループットの低下とパフォーマンスになる場合コストがかかるです。


## 次のステップ
他の開発のヒントについては、[開発の概要に関するページを参照してください。

<!--Image references-->

<!--Article references-->
[development overview]: sql-data-warehouse-overview-develop.md

<!--MSDN references-->

<!--Other Web references-->

