<properties
   pageTitle="Testability の概要 |Microsoft Azure"
   description="この記事では、Microsoft Azure Service Fabric の Testability 機能について説明します。これはサービスに対して障害を誘導し、テスト シナリオを実行するものです。"
   services="service-fabric"
   documentationCenter=".net"
   authors="rishirsinha"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA"
   ms.date="07/13/2015"
   ms.author="rsinha"/>

# Testability の概要

Testability は、Microsoft Azure Service Fabric で構築したサービスのテスト専用に設計されたツール スイートです。 このツールを使用すると、開発者は検証意義のあるエラーを容易に誘発してテスト シナリオを実行することができ、サービスがその有効期間内に直面する可能性のあるさまざまな状態と遷移を、完全に管理下にある安全な方法で、試行および検証することが可能です。

Tesability には、それを実現できるアクションとシナリオが用意されています。 アクションは、サービスをテストするための、そのサービスを対象にした個別のエラーです。  サービス開発者は、複雑なシナリオを記述するための構成要素としてアクションを使用できます。 次に例を示します。

  + ノードを再起動して、コンピューターまたは VM がリブートされた任意の数の状況をシミュレートします。
  + ステートフル サービスのレプリカを移動して、負荷分散、フェールオーバー、またはアプリケーションのアップグレードをシミュレートします。
  + ステートフル サービスでのクォーラムの損失を発生させ、新しいデータを受け入れるための十分な "バックアップ" または "セカンダリ" レプリカがないことが原因で書き込み操作を続行できない、という状況を作ります。
  + ステートフル サービスでのデータ損失を発生させ、すべてのインメモリ状態が完全に消去された状況を作ります。

シナリオは、1 つ以上のアクションで構成された完全なテストです。アクションの実体は PowerShell コマンドと C# の関数であり、任意の形態または形式を取ることができます。たとえば、実行時間の長いサービスや、PowerShell コマンド、コマンド ライン アプリケーションなどです。 Testability には、すぐに使用できる 2 つのシナリオが用意されています。

  + 混乱のテスト
  + フェールオーバー テスト

Testability 用に PowerShell と C# の両方の API が公開されています。 これにより、サービス開発者は PowerShell スクリプト作成における俊敏性が向上し、必要なときに必要な方法で、より詳細に C# API を制御できます。

## Testability の重要性

Service Fabric を使用すると、スケーラブルな分散アプリケーションを作成する作業が大幅に簡単になります。 Service Fabric の Testability コンポーネントは、分散アプリケーションの作成とテストを同様に簡単にすることを目的としています。 テスト時に解決する必要がある 3 つの主な問題があります。

1. 実際のシナリオで発生する可能性のあるエラーのシミュレート/生成: Service Fabric の重要な側面の 1 つに、分散アプリケーションをさまざまなエラーから回復できることがあります。 しかし、アプリケーションがこれらの障害から回復できることをテストするためには、制御されたテスト環境でこのような実際のエラーをシミュレート/生成するメカニズムが必要です。
2. 関連したエラーを生成する機能: ネットワーク エラーのようなシステムの基本的なエラーの中で、コンピューターの障害を個別に生成することは簡単です。 個々のエラーの相互作業の結果として実際に発生する可能性がある無数のシナリオを生成することは、容易ではありません。
3. 開発とデプロイメントのさまざまなレベルでのエクスペリエンスの統合: さまざまな種類のエラーを生成する機能を備えた多くのフォールト インジェクション システムがあります。 ただし、1 台のコンピューターの開発者シナリオから同じテストを大規模なテスト環境に移行し、運用環境でのテストに使用する場合、すべてを統合したエクスペリエンスに不整合が生じます。

システムで必要な保証 - 運用環境のクラスターでテストする 1 つのボックス開発者環境からも同様で、上記の問題を解決するために多くのメカニズムがあるときにありません。 Testability コンポーネントを使用すると、アプリケーション開発者はビジネス ロジックのテストに集中できます。 Testability は、基盤となる分散システムでサービスの相互作用をテストするために必要な、すべての機能を提供します。

### 実際のエラー シナリオのシミュレート/生成
障害に対する分散システムの堅牢性をテストするためには、エラーを生成するメカニズムが必要です。 理論上、ノード停止のような障害の生成は簡単なように見えますが、同じ一貫性の問題が発生するようになります。その問題を解決しようとするのが Service Fabric です。 たとえば、ノードをシャットダウンする場合、次のようなワークフローが必要です。

1. クライアントからノードのシャットダウン要求を発行します。
2. 適切なノードに要求を送信します。
    1. ノードが見つからない場合、エラーが発生します。
    2. ノードが見つかった場合、ノードがシャットダウンされた場合にのみ要求が完了します。

テストの観点からは、このエラーが誘発されたとき、エラーを検証するためにエラーが実際に発生したことを知る必要があります。 Windows Fabric が提供する保証では、ノードはコマンドがノードにアクセスした時点で停止するか、それ以前に停止しています。 どちらの場合も、テストで状態の原因を正しく把握し、検証で正常に終了または失敗する必要があります。 Service Fabric の外部で実装された、同じ一連のエラーを処理するシステムでは、ネットワーク、ハードウェア、ソフトウェアの問題が多数発生する可能性があり、その結果、上記のような保証を提供できなくなります。 前に説明した問題が存在する場合、Service Fabric はクラスターの状態を再構成して問題を回避します。そのため、Testability は変わらずに正しい一連の保証を提供できます。

### 必要なイベントとシナリオの生成
現実的なエラーを一貫してシミュレートすることは容易ではありませんが、関連したエラーを生成することは、さらに難しい処理です。 たとえば、次のような場合、永続化されたステートフル サービスでデータの損失が発生します。

1. レプリカの書き込みクォーラムだけがレプリケーションで同期された場合。 すべてのセカンダリ レプリカでプライマリに対する遅延が発生している場合。
2. (コード パッケージまたはノードの停止が原因で) レプリカが停止し、そのために書き込みクォーラムが停止した場合。
3. (ディスクの破損またはコンピューターの再イメージ化が原因で) レプリカのデータが失われ、そのために書き込みクォーラムを回復できない場合。

これらの関連エラーは、現実の世界で (個別エラーほど頻繁ではないにしろ) 確かに発生します。 このようなシナリオを運用環境で発生する前にテストすることが重要です。 多くの制御可能な状況 (のすべてのエンジニアに取りかかれる態勢に今日の中央) に実稼働ワークロードでこれらをシミュレートする機能は 2時 00分に実稼働環境で初めての発生しているよりも、です。 m. 午前中です。

### 異なる環境にまたがる統合されたエクスペリエンス
従来は、開発環境、テスト環境、運用環境用に 3 つの異なるエクスペリエンスのセットを作成するのが普通でした。 モデルは次のようなものでした。

1. 開発環境で、個々のメソッドの単体テストを可能にする状態遷移を生成します。
2. テスト環境でエラーを生成し、さまざまなエラー シナリオを適用してエンド ツー エンドのテストを実行します。
3. 運用環境をエラーのない状態に維持し、不自然なエラーを許容せず、障害に対してきわめて迅速に人間が対応できるようにします。

Service Fabric では、Testability のモジュールとサービスを通して、開発者環境から運用環境まで同じ方法を使用するように変える提案をしています。 これを実現する方法は 2 つあります。
1. 制御されたエラーを生成するために、1 台のコンピューターの環境から実稼働クラスターに至るまで、すべての過程で Testability API を使用します。
2. エラー自動生成の要因をクラスターに渡すために、Testability サービスを使用して自動エラーを生成します。 構成を通してエラーの割合を制御すると、同じサービスを異なる環境で、異なる方法でテストすることができます。

Service Fabric を使用すると、異なる環境でエラーの規模が異なっても、実際のメカニズムは同一になります。 これにより、コードからデプロイメントまでの経路が大幅に短縮され、現実的な負荷のもとでサービスをテストすることができます。

## Testability の使用
### C での Testability の使用# 
Testability のさまざまな機能は、System.Fabric.Testability.dll に含まれています。 この dll は、Microsoft.ServiceFabric.Testability.nupack という nuget パッケージ内にあります。 Testability の機能を使用するためには、nuget パッケージをプロジェクトの参照先としてインクルードする必要があります。

## PowerShell での Testability の使用
Testability PowerShell を使用するには、ランタイム MSI がインストールされている必要があります。 MSI がインストールされると、ServiceFabricTestability PowerShell モジュールが自動的に読み込まれます (開発者が使用するため)。

## まとめ
真のクラウド スケール サービスを作成するには、サービスをデプロイする前の実稼働デプロイメント中に、サービスが現実的なエラーに対処できるかどうかを確認できることがきわめて重要です。 また、サービスが主流の今日の世界において、短期間で手法を刷新し、コードを実稼働に移すことが、きわめて重要です。 Service Fabric の Testability 機能を使用すると、サービス開発者は上記の作業を正確に実施できます。

## 次のステップ

- [Testability アクション](service-fabric-testability-actions.md)
- [Testability のシナリオ](service-fabric-testability-actions.md)
- サービスをテストする方法
    - [サービス ワークロード中のエラーのシミュレーション](service-fabric-testability-workload-tests.md)
   - [サービス間の通信障害](service-fabric-testability-scenarios-service-communication.md)

 


