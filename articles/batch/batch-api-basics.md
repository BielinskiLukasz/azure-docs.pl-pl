<properties
    pageTitle="Azure Batch 機能の概要 | Microsoft Azure"
    description="開発の観点から、Batch サービスとその API の機能について説明します。"
    services="batch"
    documentationCenter=".net"
    authors="yidingzhou"
    manager="timlt"
    editor=""/>

<tags
    ms.service="batch"
    ms.devlang="multiple"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="big-compute"
    ms.date="11/19/2015"
    ms.author="yidingz;v-marsma"/>

# Azure Batch 機能の概要

この記事では、Azure Batch サービスのコア API 機能の基本的な概要について説明します。 使用して、分散コンピューティング ソリューションを開発するかどうか、 [バッチ REST][batch_rest_api] または [バッチ .NET][batch_net_api] Api、使用するさまざまなエンティティと機能を後で説明します。

> [AZURE.TIP] 高いレベルの技術的概要、バッチ、次を参照してください、 [Azure Batch の基本](batch-technical-overview.md)します。

## <a name="workflow"></a>Batch サービスのワークフロー

次の高レベルのワークフローは、Batch サービス内で開発されるほぼすべての分散コンピューティング シナリオで使用される、典型的なものです。

1. アップロード、 *データファイル* に分散計算シナリオで使用する、 [Azure Storage][azure_storage] アカウントです。 これらのファイルは、Batch サービスがアクセスできるように、ストレージ アカウントに配置する必要があります。 タスクがこれらのファイルをダウンロード [計算ノード](#computenode) 実行したときにします。

2. 依存ファイルをアップロード *バイナリ ファイル* 、ストレージ アカウントにします。 これらのバイナリ ファイルには、タスクによって実行されるプログラムとその依存アセンブリが含まれています。 これらのファイルにもストレージ アカウントからアクセスできる必要があるため、タスクがコンピューティング ノードにダウンロードできます。

3. 作成、 [プール](#pool) 計算ノードのです。 指定した、 [計算ノードのサイズ][cloud_service_sizes] このプール内のノードを割り当てられているタスクが実行されると、プールが作成されるを使用します。

4. 作成、 [ジョブ](#job)します。 ジョブを使用すると、コレクション タスクを管理することができます。

5. 追加 [タスク](#task) ジョブにします。 各タスクは、アップロードされたプログラムを使用して、ストレージ アカウントにアップロードされたデータ ファイルの情報を処理します。

6. ジョブの進行状況を監視し、結果を取得します。

> [AZURE.NOTE] 必要があります、 [Batch アカウント](batch-account-create-portal.md) Batch サービスとほぼすべてのソリューションを使用して、使用して、 [Azure Storage][azure_storage] ファイルの格納と取得のアカウントです。

以下のセクションでは、上記のワークフローで言及されている各リソースと、分散コンピューティング シナリオを可能にする Batch のその他の多くの機能について説明します。

## <a name="resource"></a> Batch サービスのリソース

Azure Batch サービスを使用する際は、以下のリソースを利用します。

- [アカウント](#account)

- [コンピューティング ノード](#computenode)

- [プール](#pool)

- [Job](#job)

- [タスク](#task)

    - [開始タスク](#starttask)

    - [ジョブ マネージャー タスク](#jobmanagertask)

    - [ジョブ準備タスクおよびジョブ解放タスク](#jobpreprelease)

- [ジョブ スケジュール](#jobschedule)

### <a name="account"></a>アカウント

Batch アカウントは、Batch サービス内で一意に識別されるエンティティです。 すべての処理は、Batch アカウントに関連付けられています。 Batch サービスで処理を実行するには、アカウント名とアカウント キーが必要です。 Batch アカウントを作成するには、チェック アウト [を作成し、Azure ポータルで、Azure Batch アカウントを管理](batch-account-create-portal.md)します。

### <a name="computenode"></a>コンピューティング ノード

コンピューティング ノードは、アプリケーションの特定のワークロード専用の Azure 仮想マシンです。 ノードのサイズによって、CPU コアの数、メモリ容量、およびノードに割り当てられるローカル ファイル システムのサイズが決まります。 ノードには、いずれかを指定できる、 [クラウド サービス ノード サイズ][cloud_service_sizes], 、A0 を除く。

ノードは、実行可能ファイルとスクリプトを実行できます。たとえば、実行可能ファイル (.exe)、コマンド (.cmd) ファイル、バッチ (.bat) ファイル、PowerShell スクリプトなどです。 また、ノードには以下の属性もあります。

- 標準的な **フォルダー構造** と関連付けられた **環境変数** 、パスの詳細を示す、すべての計算ノード上に作成されます。 参照してください [ファイルとディレクトリ](#files) の下の詳細。
- **環境変数** タスクで参照できます。
- **ファイアウォール** 設定のアクセスを制御するように構成します。
- 場合 **リモート アクセス** には、コンピューティング ノードが必要 (デバッグ用に、たとえば)、RDP ファイルを取得を使用してノードへのアクセスを使用している *リモート デスクトップ*します。

### <a name="pool"></a>プール

プールは、アプリケーションが実行されるノードのコレクションです。 プールはお客様が手動で作成できるほか、実行する操作を指定した場合は Batch サービスによって自動的に作成されます。 アプリケーションのニーズを満たすプールを作成して管理することができ、プールを作成した Batch アカウントだけが、そのプールを使用できます。 1 つの Batch アカウントで複数のプールを持つことができます。

Azure Batch プールは、コア Azure コンピューティング プラットフォームの上に構築されています。Batch プールによって、大規模な割り当て、アプリケーションのインストール、データの分散、状態の監視や、プール内のコンピューティング ノード数の柔軟な調整 (スケーリング) が可能になります。

プールに追加されたすべてのノードに対し、一意の名前と IP アドレスが割り当てられます。 ノードがプールから削除されると、オペレーティング システムまたはファイルに加えられた変更は失われ、将来使用できるように名前と IP アドレスが解放されます。 ノードをプールから削除すると、その有効期間が終了します。

プール内のノード間の通信を許可するようにプールを構成できます。 プールに対してプール内通信が要求された場合、Batch サービスは、プール内の各ノードで 1100 より大きい番号のポートを有効にします。 プール内の各ノードは、このポート範囲への着信接続およびプール内の他のノードからの着信接続のみを許可するように構成されます。 アプリケーションがノード間の通信を必要としない場合、Batch サービスは多くの別のクラスターおよびデータ センターのプールに大量のノードを割り当てることにより、並列処理能力を向上させることができます。

プールを作成するときに次の属性を指定できます。

- **ノードのサイズ** プール
    - ノードで実行する予定のアプリケーションの特性と要件を考慮して、適切なノードのサイズを選ぶ必要があります。 ノードのサイズは、通常、ノードで複数のタスクが同時に実行されることはないという想定で選択されます。 最も適切でコスト効率の高いノード サイズを決定するには、アプリケーションがマルチ スレッドかどうかや、どのくらいのメモリが消費されるかといった点を考慮してください。 複数のタスクを割り当てて、複数のアプリケーション インスタンスを並列して実行することができます。その場合は、通常、より大きいノードが選ばれます。詳細については、後の「タスク スケジュール ポリシー」を参照してください。
    - プール内のすべてのノードが同じサイズである必要があります。 システム要件や負荷レベルが異なる複数のアプリケーションを実行する場合は、個別にプールを作成してください。
    - すべて [クラウド サービス ノード サイズ][cloud_service_sizes] A0 を除く、プール用に構成できます。

- **オペレーティング システム ファミリ** と **バージョン** ノード上で実行されます。
    - クラウド サービス内のワーカー ロールと同様、 *OS ファミリ* と *OS バージョン* を指定できます (ワーカー ロールの詳細については、次を参照してください。、 [のクラウド サービスについて教えてください][about_cloud_services] セクション *をホストしているオプションが提供するコンピューティング Azure*)。
    - OS ファミリによって、OS と同時にインストールされる .NET のバージョンも決まります。
    - worker ロールの場合と同様に、OS バージョンには "`*`" を指定することをお勧めします。これにより、ノードは自動的にアップグレードされ、新たにリリースされたバージョンに対応するための作業が不要になります。 特定の OS バージョンを選択するのは、主にアプリケーションの互換性を維持する必要がある場合です。こうすることで、バージョンの更新を許可する前に旧バージョンとの互換性をテストできます。 検証が終わると、プールの OS バージョンを更新して、新しい OS イメージをインストールできます。その際、実行中のタスクはすべて中断され、再びキューに置かれます。

- **ノードの数をターゲット** プールで使用すること

- **ポリシーを拡大/縮小** プール
    - ノードの数、だけでなく指定することも、 [自動スケールの数式](batch-automatic-scaling.md) プール用です。 Batch サービスは式を実行し、指定されたさまざまなプール、ジョブ、およびタスク パラメーターに基づいて、プール内のノード数を調整します。

- **タスクのスケジュール設定** ポリシー
    -  [ノードあたりのタスクの最大](batch-parallel-node-tasks.md) 構成オプションは、プール内の各ノードで並列に実行できるタスクの最大数を指定します。
    - 既定の構成では、コンピューティング ノードで 1 つのタスクだけを実行しますが、ノード上で複数のタスクを同時に実行できる方がメリットがあるシナリオもあります。 たとえば、アプリケーションが I/O を待機しなければならないときに、ノードの使用率を向上させる場合です。 複数のアプリケーションを同時に実行すると、CPU の使用率が増加します。 もう 1 つの例は、プール内のノード数を減らす場合です。 そうすることで、大規模な参照データ セットに必要なデータ転送の量を減らすことができます。アプリケーションには A1 ノード サイズで十分な場合、代わりに A4 ノード サイズを選択し、プールを 8 個の並列タスク用に構成できます (各タスクが 1 つのコアを使用)。
    - "フィルの種類" を指定することもできます。それによって、Batch がタスクをすべてのノードに均等に配分するか、1 つのノードに最大数のタスクを割り当ててからプール内の次のノードにタスクを割り当てていくかが決まります。

- **通信状態** 、プール内のノード
    - プールは、プール内のノード間の通信を許可するように構成できます。それによって、基になるネットワーク インフラストラクチャが決まります。 クラスター内のノードの配置にも影響することに注意してください。
    - ほとんどのシナリオでは、タスクは独立して動作し、相互に通信する必要はありませんが、一部のアプリケーションではタスクの通信が必要である場合があります。

- **タスクを開始する** 、プール内のノード
    - A *タスクを開始する* コンピューティング ノードが、プールに参加するたびに実行される指定することがあり、ノードを再起動したとき。 このタスクは、多くの場合、ノード上で実行されるタスクによって使用されるアプリケーションをインストールするために使用されます。

### <a name="job"></a>ジョブ

ジョブはタスクのコレクションであり、プール内のコンピューティング ノードでの計算の実行方法を指定します。

- ジョブを指定、 **プール** で作業を実行します。 プールには、さまざまなジョブで使用するためにこれまでに作成した既存のプールを指定できます。また、ジョブ スケジュールに関連付けられている各ジョブ用、またはジョブ スケジュールに関連付けられているすべてのジョブ用に、オンデマンドで作成することもできます。
- 省略可能な **ジョブの優先順位** を指定できます。 現在実行中のジョブよりも優先度が高いジョブが送信されると、優先度の高いジョブのタスクが、優先度の低いジョブのタスクよりも先にキューに挿入されます。 既に実行されている優先度の低いタスクは後回しになります。
- ジョブ **制約** 、ジョブの特定の制限を指定します。
    - A **最大実行時間** ジョブに対して設定できます。 指定された最大実行時間よりも長くジョブが実行されると、ジョブおよびジョブに関連付けられているすべてのタスクが終了されます。
    - Azure Batch は失敗したタスクを検出して、再試行することができます。  **タスク再試行の最大数** 、タスクは常に、またはまったく再試行かどうかなど、制約として指定することができます。 タスクの再試行とは、タスクをもう一度実行するためにキューに置くことです。
- タスクをジョブに追加する、クライアント アプリケーションをまたは [ジョブ マネージャー タスク](#jobmanagertask) 指定することができます。 ジョブ マネージャー タスクは、Batch API を使用します。このタスクには、ジョブに必要なタスクを作成するための情報と、プール内のいずれかのコンピューティング ノードで実行されているタスクが含まれます。 ジョブ マネージャー タスクは Batch によってのみ処理されます。ジョブが作成されるとすぐにキューに配置され、失敗すると再開されます。 ジョブ スケジュールによって作成されたジョブには、ジョブ マネージャー タスクが必要です。ジョブ マネージャー タスク以外では、ジョブがインスタンス化される前にタスクを定義できないためです。 ジョブ マネージャー タスクの詳細については、以下で説明します。


### <a name="task"></a>タスク

タスクは、ジョブに関連付けられ、ノード上で実行される、計算の単位です。 タスクはノードに割り当てられて実行されるか、ノードが解放されるまでキューに格納されます。 タスクは、次のリソースを使用します。

- 指定したアプリケーション、 **コマンドライン** タスクのです。

- **リソース ファイル** を処理するデータが含まれる。 これらのファイルは、Azure ストレージ アカウントの Blob Storage からノードに自動的にコピーされます。 詳細については、次を参照してください。 [ファイルとディレクトリ](#files) 以下です。

-  **環境変数** アプリケーションで必要です。 詳細については、次を参照してください。 [タスクの環境設定](#environment) 以下です。

-  **制約** で計算が発生する必要があります。 たとえば、タスクの実行が許可される最大時間、タスクが失敗した場合に再試行する最大回数、作業ディレクトリにファイルを保持する最大時間などです。

ノードで計算を実行するために定義するタスクに加えて、Batch サービスによって次のような特殊なタスクも用意されています。

- [開始タスク](#starttask)

- [ジョブ マネージャー タスク](#jobmanagertask)

- [ジョブ準備タスクおよびジョブ解放タスク](#jobmanagertask)

#### <a name="starttask"></a>開始タスク

関連付けることによって、 **タスクを開始する** をプールに構成できますそのノードの運用環境など、ソフトウェアのインストールやバック グラウンド プロセスの開始アクションを実行します。 開始タスクは、プール内に保持されている限り、ノードが起動されるたびに実行されます。ノードが最初にプールに追加されるときにも実行されます。 開始タスクの主な利点は、ジョブ タスクの実行に必要なコンピューティング ノードの構成とアプリケーションのインストールを行うためのすべての情報が含まれていることです。 そのため、プール内のノード数を増やすには、新しいターゲット ノードの数を指定するだけで済みます。新しいノードの構成と、タスクを受け付けるための準備に必要なすべての情報は、Batch が既に持っています。

他のバッチのタスクの一覧として **リソース ファイル** で [Azure Storage][azure_storage] を指定すること、さらに、 **コマンド ライン** を実行します。 Azure Batch では、最初に Azure Storage のファイルをコピーしてから、コマンド ラインを実行します。 プール開始タスクの場合、通常はこのファイル一覧にアプリケーション パッケージまたはファイルが含まれますが、コンピューティング ノードで実行されているすべてのタスクで使用される参照データが含まれている場合もあります。 開始タスクのコマンド ラインは、PowerShell スクリプトを実行したり、`robocopy` 操作を行う場合があります。たとえば、アプリケーション ファイルを "共有" フォルダーにコピーしてから、MSI または `setup.exe` を実行します。

一般的には、Batch サービスが開始タスクの完了まで待機してから、タスクを割り当てられる状態になっているノードを判断することが望ましいですが、これは構成可能です。

コンピューティング ノードで開始タスクが失敗した場合、そのノードの状態が更新されてエラーが反映され、そのノードは割り当てタスクに使用できなくなります。 ストレージからのリソース ファイルのコピーに問題があったり、コマンド ラインで実行されたプロセスからゼロ以外の終了コードが返されたりした場合に、開始タスクは失敗することがあります。

#### <a name="jobmanagertask"></a>ジョブ マネージャー タスク

A **ジョブ マネージャー タスク** は通常、制御または監視ジョブの実行に使用します。 たとえば、ジョブのタスクの作成と送信、実行する追加タスクの決定、いつ作業が完了するかの判断などを行います。 ジョブ マネージャー タスクは、このようなアクティビティだけに限定されません。ただし、ジョブに必要なアクションを実行できる、完全な独立したタスクである必要があります。 たとえば、ジョブ マネージャー タスクは、パラメーターとして指定されたファイルをダウンロードし、ファイルの内容を分析して、その内容に基づいて追加のタスクを送信します。

ジョブ マネージャー タスクは、他のすべてのタスクより先に起動され、次のような機能を提供します。

- ジョブの作成時に Batch サービスによって自動的にタスクとして送信されます。

- ジョブ内の他のタスクより先に実行されるようにスケジュールされます。

- ジョブ マネージャー タスクに関連付けられたノードは、プールが縮小される際、プールから最後に削除されます。

- ジョブ マネージャー タスクの終了を、ジョブ内のすべてのタスクの終了に関連付けることができます。

- ジョブ マネージャー タスクを再起動する必要がある場合は、最も高い優先順位が割り当てられます。 アイドル状態のノードを使用できない場合、Batch サービスはジョブ マネージャー タスクを実行する余地を確保するために、プール内のいずれかの実行中のタスクを終了する場合があります。

- あるジョブ内のジョブ マネージャー タスクに、他のジョブのタスクに対して高い優先順位が割り当てられることはありません。 ジョブ間では、ジョブ レベルの優先順位のみが適用されます。

#### <a name="jobpreprelease"></a>ジョブ準備タスクおよびジョブ解放タスク

Batch には、ジョブ前にセットアップを実行するためのジョブ準備タスクと、ジョブ後のメンテナンスまたはクリーンアップのためのジョブ解放タスクが用意されています。

- **ジョブ準備タスク** -すべてのジョブ準備タスクの実行の計算ノードのタスクを実行するようにスケジュール、その他のジョブの前に、タスクが実行されます。 たとえば、ジョブごとに異なるものの、すべてのタスクによって共有されるデータをコピーするために、ジョブ準備タスクを使用します。
- **ジョブのリリース タスク** - ジョブが完了したら、ジョブのリリース タスクには、少なくとも 1 つのタスクを実行、プール内の各ノード上で実行します。 たとえば、ジョブ準備タスクによってコピーされたデータを削除したり、診断ログ データを圧縮してアップロードしたりするために、ジョブ解放タスクを使用します。

ジョブ準備タスクおよびジョブ解放タスクのどちらでも、タスクをいつ呼び出すかをコマンド ラインで指定し、ファイルのダウンロード、管理者特権での実行、カスタム環境変数、最大実行期間、再試行回数、ファイル保持時間などの機能を提供できます。

ジョブの準備とリリースのタスクの詳細については、次を参照してください。 [Azure Batch 上の実行ジョブの準備と完了タスクの計算ノード](batch-job-prep-release.md)します。

### <a name="jobschedule"></a>スケジュールされたジョブ

ジョブ スケジュールを使用すると、Batch サービス内に、繰り返し発生するジョブを作成することができます。 ジョブ スケジュールは、ジョブをいつ実行するかを指定し、実行されるジョブの仕様を持っています。 ジョブ スケジュールではスケジュールの期間の詳細を指定できます。スケジュールがいつ有効になって、どのくらいの期間有効であるかや、その期間中にどのくらいの頻度でジョブを作成するかなどです。

## <a name="files"></a>ファイルとディレクトリ

各タスクには作業ディレクトリがあります。この作業ディレクトリ内に、タスクによって実行されるプログラム、タスクによって処理されるデータ、およびタスクによって実行された処理の出力を格納するためのファイルおよびディレクトリが 0 個以上作成されます。 これらのファイルとディレクトリは、ジョブの実行中に他のタスクから使用できます。 ノード上のすべてのタスク、ファイル、およびディレクトリは、単一のユーザー アカウントによって所有されます。

Batch サービスは、ノード上のファイル システムの一部を "ルート ディレクトリ" として公開します。 ルート ディレクトリは、`%AZ_BATCH_NODE_ROOT_DIR%` 環境変数にアクセスすることによって、タスクから使用できます。 詳細については、環境変数を使用して、次を参照してください。 [タスクの環境設定](#environment)します。

![コンピューティング ノードのディレクトリ構造][1]

ルート ディレクトリには、次のディレクトリ構造が含まれています。

- **共有** – ジョブにかかわらず、ノード上で実行しているすべてのタスクの共有ディレクトリです。 ノードで、共有ディレクトリは経由でアクセス  `%AZ_BATCH_NODE_SHARED_DIR%`します。 このディレクトリは、ノードで実行されるすべてのタスクに読み取り/書き込みアクセスを提供します。 タスクは、このディレクトリのファイルを作成、読み取り、更新、および削除できます。

- **スタートアップ** – この場所は、開始タスクによって作業ディレクトリとして使用します。 開始タスクを起動するために Batch サービスによってダウンロードされるファイルもすべてこのディレクトリに格納されます。 ノードでは、開始ディレクトリは `%AZ_BATCH_NODE_START_DIR%` 環境変数を通じて使用されます。 開始タスクは、このディレクトリのファイルを作成、読み取り、更新、および削除できます。また、このディレクトリを使用して、オペレーティング システムを構成できます。

- **タスク** -を使用してアクセス、ノードで実行されるタスクごとに、ディレクトリが作成されて `%AZ_BATCH_TASK_DIR%`します。 各タスク ディレクトリ内に、Batch サービスによって作業ディレクトリ (`wd`) が作成されます。その一意のパスは、`%AZ_BATCH_TASK_WORKING_DIR%` 環境変数によって指定されます。 このディレクトリは、タスクに読み取り/書き込みアクセスを提供します。 に基づいて、このディレクトリが保持されますタスクを作成、読み取り、更新、およびこのディレクトリにあるファイルを削除し、 *RetentionTime* タスクに対して指定された制約。
  - `stdout.txt` および `stderr.txt` - これらのファイルは、タスクの実行中にタスク フォルダーに書き込まれます。

ノードをプールから削除すると、ノードに格納されているすべてのファイルが削除されます。

## <a name="lifetime"></a>プールとコンピューティング ノードの有効期間

Azure Batch ソリューションを設計するときは、いつ、どのようにプールを作成するかと、それらのプール内のコンピューティング ノードをどのくらいの期間利用できるようにしておくかを考慮する必要があります。

極端な例として、ジョブが送信されたときに各ジョブに対してプールを作成し、タスクの実行が完了したらすぐにノードを削除することもできます。 この場合、ノードが絶対に必要なときにのみノードを割り当て、ノードがアイドル状態になるとすぐにシャットダウンするため、使用率が最大になります。 ジョブはノードが割り当てられるまで待機する必要がありますが、ノードが個別に使用可能になって割り当てられ、開始タスクが完了するとすぐに、タスクがノードに対してスケジュール設定されることに注意してください。 バッチは *いない* おり、利用可能なすべてのノードの最大使用率のタスクを割り当てる前にプール内のすべてのノードが利用できるまで待機します。

もう一方の極端な例では、ジョブをすぐに開始することが最優先事項である場合、プールを事前に作成し、ジョブが送信される前にノードを使用可能にしておくことができます。 このシナリオでは、ジョブ タスクをすぐに開始できますが、ノードはタスクの割り当てを待つ間、アイドル状態で待機する可能性があります。

変数が、継続的な負荷を処理するために使用される通常結合のアプローチは、プールを複数のジョブは送信されますが、ジョブの負荷に応じてノードの数を拡大または縮小を用意 (を参照してください *アプリケーションのスケーリング* の下)。 この方法では、現在の負荷に応じて事後的に対応することができ、負荷を予測できる場合は事前に対応することもできます。

## <a name="scaling"></a>アプリケーションのスケーリング

 [自動スケーリング](batch-automatic-scaling.md), 、アプリケーションに簡単に行える上または下に自動的に必要な計算ニーズに対応します。 現在のワークロードとリソース使用状況の統計情報に基づいて、プール内のノード数を動的に調整できます。そのため、必要なリソースのみを使用することで、アプリケーションの実行の全体的なコストを削減できます。 プールの作成時にスケーリング設定を指定できます。また、いつでもこの構成を更新することができます。

ノード数を自動的に減らす場合は、実行中のタスクについて考慮する必要があります。 割り当て解除ポリシーを指定することで、実行中のタスクを停止してノードをすぐに削除するか、タスクが完了してからノードを削除するかを決定します。 ジョブ完了時のノードの目標個数を 0 に設定し、実行中のタスクは完了するまで実行するようにした場合に、使用率が最大になります。

アプリケーションの自動スケーリングを行うには、スケーリング式のセットを指定します。 これらの式は、次のスケーリング間隔でプールに含まれるノードの目標数を決定するために使用されます。 たとえば、実行をスケジューリングされる多数のタスクが送信されることをジョブが必要としている場合があります。 この場合、現在の保留中のタスクの数とこれらのタスクの完了率に基づいてプールのサイズ (ノード数) を調整するスケーリング式をプールに割り当てることができます。 Batch サービスは、定期的に式を評価し、ワークロードに基づいてプールのサイズを変更します。

スケーリング式には、次のメトリックを使用できます。

- **時間メトリック** – 指定した時間数内で 5 分ごとに収集された統計情報に基づいています。

- **リソース メトリック** : CPU 使用率、帯域幅使用量、メモリ使用量、およびノードの数に基づいています。

- **タスク メトリック** – 保留中のアクティブなどのタスクの状態に基づいており、完了します。

アプリケーションを自動的にスケーリングの詳細については、次を参照してください。 [スケールが自動的に Azure Batch プール内のノードをコンピューティング](batch-automatic-scaling.md)します。

> [AZURE.TIP]
 ノードの削除が必要になることはあまりありませんが、ノードを個別に指定してプールから削除することができます。 たとえば、信頼性が低いと思われるノードがある場合は、プールから削除して、タスクがさらに割り当てられないようにすることができます。

## <a name="cert"></a>証明書によるセキュリティ

暗号化またはのキーなどのタスクの機密情報を暗号化解除証明書を使用する必要は通常、 [Azure ストレージ アカウント][azure_storage]します。 そのような場合をサポートするために、証明書はノードにインストールすることができます。 暗号化された機密情報は、コマンド ライン パラメーターを通じてタスクに渡されるか、タスク リソースの 1 つに埋め込まれます。インストールされた証明書を使用して、機密情報を復号化できます。

使用する、 [証明書の追加][rest_add_cert] 操作 (バッチ REST API) または [CertificateOperations.CreateCertificate][net_create_cert] メソッドは、Batch アカウントに証明書を追加する (バッチ .NET API)。 次に、新規または既存のプールに証明書を関連付けることができます。 証明書がプールに関連付けられると、Batch サービスは、プール内の各ノードに証明書をインストールします。 Batch サービスは、ノードの起動時に、いずれかのタスク (開始タスク、ジョブ マネージャー タスクも含まれます) を起動する前に、適切な証明書をインストールします。

## <a name="scheduling"></a>スケジューリング優先順位

Batch で作成するジョブには、優先順位を割り当てることができます。 Batch サービスは、ジョブの優先順位値を使用して、アカウント内のジョブ スケジューリングの順序を決定します。 優先順位として、-1000 ～ 1000 の値を使用します。-1000 は最も低い優先順位を示し、1000 は最も高い優先順位を示します。 使用して、ジョブの優先順位を更新することができます、 [ジョブのプロパティを更新する][rest_update_job] 操作 (バッチ REST API) または変更することにより、 [CloudJob.Priority][net_cloudjob_priority] プロパティ (バッチ .NET API)。

同じアカウント内で、優先順位の高いジョブは優先順位の低いジョブよりも優先的にスケジュールされます。 あるアカウントの優先順位値が高いジョブが、異なるアカウントの優先順位値が低い別のジョブよりも優先的にスケジュールされることはありません。

複数のプールにわたるジョブ スケジューリングは、独立しています。 異なるプール間では、関連するそのプールでアイドル状態のノードが不足している場合、優先順位の高い方のジョブが最初にスケジュールされるとは限りません。 同じプール内のジョブの場合、優先順位が同じであれば、スケジュールされる可能性は等しくなります。

## <a name="environment"></a>タスクの環境設定

Batch ジョブ内で実行される各タスクは、Batch サービスによって設定された環境変数 (システム定義。下の表を参照) とユーザー定義の環境変数の両方にアクセスします。 コンピューティング ノード上のタスクによって実行されるアプリケーションとスクリプトは、ノードでの実行中に、これらの環境変数にアクセスします。

使用する場合は、ユーザー定義の環境変数を設定、 [ジョブにタスクを追加][rest_add_task] 操作 (バッチ REST API) または変更することにより、 [CloudTask.EnvironmentSettings][net_cloudtask_env] プロパティ (バッチ .NET API) のジョブにタスクを追加するときにします。

使用して両方システムとユーザー定義、タスクの環境変数を取得、 [タスクに関する情報を取得][rest_get_task_info] 操作 (バッチ REST API) にアクセスして、 [CloudTask.EnvironmentSettings][net_cloudtask_env] プロパティ (バッチ .NET API)。 前述のように、コンピューティング ノードで実行中のプロセスも、すべての環境変数にアクセスできます。たとえば、一般的な `%VARIABLE_NAME%` 構文を使用してアクセスします。

ジョブでスケジュールされるすべてのタスクに、以下のシステム定義環境変数のセットが、Batch サービスによって設定されます。

| 環境変数の名前       | 説明                                                              |
|---------------------------------|--------------------------------------------------------------------------|
| `AZ_BATCH_ACCOUNT_NAME`         | タスクが所属するアカウントの名前。                       |
| `AZ_BATCH_JOB_ID`               | タスクが所属するジョブの ID。                             |
| `AZ_BATCH_JOB_PREP_DIR`         | ノード上のジョブ準備タスク ディレクトリの完全パス。         |
| `AZ_BATCH_JOB_PREP_WORKING_DIR` | ノード上のジョブ準備タスク作業ディレクトリの完全パス。 |
| `AZ_BATCH_NODE_ID`              | タスクが実行されているノードの ID。                         |
| `AZ_BATCH_NODE_ROOT_DIR`        | ノード上のルート ディレクトリの完全パス。                         |
| `AZ_BATCH_NODE_SHARED_DIR`      | ノード上の共有ディレクトリの完全パス。                       |
| `AZ_BATCH_NODE_STARTUP_DIR`     | ノード上のコンピューティング ノードのスタートアップ タスク ディレクトリの完全パス。    |
| `AZ_BATCH_POOL_ID`              | タスクが実行されているプールの ID。                         |
| `AZ_BATCH_TASK_DIR`             | ノード上のタスク ディレクトリの完全パス。                         |
| `AZ_BATCH_TASK_ID`              | 現在のタスクの ID。                                              |
| `AZ_BATCH_TASK_WORKING_DIR`     | ノード上のタスク作業ディレクトリの完全パス。                 |

>[AZURE.NOTE] 上記のシステム定義の変数を上書きすることはできません - は読み取り専用です。

## <a name="errorhandling"></a>エラー処理

Batch ソリューション内のタスクとアプリケーションの障害を処理しなければならないことがあります。

### タスクのエラー処理
タスク エラーは、以下のカテゴリに分類されます。

- **スケジュール エラー**
    - タスク用に指定されたファイルの転送がなんらかの理由で失敗すると、タスクの "スケジュール エラー" が設定されます。
    - スケジュール エラーの原因には、ファイルが移動された、ストレージ アカウントが利用できなくなった、ノードへのコピーを失敗させるようなその他の問題が発生した、などがあります。
- **アプリケーション エラー**
    - タスクのコマンド ラインで指定されたプロセスも失敗することがあります。 タスクによって実行されたプロセスによって 0 以外の終了コードが返された場合、プロセスが失敗したと見なされます。
    - アプリケーション エラーについては、指定された回数まで自動的にタスクを再試行するように Batch を構成することができます。
- **制約エラー**
    - ジョブまたはタスクの最大実行期間を指定する制約を設定できる、 *maxWallClockTime*します。 これは、"ハング" タスクを終了させる場合に便利です。
    - タスクとしてマークされている最長時間を超過すると、 *完了* に設定されている終了コードが、 `0xC000013A`, 、および *schedulingError* フィールドとしてマークされます `{ category:"ServerError", code="TaskEnded"}`します。

### アプリケーション エラーのデバッグ

アプリケーションの実行中に、問題のトラブルシューティングに利用できる診断情報が生成される場合があります。 説明したよう [ファイルとディレクトリ](#files) Batch サービスに stdout と stderr の出力を送信する、 `stdout.txt` と `stderr.txt` コンピューティング ノードの作業ディレクトリにあるファイルです。 使用して [ComputeNode.GetNodeFile][net_getfile_node] と [CloudTask.GetNodeFile][net_getfile_task] 、Batch .NET API では、これらとトラブルシューティングのためには、その他のファイルを取得できます。

使用してコンピューティング ノードにログインして、さらに広範なデバッグを実行できる *リモート デスクトップ*します。 実行できます [ノードからリモート デスクトップ プロトコル ファイルを取得][rest_rdp] (バッチ REST API) か、使用する、 [ComputeNode.GetRDPFile][net_rdp] リモート ログインのメソッド (バッチ .NET API)。

>[AZURE.NOTE] RDP を使用してノードに接続するには、最初ノードで、ユーザーを作成する必要があります。 [ユーザー アカウントのノードを追加][rest_create_user] Batch REST API の使用、 [ComputeNode.CreateComputeNodeUser][net_create_user] バッチ .NET でのメソッドです。

### タスクのエラーや中断の理由

タスクは、エラーが発生したり中断されたりする場合があります。 タスク アプリケーション自体でエラーが発生したり、タスクが実行されているノードが再起動したりすることがあります。また、プールの割り当て解除ポリシーが、タスクの完了を待たずに直ちにノードを削除するように設定されている場合は、サイズ変更操作中にノードがプールから削除されることもあります。 どのようなケースでも、Batch によってタスクを自動的にキューに戻し、別のノードで実行することができます。

断続的に発生する問題によって、タスクが応答を停止したり、実行に長い時間がかかるようになる場合もあります。 タスクに最大実行時間を設定すると、その時間を超過したときにタスク アプリケーションを中断できます。

### 問題のあるノードの理由

プール内のノードにはそれぞれ一意の ID があり、タスクが実行されるノードはタスクのメタデータに含まれています。 特定のノードでタスクのエラーが発生している場合、そのことは Batch クライアント アプリケーションによって判断することができ、疑わしいノードはプールから削除できます。 すべてのタスクで実行しているノードが削除される場合に自動的に、その他のノードで実行するため再キューに置かれたされます。

## 次のステップ

- 次の手順に従って、最初のバッチ アプリケーションを作成する [.NET 向け Azure Batch ライブラリの概要](batch-dotnet-get-started.md)
- ダウンロードし、ビルド、 [Batch Explorer][batch_explorer_project] バッチ ソリューションを開発するときに使用するためのサンプル プロジェクトです。 Batch Explorer を使用すると、次のようなことを実行できます。
  - Batch アカウント内のプール、ジョブ、およびタスクの監視と操作
  - ノードからの `stdout.txt`、`stderr.txt` などのファイルのダウンロード
  - ノードでのユーザーの作成と、リモート ログインのための RDP ファイルのダウンロード

[1]: ./media/batch-api-basics/node-folder-structure.png

[about_cloud_services]: https://azure.microsoft.com/documentation/articles/fundamentals-application-models/#tell-me-about-cloud-services
[azure_storage]: https://azure.microsoft.com/services/storage/
[batch_explorer_project]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/BatchExplorer
[cloud_service_sizes]: https://azure.microsoft.com/documentation/articles/cloud-services-sizes-specs/

[batch_net_api]: https://msdn.microsoft.com/library/azure/mt348682.aspx
[net_cloudjob_jobmanagertask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.jobmanagertask.aspx
[net_cloudjob_priority]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.priority.aspx
[net_cloudpool_starttask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.starttask.aspx
[net_cloudtask_env]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.environmentsettings.aspx
[net_create_cert]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.certificateoperations.createcertificate.aspx
[net_create_user]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.createcomputenodeuser.aspx
[net_getfile_node]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.getnodefile.aspx
[net_getfile_task]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.getnodefile.aspx
[net_rdp]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.getrdpfile.aspx

[batch_rest_api]: https://msdn.microsoft.com/library/azure/Dn820158.aspx
[rest_add_job]: https://msdn.microsoft.com/library/azure/mt282178.aspx
[rest_add_pool]: https://msdn.microsoft.com/library/azure/dn820174.aspx
[rest_add_cert]: https://msdn.microsoft.com/library/azure/dn820169.aspx
[rest_add_task]: https://msdn.microsoft.com/library/azure/dn820105.aspx
[rest_create_user]: https://msdn.microsoft.com/library/azure/dn820137.aspx
[rest_get_task_info]: https://msdn.microsoft.com/library/azure/dn820133.aspx
[rest_update_job]: https://msdn.microsoft.com/library/azure/dn820162.aspx
[rest_rdp]: https://msdn.microsoft.com/library/azure/dn820120.aspx


