<properties
    pageTitle="オンプレミスの VMM サイト間の保護の設定"
    description="Azure Site Recovery は、オンプレミスの VMM サイト間で、Hyper-V 仮想マシンのレプリケーション、フェイルオーバー、回復を調整します。"
    services="site-recovery"
    documentationCenter=""
    authors="rayne-wiselman"
    manager="jwhit"
    editor="tysonn"/>

<tags
    ms.service="site-recovery"
    ms.workload="backup-recovery"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="10/12/2015"
    ms.author="raynew"/>

# オンプレミスの VMM サイト間の保護の設定


## 概要


Azure Site Recovery は、さまざまなデプロイ シナリオでの仮想マシンのレプリケーション、フェールオーバー、復旧を調整してビジネス継続性と障害復旧 (BCDR) 戦略に貢献します。 展開の完全な一覧のシナリオを参照して  [Azure Site Recovery の概要](site-recovery-overview.md)します。

このシナリオのガイドでは、Site Recovery をデプロイして、VMM プライベート クラウドにデプロイされている Hyper-V ホスト サーバー上の仮想マシンで実行されているワークロードの保護を調整および自動化する方法について説明します。 このシナリオでは、仮想マシンはプライマリ VMM サイトからセカンダリ VMM サイトに Hyper-V Replica を使用してレプリケートされます。

ガイドには、シナリオの前提条件が含まれています。また、Site Recovery コンテナーを設定する方法、ソースとターゲットの VMM サーバーに Azure Site Recovery プロバイダーをインストールする方法、このコンテナーにサーバーを登録する方法、保護されるすべての仮想マシンに適用される VMM クラウドの保護設定を構成する方法、およびこれらの仮想マシンの保護を有効にする方法についても説明しています。 すべてが正しく動作していることを確認するために、最後にフェールオーバーをテストします。

設定するこのシナリオの投稿、質問に問題が生じたかどうか、 [Azure Recovery Services フォーラム](http://go.microsoft.com/fwlink/?LinkId=313628)します。


## 開始する前に
次の前提条件を満たしていることを確認してください。
### Azure の前提条件

- 必要があります、 [Microsoft Azure](http://azure.microsoft.com/) アカウントです。 ない場合は始めて、 [無料評価版](http://aka.ms/try-azure)します。 さらに知っておくことができます [Azure Site Recovery Manager の料金](http://go.microsoft.com/fwlink/?LinkId=378268)します。
- 情報とデータの使用方法を理解するのには、読み取り、 [Microsoft Azure のプライバシーに関する声明](http://go.microsoft.com/fwlink/?LinkId=324899) および追加 <a href="#privacy">Site Recovery のプライバシー情報</a> このトピックの下部にあります。

### VMM の前提条件
- VMM サーバーが少なくとも 1 つ必要です。
- VMM サーバーは、少なくとも累積的な更新プログラムがインストールされている System Center 2012 SP1 を実行している必要があります。
- 保護する仮想マシンを含むすべての VMM サーバーが Azure Site Recovery プロバイダーを実行している必要があります。 このプロバイダーは Azure Site Recovery のデプロイ時にインストールされます。
- 1 つの VMM サーバーで保護を設定する場合、そのサーバーには少なくとも 2 つのクラウドを構成する必要があります。
- 2 つの VMM サーバーで保護をデプロイする場合、保護するプライマリ VMM サーバーに少なくとも 1 つのクラウドを構成し、保護と復旧に使用するセカンダリ VMM サーバーに 1 つのクラウドを構成する必要があります。
- すべての VMM クラウドには Hyper-V キャパシティ プロファイル セットが必要です。
- 保護するソース クラウドには、以下のものが含まれている必要があります。
    - 1 つ以上の VMM ホスト グループ。
    - 各ホスト グループに 1 つ以上の Hyper-V ホスト サーバー。
    - ホスト サーバー上に配置された 1 つ以上の仮想マシン。
- VMM クラウドの設定について理解を深めます。
    - プライベート VMM クラウドの詳細については [と System Center 2012 R2 VMM のプライベート クラウドの新](http://go.microsoft.com/fwlink/?LinkId=324952) し、[ [VMM 2012 とクラウド](http://go.microsoft.com/fwlink/?LinkId=324956)します。
    - について学習 [ファブリックにクラウド、VMM の構成](https://msdn.microsoft.com/library/azure/dn469075.aspx#BKMK_Fabric)
    - クラウド ファブリック要素の配置後は、プライベート クラウドでの作成について学習  [VMM でプライベート クラウドの作成](http://go.microsoft.com/fwlink/?LinkId=324953) と [チュートリアル: System Center 2012 SP1 VMM でプライベート クラウドを作成する](http://go.microsoft.com/fwlink/?LinkId=324954)です。

### Hyper-V の前提条件

- ホストおよびターゲットの Hyper-V サーバーは、少なくとも Hyper-V ロールを持つ Windows Server 2012 を実行しており、最新の更新プログラムがインストールされている必要があります。
- クラスターで Hyper-V を実行している場合に、静的 IP アドレス ベースのクラスターが存在すると、クラスター ブローカーが自動的に作成されません。 クラスター ブローカーを手動で構成する必要があります。 手順を参照してください [HYPER-V レプリカ ブローカーを構成する](http://social.technet.microsoft.com/wiki/contents/articles/18792.configure-replica-broker-role-cluster-to-cluster-replication.aspx)です。
- 保護を管理するすべての Hyper-V ホスト サーバーまたはクラスターが VMM クラウドに属している必要があります。

次の図は、Azure Site Recovery でオーケストレーションやレプリケーションに使用される、さまざまな通信チャネルと通信ポートを示しています。

![E2E トポロジ](./media/site-recovery-vmm-to-vmm/E2ETopology.png)


### ネットワーク マッピングの前提条件
ネットワーク マッピングにより、フェールオーバー後にレプリカの仮想マシンが Hyper-V ホスト サーバーへ最適に配置され、適切な VM ネットワークに接続できるようになります。 ネットワーク マッピングを構成しないと、レプリカの仮想マシンはフェールオーバー後に VM ネットワークに接続されません。 ネットワーク マッピングをデプロイする場合は、以下のことが必要になります。

- ソース VMM サーバー上の保護する仮想マシンが VM ネットワークに接続している。 そのネットワークは、クラウドに関連付けられた論理ネットワークにリンクされている必要があります。
- 復旧に使用するセカンダリ VMM サーバーのターゲット クラウドには対応する VM ネットワークが構成されており、そのネットワークが、ターゲット クラウドに関連付けられている、対応する論理ネットワークにリンクされている必要があります。

ネットワーク マッピングについての理解を深める。

- [VMM での論理ネットワークの構成](http://go.microsoft.com/fwlink/?LinkId=386307)
- [VMM での VM ネットワークとゲートウェイの構成](http://go.microsoft.com/fwlink/?LinkId=386308)

### ストレージ マッピングの前提条件
ソースの Hyper-V ホスト サーバーにある仮想マシンをターゲットの Hyper-V ホスト サーバーにレプリケートする場合、既定では、レプリケートされたデータは既定の場所に格納されます。その場所は、Hyper-V マネージャーでターゲットの Hyper-V ホストに対して指定されています。 レプリケートされたデータの格納場所を細かく制御する場合は、ストレージ マッピングを構成します。 そのためには、デプロイの開始前に、ソースとターゲットの VMM サーバーでストレージ分類を設定する必要があります。
手順を参照してください [VMM で記憶域の分類を作成する方法](http://go.microsoft.com/fwlink/?LinkId=400937)します。


## ステップ 1: Site Recovery コンテナーを作成する

1. サインイン、 [管理ポータル](https://portal.azure.com) に登録する VMM サーバーからです。

2. 展開 **Data Services** > **Recovery Services** ] をクリック **Site Recovery コンテナー**します。


3. クリックして **新規作成** > **簡易作成**します。

4.  **名**, 、コンテナーを識別するフレンドリ名を入力します。

5.  **地域** 、コンテナーのリージョンを選択します。 確認するには、サポートされているリージョンで利用可能な地域を参照してください。 [Azure Site Recovery の料金詳細](http://go.microsoft.com/fwlink/?LinkId=389880)します。

6. クリックして **コンテナーの作成**します。

    ![コンテナーの作成](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_CreateVault.png)

ステータス バーでコンテナーが作成されたことを確認します。 資格情報コンテナーが表示されます **Active** メイン [復旧サービス] ページにします。

## ステップ 2: コンテナー登録キーを生成する

コンテナーの登録キーを生成します。 Azure Site Recovery プロバイダーをダウンロードして VMM サーバーにインストールした後で、このキーを使用して、VMM サーバーをコンテナーに登録します。

1. **[Recovery Services]** ページで、資格情報コンテナーをクリックして、[クイック スタート] ページを開きます。 [クイック スタート] は、アイコンを使っていつでも開くことができます。

    ![[クイック スタート] アイコン](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_QuickStartIcon.png)

2. ドロップダウン リストで選択 **2 つのオンプレミス HYPER-V サイト間で**します。
3.  **VMM サーバーの準備**, 、クリックして **登録キー ファイルの生成**します。 キー ファイルは自動的に生成され、生成後 5 日間有効です。 VMM サーバーから Azure ポータルにアクセスしていない場合は、このファイルをサーバーにコピーする必要があります。

    ![登録キー](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_E2ERegisterKey.png)

## ステップ 3: Azure Site Recovery プロバイダーをインストールする

4.  *クイック スタート* ] ページの [ **VMM サーバーの準備**, をクリックして *ダウンロード Microsoft Azure Site Recovery プロバイダーの VMM サーバーにインストールするため* プロバイダー インストール ファイルの最新バージョンを取得します。

2. ソース VMM サーバーでこのファイルを実行します。 プロバイダーを初めてインストールするときに、VMM がクラスターにデプロイされている場合は、プロバイダーをアクティブなノードにインストールします。インストールが終了したら、VMM サーバーをコンテナーに登録します。 次に、プロバイダーを他のノードにインストールします。 プロバイダーをアップグレードする場合は、すべてのノードでアップグレードする必要があります。これは、すべてのノードで同じバージョンのプロバイダーを実行する必要があるためです。


3. インストーラーはいくつか **前提条件の確認** し、プロバイダーのセットアップを開始する VMM サービスを停止する許可を要求します。 セットアップが完了すると、VMM サービスは自動的に再起動されます。 VMM クラスターにインストールしている場合は、クラスター ロールを停止するよう求められます。

4.  **Microsoft Update** 更新プログラムを設定できます。 この設定を行うことで、設定した Microsoft Update のポリシーに従って、プロバイダーの有効な更新がインストールされます。

    ![Microsoft 更新プログラム](./media/site-recovery-vmm-to-vmm/VMMASRInstallMUScreen.png)


1.  インストール場所に設定されている **<SystemDrive>\Program Files\Microsoft System Center 2012 r2 \virtual Machine manager \bin**します。 [インストール] ボタンをクリックすると、プロバイダーのインストールが開始されます。
    ![InstallLocation](./media/site-recovery-vmm-to-vmm/VMMASRInstallLocationScreen.png)



1. プロバイダーがインストールされたら、[登録] ボタンをクリックしてサーバーをコンテナーに登録します。
    ![InstallComplete](./media/site-recovery-vmm-to-vmm/VMMASRInstallComplete.png)

5.  **インターネット接続** VMM サーバーで実行されるプロバイダーがインターネットに接続する方法を指定します。 選択 *既定のシステム プロキシ設定を使用して* 、サーバーで構成されている既定のインターネット接続設定を使用します。

    ![インターネット設定](./media/site-recovery-vmm-to-vmm/VMMASRRegisterProxyDetailsScreen.png)
    - カスタム プロキシを使用する場合は、プロバイダーをインストールする前に設定する必要があります。 カスタム プロキシ設定を構成すると、プロキシの接続を確認するためのテストが実施されます。
    - カスタム プロキシを使用する場合、または既定のプロキシで認証が必要な場合、プロキシのアドレスやポートなどの詳細を入力する必要があります。
    - VMM サーバーと Hyper-V ホストから次の URL にアクセスできる必要があります。
        - *.hypervrecoverymanager.windowsazure.com
        - *.accesscontrol.windows.net
        - *.backup.windowsazure.com
        - *.blob.core.windows.net
        - *.store.core.windows.net
    - 記載されている IP アドレスを許可する [Azure Datacenter の IP 範囲](http://go.microsoft.com/fwlink/?LinkId=511094) と HTTPS (443) プロトコルです。 使用を計画している Azure リージョンの IP の範囲と米国西部の IP の範囲をホワイトリストに登録する必要があります。

    - カスタム プロキシを使用する場合、指定されたプロキシの資格情報を使用して VMM RunAs アカウント (DRAProxyAccount) が自動的に作成されます。 このアカウントが正しく認証されるようにプロキシ サーバーを構成します。 VMM RunAs アカウントの設定は VMM コンソールで変更できます。 変更するには、[設定] ワークスペースを開いて [セキュリティ] を展開し、[実行アカウント] をクリックします。その後、DRAProxyAccount のパスワードを変更します。 新しい設定を有効にするには、VMM サービスを再起動する必要があります。

6.  **登録キー**, 、Azure Site Recovery からダウンロードし、VMM サーバーにコピーしたことを選択します。
7.  **資格情報コンテナー名**, 、サーバーを登録するコンテナーの名前を確認します。 クリックして *次*します。


    ![Server registration](./media/site-recovery-vmm-to-vmm/VMMASRRegisterVaultCreds.png)

9. この設定は VMM から Azure へのシナリオにのみ使用されます。VMM から VMM へのみのユーザーの場合は、この画面を無視できます。

    ![サーバー登録](./media/site-recovery-vmm-to-vmm/VMMASRRegisterEncryptionScreen.png)

8.  **サーバー名**, 、資格情報コンテナーで VMM サーバーを識別する表示名を指定します。 クラスター構成で、VMM クラスターのロール名を指定します。

8.  **初期クラウド メタデータ** VMM サーバー上のすべてのクラウドのメタデータをコンテナーと同期するかどうか選択を同期します。 この操作は、各サーバーで 1 回のみ実行する必要があります。 すべてのクラウドを同期したくない場合は、この設定をオフのままにして、VMM コンソールのクラウドのプロパティで各クラウドを個別に同期できます。
    ![サーバーの登録](./media/site-recovery-vmm-to-vmm/VMMASRRegisterFriendlyName.png)


8. クリックして *次* プロセスを完了します。 登録後に、VMM サーバーからのメタデータが、Azure Site Recovery によって取得されます。 サーバーが表示されます、  *VMM サーバー* ] タブで、 **サーバー** ] ページで、資格情報コンテナー。

>[AZURE.NOTE] 次のコマンドラインを使用して、Azure Site Recovery プロバイダーをインストールすることもできます。 このメソッドを使用すると、Windows Server 2012 R2 の Server CORE にプロバイダーをインストールできます。

1. プロバイダーのインストール ファイルと登録キーを C:\ASR などのフォルダーにダウンロードします。
1. System Center Virtual Machine Manager サービスを停止します。
1. プロバイダーのインストーラーを実行して抽出、次のコマンド プロンプトでコマンド **管理者** 特権

        C:\Windows\System32> CD C:\ASR
        C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q
1. 次のコマンドを実行して、プロバイダーをインストールします。

        C:\ASR> setupdr.exe /i
1. 次のコマンドを実行して、プロバイダーを登録します。

        CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
        C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin\> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>     

    
#### コマンド ラインのインストール パラメーター一覧

 - **/資格情報** : 登録キー ファイルが配置されている場所を指定する必須パラメーター  
 - **/Friendlyname** : Azure Site Recovery ポータルに表示されている HYPER-V ホスト サーバーの名前を表す必須パラメーターです。
 - **/EncryptionEnabled** : 休息中で、Azure で仮想マシンを暗号化する必要がある場合は、Azure のシナリオのための VMM でのみ使用する必要があります。 省略可能なパラメーターです。 指定したファイル名があることを確認してください、 **.pfx** 拡張機能です。
 - **/proxyAddress** : プロキシ サーバーのアドレスを指定する省略可能なパラメーターです。
 - **/proxyport** : プロキシ サーバーのポートを指定する省略可能なパラメーターです。
 - **/proxyUsername** : (プロキシ認証を必要とする場合は、プロキシ ユーザー名を指定する省略可能なパラメーターです。
 - **/proxyPassword** : 省略可能なパラメーター (プロキシ認証を必要とする場合は、プロキシ サーバーを使用した認証のパスワードを指定します。  

## ステップ 4: クラウドの保護設定の構成

VMM サーバーを登録した後、クラウドの保護設定を構成することができます。 オプションを有効になっている場合 **、資格情報コンテナーとクラウド データの同期** で VMM サーバー上のすべてのクラウドが表示されますので、プロバイダーをインストールするとき、 **保護された項目** ] タブで、資格情報コンテナー。 いない場合は、Azure Site Recovery での特定のクラウドを同期することができます、 **全般的な** VMM コンソールで、クラウドのプロパティ ページのタブをクリックします。

![発行済みのクラウド](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_CloudsList.png)

1. クイック スタート] ページで、次のようにクリックします。 **VMM クラウドの保護を設定**します。
2.  **VMM クラウド** ] タブで、構成に移動するクラウドを選択して、 **構成** ] タブをクリックします。
3. **[ターゲット]** で **[VMM]** を選択します。
4. **[ターゲットの場所]** で、回復時に使用するクラウドを管理するオンサイト VMM サーバーを選択します。
4. **[ターゲット クラウド]** で、ソース クラウド内の仮想マシンのフェールオーバー時に使用するターゲット クラウドを選択します。 以下の点に注意してください。
    - 保護する仮想マシンの復旧要件を満たしたターゲット クラウドを選択することをお勧めします。
    - クラウドは、プライマリ クラウドまたはターゲット クラウドとして、1 つのクラウド ペアに属することしかできません。
6.  **コピーの頻度** 頻度の指定ソースとターゲットの場所の間でデータを同期する必要があります。 この設定は、Hyper-V ホストで Windows Server 2012 R2 を実行している場合にのみ該当します。 他のサーバーでは、5 分間という既定の設定が使用されます。
7.  **追加の復旧ポイント** 追加の復旧ポイントを作成するかどうかを指定します。ゼロの既定値は、プライマリ仮想マシンの最新の復旧ポイントのみがレプリカ ホスト サーバーに保存されることを示します。 複数の復旧ポイントを有効にすると、各復旧ポイントで格納されるスナップショット用に追加のストレージが必要になります。 既定では、1 時間ごとに復旧ポイントが作成されるため、各復旧ポイントで 1 時間分のデータが格納されます。 VMM コンソールで仮想マシンに割り当てる復旧ポイントの値は、Azure Site Recovery コンソールで割り当てる値より小さくしないでください。
8.  **アプリケーション整合性スナップショットの頻度** アプリケーション整合性スナップショットを作成する頻度を指定します。 Hyper-V では 2 種類のバックアップを使用します。1 つは標準バックアップで、仮想マシン全体の増分バックアップを実行します。もう 1 つは、アプリケーション整合性スナップショットで、仮想マシン内部のアプリケーション データの特定の時点のスナップショットを作成します。 アプリケーション整合性スナップショットでは、ボリューム シャドウ コピー サービス (VSS) を使用して、スナップショットを作成するときにアプリケーションを一貫性のある状態に保ちます。 アプリケーション整合性スナップショットを有効にすると、ソースの仮想マシンで実行するアプリケーションのパフォーマンスに影響があります。 設定する値は、追加で構成する復旧ポイントの数より少ない数にしてください。

    ![保護設定の構成](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_CloudSettings.png)

9.  **データ転送の圧縮**, 、転送されるレプリケートされたデータを圧縮するかどうかを指定します。
10.  **認証**, 、プライマリと復旧の HYPER-V ホスト サーバー間でトラフィックを認証する方法を指定します。 実際に利用できる Kerberos 環境を構成している場合を除き、HTTPS を選択してください。 Azure Site Recovery は、HTTPS 認証に使用する証明書を自動的に構成します 手動で構成する必要はありません。 Kerberos を選択した場合は、ホスト サーバーの相互認証に Kerberos チケットが使用されます。 既定では、Hyper-V ホスト サーバーの Windows ファイアウォールで、ポート 8083 と 8084 (認証用) が開きます。 この設定は、Windows Server 2012 R2 で実行されている Hyper-V ホスト サーバーだけに関連することに注意してください。
11.  **ポート**,、ソースとターゲットのホスト コンピューターがレプリケーション トラフィックをリッスンするポート番号を変更します。 たとえば、レプリケーション トラフィックにサービス品質 (QoS) ネットワーク帯域幅スロットルを適用する場合などに、設定を変更します。 ポートが他のアプリケーションで使用されていないことと、ファイアウォール設定で開いていることを確認します。
12.  **レプリケーション方法**, 、方法、初期レプリケーション ソースからターゲットの場所へのデータを処理する、定期的なレプリケーションを開始する前に指定します。
    - **ネットワーク経由で**— 時間がかかり、リソースを消費するネットワーク経由でデータをコピーすることができます。 クラウドの仮想マシンで使用する仮想ハード ディスクの容量が比較的小さい場合、そして、プライマリ サイトがセカンダリ サイトに高速回線で接続されている場合に、このオプションを使用することをお勧めします。 コピーを直ちに開始することも、実行時刻を選択することもできます。 ネットワーク レプリケーションを使用する場合は、ピーク時間以外に実行することをお勧めします。
    - **オフライン**— この方法では、外部メディアを使用して、初期レプリケーションを実行することを指定します。 これは、ネットワーク性能の低下を避ける場合、または、場所が地理的に離れている場合に便利です。 この方法を使用するには、ソース クラウド上のエクスポート場所と、ターゲット クラウド上のインポート場所を指定します。 仮想マシンの保護を有効にすると、指定されたエクスポート場所に仮想ハード ディスクがコピーされます。 それをターゲット サイトに送信して、インポート場所にコピーします。 インポートされた情報はレプリカ仮想マシンに自動的にコピーされます。 オフライン レプリケーションの前提条件の一覧については、デプロイ ガイドの「<a href="http://go.microsoft.com/fwlink/?LinkId=323469">ステップ 3: VMM クラウドの保護設定を構成する</a>」を参照してください。
13. 選択 **レプリカ仮想マシンの削除** を選択して仮想マシンの保護を停止する場合に、レプリカ仮想マシンを削除するように指定する、 **仮想マシンの保護を削除** クラウドのプロパティの [仮想マシン] タブのオプションです。 この設定を有効にすると、保護を無効にしたときに、仮想マシンの Azure Site Recovery からの削除、VMM コンソールでの仮想マシンの Site Recovery 設定の削除、レプリカの削除が行われます。
    ![保護設定を構成します。](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_CloudSettingsRep.png)

<p>設定を保存して、ジョブが作成されますで監視できる、 **ジョブ** ] タブをクリックします。 VMM ソース クラウド内のすべての Hyper-V ホスト サーバーは、レプリケーション用に構成されます。 [クラウドの設定を変更できます、 **構成** ] タブをクリックします。 ターゲットの場所やターゲット クラウドを変更する場合は、クラウド構成を削除およびからクラウドを再構成する必要があります。</p>

### オフラインでの初期レプリケーションの準備

オフラインで初期レプリケーションを行うための準備として、次の操作を実行する必要があります。

- ソース サーバーで、データのエクスポートを実施するパスの場所を指定します。 そのエクスポート パスに対する NTFS のフル コントロール アクセス許可と共有アクセス許可を VMM サービスに付与します。 ターゲット サーバーで、データのインポートを実施するパスの場所を指定します。 このインポート パスに対して同じアクセス許可を割り当てます。
- インポート パスまたはエクスポート パスが共有されている場合は、その共有パスの配置先であるリモート コンピューター上の VMM サービス アカウントに対して、Administrator、Power User、Print Operator、または Server Operator グループのメンバーシップを割り当てます。
- いずれかの実行アカウントを使用してホストを追加している場合は、インポート パスおよびエクスポート パスに対する読み取りと書き込みのアクセス許可を VMM の実行アカウントに割り当てます。
- Hyper-V ではループバックの構成がサポートされていないため、インポート用の共有とエクスポート用の共有は、Hyper-V ホスト サーバーとして使用するどのコンピューターにも配置しないでください。
- Active Directory で、保護対象の仮想マシンを含む各 Hyper-V ホスト サーバーに対して、次のように制約付き委任を有効にして構成し、インポート パスとエクスポート パスの配置先であるリモート コンピューターを信頼します。
    1. ドメイン コント ローラーで、開く **Active Directory ユーザーとコンピューター**します。
    2. コンソール ツリーで [ **DomainName** > **コンピューター**します。
    3. HYPER-V ホスト サーバーの名前を右クリックして > **プロパティ**します。
    4.  **委任** T] タブをクリックして**このコンピューターに指定されたサービスのみ委任に対して信頼**します。
    5. クリックして **認証プロトコルを使う**します。
    6. クリックして **追加** > **ユーザーとコンピューター**します。
    7. エクスポート パスをホストするコンピューターの名前を入力 > **OK**します。利用可能なサービスの一覧では、CTRL キーを押しながらし、] をクリックして **cifs** > **OK**します。 インポート パスをホストするコンピューターの名前に対して、同じ手順を繰り返します。 必要に応じて、追加の Hyper-V ホスト サーバーに対して同じ手順を繰り返します。

## ステップ 5: ネットワーク マッピングの構成
1. クイック スタート] ページで、次のようにクリックします。 **ネットワーク マップ**します。
2. ネットワークをマップするソース VMM サーバーを選択し、次に、ネットワークがマップされるターゲット VMM サーバーを選択します。 ソース ネットワークとそれに関連付けられたターゲット ネットワークの一覧が表示されます。 現在マッピングされていないネットワークには空白の値が表示されます。
3. ネットワークを選択して **[ソースのネットワーク** > **マップ**します。 サービスによってターゲット サーバー上の VM ネットワークが検出され、表示されます。 ソース ネットワーク名とターゲット ネットワーク名の横にある情報アイコンをクリックして各ネットワークのサブネットを表示します。

    ![ネットワーク マッピングの構成](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_NetworkMapping1.png)

4. ダイアログ ボックスで、ターゲット VMM サーバーのいずれかの VM ネットワークを選択します。

    ![ターゲット ネットワークの選択](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_NetworkMapping2.png)

5. ターゲット ネットワークを選択すると、ソース ネットワークを使用する保護されたクラウドが表示されます。 保護に使用するクラウドに関連付けられている使用可能なターゲット ネットワークも表示されます。 保護に使用しているすべてのクラウドで使用可能なターゲット ネットワークを選択することをお勧めします。 または、VMM サーバーに移動してクラウドのプロパティを変更し、選択した VM ネットワークに対応する論理ネットワークを追加することもできます。
6. チェック マークをクリックして、マッピング処理を完了します。 ジョブが開始され、マッピングの進行状況を追跡します。 表示する、 **ジョブ** ] タブをクリックします。


## ステップ 6: ストレージ マッピングを構成する
ソースの Hyper-V ホスト サーバーにある仮想マシンをターゲットの Hyper-V ホスト サーバーにレプリケートする場合、既定では、レプリケートされたデータは既定の場所に格納されます。その場所は、Hyper-V マネージャーでターゲットの Hyper-V ホストに対して指定されています。 レプリケートされたデータの格納場所を細かく制御する場合は、次のようにストレージ マッピングを構成します。

- ソースとターゲットの両方の VMM サーバーでストレージ分類を定義します。 手順については、次を参照してください。 [VMM で記憶域の分類を作成する方法](http://go.microsoft.com/fwlink/?LinkId=400937)します。 分類は、ソースおよびターゲットのクラウド内の Hyper-V ホスト サーバーで使用できる必要があります。 分類のストレージの種類は同じでなくてもかまいません。 たとえば、SMB 共有が含まれているソース分類を CSV が含まれているターゲット分類に割り当てることができます。
- 分類を定義したら、マッピングを作成できます。
1.  **クイック スタート** ページ > **ストレージのマップ**します。
1. クリックして、 **ストレージ** ] タブ > **ストレージ分類のマップ**します。
1.  **ストレージ分類のマップ** タブし、分類、ソースを選択して、ターゲットの VMM サーバー。 設定を保存します。

    ![ターゲット ネットワークの選択](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_StorageMapping1.png)


## ステップ 7: 仮想マシンの保護を有効化する
サーバー、クラウド、およびネットワークを正しく構成した後で、クラウド内の仮想マシンの保護を有効にすることができます。

1.  **仮想マシン** 仮想マシンが配置されているクラウド内のタブをクリックして **保護を有効にする** > **仮想マシンの追加**します。
2. クラウド内の仮想マシンのリストから、保護する仮想マシンを選択します。


![仮想マシンの保護の有効化](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_EnableProtectionVM.png)

保護の有効化アクションの進行状況を追跡、 **ジョブ** ] タブで、初期レプリケーションなどです。 保護の最終処理のジョブが実行されると、仮想マシンは、フェールオーバーを実行できる状態になります。 保護が有効され仮想マシンが複製されると、Azure でそれらの状態を表示できます。

VMM コンソールでも仮想マシンの保護を有効にできます。 仮想マシン プロパティの [Azure Site Recovery] タブで、ツール バーにある [保護を有効にする] をクリックします。


![仮想マシン保護ジョブ](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_VMJobs.png)

### 既存の仮想マシンの追加
Hyper-V レプリカを使用してレプリケートされる VMM 内に既存の仮想マシンがある場合、次の手順で Azure Site Recovery の保護にそれらの仮想マシンを追加する必要があります。
1. プライマリ クラウドとセカンダリ クラウドがあることを確認します。 既存の仮想マシンをホストしている Hyper-V サーバーがプライマリ クラウドに存在し、レプリカ仮想マシンをホストしている Hyper-V サーバーがセカンダリ クラウドに存在することを確認します。 クラウドの保護設定が構成されていることを確認します。 この設定が、Hyper-V レプリカに現在構成されている設定と一致する必要があります。 一致しない場合、仮想マシンのレプリケーションが正しく動作しない可能性があります。
2. 次に、プライマリ仮想マシンの保護を有効にします。 Azure Site Recovery と VMM によって同じレプリカ ホストと仮想マシンが検出され、Azure Site Recovery によってクラウドを構成する際に構成された設定を使用して、レプリケーションの再使用と再確立が行われます。


## デプロイのテスト

デプロイをテストするために、1 台の仮想マシンに対するテスト フェールオーバーを実行することや、複数の仮想マシンで構成される復旧計画を作成して、その計画のテスト フェールオーバーを実行することができます。  テスト フェールオーバーは、孤立したネットワークでフェールオーバーと復旧のシミュレーションを実行します。

### 復旧計画の作成

1.  **復旧計画** ] タブ、[ **復旧計画の作成**します。
2. 復旧計画の名前、ソースおよびターゲット VMM サーバーを指定します。 ソース サーバーには、フェールオーバーと復旧が有効になった仮想マシンが必要になります。 選択 **HYPER-V** HYPER-V レプリケーションが構成されたクラウドだけを表示します。

    ![復旧計画の作成](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_RP1.png)

3.  **仮想マシンの選択**, 、レプリケーション グループを選択します。 レプリケーション グループに関連付けられているすべての仮想マシンを選択し、復旧計画に追加します。 これらの仮想マシンは、復旧計画の既定のグループ "グループ 1" に追加されます。 必要な場合は、グループを追加できます。 レプリケーションの後、仮想マシンは復旧計画のグループの順序に従って起動することに注意してください。

    ![仮想マシンを追加](./media/site-recovery-vmm-to-vmm/ASRE2EHVR_RP2.png)

一覧に表示して復旧計画が作成された後、 **復旧計画** ] タブをクリックします。

###テスト フェールオーバーの実行

1.  **復旧計画** ] タブで、プランを選択し、クリックして **テスト フェールオーバー**します。
2.  **テスト フェールオーバーの確認** ] ページで、[ **None**します。 このオプションが有効な場合、フェールオーバーしたレプリカ仮想マシンはネットワークに接続されないことに注意してください。 このテストでは、仮想マシンが想定どおりにフェールオーバーすることをテストしますが、レプリケーションのネットワーク環境はテストしません。 方法を紹介 [テスト フェールオーバーを実行](site-recovery-failover.md#run-a-test-failover) 別のネットワーク オプションを使用する方法の詳細についてです。

7. レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。 これは、レプリカ仮想マシンが配置されているクラウドに追加されます。

### 復旧計画の実行
レプリケーション後、レプリカ仮想マシンは、プライマリ仮想マシンの IP アドレスとは異なる IP アドレスを保有しません。 仮想マシンは起動後に使用されている DNS サーバーを更新します。 タイムリーな更新を行うため、DNS サーバーを更新するスクリプトを追加することもできます。

#### IP アドレスを取得するスクリプト
次のサンプル スクリプトを実行して、IP アドレスを取得します。

        $vm = Get-SCVirtualMachine -Name <VM_NAME>
        $na = $vm[0].VirtualNetworkAdapters>
        $ip = Get-SCIPAddress -GrantToObjectID $na[0].id
        $ip.address  

#### DNS を更新するスクリプト
前のサンプル スクリプトを使用して取得した IP アドレスを指定して、次のサンプル スクリプトを実行し、DNS を更新します。

        string]$Zone,
        [string]$name,
        [string]$IP
        )
        $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
        $newrecord = $record.clone()
        $newrecord.RecordData[0].IPv4Address  =  $IP
        Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord



##<a name="privacy"></a>Site Recovery のプライバシー情報

次のセクションでは、Microsoft Azure Site Recovery サービス (以降、"本サービス") の追加のプライバシー情報を示します。 Microsoft Azure サービスのプライバシーに関する声明については、
[Microsoft Azure プライバシーに関する声明](http://go.microsoft.com/fwlink/?LinkId=324899)

**機能: 登録**

- **それが何**: 仮想マシンを保護できるように、サーバーがサービスを登録します
- **収集された情報**: 収集サービスの登録された後は、処理、VMM サーバー上の VMM サーバーのサービス名と仮想マシン クラウドの名前を使用して障害復旧を提供するように指定された VMM サーバーから管理証明書の情報を送信します。
- **情報の用途**:
    - 管理証明書: 登録済みの VMM サーバーを識別および認証して本サービスにアクセスできるようにするために使用します。 本サービスは、証明書の公開キー部分を使用して、登録済みの VMM サーバーのみがアクセスできるトークンをセキュリティで保護します。 サーバーは、このトークンを使用して本サービスの機能にアクセスする必要があります。
    - VMM サーバーの名前: VMM サーバー名は、クラウドが配置されている適切な VMM サーバーを識別し、この VMM サーバーと通信するために必要です。
    - VMM サーバーからのクラウド名: クラウド名は、以下に説明する本サービスのクラウドのペアリング/ペアリング解除機能を使用するときに必要になります。 プライマリ データ センターのクラウドを復旧データ センター内のクラウドとペアリングすることを決定した場合、復旧データ センターのすべてのクラウドの名前が表示されます。

- **選択肢**: お客様および本サービスが正しい登録済み VMM サーバーを識別できる、Azure Site Recovery 保護を提供する VMM サーバーを識別できるようにするため、この情報は、サービスの登録プロセスの重要な部分です。 この情報を本サービスに送信することを希望しない場合は、本サービスは使用しないでください。 サーバーを登録した後で登録を解除することを希望する場合は、サービス ポータル (Azure ポータル) から VMM サーバー情報を削除することができます。

**機能: Azure Site Recovery 保護を有効にする**

- **それが何**: VMM サーバーにインストールされている、Azure Site Recovery プロバイダーは、サービスと通信するためのパイプです。 プロバイダーは、VMM プロセスでホストされているダイナミック リンク ライブラリ (DLL) です。 プロバイダーをインストールすると、VMM 管理者コンソールで Datacenter Recovery 機能が有効になります。 クラウドのすべての新規または既存の仮想マシンでは、"Datacenter Recovery" という名前のプロパティを有効にすることで仮想マシンを保護できます。 このプロパティを設定すると、プロバイダーは、仮想マシンの名前と ID を本サービスに送信します。 仮想保護は、Windows Server 2012 または Windows Server 2012 R2 Hyper-V レプリケーション テクノロジによって実現されます。 仮想マシンのデータは、1 つの Hyper-V ホストから (通常は別の "復旧" データ センターにある) 別の Hyper-V ホストにレプリケートされます。

- **収集された情報**: 本サービスを収集、処理、および名前、ID、仮想ネットワークをクラウドの名前を含む仮想マシンのメタデータを送信
送信します。

- **情報の用途**: 本サービスは、上記の情報を使用して、サービス ポータルの仮想マシンの情報を設定します。

- **選択肢**: このサービスの重要な要素ですし、無効にすることはできません。 この情報を本サービスに送信することを希望しない場合は、すべての仮想マシンに対して Azure Site Recovery 保護を有効にしないでください。 プロバイダーによって本サービスに送信されるすべてのデータは、HTTPS を介して送信されます。

**機能: 復旧計画**

- **それが何**: この機能を使用すると、「復旧」データ センターのオーケストレーション計画を作成できます。 仮想マシンまたは仮想マシンのグループを復旧サイトで起動する順序を定義できます。 さらに、各仮想マシンの復旧時に、実行する任意の自動化スクリプトまたは任意の手動による操作を指定することができます。 フェールオーバー (次のセクションで説明します) は、通常、調整された復旧を行う復旧計画レベルでトリガーされます。

- **収集された情報**: 本サービスを収集、処理、およびバーチャル マシンのメタデータと、自動スクリプトおよび手動アクションのメモのメタデータを含む、復旧計画のメタデータを送信します。

- **情報の用途**: 上記で説明したメタデータは、サービス ポータルで復旧計画の構築に使用します。

- **選択肢**: このサービスの重要な要素ですし、無効にすることはできません。 この情報を本サービスに送信することを希望しない場合は、本サービスで復旧計画を作成しないください。

**機能: ネットワーク マッピング**

- **それが何**: この機能では、プライマリ データ センターから復旧データ センターへのネットワークの情報をマップすることができます。 このマッピングは、仮想マシンを復旧サイトで復旧するときにネットワーク接続を確立するために使用できます。

- **収集された情報**: ネットワーク マッピング機能の一部として、サービスを収集、処理、および送信の各サイト (プライマリとデータ センター) の論理ネットワークのメタデータ。

- **情報の用途**: 本サービスが、サービス ポータルの設定にで、メタデータを使用して、ネットワークの情報をマップすることができます。

- **選択肢**: このサービスの重要な要素ですし、無効にすることはできません。 この情報を本サービスに送信することを希望しない場合は、ネットワーク マッピング機能を使用しないでください。

**機能: フェールオーバー - 計画済み、計画外、テスト**

- **それが何**: この機能は、仮想マシンのフェールオーバーを 1 つの VMM 管理対象データ センターから別の VMM 管理対象データ センターに役立ちます。 フェールオーバー アクションは、サービス ポータル上のユーザーによってトリガーされます。 フェールオーバーは、計画外のイベント (たとえば、自然災害)、計画されたイベント (たとえば、データ センターの負荷分散)、テスト フェールオーバー (たとえば、復旧計画のリハーサル) などの理由で発生します。

VMM サーバー上のプロバイダーは、本サービスからイベントの通知を受け取ると、VMM インターフェイスを介して Hyper-V ホスト上でフェールオーバー アクションを実行します。 1 つの Hyper-V ホストから (通常は別の "復旧" データ センターで実行されている) 別の Hyper-V ホストへの実際のフェールオーバーは、Windows Server 2012 または Windows Server 2012 R2 Hyper-V レプリケーション テクノロジによって処理されます。 フェールオーバーが完了した後、"復旧" データ センターの VMM サーバーにインストールされているプロバイダーから処理の成功を示す情報が本サービスに送信されます。

- **収集された情報**: 本サービスは、上記の情報を使用して、サービス ポータルのフェールオーバー アクション情報の状態を設定します。

- **情報の用途**: 本サービスは、上記の情報を次のようには。

    - 管理証明書: 登録済みの VMM サーバーを識別および認証して本サービスにアクセスできるようにするために使用します。 本サービスは、証明書の公開キー部分を使用して、登録済みの VMM サーバーのみがアクセスできるトークンをセキュリティで保護します。 サーバーは、このトークンを使用して本サービスの機能にアクセスする必要があります。
    - VMM サーバーの名前: VMM サーバー名は、クラウドが配置されている適切な VMM サーバーを識別し、この VMM サーバーと通信するために必要です。
    - VMM サーバーからのクラウド名: クラウド名は、以下に説明する本サービスのクラウドのペアリング/ペアリング解除機能を使用するときに必要になります。 プライマリ データ センターのクラウドを復旧データ センター内のクラウドとペアリングすることを決定した場合、復旧データ センターのすべてのクラウドの名前が表示されます。

- **選択肢**: このサービスの重要な要素ですし、無効にすることはできません。 この情報を本サービスに送信することを希望しない場合は、本サービスを使用しないでください。

