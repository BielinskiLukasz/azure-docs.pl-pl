<properties 
   pageTitle="Testability: サービス通信 | Microsoft Azure" 
   description="サービス間通信は、Service Fabric アプリケーションの重要な統合ポイントです。 この記事ではデザインの考慮事項とテスト手法について説明します。" 
   services="service-fabric" 
   documentationCenter=".net" 
   authors="vturecek" 
   manager="timlt" 
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="NA" 
   ms.date="08/25/2015"
   ms.author="vturecek"/>

# Service Fabric Testability シナリオ: サービス通信

マイクロサービスおよびサービス指向アーキテクチャ スタイルは、Service Fabric に無理なく適用できます。 このような種類の分散アーキテクチャでは、コンポーネント化されたマイクロサービス アプリケーションは、相互に通信する必要がある複数のサービスで構成されることが一般的です。 一般的に、最も単純な場合でも、ステートレス Web サービスとステートフル データ ストレージ サービスが最低限必要です。これらのサービスもまた、相互に通信する必要があります。

サービス間の通信はアプリケーションの重要な統合ポイントであり、各サービスは他のサービスに対してリモート API を公開します。 I/O を伴う一連の API 境界を操作するには、一般的に多少の注意と、テストと検証を十分に行う必要があります。 

分散システムでこれらのサービス境界を接続するときには、さまざまな考慮事項があります。

 - **トランスポート プロトコル**します。 相互運用性を高める HTTP か、スループットを最大化するカスタム バイナリ プロトコルか。
 - **エラー処理**します。 永続的なエラーと一時的なエラーの処理方法と、サービスを別のノードに移動したときに何が起きるか。
 - **タイムアウトと待機時間**します。 多層アプリケーションで、各サービス レイヤーがスタックからユーザーまでの待機時間をどのように処理するか。

Service Fabric によって提供されるいずれかの組み込みサービス通信コンポーネントを使用するか、独自のコンポーネントを構築してサービス間の統合をテストすることは、アプリケーションの回復セキュリティを確保するための重要な部分です。

## サービスが存在する場所

サービス インスタンスは時間の経過と共に移動します (特に、カスタム調整された最適なリソース分散のためのロード メトリックが構成されている場合)。 アップグレード、フェールオーバー、スケール アウト、および分散システムの有効期間に発生するその他のさまざまな状況では、Service Fabric がサービス インスタンスを移動してサービス インスタンスの可用性を最大化します。

サービスはクラスター全体を移動するため、クライアントやその他サービスは、サービスとの通信時に対応できるように、2 つのシナリオに合わせて準備する必要があります。

 + サービス インスタンスまたはパーティション レプリカが、前回の通信時から移動している場合。 これはサービスのライフサイクルの正常な処理であり、アプリケーションの有効期間中に発生することが予想されます。
 + サービス インスタンスまたはパーティション レプリカが移動の処理中である場合。 1 つのノードから別のノードへのサービスのフェールオーバーは Service Fabric で非常に高速に行われますが、通信コンポーネントの開始に時間がかかると、可用性にかかわる遅延が発生する場合があります。

これらのシナリオを正しく処理することは、システムのスムーズな実行にとって重要です。 そのためには、次のようないくつかの点を考慮する必要があります。

+ すべてのサービスに接続できるは、 *アドレス* (HTTP、Websocket など) 上でリッスンします。 サービス インスタンスまたはパーティションが移動した場合、アドレス エンドポイントが変わります (別の IP アドレスを持つ別のノードに移動されています)。 組み込み通信コンポーネントを使用すると、コンポーネントは再解決するサービスのアドレスを処理します。 
+ サービス インスタンスがリスナーを再度開始するときに、移動後のサービスをどれだけ迅速に開始できるかに応じて、サービスの待機時間が一時的に増加する可能性があります。
+ 新しいノードでサービスが開いたとき、既存の接続は閉じてからもう一度開く必要があります。 グレースフル ノードのシャットダウンまたは再起動では、既存の接続を正常にシャットダウンするための時間が与えられます。

### テスト: サービス インスタンスの移動

Service Fabric の Testability ツールを使用して、このような状況をさまざまな方法でテストするためのテスト シナリオを作成できます。

1. ステートフル サービスのプライマリ レプリカを移動します。
 
    ステートフル サービス パーティションのプライマリ レプリカは、さまざまな理由で移動できます。 これを使用して、特定のパーティションのプライマリ レプリカをターゲットとし、サービスが移動にどのように反応するかを高度に制御された方法で確認します。

    ```powershell

    PS > Move-ServiceFabricPrimaryReplica -PartitionId 6faa4ffa-521a-44e9-8351-dfca0f7e0466 -ServiceName fabric:/MyApplication/MyService

    ```

2. ノードを停止します。

    ノードが停止すると、そのノード上にあったすべてのサービス インスタンスやパーティションが、Service Fabric によって、クラスター内の他の使用可能なノードのいずれかに移されます。 このシナリオを使用して、ノードがクラスターから失われ、そのノード上のすべてのサービス インスタンスとレプリカを移動する必要がある状況をテストできます。

    ノードは Stop-ServiceFabricNode PowerShell コマンドレットを使用して停止できます。

    ```powershell

    PS > Restart-ServiceFabricNode -NodeName Node.1

    ```

    
    


### サービスの可用性

Service Fabric は、サービスの高可用性を実現するように設計されたプラットフォームです。 ただし、基盤となるインフラストラクチャの問題が原因で、極端な場合は利用可能性が損なわれる可能性があります。 そのため、このようなシナリオについてテストすることも重要です。

ステートフル サービスは、クォーラム ベースのシステムを使用して、高可用性の状態をレプリケートします。 つまり、書き込み操作を実行するためには、レプリカのクォーラムを使用できる必要があります。 広範囲にわたるハードウェアの障害などのまれなケースで、レプリカのクォーラムを使用できない場合があります。 この場合、書き込み操作を実行することはできませんが、読み取り操作は実行できます。

### テスト: 書き込み操作の可用性

Service Fabric の Testability ツールを使用すると、クォーラム損失を発生させるエラーを挿入して、この種のシナリオをテストできます。 まれですが、ステートフル サービスに依存するクライアントとサービスは、ステートフル サービスに書き込み要求ができない状況になることがあり、そのような状況に対処できるように準備しておくことが重要です。 同時に、ステートフル サービス自体がこのような可能性を認識し、呼び出し元に対してグレースフルな通知を行えることも重要です。 

クォーラム損失は、Invoke-ServiceFabricPartitionQuorumLoss PowerShell コマンドレットを使用して発生させることができます。

```powershell

PS > Invoke-ServiceFabricPartitionQuorumLoss -ServiceName fabric:/Myapplication/MyService -QuorumLossMode PartialQuorumLoss -QuorumLossDurationInSeconds 20

```

この例では、`QuorumLossMode` を `PartialQuorumLoss` に設定して、すべてのレプリカを停止させることなくクォーラム損失を発生させることを指示します。こうすることで、読み取り操作は引き続き可能です。 パーティション全体が使用できない状況をテストする場合は、このスイッチを `FullQuorumLoss` に設定することができます。

## 次のステップ

[Testability アクションの詳細](service-fabric-testability-actions.md)

[Testability シナリオの詳細](service-fabric-testability-scenarios.md) 

