<properties 
    pageTitle="Azure Search でファセット ナビゲーションを実装する方法 |Microsoft Azure |ホスト型クラウド検索サービス" 
    description="Microsoft Azure のホスト型クラウド検索サービスである Azure Search と統合するアプリケーションにファセット ナビゲーションを追加します。" 
    services="search" 
    documentationCenter="" 
    authors="HeidiSteen" 
    manager="mblythe" 
    editor=""/>

<tags 
    ms.service="search" 
    ms.devlang="rest-api" 
    ms.workload="search" 
    ms.topic="article" 
    ms.tgt_pltfrm="na" 
    ms.date="11/04/2015" 
    ms.author="heidist"/>


# Azure Search でファセット ナビゲーションを実装する方法

ファセット ナビゲーションは、検索アプリケーションで自律型のドリルダウン ナビゲーションを提供するフィルター処理メカニズムです。 "ファセット ナビゲーション" という用語は聞き慣れないかもしれませんが、おそらくこれまでに使用したことがある機能です。 次の例に示すように、ファセット ナビゲーションは結果のフィルター処理に使用されるカテゴリです。

## 外観

 ![][1]

ファセットを使用すると探しているものを見つけることができ、結果がゼロにならないことが保証されます。 開発者は、ファセットを使用することで検索コーパスのナビゲーションに最も有用な検索条件を公開できます。 オンライン小売アプリケーションでは、ブランド、カテゴリ (子ども用の靴など)、サイズ、価格、人気、評価などに対してファセット ナビゲーションが作成されることがよくあります。

ファセット ナビゲーションの実装は検索テクノロジによって異なり、非常に複雑な場合があります。 
Azure Search のファセット ナビゲーションは、スキーマで事前に指定されている属性フィールドを使用して、クエリ時に作成されます。 アプリケーションで作成するクエリでは、*ファセット クエリ パラメーター*を送信して、そのドキュメント結果セットに対して使用できるファセット フィルターの値を受け取る必要があります。 セットを実際にドキュメントの結果をトリミングする、アプリケーションを適用する必要があります、 `$filter` 式です。

アプリケーション開発の観点からは、クエリを構成するコードの記述が作業のかなりの部分を占めます。 範囲の設定やファセットの結果の数の取得の組み込みサポートなど、ファセット ナビゲーションによるアプリケーション動作の多くは、サービスによって提供されます。 また、サービスには、ナビゲーション構造が扱いにくくなるのを防ぐ実用的な既定値も含まれています。

実際に体験をお勧め CodePlex でこのサンプル: [Azure Search AdventureWorks カタログ](https://azuresearchadventureworksdemo.codeplex.com/)

ご覧 [Azure Search Deep Dive](http://channel9.msdn.com/Events/TechEd/Europe/2014/DBI-B410)します。 45:25 の部分に、ファセットの実装方法のデモがあります。

この記事の内容は次のとおりです。

- [それをビルドする方法](#howtobuildit)
- [プレゼンテーション層を構築します。](#presentationlayer)
- [インデックスを作成します。](#buildindex)
- [データ品質のチェック](#checkdata)
- [クエリを作成します。](#buildquery)
- [ファセット ナビゲーションを制御する方法に関するヒント](#tips)
- [範囲の値に基づくファセット ナビゲーション](#rangefacets)
- [GeoPoints に基づくファセット ナビゲーション](#geofacets)
- [試してみる](#tryitout)

## 使用する理由

最も効果的な検索アプリケーションは、検索ボックス以外に複数の操作モデルを備えています。 ファセット ナビゲーションは検索機能へのもう 1 つのエントリ ポイントであり、複雑な検索式を手入力しなくてもよい便利な機能を提供します。

## 基本の理解

初めて検索機能を開発する場合、ファセット ナビゲーションは自律的な検索機能の可能性を示していると考えるのが最も適切です。 ファセット ナビゲーションは、定義済みのフィルターに基づくドリルダウン検索エクスペリエンスの一種であり、ポイント アンド クリック操作によって検索結果をすばやく絞り込むために使用されます。

**操作モデル**

ファセット ナビゲーションの検索エクスペリエンスは反復的であるため、最初はユーザーの操作に対応して展開する一連のクエリとして理解しておくとよいでしょう。

起点となるのはファセット ナビゲーションを提供するアプリケーション ページであり、通常はページの周囲に配置されます。 ファセット ナビゲーションは、多くの場合、値ごとにチェック ボックスを備えた、またはクリック可能なテキストによる、ツリー構造をしています。

1.  Azure Search に送信されるクエリでは、1 つまたは複数のファセット クエリ パラメーターによってファセット ナビゲーションの構造を指定します。 など、クエリに含めることがあります `ファセットの評価を =`, 、おそらく、 `: 値` または `: 並べ替え` プレゼンテーションをさらに調整するためのオプションです。
2.  プレゼンテーション層は、要求で指定されているファセットを使用して、ファセット ナビゲーションを提供する検索ページを表示します。
3.  Rating を含むファセット ナビゲーション構造の場合、ユーザーが「4」をクリックすると、評価が 4 以上の商品のみを表示することを示します。
4.  アプリケーションを含むクエリの送信応答として、 `$filter = ge 4 の星評価`
5.  プレゼンテーション層はページを更新し、新しい条件を満たす項目だけを含む絞り込まれた結果セットを表示します (この場合は、評価が 4 以上の商品)。

ファセットはクエリ パラメーターですが、クエリ入力と間違えないでください。 クエリでの選択条件としては使用されません。 ファセット クエリ パラメーターは、応答で返されるナビゲーション構造への入力と考えてください。 提供されるファセット クエリ パラメーターごとに、Azure Search は各ファセット値に対する部分的な結果に含まれるドキュメントの数を評価します。

通知、 `$filter` 手順 4 でします。 これは、ファセット ナビゲーションの重要な側面です。 ファセットとフィルターは API では独立していますが、意図したエクスペリエンスを提供するには両方とも必要です。

**設計パターン**

アプリケーション コードでのパターンは、ファセット クエリ パラメーターを使用してファセット結果と共にファセット ナビゲーション構造を返し、さらに $filter 式を使用してクリック イベントを処理するというものです。 考えてみてください、 `$filter` 、プレゼンテーション層に返される検索結果の実際のトリミングの背後にあるコードとしての式。 色ファセットを指定するには、赤の色をクリックするとはによって実装され、 `$filter` 赤の色を持つ項目のみを選択する式です。

**Azure Search でのクエリの基本**

Azure Search では、要求が 1 つまたは複数のクエリ パラメーターによって指定されます (を参照してください [ドキュメントの検索](http://msdn.microsoft.com/library/azure/dn798927.aspx) のそれぞれの説明)。 どのクエリ パラメーターも必須ではありませんが、クエリが有効であるためには少なくとも 1 つのクエリ パラメーターが必要です。

一般に関係のないヒットを除外する能力として理解される正確さは、以下の式の一方または両方によって実現されます。

- **search =**<br/>
このパラメーターの値は、検索式を構成します。 単一のテキスト、または複数の語句と演算子を含む複雑な検索式を指定できます。 サーバーでは、検索式を使用してフルテキスト検索が実行され、インデックスの検索可能なフィールドで一致する語句がクエリされて、ランクの順序で結果が返されます。 設定した場合 `検索` を null にすると、クエリの実行は、インデックス全体に対して (つまり、 `検索 = *`)。 この場合は、クエリの他の要素など、 `$filter` やスコアリング プロファイルされる、ドキュメントの影響を与える主要因が返される `($filter`) およびその順序 (`scoringProfile` または `$orderb`y)。

- **$filter =**<br/>
フィルターは、特定のドキュメントの属性の値に基づいて検索結果のサイズを制限するための強力なメカニズムです。 A `$filter` が最初に評価され、その後、使用可能な値とそれぞれの値に対応する数を生成するファセット ロジック

複雑な検索式は、クエリのパフォーマンスを低下させます。 可能な限り、正確さとクエリのパフォーマンスが向上するように、適切に構成されたフィルター式を使用してください。

フィルターによってどのように正確さが向上するのかをよく理解するため、次のような複雑な検索式とフィルター式を含む式を比較してみてください。

- `GET/indexes/hotel/docs? 検索 = 宿泊予算 + シアトル – motel + 駐車場`

- `GET/indexes/hotel/docs? 検索 = 宿泊 & $filter = City eq 'Seattle' と駐車場と型の ne 'motel'`

どちらのクエリも有効ですが、シアトルで駐車場のあるモーテル以外を探している場合は 2 番目の方が優れています。 1 番目のクエリは、Name や Description などの文字列フィールドおよび検索可能なデータを含む他のフィールドにおいて、特定の単語が言及されている、または言及されていないことに依存します。 2 番目のクエリは、構造化されたデータで正確な一致を検索し、より正確であると考えられます。

ファセット ナビゲーションを含むアプリケーションでは、ファセット ナビゲーション構造に対する各ユーザー操作の結果として、フィルター式により検索結果が絞り込まれることが期待されます。

<a name="howtobuildit"></a>
## 構築方法

Azure Search でのファセット ナビゲーションは、要求を作成するアプリケーション コードで実装されますが、スキーマ内の定義済みの要素に依存します。

定義済みのインデックスは、検索に、 `Facetable [true | false]` インデックスの属性を有効または無効、ファセット ナビゲーション構造での使用に選択したフィールドに設定します。 せず `「ファセット」= true`, 、ファセット ナビゲーションで、フィールドは使用できません。

アプリケーション コードを含む要求の作成、クエリ時に `ファセット = [string]`, 、ファセットに使用するフィールドを提供する要求パラメーターです。クエリでは、複数のファセットをなどが `& ファセット = 色 & ファセット = カテゴリ & ファセット = 評価`, 、アンパサンド (&) 文字で区切られた 1 つずつです。

アプリケーション コードを構築する必要がありますも、 `$filter` ファセット ナビゲーションでのクリック イベントを処理する式。 A `$filter` フィルター条件としてファセット値を使用して、検索結果を減らします。

Azure Search は、ユーザーが入力した語句ごとの検索結果と共に、ファセット ナビゲーション構造への更新を返します。 Azure Search でのファセット ナビゲーションは、単一レベルの構造、ファセット値、そして各ファセット値に対して見つかった結果の数です。

コードのプレゼンテーション層は、ユーザー エクスペリエンスを提供します。 プレゼンテーション層では、ラベル、値、チェック ボックス、数など、ファセット ナビゲーションを構成する各部分を表示する必要があります。 Azure Search REST API はプラットフォームに依存しないので、好みの言語とプラットフォームを何でも使用できます。 重要なことは、新しいファセットが選択されて UI 状態が更新されたときの増分更新をサポートする UI 要素を含めるです。

以下のセクションでは、プレゼンテーション層から始めて、各部分の作成方法を詳しく見ていきます。

<a name="presentationlayer"></a>
## プレゼンテーション層の構築

プレゼンテーション層から再度作業することで、見落としているかもしれない要件を明らかにし、検索エクスペリエンスに不可欠な機能を理解するのに役立ちます。

ファセット ナビゲーションでは、Web ページまたはアプリケーション ページがファセット ナビゲーション構造を表示し、ページでのユーザー入力を検出し、変更された要素を挿入します。

Web アプリケーションの場合は、増分変更を更新できるので、一般に AJAX がプレゼンテーション層に使用されます。 また、ASP.NET MVC または HTTP 経由で Azure Search サービスに接続できる他の視覚化プラットフォームを使用することもできます。 この記事全体で参照されているサンプル アプリケーション **AdventureWorks Catalog** は、ASP.NET MVC アプリケーションです。

サンプル アプリケーションの **index.cshtml** ファイルから抜粋した次の例では、検索結果ページにファセット ナビゲーションを表示するための動的な HTML 構造を作成しています。 サンプルでは、ファセット ナビゲーションは検索結果ページに組み込まれており、ユーザーが検索語句を送信した後で表示されます。

各ファセットは、ファセット フィールド (color、categoryName、listPrice) へのバインドおよび、ラベル (Colors、Categories、Prices) を持ち `.count` パラメーター、そのファセット結果に対して見つかった項目の数を返すために使用します。

  ![][2]

> [AZURE.TIP] 検索結果ページを設計するときは、ファセットをクリアするためのメカニズムを追加することを忘れないでください。 チェック ボックスを使用すれば、ユーザーはフィルターをクリアする方法が簡単にわかります。 その他のレイアウトでは、階層リンク パターンや別の創造的な方法が必要になる場合があります。 たとえば、AdventureWorks Catalog サンプル アプリケーションでは、[AdventureWorks Catalog] というタイトルをクリックして検索ページをリセットできます。

<a name="buildindex"></a>
## インデックスの作成

このインデックスの属性を使用して、インデックスのフィールドごとに、ファセットが有効になっている: `「ファセット」: true`します。  
ファセット ナビゲーションで使用できる可能性のあるすべてのフィールド タイプは `Facetable` 既定です。 このようなフィールド型を含める `Edm.String`, 、`Edm.DateTimeOffset`, 、およびすべての数値フィールド タイプ (すべてのフィールド タイプの facetable 以外は基本的には、 `Edm.GeographyPoint`, 、ファセット ナビゲーションで使用できない)。

インデックスを作成するときのファセット ナビゲーションに関するベスト プラクティスは、ファセットとして使用できないようにするフィールドのファセットを明示的にオフにすることです。 具体的には、ID や製品名などのシングルトン値の文字列フィールドに設定する必要があります `「ファセット」: false` 、ファセット ナビゲーションで誤って (および非効率的な) 使用されないようにします。

AdventureWorks Catalog サンプル アプリケーションのスキーマを次に示します (全体のサイズを小さくするため、一部の属性は除いてあります)。

 ![][3]

注意 `Facetable` ID や名前など、ファセットとして使用してはならない文字列フィールドにオフにします。 必要のないフィールドのファセットをオフにすることで、インデックスのサイズが小さくなり、一般にパフォーマンスが向上します。
> [AZURE.TIP] ベスト プラクティスとしては、各フィールドのインデックス属性の完全なセットを含めます。  `Facetable` は既定で意識的に設定のほとんどすべてのフィールドの各属性を使用して、各スキーマの決定の影響を検討できます。 

<a name="checkdata"></a>
## データ品質のチェック

どのようなデータ中心アプリケーションでも、開発時には、データの準備が作業の大きな部分の 1 つになることがよくあります。 検索アプリケーションも例外ではありません。 データの品質は、ファセット ナビゲーションが意図したとおりに実現されるかどうか、および結果セットを削減するフィルターの作成に対するその有効性に、直接影響します。

Azure Search では、検索コーパスはインデックスを生成するドキュメントから作成されます。 ドキュメントは、ファセットの計算に使用される値を提供します。 Brand または Price でファセットを行う場合は、各ドキュメントの *BrandName* および *ProductPrice* に、フィルター オプションとして有効で、整合性があり、意味のある値が含まれる必要があります。

品質向上のためには、次のようなことに注意する必要があります。

- ファセットに使用する予定のすべてのフィールドについて、自律型検索のフィルターとして適切な値が含まれるかどうかを検討します。 値は、短く、わかりやすく、競合するオプションから 1 つを明確に選択できる十分に特徴的なものである必要があります。
- スペル ミスまたはよく似た値。 Color をファセットとして使用し、フィールド値に Orange と Ornage (スペルミス) が含まれる場合、Color フィールドに基づくファセットでは両方が選択されます。
- 大文字と小文字が混在するテキストによっても、ファセット ナビゲーションに大きな支障が出る可能性があります。orange と Orange は 2 つの異なる値として表示されます。
- 同じ値の単数形と複数形は、それぞれが別のファセットになる場合があります。

ご想像のとおり、手を抜かずにデータを準備することが、効果的なファセット ナビゲーションにとって不可欠な要素です。

<a name="buildquery"></a>
## クエリの作成

クエリを作成するために記述するコードでは、検索式、ファセット、フィルター、スコアリング プロファイルなど、要求の作成に使用されるすべてのものを含む有効なクエリのすべての部分を指定する必要があります。 このセクションでは、クエリ内でのファセットの位置と、結果セットを削減するためのファセットでのフィルターの使用方法について説明します。

通常は、例から始めるのがよい方法です。 **CatalogSearch.cs** ファイルから抜粋した次の例では、Color、Category、Price に基づいてファセット ナビゲーションを作成する要求を作成します。

ファセットはこのサンプル アプリケーションに不可欠であることに注意してください。 AdventureWorks Catalog の検索エクスペリエンスは、ファセット ナビゲーションとフィルターを中心に設計されています。 これは、ファセット ナビゲーションがページ内で目立つように配置されていることからも明らかです。 サンプル アプリケーションには、Search メソッド (サンプル アプリケーションで作成されています) のプロパティとしてファセット (色、カテゴリ、価格) に対する URI パラメーターが含まれます。

  ![][4]

ファセット クエリ パラメーターは、フィールドに設定され、に応じてデータ型、さらにパラメーター化できるを含むコンマ区切りリストによって `数: < 整数 >`, 、`並べ替え: <>`, 、`間隔: < 整数 >`, 、および  `値: < リスト >`します。値リストは、範囲を設定するときに数値データに対してサポートされます。参照してください [ドキュメントの検索 (Azure Search API)](http://msdn.microsoft.com/library/azure/dn798927.aspx) 使用の詳細について。

アプリケーションで作成する要求では、ファセットだけでなく、ファセット値の選択に基づいて候補ドキュメントのセットを絞り込むフィルターも作成する必要があります。 自転車ストアの場合、ファセット ナビゲーションでは「どのような色、製造元、および種類の自転車が手にはいるか」のような質問への手掛かりが提供されるのに対し、フィルター処理は「赤、マウンテン バイク、特定の価格範囲という条件を満たす自転車」のような質問に回答します。

ユーザーは、赤い商品だけを表示するように指示するには、"Red"をクリックすると、アプリケーションを送信する次のクエリが含まれます `$filter = 色 eq 'Red'`します。

## ファセット ナビゲーションのベスト プラクティス

ベスト プラクティスを次にまとめます。

- **有効桁数**<br/>
フィルターを使用します。 検索式にのみ依存すると、どのフィールドにも正確なファセット値が含まれないドキュメントが語幹検索で返される可能性があります。

- **対象のフィールド**<br/>
ファセットのドリル ダウンでは、通常入力のみを検索可能なすべてのフィールドにわたっていない任意の場所、特定の (ファセット) フィールドにファセット値を持つドキュメントが含まれます。 フィルターを追加すると、ファセット フィールドでのみ一致する値を検索するようにサービスに指示されて、ターゲット フィールドがいっそう限定されます。

- **インデックスの効率性**<br/>
アプリケーションが排他的ファセット ナビゲーションを使用する場合 (つまり、検索ボックスなし)、ものとしてフィールドをマークする `検索可能な = false`, 、`facetable = true` よりコンパクトなインデックスを生成します。 さらに、インデックスの作成はファセット値全体に対してのみ行われ、単語の区切りや、複数の単語からなる値のコンポーネント部分のインデックス作成は行われません。

- **パフォーマンス**<br/>
フィルターは、検索の候補ドキュメントのセットを絞り込むし、それらをランキングから除外します。 ドキュメント セットが大きい場合、非常に限定的なファセット ドリルダウンを使用すると、パフォーマンスが著しく向上することがよくあります。


<a name="tips"></a>
## ファセット ナビゲーションの制御方法に関するヒント

特定の問題についてのガイダンスを含むヒントを以下に示します。

**ファセット ナビゲーションの各フィールドのラベルを追加する**

通常、ラベルは HTML またはフォームで定義されます (サンプル アプリケーションでは **index.cshtml**)。 Azure Search には、ファセット ナビゲーションのラベル用または他の種類のメタデータ用の API はありません。

**ファセットとして使用できるフィールドを定義する**

インデックスのスキーマによってファセットとして使用できるフィールドが決まることを思い出してください。 フィールドがファセット可能である場合、クエリではファセットに使用するフィールドを指定します。 ファセットに使用しているフィールドは、ラベルの下に表示される値を提供します。

各ラベルの下に表示される値は、インデックスから取得されます。 たとえば、ファセット フィールドが *Color* である場合、追加のフィルター処理に使用できる値は (Red、Black など) はそのフィールドの値になります。

数値および日時値についてのみ、明示的に値を設定できます、ファセット フィールドに (たとえば、 
`ファセット = 評価は、値: 1|2|3|4|5`)。 このようなフィールドの種類に値の一覧を使用して、ファセット結果の分離を連続する範囲 (数値に基づく範囲または時間の期間) に単純化できます。

**ファセットの結果をトリミングする**

ファセットの結果は、ファセット語句に一致する検索結果で見つかったドキュメントです。 *cloud computing* の検索結果を示す次の例では、254 個の項目は Content type も *Internal specification* で一致しています。 項目は必ずしも相互に排他的ではありません。 1 つの項目が両方のフィルターの条件を満たしている場合、その項目はそれぞれにカウントされます。 これは、可能な場合にファセット処理で発生 `Collection(Edm.String)` フィールドで、多くの場合、ドキュメントのタグ付けの実装に使用します。

        Search term: "cloud computing"
        Content type
           Internal specification (254)
           Video (10) 

一般に、ファセットの結果がなかなか小さくならない場合は、前のセクションで説明したようにフィルターを増やして、検索をさらに絞り込むためのオプションをアプリケーション ユーザーに提供することをお勧めします。

**ファセット ナビゲーションの項目を制限する**

ナビゲーション ツリーの各ファセット フィールドの値は、既定で 10 個に制限されています。 この既定値は、値のリストが管理しやすいサイズに保たれるため、ナビゲーション構造にとって意味のあるものです。 count に値を割り当てることによって、既定値をオーバーライドできます。

- `& ファセット市区町村、数: 5 =` 、上位ランクの結果で見つかった最初の 5 つの都市のみが、ファセットの結果として返されることを指定します。クエリが指定されている場合に、検索語句が"airport"で 32 の一致を指定 `& ファセット市区町村、数: 5 =`, 、検索結果のドキュメントを最大限に最初の 5 つの一意な都市のみが、ファセットの結果に含まれます。

ファセットの結果と検索結果の違いに注意してください。 検索結果は、クエリに一致するすべてのドキュメントです。 ファセットの結果は、各ファセットの値と一致するものです。 この例では、検索結果には、ファセット分類リスト (この例では 5) に含まれていない都市名が含まれます。 ファセット ナビゲーションによって除外された結果は、ユーザーがファセットをクリアするか、または都市以外の他のファセットを選択することによって、表示されるようになります。
> [AZURE.NOTE] 説明 `カウント` 1 種類以上が混乱する可能性がある場合。 Azure Search API、サンプル コード、ドキュメントで count が使用される方法についてのまとめを以下に示します。 

- `@colorFacet.count`<br/>
プレゼンテーション コードでは、ファセット結果の数を表示するため、ファセットの count パラメーターが表示されます。 ファセットの結果では、count はファセットの語句または範囲に一致するドキュメントの数を示します。

- `& ファセット = 市区町村、count: 12`<br/>
ファセット クエリでは、値に数を設定することができます。 既定値は 10 ですが、これより大きい値または小さい値を設定できます。 設定 `数: 12` ドキュメント数によるファセットの結果で上位 12 個が一致する取得します。

- "`@odata.count`"<br/>
クエリの応答では、この値は、検索結果において一致する項目の数を示します。 検索語句とは一致しても、ファセット値とは一致しない項目が存在するため、平均すると、この値はすべてのファセット結果を組み合わせた合計より大きくなります。


**ファセット ナビゲーションでのレベル**

前に説明したように、階層でのファセットの入れ子は直接サポートされません。 既定では、ファセット ナビゲーションは 1 レベルのフィルターのみをサポートします。 ただし、回避策は存在します。 階層的なファセット構造をエンコードすることができます、 `Collection(Edm.String)` ポイントの階層あたり 1 つのエントリを使用します。 この回避策の実装はこの記事の範囲を超えて読むことができますでのコレクションに関する [の例で OData](http://msdn.microsoft.com/library/ff478141.aspx)します。

**フィールドの検証**

ファセット フィールドの名前が有効で、または、いずれかを使用して Url を構築するときに名前をエスケープを検証する必要がありますか、信頼できないユーザー入力に基づいて動的にファセットのリストを作成する場合は、 `Uri.EscapeDataString()` .NET、または任意のプラットフォームのそれと同等です。

**ファセットの結果での数**

をファセット クエリにフィルターを追加するとき、ファセット ステートメントを保持する場合 (たとえば、 `ファセット = 評価 & $filter = ge 4 の星評価`)。技術的には、facet=Rating は必要ありませんが、残しておくと、レーティング 4 以上に対するファセット値の数が返されます。たとえば、ユーザーが "4" をクリックし、クエリに "4" 以上に対するフィルターが含まれる場合、4 以上の各レーティングに対する数が返されます。

**ファセットの数に対するシャーディングの影響**

状況によっては、ファセットの数には、結果セットと一致しないことを見つけることがあります (を参照してください [(フォーラムの投稿) の Azure Search のファセット ナビゲーション](https://social.msdn.microsoft.com/Forums/azure/06461173-ea26-4e6a-9545-fbbd7ee61c8f/faceting-on-azure-search?forum=azuresearch))します。

シャーディング アーキテクチャのために、ファセットの数が正しくなくなる可能性があります。 すべての検索インデックスに複数のシャードがあり、それぞれがドキュメント数によって上位 N ファセットを報告すると、単一の結果に結合されます。 一部のシャードの一致値が多く、他のシャードは少ない場合、一部のファセットの値が結果に含まれないか、または数が少なくなる可能性があります。

今日この現象が発生した場合、この動作はいつでも変更でした、することができることによって回避意図的に数を増やして:<number> 各シャードから完全にレポートを強制する非常に大きい数にします。count: の値がフィールドの固有の値の数と等しいかそれより大きい場合、正確な結果が保証されます。ただし、ドキュメントの数が非常に大きい場合はパフォーマンスが低下するので、このオプションは注意して使用する必要があります。

<a name="rangefacets"></a>
## 範囲の値に基づくファセット ナビゲーション

検索アプリケーションでは範囲に対するファセットが一般に必要になります。 範囲は、数値データおよび日時値に対してサポートされています。 詳細にそれぞれの方法に関する [ドキュメントの検索 (Azure Search API)](http://msdn.microsoft.com/library/azure/dn798927.aspx)します。

Azure Search では、範囲を計算する 2 つの方法が提供されており、簡単に範囲を作成できます。 どちらの方法でも、ユーザーが提供する入力に基づいて Azure Search が適切な範囲を作成します。 たとえば、範囲の値として 10|20|30 を指定すると、自動的に 0 -10、10-20、20-30 という範囲が作成されます。 サンプル アプリケーションでは、空の間隔は削除されます。

**方法 1: 間隔パラメーターを使用します。**<br/>
$10 刻みの価格ファセットを設定するには指定: `& ファセット価格、間隔: 10 =`


**方法 2: は、値の一覧を使用します。**<br/>
数値データ値の一覧を使用することができます。 次のように表示される ListPrice のファセット範囲について考えます。

  ![][5]

範囲は、値リストを使用して **CatalogSearch.cs** ファイルで指定されています。

    facet=listPrice,values:10|25|100|500|1000|2500

各範囲は始点として 0 を、終点としてリストの値を使用して作成され、前の範囲を除くことによって個別の間隔が作成されます。 Azure Search は、ファセット ナビゲーションの一部としてこれを行います。 各間隔を作成するためのコードを記述する必要はありません。

### ファセット範囲のフィルターの作成

ユーザーが選択した範囲に基づいてドキュメントをフィルター処理するには、 `"ge"` と `"lt"` 範囲のエンドポイントを定義する 2 つの部分式の演算子をフィルター処理します。 たとえば、ユーザーが範囲 10 ~ 25 を選択した場合、フィルターなります `$filter = listPrice ge 10 および listPrice lt 25`します。

サンプル アプリケーションでは、フィルター式は **priceFrom** および **priceTo** パラメーターを使用して終点を設定しています。 **CatalogSearch.cs** の **BuildFilter** メソッドには、範囲内のドキュメントを提供するフィルター式が含まれます。

  ![][6]

<a name="geofacets"></a>
## GeoPoints に基づいてフィルターされたナビゲーション

現在の位置に近い店、レストラン、目的地を選択するのにフィルターが役立つことがよくあります。 この種のフィルターはファセット ナビゲーションのように見えますが、実際は単なるフィルターです。 ここでは、この特定の設計上の問題に対する実装に関する助言を求めているユーザーのためにこれについて説明します。

Azure Search には、**geo.distance** および **geo.intersects** という 2 つの地理空間関数があります。

- **geo.distance** 関数は、フィルターの一部として、1 つはフィールドで、もう 1 つは定数で渡される 2 つの点の間の距離を、キロメートル単位で返します。

- **geo.intersects** 関数は、指定された点が指定された多角形の内部にある場合は true を返します。点はフィールドとして、多角形は座標の定数リストとして指定されて、フィルターの一部として渡されます。

[フィルターの例を見つけることができます [OData 式の構文 (Azure Search)](http://msdn.microsoft.com/library/azure/dn798921.aspx)します。 地理空間検索の詳細については、次を参照してください。 [Azure Search で地理空間検索アプリを作成する](search-create-geospatial.md)します。

<a name="tryitout"></a>
## 実際に使ってみる

この記事で参照されている例は、Codeplex の Azure Search を使用した Adventure Works のデモに含まれます。 検索結果を使用するときは、クエリ構造での変更について URL をご覧ください。 このアプリケーションは、ユーザーが 1 つを選択すると URI にファセットを追加します。

1.  サンプル アプリケーションを構成する (を参照してください [手順については、最初のアプリケーションを作成する](search-create-first-solution.md))します。

    CatalogIndexer プロジェクトの Program.cs ファイルで定義されているスキーマに注意してください。 スキーマでは、color、listPrice、size、weight、categoryName、modelName がファセット可能なフィールドとして指定されています。 ファセット ナビゲーションで実際に実装されているのは、一部のフィールド (color、listPrice、categoryName) だけです。

3.  アプリケーションを実行します。

    最初は、検索ボックスだけが表示されます。 [Search] ボタンをクリックしてすべての結果を取得するか、または検索語句を入力できます。

    ![][7]

4.  「bike」のような検索語句を入力して、**[Search]** をクリックします。 クエリがすぐに実行されます。

    検索結果と共に、ファセット ナビゲーション構造も返されます。 URL では、Colors、Categories、Prices のファセットは null になっています。 検索結果ページでは、ファセット ナビゲーション構造には各ファセット結果の数が含まれます。

     ![][8]

5.  色、カテゴリ、および価格の範囲をクリックします。 最初の検索ではファセットは null ですが、ファセットが値を受け取ると、一致しない項目は検索結果から除外されます。 URI にクエリへの変更が反映されることに注意してください。

    ![][9]

6.  ファセット クエリをクリアして別のクエリ動作を試すには、ページの先頭にある **[AdventureWorks Catalog]** をクリックします。

    ![][10]

<a name="nextstep"></a>
## 次のステップ

知識を試してみるには、*modelName* のファセット フィールドを追加してみてください。 このファセットにはインデックスが既に設定されているので、インデックスを変更する必要はありません。 ただし、Models に対する新しいファセットを含むように HTML を変更し、クエリのコンストラクターにファセット フィールドを追加する必要があります。

ファセット ナビゲーションの設計の原則の詳細については、次のリンクをお勧めします。

- [ファセット検索のための設計](http://www.uie.com/articles/faceted_search/)
- [ファセット ナビゲーションの設計パターン:](http://alistapart.com/article/design-patterns-faceted-navigation)





[how to build it]: #howtobuildit 
[build the presentation layer]: #presentationlayer 
[build the index]: #buildindex 
[check for data quality]: #checkdata 
[build the query]: #buildquery 
[tips on how to control faceted navigation]: #tips 
[faceted navigation based on range values]: #rangefacets 
[faceted navigation based on geopoints]: #geofacets 
[try it out]: #tryitout 
[1]: ./media/search-faceted-navigation/Facet-1-slide.PNG 
[2]: ./media/search-faceted-navigation/Facet-2-CSHTML.PNG 
[3]: ./media/search-faceted-navigation/Facet-3-schema.PNG 
[4]: ./media/search-faceted-navigation/Facet-4-SearchMethod.PNG 
[5]: ./media/search-faceted-navigation/Facet-5-Prices.PNG 
[6]: ./media/search-faceted-navigation/Facet-6-buildfilter.PNG 
[7]: ./media/search-faceted-navigation/Facet-7-appstart.png 
[8]: ./media/search-faceted-navigation/Facet-8-appbike.png 
[9]: ./media/search-faceted-navigation/Facet-9-appbikefaceted.png 
[10]: ./media/search-faceted-navigation/Facet-10-appTitle.png 
[designing for faceted search]: http://www.uie.com/articles/faceted_search/ 
[design patterns: faceted navigation]: http://alistapart.com/article/design-patterns-faceted-navigation 
[create your first application]: search-create-first-solution.md 
[odata expression syntax (azure search)]: http://msdn.microsoft.com/library/azure/dn798921.aspx 
[create a geospatial search application in azure search]: search-create-geospatial.md 
[azure search adventure works demo]: https://azuresearchadventureworksdemo.codeplex.com/ 
[http://www.odata.org/documentation/odata-version-2-0/overview/]: http://www.odata.org/documentation/odata-version-2-0/overview/ 
[faceting on azure search forum post]: ../faceting-on-azure-search.md?forum=azuresearch 
[search documents (azure search api)]: http://msdn.microsoft.com/library/azure/dn798927.aspx 

