<properties
    pageTitle="Azure における VM バックアップ インフラストラクチャの計画を立てる | Microsoft Azure"
    description="Azure における VM バックアップ インフラストラクチャの計画を立てる際の重要な考慮事項"
    services="backup"
    documentationCenter=""
    authors="Jim-Parker"
    manager="jwhit"
    editor=""/>

<tags
    ms.service="backup"
    ms.workload="storage-backup-recovery"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="10/29/2015"
    ms.author="trinadhk; aashishr; jimpark; markgal"/>

# Azure における VM バックアップ インフラストラクチャの計画を立てる
この記事では、仮想マシン (VM) バックアップ インフラストラクチャの計画を立てる際に考慮すべき重要な事柄について取り上げます。 したら [、環境を準備](backup-azure-vms-prepare.md), 、開始する前に、次の手順は、この [の Vm をバックアップする](backup-azure-vms.md)です。 詳細については、Azure の仮想マシンを実行する場合を参照してください、 [Virtual Machines のドキュメント](https://azure.microsoft.com/documentation/services/virtual-machines/)します。

## Azure における仮想マシン バックアップの動作
Azure Backup サービスは、スケジュールされた時刻にバックアップ ジョブを開始し、バックアップ拡張機能をトリガーして特定時点のスナップショットを作成します。 このスナップショットは Volume Shadow Copy Service (VSS) と連携して作成されるため、シャットダウンせずに、仮想マシンに使用されているディスクの一貫したスナップショットを取得することができます。

スナップショットが作成されると、データは Azure Backup サービスによってバックアップコンテナーに転送されます。 バックアップ プロセスの効率を高めるために、前回のバックアップ以降に変更されたデータ ブロックが特定され、そのデータのみが転送されます。

![Azure 仮想マシンのバックアップ アーキテクチャ](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

データ転送が完了すると、スナップショットが削除され、回復ポイントが作成されます。

### データの一貫性
業務に不可欠なデータのバックアップと復元は、その生成元となるアプリケーションの実行中にバックアップを行う必要があるため簡単ではありません。 この課題に対処するために、Azure Backup は、VSS を使用してデータを正しくストレージに書き込むことにより、マイクロソフトのワークロードに対するアプリケーション整合性を確保しています。

>[AZURE.NOTE] Linux 仮想マシン用ファイル整合バックアップのみが可能であれば、Linux は vss と同等のプラットフォームではないため

Azure Backup は、Windows Vm 上で VSS 完全バックアップを受け取り (詳細について [VSS 完全バックアップ](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx))。 VSS コピー バックアップを有効にするには、VM に以下のレジストリ キーを設定する必要があります。

```
[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
"USEVSSCOPYBACKUP"="TRUE"
```


この表は、整合性の種類を一覧にしたものです。Azure VM のバックアップと復元で確保される状態をそれぞれ説明しています。

| 整合性 | VSS ベース | 説明と詳細 |
|-------------|-----------|---------|
| アプリケーション整合性 | あり | これは、確実にする、Microsoft ワークロードの理想的な整合性の種類です。<ol><li> VM *起動*します。 <li>ある *は破損しません*します。 <li>ある *データを失わない*します。<li> データが VSS を使用 - バックアップの時点でアプリケーションを含めることにより、データを使用するアプリケーションに一貫して</ol> ほとんどの Microsoft ワークロードには、データの整合性に関連するワークロードに固有の操作を実行する VSS ライターがあります。 たとえば、Microsoft SQL Server では、トランザクション ログ ファイルとデータベースへの書き込みが正常に行われることを保証 VSS ライターがあります。<br><br> Azure VM でアプリケーション整合性復旧ポイントを取得するバックアップはバックアップ拡張機能が、VSS ワークフローを呼び出すし、完了をできたこと *正しく* スナップショットが作成された VM の前にします。 当然ながら、つまり、Azure VM 内のすべてのアプリケーションの VSS ライターが同様に起動されたこと。<br><br>(説明、 [VSS の基本](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx) の詳細を深めて [しくみ](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx))。 |
| ファイル システム整合性 | あり - Windows ベースのコンピューターの場合 | 2 つのシナリオにおいて、回復ポイントがある *ファイル システムの一貫性のある*:<ul><li>Linux には vss と同等のプラットフォームがないため、Azure での Linux Vm のバックアップ<li>Windows Azure Vm のバックアップ中に VSS の障害。</li></ul> どちらの場合もいることを確認するが最善の対応を実行できます。 <ol><li> VM *起動*します。 <li>ある *は破損しません*します。<li>ある *データを失わない*します。</ol> アプリケーションでは、復元されたデータに対する独自の "修正" メカニズムを実装する必要があります。|
| クラッシュ整合性 | いいえ | この状況は、(ソフト リセットまたはハード リセットにより) 仮想マシンが "クラッシュ" した状況に相当します。 これは通常、バックアップ時に Azure 仮想マシンがシャットダウンされるときに発生します。 Azure 仮想マシンのバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、オペレーティング システムの観点からもアプリケーションの観点からも、ストレージ メディア上のデータの整合性に関して何も保証しないことを意味します。 バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。 <br/> <br/> ほとんどの場合、保証はありません、オペレーティング システムは起動します。 通常、その後に chkdsk などのディスク検査手順が実行され、破損エラーがあれば修正されます。 メモリ内にあったデータや、ディスクに完全にフラッシュされていなかったデータは、すべて失われます。 通常、アプリケーションは、データのロールバックを実行する必要がある場合に独自の検証メカニズムに従います。 <br><br>たとえば、トランザクション ログ エントリにある場合、データベースに存在しないものし、データベース ソフトウェアはロールバック データが一貫性のあるまで、します。 (スパン ボリュームのように) データが複数の仮想ディスクにまたがる場合、クラッシュ整合性の復旧ポイントは、データの正確性に関して何も保証しません。|


## パフォーマンスおよびリソース使用率
オンプレミスにデプロイされるバックアップ ソフトウェアと同様、Azure における VM のバックアップも、容量とリソースの使用率を考慮する必要があります。  [Azure ストレージの制限](azure-subscription-service-limits.md#storage-limits) ワークロードを実行するへの影響を最小に最大限のパフォーマンスへの VM の展開を構成する方法を定義します。

バックアップのパフォーマンスに影響を与える Azure Storage の制限には、主に次の 2 つがあります。

- ストレージ アカウントあたりの最大送信速度
- ストレージ アカウントあたりの合計要求レート

### ストレージ アカウントの制限
顧客のストレージ アカウントからバックアップ データがコピーされると、ストレージ アカウントの 1 秒あたりの入力/出力操作 (IOPS) および送信速度 (ストレージ スループット) メトリックスが計算されます。 同時に、仮想マシンは、実行されていると (IOPS) を使用し、スループットです。 この目標は、バックアップおよび仮想マシンのトラフィック合計が、ストレージ アカウントの制限を超過しないことです。

### ディスクの数
バックアップは負荷の高い処理です。可能な限りバックアップを早く完了するために、使用可能なリソースをできるだけ多く消費しようとします。 ただし、すべての I/O 操作がによって制限、 *1 つの Blob のターゲット スループット*, 、1 秒あたり 60 MB の制限値を持ちます。 バックアップ プロセスをスピードアップするのには、VM の各ディスクのバックアップが試行された *並列*します。 つまり、VM にディスクが 4 つある場合、Azure Backup は 4 つのディスクをすべて並行して更新します。 そのため、バックアップのトラフィックがユーザーのストレージ アカウントを終了することを決定する 1 つの最も重要な要素が、 **ディスク数** ストレージ アカウントからバックアップします。

### バックアップ スケジュール
パフォーマンスに影響するその他の要素は、 **バックアップ スケジュール**します。 同時にバックアップするすべての Vm を構成する期間場合、バックアップ対象ディスクの数 *並列* が増加 - Azure Backup は、できるだけ多くのディスクをバックアップしようとします。 したがって、ストレージ アカウントからバックアップされるトラフィックを減らすには、それぞれの VM が重複せずにバックアップされるように 1 日の異なる時間にバックアップするのが 1 つの方法です。

## 容量計画
これらの要素をすべてまとめると、ストレージ アカウントの用途は正確に計画する必要があることを意味します。 ダウンロード、 [VM バックアップのキャパシティ プランニングの Excel スプレッドシート](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33) ディスクとバックアップ スケジュールの選択の影響を確認します。

### バックアップのスループット
バックアップ対象の各ディスクは、Azure Backup がディスク上のブロックを読み込み、変更されたデータのみを格納します (増分バックアップ)。 この表は、Azure Backup に見込まれる平均スループット値を示しています。 これを使用すると、特定のサイズのディスクをバックアップするために要する時間を見積もることができます。

| バックアップ操作 | 最適なスループット |
| ---------------- | ---------- |
| 初回バックアップ | 160 Mbps |
| 増分バックアップ (DR) | 640 Mbps <br><br> バックアップする必要があるディスクに分散した顧客離れの多くがある場合、このスループットが大幅にドロップできます。 |

### VM のバックアップの合計時間
VM のバックアップには、データの読み取りやコピーに多くのバックアップ時間が費やされますが、他にも必要な合計時間に影響を与える操作があります。

- 必要な時間 [バックアップ拡張機能の更新のインストールまたは](backup-azure-vms.md#offline-vms)です。
- スナップショットの時間。スナップショットをトリガーするのにかかった時間です。 スナップショットは、スケジュールされたバックアップ時刻の近くでトリガーされます。
- キューの待機時間。 バックアップ サービスは複数の顧客のバックアップを処理するため、スナップショットから Azure Backup コンテナーへのバックアップ データのコピーは直ちに開始されない場合があります。 負荷のピーク時には、処理するバックアップ数に応じて、待機時間が最大 8 時間まで延長される可能性があります。 ただし、毎日のバックアップ ポリシーでは、VM バックアップの合計時間は 24 時間未満になります。

## データの暗号化

Azure Backup では、データはバックアップ プロセスの一部として暗号化されません。 ただし、VM 内のデータを暗号化し、シームレスに保護されたデータのバックアップを作成する (詳細について [暗号化されたデータのバックアップ](backup-azure-vms-encryption.md))。


## 保護するインスタンスの計算方法
Azure Backup でバックアップされている azure の仮想マシンは、影響を受けます [Azure Backup の料金](http://azure.microsoft.com/pricing/details/backup/)します。 保護するインスタンスの計算がに基づいて、 *実際* 「リソース ディスク」を除く - 仮想マシン内のすべてのデータの合計になっている仮想マシンのサイズ。

したら *いない* 課金仮想マシンに接続されている各データ ディスクはサポートされている最大サイズには、データ ディスクに格納されている実際のデータです。 同様に、バックアップ ストレージの課金は、Azure Backup で格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。

たとえば、最大サイズが各 1 TB のデータ ディスクが 2 台追加で搭載されている A2 標準サイズの仮想マシンがあります。 次の表は、これらの各ディスクに格納されている実際のデータを示しています。

|ディスクの種類|最大サイズ|実際のデータ量|
|---------|--------|------|
| オペレーティング システム ディスク | 1023 GB | 17 GB |
| ローカル ディスク / リソース ディスク | 135 GB | 5 GB (バックアップに含まれない) |
| データ ディスク 1 | 1023 GB | 30 GB |
| データ ディスク 2 | 1023 GB | 0 GB |

 *実際* 17 GB + 30 GB + 0 GB = 47 GB の仮想マシンのサイズがここでは。 これが毎月の課金の基になる保護するインスタンス サイズになります。 仮想マシンのデータ量が大きくなると、課金に使用される保護するインスタンス サイズも変化します。

課金は、最初のバックアップが正常に完了するまでは開始されません。 この時点では、ストレージと保護するインスタンスの両方に対する課金が開始されます。 ある限り、課金が継続 *Azure Backup で格納されているデータをバックアップ、* バーチャル マシン用です。 バックアップ データを保持している場合は、保護の停止操作を行っても課金は停止されません。

保護が停止している場合にのみ、指定された仮想マシンの課金が停止する *と* バックアップ データを削除します。 アクティブなバックアップ ジョブがない場合 (保護が停止されている場合) は、最後にバックアップに成功した時点の仮想マシンのサイズは、毎月の課金の基になる保護するインスタンス サイズになります。

## 疑問がある場合
質問がある場合、または「希望する機能が [フィードバックの送信](http://aka.ms/azurebackup_feedback)します。

## 次のステップ

- [仮想マシンのバックアップ](backup-azure-vms.md)
- [仮想マシンのバックアップを管理する](backup-azure-manage-vms.md)
- [仮想マシンの復元](backup-azure-restore-vms.md)
- [VM のバックアップに関する問題のトラブルシューティング](backup-azure-vms-troubleshoot.md)


