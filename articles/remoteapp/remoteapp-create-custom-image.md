<properties
    pageTitle="Azure RemoteApp のカスタム テンプレート イメージの作成方法 | Microsoft Azure"
    description="Azure RemoteApp のカスタム テンプレート イメージの作成方法について説明します。 このテンプレートは、ハイブリッド コレクションまたはクラウド コレクションで使用できます。"
    services="remoteapp"
    documentationCenter=""
    authors="lizap"
    manager="mbaldwin"
    editor=""/>

<tags
    ms.service="remoteapp"
    ms.workload="compute"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="09/12/2015" 
    ms.author="elizapo"/>

# Azure RemoteApp のカスタム テンプレート イメージの作成方法
Azure RemoteApp では、ユーザーと共有するすべてのプログラムをホスティングするために Windows Server 2012 R2 のテンプレート イメージを使用します。 カスタム RemoteApp テンプレート イメージを作成するには、既存のイメージを使うことも新しく作成することもできます。 


> [AZURE.TIP] Azure VM からイメージを作成することをご存知でしたか。 これは本当の話で、イメージをインポートする時間を削減できます。 チェック アウト手順 [ここ](remoteapp-image-on-azurevm.md)します。

Azure RemoteApp で使用するためにアップロードできるイメージの要件は次のとおりです。


- イメージのサイズは MB の倍数にする必要があります。 正確な倍数ではないイメージをアップロードしようとすると、アップロードは失敗します。
- イメージのサイズは 127 GB 未満でなければなりません。
- VHD ファイルにある必要があります。VHDX ファイル (Hyper-V 仮想ハード ドライブ) は現在サポートされていません。
- VHD を第 2 世代仮想マシンにしないでください。
- VHD は固定サイズにすることも、動的に拡大する容量可変にすることも可能です。 固定サイズの VHD より Azure へのアップロードの所要時間が短いことから、容量可変の VHD が推奨されます。
- ディスクはマスター ブート レコード (MBR) パーティション分割のスタイルを使用して初期化しなければなりません。 GUID パーティション テーブル (GPT) パーティション分割のスタイルはサポートされていません。
- VHD には Windows Server 2012 R2 の単一インストールが含まれていなければなりません。 複数のボリュームを含むことはできますが、Windows がインストールされるのは 1 ボリュームのみです。
- リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能がインストール済みでなければなりません。
- リモート デスクトップ接続ブローカーの役割 *いない* をインストールします。
- 暗号化ファイル システム (EFS) は無効にする必要があります。
- イメージはパラメーターを使用して/mode:vm である必要があります **/oobe/generalize/shutdown** (使用しないで、 **/mode:vm** パラメーター)。
- スナップショット チェーンからの VHD のアップロードはサポートされていません。


**開始する前に**

サービスを作成する前に、以下の操作が必要です。

- [サインアップ](http://azure.microsoft.com/services/remoteapp/) RemoteApp のです。
- RemoteApp サービス アカウントとして使用するためのユーザー アカウントを Active Directory に作成します。 ドメインへのマシンの参加のみが実行可能になるように、このアカウントのアクセス許可を制限します。 参照してください [Configure Azure Active Directory for RemoteApp](remoteapp-ad.md) の詳細。
- オンプレミスのネットワークに関する情報、つまり IP アドレス情報と VPN デバイスの詳細情報を収集します。
- インストール、 [Azure PowerShell](../install-configure-powershell.md) モジュールです。
- アクセス権を付与するユーザーに関する情報を集めます。 この情報とは、ユーザーの Microsoft アカウントの情報または Active Directory の仕事用アカウントの情報です。



## テンプレート イメージの作成 ##

新しいテンプレート イメージを一から作成する手順の概要を次に示します。

1.  Windows Server 2012 R2 Update DVD または ISO イメージを見つけます。
2.  VHD ファイルを作成します。
4.  Windows Server 2012 R2 をインストールします。
5.  リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能をインストールします。
6.  使用するアプリケーションで必要な追加の機能をインストールします。
7.  アプリケーションをインストールし、構成します。 共有アプリをしやすくするには、アプリやを共有するプログラムの追加、 **開始** **%systemdrive%\ProgramData\Microsoft\Windows\Start メニュー \ プログラムで具体的には、イメージのメニュー。
8.  使用するアプリケーションで必要な追加の Windows 構成を実行します。
9.  暗号化ファイル システム (EFS) を無効にします。
10. **必要な作業:** Windows Update に移動し、すべての重要な更新プログラムをインストールします。
9.  イメージを SYSPREP します。

新しいイメージを作成するための詳しい手順は次のとおりです。

1.  Windows Server 2012 R2 Update DVD または ISO イメージを見つけます。
2.  ディスクの管理を使用して VHD ファイルを作成します。
    1.  ディスクの管理 (diskmgmt.msc) を起動します。
    2.  40 GB 以上のサイズに動的に拡大する VHD を作成します (Windows、使用するアプリケーション、カスタマイズで必要とされる容量を見積もってください。 RDSH ロールとデスクトップ エクスペリエンスの機能がインストールされた Windows Server では約 10 GB の容量が必要になります)。
        1.  クリックして **アクション > VHD の作成**します。
        2.  場所、サイズ、VHD 形式を指定します。 選択 **容量可変の拡張**, 、] をクリックし、 **OK**します。

            実行には数秒かかります。 VHD の作成完了時、ディスクの管理用コンソールにドライブ文字のない新しいディスクと、[初期化されていません] の状態が表示されます。

        - (未割り当て領域ではなく)、ディスクを右クリックし、をクリックし、 **ディスクの初期化**します。 選択 **MBR** (マスター ブート レコード) をクリックし、パーティション スタイルとして **OK**します。
        - 新しいボリュームの作成: 未割り当て領域を右クリックし、をクリックし、 **新しいシンプル ボリューム**します。 ウィザードの既定をそのまま使用できますが、テンプレート イメージのアップロード時に問題が発生する可能性を避けるためにドライブ文字を必ず割り当てるようにしてください。
        - ディスクを右クリックし、 **VHD の切断**します。





1. Windows Server 2012 R2 をインストールします。
    1. 新しい仮想マシンを作成します。 Hyper-V マネージャーまたはクライアント Hyper-V で仮想マシンの新規作成ウィザードを使用します。
        1. 世代の指定] ページで、次のように選択します。  **第 1 世代**します。
        2. 仮想ハード_ディスクの接続] ページで選択 **既存のバーチャル ハード_ディスクを使用して**, 、前の手順で作成した VHD を参照します。
        2. [インストール オプション] ページで、次のように選択します。 **ブート cd/dvd_rom からオペレーティング システムをインストール**, 、し、Windows Server 2012 R2 インストール メディアの場所を選択します。
        3. Windows とアプリケーションのインストールに必要な他のオプションをウィザードで選択します。 ウィザードを終了します。
    2.  ウィザードの完了後、仮想マシンの設定を編集し、Windows および仮想プロセッサの数などのプログラムをインストールするために必要なその他の変更を行う **OK**します。
    4.  仮想マシンに接続し、Windows Server 2012 R2 をインストールします。
1. リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能を次の手順でインストールします。
    1. サーバー マネージャーを起動します。
    2. をクリックして **[役割と機能** へようこそ] 画面で、 **管理** メニュー。
    3. クリックして **次** [開始する前に] ページ。
    4. 選択 **役割ベースまたは機能ベースのインストール**, 、クリックして **次**します。
    5. リストから、ローカル コンピューターを選択し、クリックして **次**します。
    6. 選択 **リモート デスクトップ サービス**, 、] をクリックし、 **次**します。
    7. 展開 **ユーザー インターフェイスとインフラストラクチャ** 選択 **デスクトップ エクスペリエンス**します。
    8. クリックして **機能の追加**, 、順にクリック **次**します。
    9. [リモート デスクトップ サービス] ページで、クリックして **次**します。
    10. クリックして **リモート デスクトップ セッション ホスト**します。
    11. クリックして **機能の追加**, 、順にクリック **次**します。
    12. インストール オプションの確認] ページで、次のように選択します。 **ために必要な場合は、移行先サーバーを自動的に再起動**, 、順にクリック **[はい]** で、再起動警告が表示されます。
    13. クリックして **インストール**します。 コンピューターが再起動します。
1.  .NET Framework 3.5 など、アプリケーションで必要な追加の機能をインストールします。 機能をインストールするには、役割と機能の追加ウィザードを実行してください。
7.  RemoteApp を使用して発行するプログラムとアプリケーションをインストールして構成します。

>[AZURE.IMPORTANT]
>
>RemoteApp にイメージがアップロードされる前に、アプリケーションの互換性の問題が検出されるように、アプリケーションのインストール前に RDSH ロールをインストールします。
>
>ショートカットを作成することを確認して、アプリケーションに (**.lnk** ファイル) に表示されます、 **開始** ] メニューの [すべてのユーザー (%systemdrive%\ProgramData\Microsoft\Windows\Start メニュー \ プログラム)。 『 アイコンも確認、 **開始** メニューは、ユーザーに表示します。 異なる場合は、変更します。 (そうしない *が* を開始するアプリケーションを追加するメニューには、大幅に簡単に RemoteApp にアプリケーションを発行します。 そうしないと、アプリケーションを発行するときに、アプリケーションのインストール パスを提供することが必要になります。)


8.  使用するアプリケーションで必要な追加の Windows 構成を実行します。
9.  暗号化ファイル システム (EFS) を無効にします。 管理者特権のコマンド ウィンドウで、次のコマンドを実行してください。

        Fsutil behavior set disableencryption 1

    別の方法としては、次の DWORD 値をレジストリに設定または追加できます。

        HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1
9.  Azure の仮想マシン内にイメージを構築する場合の名前を変更、 **\%windir%\Panther\Unattend.xml** ファイルをブロックする作業から後で使用するアップロード スクリプトです。 このファイルの名前を Unattend.old に変更して、デプロイを元に戻す必要が生じた場合に備えてファイルを温存しておいてください。
10. Windows Update に移動し、すべての重要な更新プログラムをインストールします。 すべての更新プログラムを適用するには、Windows Update を複数回実行することが必要になる場合があります (更新プログラムをインストールするときに、更新内容自体に更新が必要ということもあります)。
10. イメージを SYSPREP します。 管理者特権のコマンド プロンプトで、次のコマンドを実行します。

    **C:\Windows\System32\sysprep\sysprep.exe /generalize /oobe /shutdown**

    **注:** 使用しないでください、 **/mode:vm** これは仮想マシンであっても SYSPREP コマンド スイッチです。


## 次のステップ ##
これでカスタム テンプレート イメージを作成し終えたので、次にこのイメージを RemoteApp コレクションにアップロードする必要があります。 以下の記事の情報を利用して、コレクションを作成してください。


- [RemoteApp のクラウド ハイブリッド コレクションの作成方法](remoteapp-create-hybrid-deployment.md)
- [RemoteApp のクラウド コレクションの作成方法](remoteapp-create-cloud-deployment.md)
 
