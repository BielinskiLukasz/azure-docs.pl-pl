<properties
    pageTitle ="アプリ モデル v2.0 OpenID Connect プロトコル |Microsoft Azure]
    description =「web アプリケーションを構築、OpenID Connect 認証プロトコルの Azure AD の実装を使用します」。
    サービス ="active directory"
    documentationCenter=""
    authors ="dstrockis"
    manager ="msmbaldwin"
    editor=""/>

<tags
    ms.service="active directory"
    ms.workload="identity"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="12/09/2015"
    ms.author="dastrock"/>

# アプリ モデル v2.0 プレビュー: プロトコル - OpenID Connect

OpenID Connect は OAuth 2.0 を基盤として開発された認証プロトコルであり、ユーザーを Web アプリケーションに安全にサインインさせるために利用されます。 アプリ モデル v2.0 による OpenID Connect の実装を使用すると、サインインおよび API アクセスを Web ベースのアプリケーションに追加できます。 本ガイドでは、この外注を言語に依存せずに行う方法について説明します。オープンソース ライブラリを利用せず、HTTP メッセージを送受信する方法について説明します。
> [AZURE.NOTE]
    この情報は、v2.0 アプリ モデルのパブリック プレビューに関するものです。 一般的に使用できる Azure AD と統合する方法については、サービスを参照してください、 [Azure Active Directory 開発者ガイド 』](active-directory-developers-guide.md)します。

[OpenID Connect](http://openid.net/specs/openid-connect-core-1_0.html) は、OAuth 2.0 拡張 *承認* として使用するためのプロトコル、 *認証* プロトコルで、1 つを実行できるようにサインオン OAuth を使用しています。 概念が導入されて、 `id_token`, 、これはクライアントが、ユーザーの身元を確認し、ユーザーに関する基本的なプロファイル情報を取得できるようにするセキュリティ トークン。 アプリケーションに安全に取得することもできます OAuth 2.0 を拡張するため **access_tokens** によって保護されたリソースへのアクセスに使用できる、 [承認サーバー](active-directory-v2-protocols.md#the-basics)します。 という推奨設定を作成する場合は、OpenID Connect、 [web アプリケーション](active-directory-v2-flows.md#web-apps) をサーバーでホストされ、ブラウザーを使用してアクセスします。

## サインイン要求を送信する

Web アプリは、ユーザーを認証する必要がある、ユーザーに向け、 `承認/` エンドポイント。 この要求は、最初の区間はのような [OAuth 2.0 承認コード フロー](active-directory-v2-protocols-oauth-code.md), 、いくつかの重要な違いとします。

- 要求は、スコープを含める必要があります `openid` で、 `スコープ` パラメーター。
- `Response_type` パラメーターを含める必要があります `id_token`
- 要求に含める必要があります、 `nonce` パラメーター

```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application Id
&response_type=id_token
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded
&response_mode=query                                  // 'query', 'form_post', or 'fragment'
&scope=openid                                        // Translates to the 'Read your profile' permission
&state=12345                                         // Any value, provided by your app
&nonce=678910                                        // Any value, provided by your app
```

| パラメーター| | 説明|
| ----------------------- | ------------------------------- | --------------- |
| client_id| 必須| アプリケーション Id を登録ポータル ([apps.dev.microsoft.com](https://apps.dev.microsoft.com)) アプリに割り当てられます。|
| response_type| 必須| 含める必要があります `id_token` OpenID Connect サインインします。などの他の response_types を含める場合も `コード`します。|
| redirect_uri| 必須| アプリ の redirect_uri。アプリは、この URI で認証応答を送受信することができます。ポータルで登録したいずれかの redirect_uri と完全に一致させる必要があります (ただし、URL エンコードが必要)。|
| scope| 必須| スコープのスペース区切りリスト。OpenID Connect のスコープを含めることは `openid`, 、同意 UI の「記号と読み取りのプロファイルで」アクセス許可に変換されします。同意を求めるこの要求には他のスコープが含まれていてもかまいません。|
| nonce| 必須| 要求に追加する (アプリによって生成された) 値。この値が、最終的な id_token に要求として追加されます。アプリでこの値を確認することにより、トークン再生攻撃を緩和することができます。通常この値はランダム化された一意の文字列になっており、要求の送信元を特定する際に使用できます。|
| response_mode| 推奨| 結果として得られた authorization_code をアプリに返す際に使用するメソッドを指定します。'query'、'form_post'、'fragment' のいずれかを指定できます。
| state| 推奨| 要求に含まれ、かつトークンの応答として返される値。任意の文字列を指定することができます。クロスサイト リクエスト フォージェリ攻撃を防ぐために通常、ランダムに生成された一意の値が使用されます。この状態は、認証要求の前にアプリ内でユーザーの状態 (表示中のページやビューなど) に関する情報をエンコードする目的にも使用されます。|
| prompt| 省略可能| ユーザーとの必要な対話の種類を指定します。現時点で唯一の有効な値は「ログイン」'none'、'承認' とします。`prompt ログイン` でのシングル サインオンの否定、その要求に資格情報を入力するユーザーを強制します。`prompt = none` 反対に、ユーザーがまったく対話型プロンプトが表示されませんされることを確認します。要求は、シングル サインオンを使用して自動的に完了できません、バージョン 2.0 のエンドポイントは、エラーを返します。`同意を求められる =` アプリへのアクセス許可を付与するユーザーに確認する、ユーザーがサインインした後に OAuth 同意ダイアログをトリガーします。|
| login_hint| 省略可能| ユーザーに代わって、サインイン ページのユーザー名/電子メール アドレス フィールドに事前入力できます。|

現時点では、ユーザーに資格情報の入力と認証が求められます。 V2.0 エンドポイントに示されているアクセス許可をユーザーが同意したことを確認しても、 `スコープ` クエリ パラメーターです。 いずれのアクセス許可にもユーザーが同意しなかった場合、必要なアクセス許可に同意するようユーザーに求めます。 詳細 [アクセス許可、承認、およびマルチ テナント アプリはここで指定した](active-directory-v2-scopes.md)します。

バージョン 2.0 のエンドポイントが、表示されているアプリへの応答を返すを認証し、同意を付与すると、 `redirect_uri`, で指定されたメソッドを使用して、 `response_mode` パラメーター。

正常な応答を使用して、 `response_mode = クエリ` のようになります。

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...   // the id_token, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint
&state=12345                                                    // the value provided in the request
&id_token_expires_in=3600
```

| パラメーター| 説明|
| ----------------------- | ------------------------------- |
| id_token| アプリケーションが要求された id_token します。この id_token を使用してユーザーの本人性を確認し、そのユーザーとのセッションを開始することができます。含まれる id_tokens とその内容の詳細については、 [v2.0 エンドポイント トークン参照](active-directory-v2-tokens.md)します。|
| session_state| 現在のユーザー セッションを識別する一意の値。この値は GUID ですが、検査なしで渡される不透明な値として扱う必要があります。|
| state| 要求に state パラメーターが含まれている場合、同じ値が応答にも含まれることになります。アプリケーションは、要求と応答の状態の値が同じであることを確認する必要があります。|
| id_token_expires_in| ID トークンの有効期間 (秒) です。|


エラー応答を送信することがありますも、 `redirect_uri` 、アプリケーションが適切に処理するようにします。

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| パラメーター| 説明|
| ----------------------- | ------------------------------- |
| error| 発生したエラーの種類を分類したりエラーに対処したりする際に使用するエラー コード文字列。|
| error_description| 認証エラーの根本的な原因を開発者が特定しやすいように記述した具体的なエラー メッセージ。|

## id_token を検証する

ユーザーを認証するための十分なだけ、id_token の受信はid_token の署名を検証し、要件に、アプリケーションのトークンの要求を確認する必要があります。 バージョン 2.0 のエンドポイントを使用して [JSON Web トークン (JWTs)](http://self-issued.info/docs/draft-ietf-oauth-json-web-token.html) と公開キーの暗号化署名し、トークンが有効であることを確認します。

v2.0 アプリ モデルには、OpenID Connect メタデータ エンドポイントがあって、アプリは、このエンドポイントを使用することで、v2.0 アプリ モデルに関する情報を実行時にフェッチすることができます。 この情報には、エンドポイント、トークンの内容、トークンの署名キーが含まれます。 メタデータ エンドポイントは、以下の場所に JSON ドキュメントを格納しています。

`https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration`

この構成ドキュメントのプロパティの 1 つは、 `jwks_uri`, が v2.0 アプリ モデルの値します。

`https://login.microsoftonline.com/common/discovery/v2.0/keys`します。

id_token の署名は、このエンドポイントに置かれている RSA256 公開キーを使用して検証できます。 特定の時点には、このエンドポイントで記載されている複数のキーがあるで識別される各、 `子供`します。 された id_token のヘッダーも含まれます、 `子供` 要求された id_token の署名に使用されたこれらのキーを示します。

参照してください、 [v2.0 アプリ モデル トークン参照](active-directory-v2-tokens.md) 詳細についてを含む [を検証するトークン](active-directory-v2-tokens.md#validating-tokens) と [重要な情報は署名キー ロール オーバー](active-directory-v2-tokens.md#validating-tokens)します。


id_token の署名を検証した後に、確認の必要な要求がいくつか存在します。

- 検証する必要があります、 `nonce` トークン リプレイ攻撃を防ぐために要求します。 その値が、サインイン要求で指定した値と一致していることが必要です。
- 検証する必要があります、 `aud` された id_token がアプリに対して発行されたことを確認を要求します。 その値にする必要があります、 `client_id` アプリのです。
- 検証する必要があります、 `iat` と `exp` された id_token の有効期限が切れていないことを確認を要求します。

シナリオに応じてその他の要求も検証することができます。 以下に一般的な検証の例をいくつか挙げます。

- ユーザー/組織を確実にサインアップしているアプリケーションです。
- 適切な承認/特権がユーザーにあることを確認する。
- 多要素認証など特定の強度の認証が行われたことを確認する。

Id_token 内のクレームの詳細については、次を参照してください。、 [v2.0 アプリ モデル トークン参照](active-directory-v2-tokens.md)します。

id_token を十分検証したら、ユーザーとのセッションを開始し、id_token に含まれる要求を使ってそのユーザーに関する情報をアプリの中で取得することができます。 取得した情報は、表示、記録、承認などに利用することができます。

## サインアウト要求を送信する

OpenIdConnect `end_session_endpoint` v2.0 アプリ モデルのプレビューでは現在サポートされていません。 したがって、v2.0 エンドポイントに対しアプリから、ユーザーのセッションを終了し、v2.0 エンドポイントによって設定された Cookie をクリアする要求を送信することはできません。
ユーザーをサインアウトさせるには、単にアプリ側でユーザーとのセッションを終了し、ユーザー側の v2.0 エンドポイントとのセッションは放置してください。 次回ユーザーがサインインしようとすると "アカウントの選択" ページが表示され、実際にサインインしているアカウントが一覧表示されます。
そのページでユーザーは任意のアカウントを選んでサインアウトし、v2.0 エンドポイントとのセッションを終了することができます。



## サインインの概要図

ごく基本的なサインイン フローは、以下のステップから成ります。

![OpenId Connect Swimlanes](../media/active-directory-v2-flows/convergence_scenarios_webapp.png)

## アクセス トークンの取得

多くの Web アプリは、ユーザーをサインインさせるだけでなく、OAuth を使用してそのユーザーの代わりに Web サービスにアクセスする必要もあります。 このセクションでは、OpenID Connect を使ってユーザー認証を行うと同時に、OAuth 承認コード フローを使って、access_token を取得するための authorization_code を取得します。 アクセス トークンを取得するには、前に示したサインイン要求を少し変更する必要があります。


```
// Line breaks for legibility only

GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?
client_id=2d4d11a2-f814-46a7-890a-274a72a7309e      // Your registered Application Id
&response_type=id_token+code
&redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F       // Your registered Redirect Uri, url encoded
&response_mode=query                                  // 'query', 'form_post', or 'fragment'
&scope=openid%20                                      // Include both 'openid' and scopes your app needs  
offline_access%20                                        
https%3A%2F%2Fgraph.windows.net%2Fdirectory.read%20
https%3A%2F%2Fgraph.windows.net%2Fdirectory.write
&state=12345                                         // Any value, provided by your app
&nonce=678910                                        // Any value, provided by your app
```

使用してアクセス許可スコープを要求に含める `response_type = コード + id_token`, 、v2.0 エンドポイントはユーザーに示されているアクセス許可に同意したことを確認、 `スコープ` クエリ パラメーター、およびアクセス トークンで交換する承認コードをアプリに返されます。

正常な応答を使用して、 `response_mode = クエリ` のようになります。

```
GET https://localhost/myapp/?
id_token=eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik5HVEZ2ZEstZnl0aEV1Q...   // the id_token, truncated
&code=AwABAAAAvPM1KaPlrEqdFSBzjqfTGBCmLdgfSTLEMPGYuNHSUYBrq...  // the authorization_code, truncated
&session_state=7B29111D-C220-4263-99AB-6F6E135D75EF            // a value generated by the v2.0 endpoint
&state=12345                                                    // the value provided in the request
&id_token_expires_in=3599
```

| パラメーター| 説明|
| ----------------------- | ------------------------------- |
| id_token| アプリケーションが要求された id_token します。この id_token を使用してユーザーの本人性を確認し、そのユーザーとのセッションを開始することができます。含まれる id_tokens とその内容の詳細については、 [v2.0 アプリ モデル トークン参照](active-directory-v2-tokens.md)します。|
| code| アプリケーションが要求された authorization_code します。アプリケーションでは、ターゲット リソースのアクセス トークンを要求するのに承認コードを使用できます。承認コードは有効期間が非常に短く、通常 10 分後には期限切れとなります。|
| session_state| 現在のユーザー セッションを識別する一意の値。この値は GUID ですが、検査なしで渡される不透明な値として扱う必要があります。|
| state| 要求に state パラメーターが含まれている場合、同じ値が応答にも含まれることになります。アプリケーションは、要求と応答の状態の値が同じであることを確認する必要があります。|
| id_token_expires_in| ID トークンの有効期間 (秒) です。|

エラー応答を送信することがありますも、 `redirect_uri` 、アプリケーションが適切に処理するようにします。

```
GET https://localhost/myapp/?
error=access_denied
&error_description=the+user+canceled+the+authentication
```

| パラメーター| 説明|
| ----------------------- | ------------------------------- |
| error| 発生したエラーの種類を分類したりエラーに対処したりする際に使用するエラー コード文字列。|
| error_description| 認証エラーの根本的な原因を開発者が特定しやすいように記述した具体的なエラー メッセージ。|

承認を取得した後 `コード` と `id_token`, 、ユーザーをサインインし、代わりに管理者アクセス トークンを取得します。 ユーザーをサインインするには、検証する必要があります、 `id_token` 説明したとおりに正確に [上](#validating-the-id-token)します。 アクセス トークンを取得するには、記載された手順を行うことができる、 [OAuth プロトコルのドキュメント](active-directory-v2-protocols-oidc.md#request-an-access-token)します。

## トークンの取得の概要図

参考として、OpenID Connect によるサインインとトークン取得の完全なフローは次のようになります。

![OpenId Connect Swimlanes](../media/active-directory-v2-flows/convergence_scenarios_webapp_webapi.png)




