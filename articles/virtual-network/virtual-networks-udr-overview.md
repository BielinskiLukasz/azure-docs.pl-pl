<properties 
   pageTitle="ユーザー定義のルートと IP 転送の概要"
   description="UDR と IP 転送の概要"
   services="virtual-network"
   documentationCenter="na"
   authors="telmosampaio"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="12/11/2015"
   ms.author="telmos" />


# ユーザー定義のルートと IP 転送

Azure で仮想マシン (VM) を仮想ネットワーク (VNet) に追加すると、VM どうしがネットワークを介して自動的に通信できることがわかります。 VM が異なるサブネットにあったとしても、ゲートウェイを指定する必要はありません。 VM からパブリック インターネットへの通信も同様であり、Azure からユーザー独自のデータセンターにハイブリッド接続が存在する場合は、オンプレミスのネットワークへの通信でも同様です。

このような通信フローが可能であるのは、Azure が一連のシステム ルートを使用して IP トラフィックのフロー方法を定義するためです。 システム ルートは、以下のシナリオでの通信フローを制御します。

- 同じサブネット内から。
- VNet 内でサブネットから別のサブネットに。
- VM からインターネットに。
- VNet から VPN Gateway を通して別の VNet に。
- VNet から VPN Gateway を通してオンプレミスのネットワークに。

次の図は、VNet、2 つのサブネット、いくつかの VM、および IP トラフィックのフローを許可するシステム ルートによる、簡単な設定を示したものです。

![Azure でのシステム ルート](./media/virtual-networks-udr-overview/Figure1.png)

システム ルートを使用するとデプロイのトラフィックが自動的に促進されますが、仮想アプライアンスを通過するパケットのルーティングを自分で制御したい場合もあります。 特定のサブネット宛のパケットが代わりに仮想アプライアンスを通るように次ホップを指定するユーザー定義のルートを作成し、仮想アプライアンスとして実行する VM に対して IP 転送を有効にすることにより、これを実現できます。

次の図は、ユーザー定義のルートと IP 転送の例を示しています。この例では、あるサブネットから別のサブネットに送信されたパケットが 3 つ目のサブネットにある仮想アプライアンスを通過します。

![Azure でのシステム ルート](./media/virtual-networks-udr-overview/Figure2.png)
>[AZURE.IMPORTANT] ユーザー定義のルートは、サブネットのままのトラフィックにのみ適用されます。 どのようにトラフィックは、サブネットに、インターネットからのインスタンスを指定するルートを作成することはできません。またへのトラフィックを転送するには、アプライアンスは、トラフィックの発生源に同じサブネットにすることはできません。 常に、アプライアンス用に別のサブネットを作成してください。 

## ルーティング

パケットは、物理ネットワーク上の各ノードに定義されているルート テーブルに基づき、TCP/IP ネットワークを介してルーティングされます。 ルート テーブルは、宛先 IP アドレスに基づいてパケットの転送先を決定する目的で使用される個々のルートの集まりです。 ルートの構成要素を次に示します。

- **アドレス プレフィックス**。 ルートの適用対象となる宛先の CIDR 表記 (例: 10.1.0.0/16)。
- **次ホップの種類**。 パケットの送信先となる Azure ホップの種類。 次のいずれかの値になります。
    - **Local**:  ローカルの仮想ネットワークを表します。 たとえば、同じ仮想ネットワークに 10.1.0.0/16 と 10.2.0.0/16 の 2 つのサブネットがある場合、ルート テーブル内の各サブネットのルートは、次ホップの値が *Local* になります。
    - **VPN Gateway**: Azure S2S VPN Gateway を表します。
    - **Internet**:  Azure インフラストラクチャによって提供される既定のインターネット ゲートウェイを表します。
    - **Virtual Appliance**: Azure Virtual Network に追加した仮想アプライアンスを表します。
    - **NULL**:  ブラック ホールを表します。 ブラック ホールに転送されたパケットはまったく転送されません。
- **次ホップの値**。 次ホップの値には、パケットの転送先となる IP アドレスが格納されます。 次ホップの値が使用できるのは、次ホップの種類が *Virtual Appliance* であるルートに限られます。

## システム ルート

仮想ネットワークで作成されるすべてのサブネットは、次のシステム ルート ルールを含むルート テーブルに自動的に関連付けられます。

- **ローカル Vnet ルール**: このルールは、仮想ネットワーク内のすべてのサブネットに対して自動的に作成されます。 これは、VNet 内の VM 間に直接リンクがあり、中間次ホップがないことを指定します。
- **オンプレミス ルール**: このルールは、オンプレミス アドレス範囲宛てのすべてのトラフィックに適用され、次ホップの宛先として VPN Gateway を使用します。
- **インターネット ルール**: このルールは、パブリック インターネット宛てのすべてのトラフィックを処理し、インターネット宛のすべてのトラフィックの次ホップとしてインフラストラクチャ インターネット ゲートウェイを使用します。

## ユーザー定義のルート

ほとんどの環境では、Azure によって既に定義されているシステム ルートだけが必要です。 ただし、ある特定のケースにおいては、ルート テーブルを作成して独自にルートを追加する必要があります。その例を次に示します。

- インターネットへのオンプレミス ネットワークを介した強制トンネリング。
- Azure 環境での仮想アプライアンスの使用。

以上のシナリオでは、ルート テーブルを作成してユーザー定義のルートを追加する必要があります。 ルート テーブルは複数設定することができ、また、同じルート テーブルを 1 つまたは複数のサブネットに関連付けることができます。 ただし、関連付けることができるルート テーブルは各サブネットにつき 1 つだけです。 サブネット内のすべての VM およびクラウド サービスは、そのサブネットに関連付けられているルート テーブルを使用します。

サブネットにルート テーブルが関連付けられるまでは、システム ルートが使用されます。 いったん関連付けがなされると、ユーザー定義ルートとシステム ルートの間で、LPM (Longest Prefix Match) に基づくルーティングが行われます。 同じ LPM マッチの複数のルートが存在する場合は、そのルートが検出された経緯に応じて次の順序でルートが選択されます。

1. ユーザーの定義ルート
1. BGP のルート (ExpressRoute を使用している場合)
1. システム ルート

ユーザー定義のルートを作成する方法については、次を参照してください。 [ルートの作成と Azure での IP 転送を有効にする方法](../virtual-networks-udr-how-to#How-to-manage-routes)します。
>[AZURE.IMPORTANT] ユーザー定義のルートが適用されるのは、Azure VM と Cloud Services だけです。 たとえば、オンプレミス ネットワークと Azure との間にファイアウォール仮想アプライアンスを追加する場合、オンプレミスのアドレス空間に向かうすべてのトラフィックを仮想アプライアンスに転送するユーザー定義のルートを Azure ルート テーブルに作成する必要があります。 一方、オンプレミスのアドレス空間から入ってくるトラフィックは、VPN Gateway または ExpressRoute 回線を経由し、仮想アプライアンスを飛び越えて直接 Azure 環境に向かいます。

## BGP のルート

オンプレミス ネットワークと Azure との間に ExpressRoute 接続が存在する場合、BGP を有効にして、オンプレミス ネットワークから Azure へとルートを伝達することができます。 これらの BGP ルートは、各 Azure サブネットでシステム ルートやユーザー定義ルートと同じように使用されます。 詳細については、次を参照してください。 [ExpressRoute の概要](../expressroute-introduction)します。
>[AZURE.IMPORTANT] VPN Gateway を次ホップとする、サブネット 0.0.0.0/0 宛てのユーザー定義のルートを作成することで、オンプレミス ネットワークを介した強制トンネリングを使用するように Azure 環境を構成することができます。 ただし、この方法が利用できるのは、VPN Gateway を使用している場合に限られます。ExpressRoute では利用できません。 ExpressRoute の場合、強制トンネリングは BGP を介して構成します。

## IP 転送

これまで説明してきたように、ユーザー定義のルートを作成する主な目的の 1 つは、トラフィックを仮想アプライアンスに転送することです。 仮想アプライアンスは、アプリケーションを実行する VM にすぎません。ファイアウォールや NAT デバイスなど、ネットワーク トラフィックを何らかの方法で処理するために使用されるアプリケーションが仮想アプライアンスで実行されます。

仮想アプライアンスとして機能するこの VM は、自分宛てではない着信トラフィックを受信できることが必要です。 VM が自分以外の宛先に向かうトラフィックを受信するためには、VM の IP 転送を有効にする必要があります。 これは Azure の設定であり、ゲスト オペレーティング システムでの設定ではありません。

## 次のステップ

- 学習方法 [リソース マネージャーの展開モデルのルートを作成する](../virtual-network-create-udr-arm-template) とサブネットに関連付けることです。
- 学習方法 [クラシック展開モデルのルートを作成する](../virtual-network-create-udr-classic-ps) とサブネットに関連付けることです。





