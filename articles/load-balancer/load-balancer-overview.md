<properties 
   pageTitle="Azure Load Balancer の概要 | Microsoft Azure"
   description="Azure Load Balancer の機能の概要、アーキテクチャ、実装。 ロード バランサーの機能とクラウドの利用方法の理解に役に立つ"
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="12/09/2015"
   ms.author="joaoma" />


# Azure Load Balancer とは
 
Azure Load Balancer は、アプリケーションに高可用性と優れたネットワーク パフォーマンスを提供します。 これは、ロード バランサー セットで定義されているクラウド サービスや仮想マシンの正常なサービス インスタンス間で着信トラフィックを分散する、第 4 層 (TCP、UDP) のロード バランサーです。
 
次のように構成できます。

- 仮想マシンへの着信インターネット トラフィックを負荷分散します。 参照として [インターネットへの負荷分散](load-balancer-internet-overview.md)します。
- Virtual Network 内の仮想マシン間、クラウド サービス内の仮想マシン間、クロスプレミスの仮想ネットワーク内のオンプレミスのコンピューターと仮想マシン間でトラフィックを負荷分散します。 参照として [内部負荷分散 (ILB)](load-balancer-internal-overview.md)します。
-   外部トラフィックを特定の仮想マシン インスタンスに転送します。

## Azure クラシックと Azure リソース マネージャー (ARM) の Azure Load Balancer の概要

インターネットから到達できるようにするには、クラウド内のすべてのリソースにパブリック IP アドレスが必要です。 Microsoft Azure のクラウド インフラストラクチャは、リソース内でルーティング不可能な IP アドレスを使用し、ネットワーク アドレス変換 (NAT) でパブリック IP アドレスに変換してインターネットと通信します。

Microsoft Azure とその Load Balancer 実装には、2 つのデプロイメント モデルがあります。

 
### Azure クラシック

Azure クラシックは、Microsoft Azure で実装された最初のデプロイメント モデルです。 このモデルでは、パブリック IP アドレスと FQDN がクラウド サービスに割り当てられます。また、クラウド サービス境界内にデプロイされた仮想マシンをグループ化して、1 つのロード バランサーを使用することができます。 このロード バランサーがポート変換を実行し、ネットワーク トラフィックの負荷を分散して、クラウド サービスのパブリック IP アドレスを利用します。

クラシック デプロイメント モデルのポート変換は、パブリック IP アドレスに割り当てられたパブリック ポートと、特定の仮想マシンに対してトラフィックを送信するために割り当てられたローカル ポート間の 1 対 1 の関係にあるエンドポイントを使用して実行されます。

負荷分散は、ロード バランサー セット エンドポイントを使用して実行されます。 これらのエンドポイントは、パブリック IP アドレスと、負荷分散されたネットワーク トラフィックに応答するセット内のすべての仮想マシンに割り当てられたローカル ポート間の 1 対多の関係にあります。 

このデプロイメント モデルでロード バランサーが使用するパブリック IP アドレスのドメイン ラベルは、`<cloud service name>.cloudapp.net` です。

これは、従来のデプロイ モデル内のロード バランサーのグラフィック表現です。
![ハッシュ ベースのロード バランサー](./media/load-balancer-overview/asm-lb.png)

### Azure リソース マネージャー
 
ロード バランサーの概念は、Azure リソース マネージャー (ARM) では異なります。ARM では、ロード バランサーを作成するためにクラウド サービスは必要ありません。

ARM では、パブリック IP アドレスは独自のリソースであり、ドメイン ラベルまたは DNS 名に関連付けることができます。 この例のパブリック IP アドレスはロード バランサー リソースに関連付けられているので、ロード バランサーの規則、着信 NAT の規則は、リソースが負荷分散されたネットワーク トラフィックを受信するためのインターネット エンドポイントとしてパブリック IP アドレスを使用します。 

ネットワーク インターフェイス (NIC) リソースは、仮想マシンの IP アドレス構成 (プライベートまたはパブリック IP) を保持します。 NIC がロード バランサーのバックエンド IP アドレス プールに追加されると、ロード バランサーは、作成された負荷分散規則に基づいて、負荷分散されたネットワーク トラフィックを送信し始めます。

可用性セットは、仮想マシンをロード バランサーに追加するために使用されるグループ化方法です。 可用性セットによって、仮想マシンが同じ物理ハードウェアに配置されないようにして、物理インフラストラクチャに関連するエラーが発生した場合でも、ロード バランサーから常に負荷分散されたネットワーク トラフィックが仮想マシンに送信されるように確保することができます。

次に、Azure リソース マネージャー (ARM) のロード バランサーの説明図を示します。

![ハッシュ ベースのロード バランサー](./media/load-balancer-overview/arm-lb.png)

## Load Balancer の機能

### 第 4 層の Load Balancer、ハッシュ ベースの分散

Azure Load Balancer は、ハッシュ ベースの分散アルゴリズムを使用します。 既定では、5 つの組 (ソース IP、ソース ポート、接続先 IP、接続先ポート、プロトコルの種類) のハッシュを使用して、使用可能なサーバーにトラフィックをマップします。 これは、トランスポート セッション内でのみ持続性を提供します。 TCP または UDP の同じセッション内のパケットは、負荷分散されたエンドポイントの背後にある同じデータ センターの IP (DIP) インスタンスに送信されます。 クライアントがもう一度接続を開くか、同じソース IP から新しいセッションを開始すると、ソース ポートが変更されます。 これにより、トラフィックは別の DIP エンドポイントに送信される可能性があります。


詳細については [分散モードの負荷分散](load-balancer-distribution-mode.md)

![ハッシュ ベースのロード バランサー](./media/load-balancer-overview/load-balancer-distribution.png)

### ポート フォワーディング

Azure Load Balancer では、受信通信 (他のクラウド サービスや仮想ネットワーク内のインターネット ホストや仮想マシンから送信されるトラフィックなど) の管理方法を制御します。 この制御は、エンドポイントで表されます (入力エンドポイントとも呼ばれます)。

エンドポイントはパブリック ポートでリッスンし、内部ポートにトラフィックを転送します。  内部エンドポイントと外部エンドポイントには同じポートをマップしたり、別のポートを使用することもできます。 たとえば、パブリック エンドポイントをポート 80 にマップしているときに、Web サーバーがポート 81 をリッスンするように構成できます。 パブリック エンドポイントを作成すると、Azure Load Balancer の作成がトリガーされます。

Microsoft Azure 管理ポータルを使用して作成した仮想マシンのエンドポイントは、既定で、リモート デスクトップ プロトコル (RDP) とリモート Windows PowerShell セッションのトラフィック用に使用および構成されます。 これらのエンドポイントを使用して、インターネット上で仮想マシンをリモートで管理することができます。


### スケール アウト/スケール ダウンの自動再構成

Azure Load Balancer は、インスタンスをスケール アップまたはスケール ダウンするとすぐに自身を再構成します (Web ロール / worker ロールのインスタンス数を増やすため、または同じ負荷分散セットに追加の仮想マシンを配置するため)。


### サービスの監視
Azure Load Balancer は、さまざまなサーバー インスタンスの正常性をプローブする機能を提供します。 プローブが応答できない場合は、Azure Load Balancer は異常なインスタンスへの新しい接続の送信を停止します。 既存の接続は影響を受けません。 

次の 3 種類のプローブがサポートされています。
 
- ゲスト エージェント プローブ (PaaS VM のみ)。 Azure Load Balancer は、仮想マシン内のゲスト エージェントを使用してリッスンし、インスタンスが準備完了状態の場合のみ (ビジー、リサイクル中、停止中などの状態でない場合) HTTP 200 OK 応答を返します。 ゲスト エージェントが HTTP 200 OK に応答できない場合、Azure Load Balancer はそのインスタンスを応答不能と見なし、インスタンスへのトラフィックの送信を停止します。 Azure Load Balancer は引き続きインスタンスに ping を実行し、ゲスト エージェントが HTTP 200 に応答した場合は、Azure Load Balancer がもう一度そのインスタンスにトラフィックを送信します。  Web サイトのコードは、通常は Azure ファブリックでは監視されない w3wp.exe または (例: w3wp.exe が失敗のつまりゲスト エージェントで実行する web ロールを使用する場合。 HTTP 500 応答) は、ゲスト エージェントに報告されず、ロード バランサーはのことをローテーションから外すには、そのインスタンスを認識しません。

- HTTP カスタム プローブ。 カスタム ロード バランサー プローブは、既定のゲスト エージェント プローブを上書きするため、ユーザーは独自のカスタム ロジックを作成してロール インスタンスの正常性を判断できます。  ロード バランサーは、エンドポイントを定期的に調査し (既定では 15 秒ごと)、タイムアウト期間内 (既定値は 31 秒) にインスタンスが TCP ACK または HTTP 200 に応答した場合はローテーション内にあると見なします。  これは、ユーザー独自のロジックを実装して、インスタンスをロード バランサーのローテーションから削除する場合に役立ちます (インスタンスが CPU の 90% を超えたら 200 以外の状態を返すなど)。  Web ロールの場合は、Web サイト コードが失敗してもロード バランサー プローブに 200 以外の状態が返されるため、w3wp.exe の使用は Web サイトの自動監視を意味します。  

- TCP カスタム プローブ。 TCP プローブは、定義済みプローブ ポート上の正常な TCP セッションの確立に依存します。

詳細については、次を参照してください。 [ロード バランサー ヘルス プローブ](https://msdn.microsoft.com/library/azure/jj151530.aspx)します。

### Source NAT (SNAT)


サービスからインターネットへのすべての送信トラフィックは、受信トラフィックと同じ VIP アドレスを使用して Source NAT (SNAT) 変換されます。 SNAT には重要な利点があります。

- VIP を別のサービス インスタンスに動的にマップできるため、サービスのアップグレードや障害回復が簡単にできます。

- ACL は VIP を使用して表現できるため、ACL の管理が簡単になります。サービスのスケール アップやスケール ダウン、再デプロイによって変更されません。

Azure Load Balancer の構成は、UDP の Full cone NAT をサポートします。 Full cone NAT は、ポートが (送信要求に応答して) 任意の外部ホストからの着信接続を許可する NAT の一種です。


>[AZURE.NOTE]接続ごとに新しい送信 VM によって開始された、送信ポートにも割り当てられる Azure ロード バランサーによってに注意してください。 外部ホストは、VIP: allocated port からのトラフィックを認識します。  大量の送信接続が必要なシナリオの場合は、送信 IP を Source Network Address Translation (SNAT) 専用にできるように、VM ではインスタンス レベルのパブリック IP を使用することをお勧めします。 これにより、ポートの枯渇のリスクが減少します。 
>
>VIP または ILPIP で使用できるポートの最大数は 64k です。 これは TCP の標準的な限度です。


**仮想マシンの複数の負荷分散された IP のサポート**

仮想マシン セットに割り当てられている負荷分散されたパブリック IP アドレスを 1 つ以上取得できます。 この機能を使用して、複数の SSL Web サイトや複数の SQL AlwaysOn 可用性グループ リスナーを同じ仮想マシン セット上にホストすることができます。 詳細を参照する [クラウド サービスごとの複数の VIP](load-balancer-multivip.md)

* * Azure リソース マネージャーを使用して、テンプレートに基づいた展開 * * 
Azure リソース マネージャー (ARM) は、Azure のサービスの新しい管理フレームワークです。 Azure リソース マネージャー ベースの API とツールを使用して Azure Load Balancer を管理できるようになりました。 Azure リソース マネージャーについての詳細については、次を参照してください [なった Iaas Azure リソース マネージャーで簡単に。](http://azure.microsoft.com/blog/2015/04/29/iaas-just-got-easier-again/)


## 次のステップ

[インターネットに接続するロード バランサーの概要](load-balancer-internet-overview.md)

[内部ロード バランサーの概要](load-balancer-internal-overview.md)

[インターネットに接続するロード バランサーの開始](load-balancer-internet-getstarted.md)
 


