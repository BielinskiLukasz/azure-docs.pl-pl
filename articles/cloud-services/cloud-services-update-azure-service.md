<properties
pageTitle="クラウド サービスの更新方法 | Microsoft Azure"
description="Azure のクラウド サービスの更新方法について説明します。 クラウド サービスで更新が処理され、可用性が確保されるしくみについて説明します。"
services="cloud-services"
documentationCenter=""
authors="kenazk"
manager="timlt"
editor=""/>
<tags
ms.service="cloud-services"
ms.workload="tbd"
ms.tgt_pltfrm="na"
ms.devlang="na"
ms.topic="article"
ms.date="10/26/2015"
ms.author="kenazk"/>

# クラウド サービスの更新方法

## 概要
クラウド上でロールとゲスト OS の両方を含むクラウド サービスを更新するには、次の 3 つの手順を実施します。 最初に、クラウド サービスまたは OS の新しいバージョン用のバイナリ ファイルと構成ファイルをアップロードする必要があります。 次に、Azure で、クラウド サービスの新しいバージョンの要件に基づいて、クラウド サービスのコンピューティング リソースとネットワーク リソースが予約されます。 最後に、Azure で、ローリング アップグレードが実行され、可用性を維持しながら、テナントが新しいバージョンまたは新しいゲスト OS に段階的に更新されます。 この記事では、この最後の手順であるローリング アップグレードの詳細について説明します。

## Azure サービスを更新する

Azure では、ロール インスタンスが、アップグレード ドメイン (UD) と呼ばれる論理的なグループに編成されます。 アップグレード ドメイン (UD) は、1 つのグループとして更新されるロール インスタンスの論理セットです。  Azure ではクラウド サービスの更新を一度に 1 つの UD に対して行います。そのため、他の UD 内のインスタンスは引き続きトラフィックを処理できます。

アップグレード ドメインの既定の数は 5 です。 アップグレード ドメインの数を変更するには、サービスの定義ファイル (.csdef) に upgradeDomainCount 属性を追加します。 UpgradeDomainCount 属性の詳細については、次を参照してください。 [WebRole スキーマ](https://msdn.microsoft.com/library/azure/gg557553.aspx) または [WorkerRole スキーマ](https://msdn.microsoft.com/library/azure/gg557552.aspx)します。

サービス内の 1 つ以上のロールをインプレースで更新すると、Azure では、そのロールが属するアップグレード ドメインに相当するロール インスタンスのセットが更新されます。 Azure は、1 つのアップグレード ドメイン内のすべてのインスタンスを更新してから (つまり、インスタンスを停止し、更新して、オンラインに復帰させてから)、次のドメインの処理に移ります。 現在のアップグレード ドメインで実行されているインスタンスのみを停止することで、更新が実行中のサービスに与える影響を最小限に抑えています。 詳細については、次を参照してください。 [更新処理のようす](https://msdn.microsoft.com/library/azure/Hh472157.aspx#proceed) この記事で後述します。

> [AZURE.NOTE] 条件の中に **更新** と **アップグレード** コンテキスト Azure で若干異なる意味を持つ、プロセスおよびこのドキュメントでは機能の説明の同じ意味で使用できます。

ダウンタイムなしでロールをインプレース更新するには、サービスにそのロール インスタンスを少なくとも 2 つ定義する必要があります。 サービスが 1 つのロールの 1 つのインスタンスのみで構成されている場合、インプレース更新が完了するまでサービスを使用できません。

このトピックでは、Azure の更新に関する次の情報について説明します。

-   [更新中に許可されるサービスの変更](#AllowedChanges)
-   [更新のロールバック](#RollbackofanUpdate)
-   [進行中のデプロイに対する複数の変更操作の開始](#multiplemutatingoperations)
-   [複数のアップグレード ドメインへのロールの分配](#distributiondfroles)
-   [アップグレードの処理のしくみ](#howanupgradeproceeds)

## 更新中に許可されるサービスの変更
次の表は、更新中に許可されるサービスの変更を示しています。

|ホスティング、サービス、ロールに対して許可される変更|インプレース更新|ステージング (VIP スワップ)|削除と再デプロイ|
|---|---|---|---|
|オペレーティング システムのバージョン|あり|はい|あり
|.NET 信頼レベル|あり|はい|あり|
|仮想マシンのサイズ|はい*|あり|あり|
|ローカル ストレージの設定|増加のみ*|あり|あり|
|サービス内のロールの追加または削除|あり|はい|あり|
|特定のロールのインスタンスの数|あり|はい|あり|
|サービスのエンドポイントの数または種類|はい*|いいえ|あり|
|構成設定の名前と値|あり|はい|あり|
|構成設定の値 (名前は不可)|あり|はい|あり|
|新しい証明書の追加|あり|はい|あり|
|既存の証明書の変更|あり|はい|あり|
|新しいコードのデプロイ|あり|はい|あり|
Azure SDK 1.5 \*Requires またはそれ以降のバージョン。

> [AZURE.WARNING] 仮想マシンのサイズを変更すると、ローカル データが破棄されます。


更新中、次の操作はサポートされていません。

-   ロールの名前の変更。 そのロールを削除してから、新しい名前を持つロールを追加してください。
-   アップグレード ドメインの数の変更。
-   ローカル リソースのサイズの縮小。

ローカル リソースのサイズの縮小など、サービスの定義に他の更新を加える場合は、代わりに VIP スワップ更新を実行する必要があります。 詳細については、次を参照してください。 [展開のスワップ](https://msdn.microsoft.com/library/azure/ee460814.aspx)します。

## アップグレードの処理のしくみ
サービス内のすべてのロールを更新するか、サービス内の単一のロールを更新するかを決めることができます。 どちらの場合も、アップグレード対象の最初のアップグレード ドメインに属する各ロールのインスタンスがすべて停止され、アップグレードされてから、オンラインに復帰します。 最初のアップグレード ドメインがオンラインに戻った後で、2 番目のアップグレード ドメイン内のインスタンスが、停止後にアップグレードされて、オンラインに復帰します。 クラウド サービスでは、一度に 1 つのアップグレードしかアクティブになりません。 アップグレードは常に、クラウド サービスの最新のバージョンに対して実行されます。

次の図は、サービス内のすべてのロールをアップグレードする場合のアップグレードの処理のしくみを示しています。

![サービスのアップグレード](media/cloud-services-update-azure-service/IC345879.png "Upgrade service")

この次の図では、単一のロールのみをアップグレードする場合の更新の処理のしくみを示しています。

![ロールのアップグレード](media/cloud-services-update-azure-service/IC345880.png "Upgrade role")  

> [AZURE.NOTE] 複数のインスタンスを 1 つのインスタンスからサービスをアップグレードする場合、サービスが停止されますサービス方法 Azure のアップグレードのため、アップグレードを実行中です。 サービス レベル アグリーメントによるサービスの可用性保証は、複数のインスタンスでデプロイされたサービスのみに適用されます。 次の一覧は、各ドライブ上のデータが Azure サービスのアップグレード シナリオによってどのような影響を受けるかを示しています。
>
>VM の再起動:
>
-   C: 保持される
-   D: 保持される
-   E: 保持される
>
>ポータルの再起動:
>
-   C: 保持される
-   D: 保持される
-   E: 破棄される
>
>ポータルの再イメージ化:
>
-   C: 保持される
-   D: 破棄される
-   E: 破棄される

>インプレース アップグレード:
>
-   C: 保持される
-   D: 保持される
-   E: 破棄される
>
>ノードの移行:
>
-   C: 破棄される
-   D: 破棄される
-   E: 破棄される

>上の一覧中の E: ドライブはロールのルート ドライブを表しているため、ハードコーディングしないように注意してください。 代わりに、%RoleRoot% 環境変数を使用してドライブを表してください。

>単一のインスタンスのみで構成されるサービスをアップグレードする場合にダウンタイムを最小限に抑えるには、複数のインスタンスで構成される新しいサービスをステージング サーバーにデプロイし、VIP スワップを実行します。

自動更新中、Azure ファブリック コントローラーがクラウド サービスの正常性を定期的に評価し、次の UD に進む安全なタイミングを判断します。 この正常性の評価はロールごとに実行され、最新バージョンのインスタンス (つまり、処理済みの UD のインスタンス) のみが対象になります。 この評価では、ロールごとに、最小限の数のロール インスタンスが良好な最終状態になったかどうかが検証されます。

### ロール インスタンス開始のタイムアウト 
ファブリック コントローラーは、各ロール インスタンスが開始状態に到達するまで 30 分間待機します。 このタイムアウト期間が経過すると、ファブリック コントローラーは次のロール インスタンスに進みます。 

## 更新のロールバック
Azure では、更新中のサービス管理の柔軟性を高めるために、最初の更新要求が Azure ファブリック コントローラーで受信された後もサービスに対する追加の操作を実行することができます。 ロールバックは、更新プログラム (構成の変更) の場合にのみ実行できる、またはアップグレードが、 **進行中の** 展開の状態。 更新またはアップグレードが進行中であると見なされるのは、新しいバージョンに更新されていないサービスのインスタンスが少なくとも 1 つある場合です。 によって返される、RollbackAllowed フラグの値を確認して、ロールバックが許可されているかどうかをテストするに [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) と [クラウド サービスのプロパティの取得](https://msdn.microsoft.com/library/azure/ee460806.aspx) 、操作が設定を true にします。

> [AZURE.NOTE] のみをする方のロールバックを呼び出す、 **インプレース** 更新またはアップグレード VIP スワップ アップグレードでは、別のサービスの 1 つ全体の実行中のインスタンスを置き換えることが含まれるためです。

進行中の更新をロールバックすると、デプロイに次の影響を与えます。

-   新しいバージョンへの更新またはアップグレードが完了していないロール インスタンスは、更新またはアップグレードされません。これらのインスタンスでは、目的のバージョンのサービスが既に実行されているためです。
-   既に更新またはサービス パッケージ (\*.cspkg) ファイルまたはサービス構成 (\*.cscfg) ファイル (または両方のファイル) の新バージョンにアップグレードしたロール インスタンスは、これらのファイルのアップグレード前のバージョンに戻されます。

ロールバックは、次の機能によって実現されています。

-    [ロールバックを更新またはアップグレード](https://msdn.microsoft.com/library/azure/hh403977.aspx) 操作で、構成の更新と呼ばれることができます (呼び出しによってトリガーされる [配置構成の変更](https://msdn.microsoft.com/library/azure/ee460809.aspx)) またはアップグレード (呼び出しによってトリガーされる [デプロイのアップグレード](https://msdn.microsoft.com/library/azure/ee460793.aspx)) 新しいバージョンに更新されていないサービスには、少なくとも 1 つのインスタンスがある限り、します。
-   Locked 要素と RollbackAllowed 要素の応答本文の一部として返される、 [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) と [クラウド サービスのプロパティの取得](https://msdn.microsoft.com/library/azure/ee460806.aspx) 操作。
    1.  Locked 要素を使用すると、特定のデプロイで変更操作を呼び出すことができるタイミングを検出できます。
    2.  RollbackAllowed 要素を使用するときに検出すると、 [更新またはアップグレードのロールバック](https://msdn.microsoft.com/library/azure/hh403977.aspx) 操作は、特定の配置に対して呼び出すことができます。

    ロールバックを実行するために、Locked 要素と RollbackAllowed 要素の両方を確認する必要はありません。 RollbackAllowed が true に設定されていることを確認するだけで十分です。 "x-ms-version: 2011-10-01" またはそれ以降のバージョンに設定されている要求ヘッダーを使用してこれらのメソッドが呼び出された場合のみ、この 2 つの要素が返されます。 バージョン ヘッダーの詳細については、次を参照してください。 [サービス管理のバージョン管理](https://msdn.microsoft.com/library/azure/gg592580.aspx)します。

更新やアップグレードのロールバックがサポートされないのは、次のような場合です。

-   ローカル リソースの不足: 更新によってロールのローカル リソース使用量が増える場合、Azure のプラットフォームではロールバックが許可されません。 ロールのローカル リソースを構成する方法の詳細については、次を参照してください。 [ローカル ストレージ リソースの構成](https://msdn.microsoft.com/library/azure/ee758708.aspx)します。
-   クォータの制限: 更新することでスケールダウンする場合、ロールバック操作を完了できるだけのコンピューティング クォータがなくなる可能性があります。 Azure の各サブスクリプションには、そのサブスクリプションに関連付けられているクォータがあります。このクォータは、そのサブスクリプションに属するすべてのホストされるサービスで使用できるコアの最大数を指定しています。 特定の更新のロールバックを実行することでサブスクリプションがクォータを越える場合、ロールバックは有効になりません。
-   競合状態: 最初の更新が完了している場合、ロールバックできません。

使用するかどうかと更新のロールバックすることがの例としては、 [デプロイのアップグレード](https://msdn.microsoft.com/library/azure/ee460793.aspx) を Azure の主要なインプレース アップグレードするには、サービスがホストされている割合を制御手動モードで操作をロールアウトします。

アップグレードのロールアウト中を呼び出す [デプロイのアップグレード](https://msdn.microsoft.com/library/azure/ee460793.aspx) 手動モードでアップグレード ドメインの逐次処理を開始します。 かどうか、ある時点で、アップグレードを監視することに注意していずれかを確認する最初のアップグレード ドメインのロール インスタンスが応答しなくなるが、呼び出すことができます、 [更新またはアップグレードのロールバック](https://msdn.microsoft.com/library/azure/hh403977.aspx) まだアップグレードされていないインスタンスと、以前のサービス パッケージと構成にアップグレードされてロールバック インスタンスにそのままに、その配置に対して操作が残ります。

## 進行中のデプロイに対する複数の変更操作の開始
進行中のデプロイに対して複数の変更操作を同時に開始することが必要になる場合があります。 たとえば、サービス更新を実行していて、その更新がサービス全体にロール アウトされている間に、更新のロールバック、別の更新の適用、場合によってはデプロイの削除など、なんらかの変更を加える必要が生じることがあります。 これが必要になる一例は、アップグレード後のロール インスタンスでクラッシュが繰り返し発生するようなバグがサービス アップグレードのコードに含まれている状況です。 この場合、アップグレード済みのドメイン内で正常な状態のインスタンスが少なくなるため、Azure ファブリック コントローラーでは、アップグレードの適用を進めることができなくなります。 この状態と呼ばれます、 *展開を停止している*します。 更新をロールバックするか、失敗したデプロイを上書きする形で新しい更新を適用することで、スタック デプロイを正常な状態に戻すことができます。

サービスを更新またはアップグレードする最初の要求が Azure ファブリック コントローラーで受信されると、後続の変更操作を開始できます。 つまり、別の変更操作を開始するために、最初の操作が完了するまで待つ必要はありません。

最初の更新の進行中に 2 つ目の更新操作を開始すると、ロールバック操作と似た方法で処理が実行されます。 2 番目の更新が自動モードである場合、最初のアップグレード ドメインが直ちにアップグレードされ、複数のアップグレード ドメインのインスタンスが同時にオフラインになる可能性があります。

変更操作は次のとおり: [配置構成の変更](https://msdn.microsoft.com/library/azure/ee460809.aspx), 、[デプロイのアップグレード](https://msdn.microsoft.com/library/azure/ee460793.aspx), 、[更新プログラムの展開ステータス](https://msdn.microsoft.com/library/azure/ee460808.aspx), 、[展開の削除](https://msdn.microsoft.com/library/azure/ee460815.aspx), 、および [更新またはアップグレードのロールバック](https://msdn.microsoft.com/library/azure/hh403977.aspx)します。

2 つの操作 [Get Deployment](https://msdn.microsoft.com/library/azure/ee460804.aspx) と [クラウド サービスのプロパティの取得](https://msdn.microsoft.com/library/azure/ee460806.aspx), 、特定の配置に対して変更操作を呼び出すことができるかどうかを決定を調べることはロック済みフラグを返します。

これらの操作のうち、Locked フラグを返すバージョンを呼び出すには、要求ヘッダーに "x-ms-version: 2011-10-01" 以降を設定する必要があります。 バージョン ヘッダーの詳細については、次を参照してください。 [サービス管理のバージョン管理](https://msdn.microsoft.com/library/azure/gg592580.aspx)します。

## 複数のアップグレード ドメインへのロールの分配
Azure では、設定された数のアップグレード ドメイン全体に対してロール インスタンスが均等に分配されます。この数は、サービス定義 (.csdef) ファイルの一部として構成することができます。 アップグレード ドメインの最大数は 20 で、既定値は 5 です。 サービス定義ファイルを変更する方法の詳細については、次を参照してください。 [Azure サービス定義スキーマ (.csdef ファイル)](https://msdn.microsoft.com/library/azure/ee758711.aspx)します。

たとえば、ロールに 10 個のインスタンスがある場合、既定では各アップグレード ドメインに 2 個のインスタンスが含まれます。 ロールに 14 個のインスタンスがある場合は、4 つのアップグレード ドメインにそれぞれ 3 個のインスタンスが含まれ、5 番目のアップグレード ドメインには 2 個が含まれます。

アップグレード ドメインは、0 から始まるインデックスで識別されます。最初のアップグレード ドメインの ID は 0、2 番目のアップグレード ドメインの ID は 1、と続きます。

次の図は、サービスに 2 つのアップグレード ドメインが定義されているときに、2 つのロールで構成されるサービスが分配されるしくみを示しています。 サービスは、Web ロールの 8 個のインスタンスと worker ロールの 9 個のインスタンスを実行しています。

![アップグレード ドメインの分配](media/cloud-services-update-azure-service/IC345533.png "Distribution of Upgrade Domains")

> [AZURE.NOTE] Azure のアップグレード ドメイン間でのインスタンスの割り当て方法が制御されることに注意してください。 どのインスタンスをどのドメインに割り当てるかを指定することはできません。

## 次のステップ
[クラウド サービスを管理する方法](cloud-services-how-to-manage.md)<br>
[クラウド サービスを監視する方法](cloud-services-how-to-monitor.md)<br>
[クラウド サービスを構成する方法](cloud-services-how-to-cofigure.md)<br>

