<properties
   pageTitle="SQL データベース ファイアウォールの構成 | Microsoft Azure"
   description="アクセスを管理するために、サーバー レベルおよびデータベース レベルのファイアウォール規則を使用して SQL データベース ファイアウォールを構成する方法について説明します。"
   keywords="database firewall"
   services="sql-database"
   documentationCenter=""
   authors="BYHAM"
   manager="jeffreyg"
   editor="cgronlun"
   tags=""/>

<tags
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management"
   ms.date="11/24/2015"
   ms.author="rickbyh"/>

# Azure SQL データベース ファイアウォールを構成する方法

Microsoft Azure SQL Database は、Azure およびその他のインターネット ベースのアプリケーション用のリレーショナル データベース サービスを提供します。 データを保護するため、SQL Database ファイアウォールは、どのコンピューターに権限を持たせるかを指定するまで、SQL Database サーバーへのすべてのアクセスを遮断します。 データベースのファイアウォールは、各要求の送信元 IP アドレスに基づいてアクセス権を付与します。

データベースのファイアウォールを構成するには、受け入れ可能な IP アドレスの範囲を指定するファイアウォール規則を作成します。 サーバーおよびデータベース レベルでは、ファイアウォール規則を作成できます。

- **サーバー レベルのファイアウォール規則:** これらのルールは、Azure SQL Database サーバー全体、つまりにアクセスするクライアントが同じ論理サーバー内のすべてのデータベースを有効にします。 これらのルールに含まれて、 **マスター** データベースです。
- **データベース レベルのファイアウォール規則:** これらのルールは、Azure SQL Database サーバー内の個々 のデータベースにアクセスするクライアントを有効にします。 これらのルールは、データベースごとに作成され、個々 のデータベースに格納されます (を含む **マスター**)。 これらの規則は、同じ論理サーバー内の特定の (セキュリティで保護された) データベースへのアクセスを制限する場合に便利です。

**推奨事項:** 、データベースの移植性を高める可能な限り、データベース レベルのファイアウォール ルールの使用をお勧めします。 アクセス要件が同じ多くのデータベースがある場合、およびそれぞれのデータベースの設定に時間を費やしたくない場合は、サーバー レベルのファイアウォール規則を使用します。

**ついてフェデレーション:** フェデレーションの現在の実装は、Web および Business サービス階層で廃止される予定です。 スケーラビリティ、柔軟性、パフォーマンスを最大限に高めるために、カスタム シャーディング ソリューションのデプロイを検討してください。 カスタム シャーディングの詳細については、次を参照してください。 [Azure SQL Database のスケール アウト](https://msdn.microsoft.com/library/dn495641.aspx)します。

> [AZURE.NOTE] ルート データベースがデータベース レベルのファイアウォール ルールを含む Azure SQL Database にデータベース フェデレーションを作成する場合、規則はフェデレーション メンバー データベースにコピーされません。 フェデレーション メンバーに対し、データベース レベルのファイアウォール規則が必要な場合、フェデレーション メンバーの規則を再作成する必要があります。 ただし、ALTER FEDERATION を使用して新しいフェデレーション メンバーにデータベース レベルのファイアウォール ルールを含むフェデレーション メンバーを分割する場合. SPLIT ステートメント、新しいターゲット メンバーは、ソース フェデレーション メンバーと同じデータベース レベルのファイアウォール規則があります。 フェデレーションの詳細については、次を参照してください。 [Azure SQL Database におけるフェデレーション](https://msdn.microsoft.com/library/hh597452.aspx)します。

## SQL Database ファイアウォールの概要

最初は、Azure SQL Database サーバーへのすべてのアクセスは、ファイアウォールによってブロックされます。 Azure SQL Database サーバーの使用を開始するためには、クラシック ポータルに移動し、Azure SQL Database サーバーへのアクセスを有効にする 1 つまたは複数のサーバー レベルのファイアウォール規則を指定する必要があります。 ファイアウォール規則を使用すると、インターネットからのアクセスを許可する IP アドレス範囲、および Azure アプリケーションから Azure SQL Database サーバーへの接続を試みることができるかどうかを指定できます。

ただし、Azure SQL Database サーバーにある 1 つのデータベースにのみ選択的にアクセス許可を付与するには、サーバー レベルのファイアウォール規則で指定された IP アドレス範囲を超えた IP アドレス範囲とともに、必要なデータベース用のデータベース レベルの規則を作成する必要があります。また、そのクライアントの IP アドレス範囲が、データベース レベルの規則で指定された範囲内にあるようにします。

インターネットおよび Azure からの接続の試行は、次の図に示されるように、Azure SQL Database サーバーまたはデータベースに到達する前にファイアウォールを通過する必要があります。

   ![図の SQL Database ファイアウォールの構成を記述します。][1]

## インターネットからの接続

コンピューターがインターネットからデータベース サーバーに接続しようとした場合、ファイアウォールは、すべてのサーバー レベルのファイアウォール規則と (必要な場合は) データベース レベルのファイアウォール規則に対し、要求の送信元の IP アドレスを確認します。

- 要求の IP アドレスがサーバー レベルのファイアウォール規則で指定されたいずれかの IP アドレス範囲内にある場合は、Azure SQL Database サーバーへの接続が許可されます。

- 要求の IP アドレスがサーバー レベルのファイアウォール規則で指定されたいずれかの IP アドレス範囲内にない場合は、データベース レベルのファイアウォール規則が確認されます。 要求の IP アドレスがデータベース レベルのファイアウォール規則で指定されたいずれかの IP アドレス範囲内にある場合は、該当するデータベース レベルの規則を持つデータベースへの接続のみが許可されます。

- 要求の IP アドレスがサーバー レベルのファイアウォール規則またはデータベース レベルのファイアウォール規則で指定された IP アドレス範囲内にない場合は、接続要求は失敗します。

> [AZURE.NOTE] ローカル コンピューターから Azure SQL データベースにアクセスするには、ネットワークおよびローカル コンピューター上のファイアウォールが TCP ポート 1433年で送信の通信を許可を確認します。


## Azure からの接続

Azure からアプリケーションがデータベース サーバーに接続しようとした場合、ファイアウォールは、Azure の接続が許可されていることを確認します。 開始アドレスと終了アドレスが 0.0.0.0 であるファイアウォール設定は、これらの接続が許可されていることを示します。 接続試行が許可されていない場合、要求は、Azure SQL Database サーバーに到達しません。

Azure からの接続を有効にすることができます、 [クラシック ポータル](http://go.microsoft.com/fwlink/p/?LinkID=161793) は 2 つあります。

- チェック ボックスをオン **Microsoft Azure サービス、サーバーへのアクセス許可** 新しいサーバーを作成するときにします。

-  **構成** [サーバー] タブ、 **使用できるサービス** ] をクリックして **はい** の **Microsoft Azure サービス**します。

## 最初のサーバー レベルのファイアウォール規則の作成

使用して最初のサーバー レベルのファイアウォール設定を作成することができます、 [旧ポータル](http://go.microsoft.com/fwlink/p/?LinkID=161793) またはプログラムを使用して、REST API または Azure PowerShell を使用しています。 それ以降のサーバー レベルのファイアウォール規則もこれらの方法で作成および管理できます。また、Transact-SQL を介しても実行できます。 サーバー レベルのファイアウォール ルールの詳細については、次を参照してください。 [方法: ファイアウォールの設定を構成する (Azure SQL データベース)](sql-database-configure-firewall-settings.md)します。

## データベース レベルのファイアウォール規則の作成

最初のサーバー レベルのファイアウォールを構成した後、特定のデータベースへのアクセスを制限することがあります。 サーバー レベルのファイアウォール規則で指定された範囲外にあるデータベース レベルのファイアウォール規則で IP アドレスの範囲を指定した場合、データベース レベルの範囲の IP アドレスを持つクライアントのみがデータベースにアクセスできます。 データベースに対し、最大 128 のデータベース レベルのファイアウォール規則を持つことができます。 マスターおよびユーザーのデータベースに対するデータベース レベルのファイアウォール規則は、Transact-SQL を介して作成、および管理できます。 詳細については、次を参照してください。 [方法: ファイアウォールの設定を構成する (Azure SQL データベース)](sql-database-configure-firewall-settings.md)します。

## データベース ファイアウォール規則のプログラムによる管理

ファイアウォール規則は、Azure クラシック ポータルに加え、Transact-SQL、REST API、および Azure PowerShell を使用して、プログラムによって管理することができます。 以下の表では、各メソッドで使用できるコマンド セットについて説明します。


### Transact-SQL

| カタログ ビューまたはストアド プロシージャ                                                           | Level     | 説明                                          |
|--------------------------------------------------------------------------------------------|-----------|------------------------------------------------------|
| [sys.firewall_rules](https://msdn.microsoft.com/library/dn269980.aspx)                   | サーバー    | 現在のサーバー レベルのファイアウォール規則を表示     |
| [sp_set_firewall_rule](https://msdn.microsoft.com/library/dn270017.aspx)             | サーバー    | サーバー レベルのファイアウォール規則を作成または更新       |
| [sp_delete_firewall_rule](https://msdn.microsoft.com/library/dn270024.aspx)          | サーバー    | サーバー レベルのファイアウォール規則を削除                  |
| [sys.database_firewall_rules](https://msdn.microsoft.com/library/dn269982.aspx)        | データベース  | 現在のデータベース レベルのファイアウォール規則を表示   |
| [sp_set_database_firewall_rule](https://msdn.microsoft.com/library/dn270010.aspx)    | データベース  | データベース レベルのファイアウォール規則を作成または更新 |
| [sp_delete_database_firewall_rule](https://msdn.microsoft.com/library/dn270030.aspx) | データベース | データベース レベルのファイアウォール規則を削除                |

### REST API

| API                  | Level  | 説明                                                      |
|----------------------|--------|------------------------------------------------------------------|
| [ファイアウォール規則の一覧表示](https://msdn.microsoft.com/library/azure/dn505715.aspx)  | サーバー | 現在のサーバー レベルのファイアウォール規則を表示                 |
| [ファイアウォール規則の作成](https://msdn.microsoft.com/library/azure/dn505712.aspx) | サーバー | サーバー レベルのファイアウォール規則を作成または更新                   |
| [ファイアウォール規則の設定](https://msdn.microsoft.com/library/azure/dn505707.aspx)    | サーバー | 既存のサーバー レベルのファイアウォール規則のプロパティを更新 |
| [ファイアウォール規則の削除](https://msdn.microsoft.com/library/azure/dn505706.aspx) | サーバー | サーバー レベルのファイアウォール規則を削除                              |


### Azure PowerShell

| コマンドレット                                                                                              | Level  | 説明                                                      |
|-----------------------------------------------------------------------------------------------------|--------|------------------------------------------------------------------|
| [Get-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546731.aspx)    | サーバー | 現在のサーバー レベルのファイアウォール規則を返す                  |
| [New-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546724.aspx)    | サーバー | 新しいサーバー レベルのファイアウォール規則を作成                         |
| [Set-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546739.aspx)    | サーバー | 既存のサーバー レベルのファイアウォール規則のプロパティを更新 |
| [Remove-AzureSqlDatabaseServerFirewallRule](https://msdn.microsoft.com/library/azure/dn546727.aspx) | サーバー | サーバー レベルのファイアウォール規則を削除                              |

> [AZURE.NOTE] 可能性があります 5 分間設定の変更を有効にするファイアウォールの設定を有効になります。

## データベース ファイアウォールのトラブルシューティング

Microsoft Azure SQL Database サービスへ期待どおりにアクセスできない場合は、次の点を検討してください。

- **ローカルのファイアウォールの構成:** お使いのコンピューターは、Azure SQL データベースにアクセスできる、前に、TCP ポート 1433年のコンピューターに、ファイアウォールの例外を作成する必要があります。 Azure クラウド境界内で接続を行う場合は、追加のポートをいくつか開かなければならない場合があります。 詳細については、次を参照してください。、 **SQL Database の V12: 外部と内部** の [1433 for ADO.NET 4.5 と SQL Database V12 における 1433 以外のポート](sql-database-develop-direct-route-ports-adonet-v12.md)します。

- **ネットワーク アドレス変換 (NAT):** NAT が原因で、Azure SQL Database に接続するコンピューターによって使用される IP アドレスが、異なる場合があります、コンピューターの IP 構成設定で表示される IP アドレスです。 Azure に接続するコンピューターを使用して IP アドレスを表示する従来のポータルにログインしに移動、 **構成** 、データベースをホストするサーバーでタブをクリックします。 下にある、 **使用できる IP アドレス** ] セクションで、 **現在のクライアント IP アドレス** が表示されます。 クリックして **追加** に、* * 使用できる IP アドレス * * このコンピューターにサーバーへのアクセスを許可するようにします。

- **許可一覧に加えた変更が有効にまだなっていない:** 5 分間の遅延の変更を有効にする Azure SQL Database ファイアウォールの構成にできるだけ多くかかる可能性があります。

- **ログインが許可されていないか、誤ったパスワードを使用します。** ログインでは、Azure SQL データベース サーバーでは、アクセス許可がありません、または使用するパスワードが正しくない、Azure SQL Database サーバーへの接続は拒否されます。 ファイアウォール設定の作成は、クライアントに対し、サーバーへの接続を試行する機会のみを提供します。それぞれのクライアントは、必要なセキュリティ資格情報を提供する必要があります。 ログインを準備する方法の詳細については、「データベースの管理」、「ログイン」、および「Azure SQL Database 内のユーザー」を参照してください。

- **動的 IP アドレス:** 動的 IP アドレス指定にはインターネット接続があり、ファイアウォールの通過に問題が発生した場合、次の解決策のいずれかを試して可能性があります。

 - Azure SQL Database サーバーへアクセスするクライアント コンピューターに割り当てられている IP アドレス範囲について、インターネット サービス プロバイダー (ISP) に問い合わせ、ファイアウォール規則として、IP アドレス範囲を追加してください。

 - 動的 IP アドレスの代わりに、静的 IP アドレスを取得し、ファイアウォール規則として、IP アドレス範囲を追加してください。

## 関連項目

[データベース ファイアウォール設定の構成方法 (Azure SQL Database)](sql-database-configure-firewall-settings.md)

[SQL Server Database エンジンと Azure SQL Database のセキュリティ センター](https://msdn.microsoft.com/library/bb510589)

<!--Image references-->
[1]: ./media/sql-database-firewall-configure/sqldb-firewall-1.png

