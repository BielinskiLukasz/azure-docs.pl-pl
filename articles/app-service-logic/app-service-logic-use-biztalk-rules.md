<properties
   pageTitle="BizTalk ルール"
   description="このトピックでは、BizTalk ルールの機能とその使用方法について説明します"
   services="app-service\logic"
   documentationCenter=".net,nodejs,java"
   authors="anuragdalmia"
   manager="dwrede"
   editor=""/>

<tags
   ms.service="app-service-logic"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration"
   ms.date="10/28/2015"
   ms.author="andalmia"/>

#BizTalk ルール

ビジネス ルールには、ビジネス プロセスを制御するポリシーと意思決定がカプセル化されます。 これらのポリシーは、手順書、契約書、合意書で正式に定義されることも、従業員が知識や専門知識として持っていることもあります。 これらのポリシーは動的であり、ビジネス プランや規則の変更、またはその他の理由により時間が経つと変更されることがあります。

これらのポリシーを従来のプログラミング言語で実装するにはかなりの時間と調整が必要であり、プログラマーが参加しないと、ビジネス ポリシーの作成と維持管理を行うことができません。 BizTalk のビジネス ルールでは、これらのポリシーを迅速に実装し、ビジネス プロセスの残りの部分と分離する方法を提供します。 これにより、ビジネス プロセスの残りの部分に影響を与えることなく、必要に応じてビジネス ポリシーを変更できます。

##ルールを使用する理由

ビジネス プロセスで BizTalk のビジネス ルールを使用する主な理由は、次の 3 つです。

* アプリケーション コードからビジネス ロジックを分離する
- ビジネス アナリストがビジネス ロジックの管理をより制御できるようにする
+ ビジネス ロジックの変更をより早く運用環境に送る

##ルールの概念

##ボキャブラリ

A _ボキャブラリ_ ルール条件およびアクションで使用されるコンピューティング オブジェクトのフレンドリ名で構成される定義のコレクションです。 ボキャブラリを定義すると、特定のビジネス分野のユーザーによるルールの参照、理解、共有が簡単になります。

ボキャブラリは、ビジネス セマンティクスと実装のギャップを解消するために設計されています。 たとえば、承認状態のデータ バインドは、SQL クエリとして表される特定のデータベースの特定の行の単一の列を示す場合があります。 ルールに直接このような複雑な表現を挿入する代わりに、たとえば、データ バインドに関連付けるボキャブラリ定義をフレンドリ名 "Status" で作成します。 後で任意の数のルールに "Status" を含めることができるので、ルール エンジンは、テーブルから対応するデータを取得できます。

##ルール

ビジネス ルールは、ビジネス プロセスの実施を管理する宣言型ステートメントです。 ルールは条件とアクションで構成されます。 条件が評価され、その結果が true であれば、ルール エンジンがアクションを開始します。
ビジネス ルール フレームワークではルールは次の形式で定義されます。

_IF_ _条件_ _し_ _アクション_

次の例を考えてみます。

*IF 金額が使用可能な資金以下である*  
*THEN 取引を行い、レシートを印刷する*

このルールはビジネス ロジックを適用して、2 つの金額、ここでは取引金額と使用可能な資金を比較し、取引を行うかどうかを決定します。
ビジネス ルールの作成、変更、デプロイにはビジネス ルールを使用します。 これらの作業を、プログラムで実行することもできます。

###条件

条件は 1 つ以上の述語から成る true/false (ブール値) 式です。
この例では、述語の "以下である" が "金額" と "使用可能な資金" に適用されます。 この条件の評価結果は常に true と false のいずれかになります。
述語は論理演算子の AND、OR、および NOT と組み合わせることができます。そのようにして作成された論理式は非常に大きくなることもありますが、評価結果は必ず true または false になります。

###アクション

アクションは条件評価の機能的な結果です。 ルールの条件が満たされると、対応するアクションが開始されます。
この例では、"取引を行う" と "レシートを印刷する" がアクションです。これらのアクションは、条件 (IF 金額が使用可能な資金以下である) が true の場合にのみ実行されます。
ビジネス ルール フレームワークでは、アクションは XML ドキュメントに対する集合演算という形で表現されます。

##ポリシー

ポリシーは、ルールの論理的なグループです。 ポリシーの作成、保存、テストを行い、目的の結果が得られた場合には、運用環境で使用することができます。

###ポリシーの作成

ルール ポータルでポリシーを作成できます。 ポリシーには、任意の大きさのルールのセットを含めることができますが、通常は、ポリシーを使用するアプリケーションのコンテキスト内で特定のビジネス ドメインに関連するルールからポリシーを作成します。

###ポリシーのテスト
ポリシーを運用環境で使用する前に、ポリシーのテスト実行を効果的に行うことができます。 ルール ポータルを使用して、入力をポリシーに提供し、ポリシーを実行し、その出力を表示することができます。 出力に含まれるのは、ログ、ルールの実行、条件の評価、および結果の出力です。

##サンプル シナリオ - 保険金請求
サンプル シナリオに沿って進め、シナリオと同じビジネス ロジックを作成します。

![Alt text][1]

このごく簡単な保険金請求のシナリオでは、請求者は (Web サイト、携帯電話のアプリなど任意のクライアントを利用して) 保険金請求を提出します。 この請求リクエストは企業の請求処理ユニットに送信され、処理の結果に基づいて、請求は承認または却下されるか、さらに手動で処理するように送信されることもあります。
このシナリオでは、請求処理ユニットにシステムのビジネス ロジックが含まれます。 このユニットについて詳しくは次をご覧ください。

![Alt text][2]

このビジネス ロジックを実装するには、ビジネス ルールを使用します。


##ルール API アプリの作成


1. Azure ポータルにログインします。
2. [新規作成] の [Marketplace し検索 *BizTalk ルール*
3. 結果の一覧から、BizTalk ルールを選択します。 BizTalk ルールのブレードが開きます。
4. 選択、 *作成* ボタン
![代替テキスト][3]
1. 新しく開いたブレードで、次の情報を入力します。  
    1. [名前] - ルール API アプリの名前を指定します
    1. [App Service プラン] – 新しい App Service プランを選択または作成します
    1. [価格レベル] - このアプリが属する価格レベルを選択します
    1. [リソース グループ] - このアプリが属するリソース グループを選択します
    2. [サブスクリプション] - 使用するサブスクリプションを選択します
    1. [場所] - アプリをデプロイする地域を選択します
4.  選択 *作成*します。 数分以内に BizTalk ルール API アプリが作成されます。

##ボキャブラリの作成
BizTalk ルール API アプリを作成したら、次にボキャブラリを作成します。 この演習を実行する開発者は一般的な人を想定しています。 作成方法を以下に示します。


1. BizTalk は、[参照] に移動して、ポータルから API アプリをルールの起動] メニューの [API アプリ - ><Your Rules API App>. この操作により、次に示すようなルール API アプリ ダッシュボードにアクセスします。

   ![Alt text][4]

2. [ボキャブラリの定義] を選択します。 ボキャブラリ作成画面を表示するとこの
3. では、新しいボキャブラリの定義の追加を開始するには、[追加] を選択します。
現在、ボキャブラリの定義では、リテラルと XML の 2 つの型がサポートされています。

##リテラルの定義
1.  [追加] をクリックすると、[定義の追加] ブレードが新しく開きます。 次の値を入力します。
  1.    [名前] - 英数字のみを使用できます。特殊文字は使用できません。 既存のボキャブラリ定義リストに対して一意である必要もあります。
  2.    [説明] - オプション フィールドです。
  3.    [定義の型] - 2 つの型がサポートされています。 この例では [リテラル] を選択します。
  4.    [データ型] - ここでユーザーは定義のデータ型を選択できます。 現在、4 つのデータ型がサポートされています。
    i.  文字列 – 値は二重引用符で囲んで入力する必要があります ("文字列の例")。  
    ii. [ブール] - 値は true または false のどちらかです  
    iii.    [数値] - 値は 10 進数です  
    iv. [日時] - 定義が日時型であることを意味します。 値は "mm/dd/yyyy hh:mm:ss AM\PM" の形式で入力する必要があります  
  5. [入力] – ここには定義する値を入力します。 ここに入力する値は選択したデータ型と一致する必要があります。 単一の値をコンマ、またはキーワードを使用して値の範囲で区切られた値のセットを入力するか、 *に*します。 たとえば、一意の値として「1」を、値のセットとして「1, 2, 3」を、値の範囲として「1 to 5」を入力することができます。 範囲としてサポートされているのは数字のみであることに注意してください。
  6. 選択 *OK*します。

![Alt text][5]
##XML の定義
ボキャブラリの型に XML を選択する場合、次の情報を入力する必要があります。  
  a.    [スキーマ] – ここをクリックすると、新しいブレードが表示され、ユーザーは既にアップロードしたスキーマの一覧から選択するか、新しくアップロードすることができます。
  b.    [XPATH] – 前の手順でスキーマを選択した後にのみ、この入力はロックが解除されます。 これをクリックすると、選択したスキーマが表示され、ユーザーはボキャブラリの定義を作成する必要のあるノードを選択できます。  
  c.    [ファクト] – この入力は、ルール エンジンにフィードして処理するデータ オブジェクトを識別します。 これは高度なプロパティであり、既定では、選択した XPATH の親に設定されます。 FACT は、チェーンと収集のシナリオに特に重要です。

![Alt text][6]

### 一括追加
前の手順では、ボキャブラリの定義を作成しました。 一度作成すると、作成したボキャブラリの定義はリスト形式で表示されます。 前の手順を毎回繰り返す代わりに、同じスキーマから複数の定義を作成しなければならない場合もあります。 このような場合、[一括追加] 機能は非常に便利です。
[一括追加] を選択すると、新しいブレードが開きます。 まず、複数の定義を作成するスキーマを選択します。 これを選択すると、新しいブレードが開き、ユーザーは既にアップロード済みのスキーマのリストから選択することも、新しいスキーマをアップロードすることもできます。
これで XPATHS プロパティのロックが解除されます。 このプロパティを選択すると、複数のノードを選択できるスキーマ ビューアーが開きます。
作成した複数の定義の名前は既定では選択したノードの名前になります。 この名前は作成後にいつでも変更できます。

![Alt text][7]

##ポリシーの作成
開発者が必要なボキャブラリを作成したら、ビジネス アナリストが Azure ポータルを利用してビジネス ポリシーを作成することを想定します。  
    1.作成したルール アプリで、[ポリシー] レンズをクリックすると、ポリシー作成ページに移動します。  
    2.このページには、ルール アプリに含まれるポリシーの一覧が表示されます。 アナリストはポリシーの名前を入力し、タブを 2 回クリックするだけで簡単に新しいポリシーを追加できます。 1 つのルール API アプリに複数のポリシーを含めることができます。  
    3.作成したポリシーを選択すると、ポリシー内のルールを確認できるポリシーの詳細ページに移動します。  
    ![Alt text][8]
    4.[追加] を選択し、新しいルールを追加します。 新しいブレードが開きます。

##ルールの作成
ルールは条件とアクションのステートメントで構成されます。 条件が true と評価されると、アクションが実行されます。 [ルールの作成] ブレードでは、ポリシーに対して一意のルール名を指定し、説明をオプションで入力します。
[条件 (IF)] ボックスを使用すると、複雑な条件ステートメントを作成できます。 次のキーワードがサポートされています。  
1.  And – 条件演算子  
2.  Or – 条件演算子  
3.  does\_not\_exist  
4.  exists  
5.  false  
6.  is\_equal\_to  
7.  is\_greater\_than  
8.  is\_greater\_than\_equal\_to  
9.  is\_in  
10. is\_less\_than  
11. is\_less\_than\_equal\_to  
12. is\_not\_in  
13. is\_not\_equal\_to  
14. mod  
15. true  

[アクション(THEN)] ボックスには実行されるアクションを作成するために複数のステートメントを含めることができます (1 行につき 1 つ)。 次のキーワードがサポートされています。  
1.  equals  
2.  false  
3.  true  
4.  halt  
5.  mod  
6.  null  
7.  update  

条件ボックスとアクション ボックスには Intellisense の機能が用意されているため、ルールを簡単に作成できます。 この機能は Ctrl キーを押しながら Space キーを押すか、入力を開始することによって起動されます。 入力した文字に一致するキーワードが自動的に下にフィルターされ、表示されます。 Intellisense ウィンドウにはすべてのキーワードとボキャブラリの定義が表示されます。
![Alt text][9]

##明示的なフォワード チェーン
BizTalk ルールは明示的なフォワード チェーンをサポートします。このため、ユーザーが特定のアクションに応答してルールを再評価する場合、ある特定のキーワードを使用することでルールの再評価をトリガーできます。 次のキーワードがサポートされます。  
   1.   update <vocabulary definition> – このキーワードは、条件内の指定したボキャブラリの定義を使用してすべてのルールを再評価します。  
   2.   Halt – このキーワードにより、すべてのルールの実行を停止します。

##ルールの有効化/無効化
ポリシーの各ルールは有効または無効にできます。 既定では、すべてのルールが有効です。 無効に設定したルールはポリシーの実行時に実行されません。 ルールの有効化/無効化は、[ルール] ブレードから直接行うことができます。このコマンドは、ブレードの上部のコマンド バーにあります。また、コンテキスト メニュー (ルールを右クリック) に有効化/無効化のオプションがあります。

##ルールの優先順位
すべてのポリシーのルールは順番に実行されます。 実行の優先順位は、ポリシー内の順番で決定されます。 この優先順位はルールをドラッグ アンド ドロップするだけで変更できます。

##ポリシーのテスト
ポリシーをテストするには、[ポリシーのテスト] ブレードで [ポリシーのテスト] コマンドを使用します。 このブレードでは、ポリシーで使用されているボキャブラリの定義の一覧が表示され、ユーザーは入力を求められます。 ユーザーはテストのためにこれらの入力に対して手動で値を追加できます。 代わりに、入力のテスト XML をインポートすることもできます。 すべての入力が完了すると、テストを実行でき、各ボキャブラリの定義の出力が出力列に表示されるので、簡単に確認できます。 ビジネス アナリストにとってわかりやすいログを表示するには、[ログの表示] をクリックして、実行ログを表示します。 ログを保存するには、[出力の保存] を利用します。個別の分析のテスト関連データをすべて保存できます。

## ロジック アプリでのルールの使用
ポリシーは作成とテストが完了すると、使用できます。 新しいロジック アプリを作成するには、ポータルのホーム ページの左側から [Logic Apps] を選択します。 これを起動し、選択ロジック アプリが作成されたら *トリガーとアクション*します。 選択することができますし、 *を最初から作成* テンプレートです。 BizTalk ルールの API アプリをロジック アプリに追加するための手順に従います。 その後で、対象とするルール API アプリ (アクション) を選択できます。 アクションには、実行される一連のポリシーが含まれます。 ポリシーを選択したら、そのポリシーに対して必要な入力を行います。 ユーザーはルール API アプリのダウンストリームからの出力を、後続の決定に使用できます。

## API 経由でのルールの使用
ルール API アプリは、豊富な API を利用して起動することもできます。 そうすれば、ユーザーは単に Logic Apps を使用するだけに留まらず、REST の呼び出しにより任意のアプリケーションでルールを使用できます。 利用できる REST API　を確認するには、ルールのダッシュボードで [API の定義] レンズをクリックします。

![Alt text][10]

C ではこの API の使用方法の例を次に示します#

            // Constructing the JSON message to use in API call to Rules API App

            // xmlInstance is the XML message instance to be passed as input to our Policy
            string xmlInstance = "<ns0:Patient xmlns:ns0=\"http://tempuri.org/XMLSchema.xsd\">  <ns0:Name>Name_0</ns0:Name>  <ns0:Email>Email_0</ns0:Email>  <ns0:PatientID>PatientID_0</ns0:PatientID>  <ns0:Age>10.4</ns0:Age>  <ns0:Claim>    <ns0:ClaimDate>2012-05-31T13:20:00.000-05:00</ns0:ClaimDate>    <ns0:ClaimID>10</ns0:ClaimID>    <ns0:TreatmentID>12</ns0:TreatmentID>    <ns0:ClaimAmount>10000.0</ns0:ClaimAmount>    <ns0:ClaimStatus>ClaimStatus_0</ns0:ClaimStatus>    <ns0:ClaimStatusReason>ClaimStatusReason_0</ns0:ClaimStatusReason>  </ns0:Claim></ns0:Patient>";

            JObject input = new JObject();

            // The JSON object is to be of form {"<XMLSchemName>_<RootNodeName>":"<XML Instance String>".
            // In the below case, we are using XML Schema - "insruanceclaimsschema" and the root node is "Patient".
            // This is CASE SENSITIVE.
            input.Add("insuranceclaimschema_Patient", xmlInstance);
            string stringContent = JsonConvert.SerializeObject(input);


            // Making REST call to Rules API App
            HttpClient httpClient = new HttpClient();

            // The url is the Host URL of the Rules API App
            httpClient.BaseAddress = new Uri("https://rulesservice77492755b7b54c3f9e1df8ba0b065dc6.azurewebsites.net/");
            HttpContent httpContent = new StringContent(stringContent);
            httpContent.Headers.ContentType = MediaTypeHeaderValue.Parse("application/json");

            // Invoking API "Execute" on policy "InsruranceClaimPolicy" and getting response JSON object. The url can be gotten from the API Definition Lens
            var postReponse = httpClient.PostAsync("api/Policies/InsuranceClaimPolicy?comp=Execute", httpContent).Result;

先ほどのルール API アプリのセキュリティ設定が [パブリック (匿名)] であることに注意してください。 これで設定できますから API アプリを使用して - すべての設定]、[アプリケーションの設定] メニューの [アクセス レベル

![Alt text][11]

## ボキャブラリとポリシーの編集
ビジネス ルールを使用する利点は、ビジネス ロジックの変更をより早く運用環境に送ることができる点です。 ボキャブラリとポリシーに対する変更は運用環境ですぐに適用されます。 ユーザーがボキャブラリの定義やポリシーを個別に参照し、変更を行うだけで、変更が適用されます。

<!--Image references-->
[1]: ./media/app-service-logic-use-biztalk-rules/InsuranceScenario.PNG
[2]: ./media/app-service-logic-use-biztalk-rules/InsuranceBusinessLogic.png
[3]: ./media/app-service-logic-use-biztalk-rules/CreateRuleApiApp.png
[4]: ./media/app-service-logic-use-biztalk-rules/RulesDashboard.png
[5]: ./media/app-service-logic-use-biztalk-rules/LiteralVocab.PNG
[6]: ./media/app-service-logic-use-biztalk-rules/XMLVocab.PNG
[7]: ./media/app-service-logic-use-biztalk-rules/BulkAdd.PNG
[8]: ./media/app-service-logic-use-biztalk-rules/PolicyList.PNG
[9]: ./media/app-service-logic-use-biztalk-rules/RuleCreate.PNG
[10]: ./media/app-service-logic-use-biztalk-rules/APIDef.PNG
[11]: ./media/app-service-logic-use-biztalk-rules/PublicAnon.PNG


