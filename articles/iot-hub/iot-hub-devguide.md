<properties
 pageTitle="IoT Hub の開発者ガイド トピック | Microsoft Azure"
 description="IoT Hub のエンドポイント、セキュリティ、デバイス ID レジストリ、メッセージングなどについて説明する、Azure IoT Hub の開発者ガイドです。"
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="multiple"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="09/29/2015"
 ms.author="elioda"/>

# Azure IoT Hub 開発者ガイド

Azure IoT Hub は、何百万もの IoT デバイスとアプリケーション バックエンドの間に信頼性のある保護された双方向通信を確立できる、完全に管理されたサービスです。

Azure IoT Hub により、次のことを実現できます。

* デバイスごとのセキュリティ資格情報とアクセス制御を使用した、通信のセキュリティ保護。
* 非常にスケール性が高く信頼性に優れた、デバイスとクラウド間の双方向メッセージング。
* 最も一般的な言語とプラットフォームのデバイスのライブラリを使用した、簡単なデバイスの接続。

このドキュメントで扱う領域を次に示します。

- [エンドポイント](#endpoints)します。 このセクションでは、各 IoT Hub がランタイムと管理の操作のために公開する、さまざまなエンドポイントについて説明します。
- [デバイスの id のレジストリ](#device-identity-registry)します。 このセクションでは、各 IoT Hub のデバイス ID レジストリに格納されている情報と、その情報へのアクセス方法と変更方法について説明します。
- [セキュリティ](#security)します。 このセクションでは、IoT Hub の機能へのアクセスを許可するために使用する、デバイスとクラウド コンポーネントの両方のセキュリティ モデルについて説明します。
- [メッセージング](#messaging)します。 このセクションでは、IoT Hub によって公開される、(デバイスとクラウド間の双方向の) メッセージング機能について説明します。
- [クォータおよび調整](#throttling)します。 このセクションでは、IoT Hub の使用に適用されるクォータの概要ついて説明します。

## エンドポイント<a id="endpoints"></a>

Azure IoT Hub はマルチテナント サービスで、さまざまなアクターの機能を公開します。 次の図は、IoT Hub によって公開されているさまざまなエンドポイントを示しています。

![IoT Hub エンドポイント][img-endpoints]

エンドポイントの説明を次に示します。

* **リソース プロバイダー**:、IoT Hub リソース プロバイダーを公開、 [Azure リソース マネージャー][lnk arm] IoT hub を作成、IoT hub のプロパティを更新および IoT hub を削除する Azure サブスクリプションの所有者ができるインターフェイス。 IoT Hub のプロパティは、デバイス レベルのアクセス制御ではなくハブ レベルのセキュリティ ポリシー ( 参照してください [アクセス制御](#accesscontrol)) とクラウドとデバイスとクラウドへのデバイスのメッセージングの機能のオプションです。 リソース プロバイダーすることもできます [デバイスの id をエクスポート](#importexport)します。
* **デバイスの id 管理**: 各 IoT hub は、一連のデバイス id を管理する HTTP REST エンドポイントを公開 (作成、取得、更新、および削除) します。 デバイス ID は、デバイスの認証とアクセス制御に使用されます。 参照してください [デバイスの id のレジストリ](#device-identity-registry) の詳細。
* **デバイス エンドポイント**: IoT Hub がそのデバイスとの間の通信に使用されるエンドポイントのセットを公開する各デバイス用にデバイスの id のレジストリで準備します。 これらのエンドポイントは両方の HTTP で公開されていると [AMQP][lnk amqp]:
    - *デバイスからクラウドへのメッセージを送信*します。 このエンドポイントを使用して、D2C メッセージを送信します。 詳細については、次を参照してください。 [メッセージングをクラウドへのデバイス](#d2c)します。
    - *クラウドとデバイス間のメッセージが表示される*します。 デバイスは、このエンドポイントを使用して、そのデバイスが宛先となっている C2D メッセージを受信します。 詳細については、次を参照してください。 [デバイス メッセージングにクラウド](#c2d)します。
* **サービスのエンドポイントを**: 各 IoT hub は、一連のアプリケーションのバックエンドで使用されるエンドポイントも公開 (*サービス*)、デバイスと通信します。 このエンドポイントは現在のみ公開されているを使用して、 [AMQP][lnk amqp] プロトコルです。
    - *デバイスからクラウドへのメッセージが表示される*します。 このエンドポイントは、互換性 [Azure Event Hubs][lnk event hub] と、デバイスによって送信されるすべてのデバイスからクラウドへのメッセージの読み取りに使用することができます。 詳細については、次を参照してください。 [メッセージングをクラウドへのデバイス](#d2c)します。
    - *クラウドとデバイス間のメッセージを送信し、配信の受信確認を受け取る*します。 これらのエンドポイントにより、アプリケーション バックエンドは、信頼性の高い C2D メッセージを送信し、対応する配信または有効期限の確認メッセージを受信できます。 詳細については、次を参照してください。 [デバイス メッセージングにクラウド](#c2d)します。

 [IoT Hub Api と Sdk][lnk の sdk の api] これらのエンドポイントにアクセスできるさまざまな方法について説明します。

最後に、を介してすべての IoT Hub エンドポイントが公開されることに注意する必要は [TLS][lnk tls], 、暗号化されていない、セキュリティ チャネルでこれまで公開されているエンドポイントがないとします。

### Event Hubs と互換性のあるエンドポイントから読み取る方法<a id="eventhubcompatible"></a>

使用する場合、 [Azure Service Bus SDK for .NET](https://www.nuget.org/packages/WindowsAzure.ServiceBus) または [Event Hubs のイベント プロセッサ ホスト][], 、正しいアクセス許可を持つ接続文字列は IoT Hub を使用して使用して、 `messages/events` として Event Hub の名前。

Sdk (または製品の統合) を使用して IoT Hub に対応していないこと、IoT Hub の設定から、イベント ハブと互換性のあるエンドポイントと Event Hub の名前を取得する必要があります、 [Azure ポータル][]:

1. IoT hub のブレードでクリックして **設定**, 、し **メッセージング**,、
2.  **クラウドへのデバイス設定** セクションは、検索は、 **イベント ハブと互換性のあるエンドポイント**, 、**イベント ハブと互換性のある名前**, 、および **パーティション** ボックス。

    ![][img-eventhubcompatible]

> [AZURE.NOTE] SDK を必要とする **ホスト名** または **名前空間** 値。 その場合から設定を削除、 **イベント ハブと互換性のあるエンドポイント**します。 たとえば、イベント ハブと互換性のあるエンドポイントが `sb://iothub-ns-myiothub-1234.servicebus.windows.net/`, 、 **ホスト名** になります `iothub-ns-myiothub-1234.servicebus.windows.net`, 、および **名前空間** になります `iothub-ns-myiothub-1234`します。

持つすべての共有アクセス セキュリティ ポリシーを使用することができますし、 **接続** 指定したイベント ハブに接続する権限です。

前の情報を使用してイベント ハブの接続文字列を作成する必要がある場合は、次のパターンを使用できます。

        Endpoint={Event Hub-compatible endpoint};SharedAccessKeyName={iot hub policy name};SharedAccessKey={iot hub policy key}


IoT Hub に使用できる SDK と統合の一覧を次に示します。

* [Event Hubs の Java クライアント](https://github.com/hdinsight/eventhubs-client)
* [Apache Storm のスパウト](../hdinsight/hdinsight-storm-develop-csharp-event-hub-topology.md)します。 表示することができます、 [ソースをスパウト](https://github.com/apache/storm/tree/master/external/storm-eventhubs) GitHub にします。
* [Apache Spark の統合](../hdinsight/hdinsight-apache-spark-csharp-apache-zeppelin-eventhub-streaming.md)

## デバイス ID レジストリ

各 IoT hub は、クラウドとデバイスの実行中のメッセージを含む、キューなどのサービスでデバイスごとのリソースを作成するために使用してで説明したように、デバイスに接続するエンドポイントへのアクセスを許可するデバイスの id のレジストリ、 [アクセス制御](#accesscontrol) セクションです。

大まかに言うと、デバイス ID レジストリは、デバイス ID リソースの REST 対応のコレクションです。 次のセクションでは、デバイス ID リソースのプロパティと、レジストリで ID に対して許可されている操作について詳しく説明します。

> [AZURE.NOTE] 参照してください [IoT Hub Api と Sdk][lnk の sdk の api] HTTP プロトコルとデバイスの id のレジストリとの対話に使用可能な Sdk の詳細についてです。

### デバイス ID プロパティ<a id="deviceproperties"></a>

デバイス ID は、次のプロパティを持つ JSON ドキュメントとして表されます。

| プロパティ | オプション | 説明 |
| -------- | ------- | ----------- |
| deviceId | 必須、読み取り専用 (更新時) | ASCII 7 ビット英数字の大文字と小文字が区別される文字列 (最大 128 文字) + `{'-', ':', '.', '+', '&percnt;', '_', '&num;', '&ast;', '?', '!', '(', ')', ',', '=', '&commat;', ';', '&dollar;', '''}`。 |
| generationId | 必須、読み取り専用 | ハブによって生成された大文字と小文字が区別される文字列。最大 128 文字。 これは、同じデバイスを区別するために使用 **deviceId** ときに、削除し、再作成します。 |
| etag | 必須、読み取り専用 | に従って、デバイス id の弱い etag を表す文字列 [RFC7232][lnk rfc7232]します。|
| auth | 省略可能 | 認証情報とセキュリティのマテリアルを含む複合オブジェクト。 |
| auth.symkey | 省略可能 | base64 形式でプライマリ キーとセカンダリ キーを格納する複合オブジェクト。 |
| status | 必須 | できる **有効** または **無効になっている**します。 場合 **有効**, 、デバイスが接続を許可します。 場合 **無効になっている**, 、このデバイスが任意のデバイスに接続するエンドポイントにアクセスできません。 |
| statusReason | 省略可能 | デバイス ID の状態の理由を格納する、長さが 128 文字の文字列。 すべての UTF-8 文字を使用できます。 |
| statusUpdateTime | 読み取り専用 | 状態が最後に更新された日付と時刻。 |
| connectionState | 読み取り専用 | **接続されている** または **Disconnected**, 、デバイスの接続状態の IoT Hub ビューを表します。 |
| connectionStateUpdatedTime | 読み取り専用 | 前回接続状態が更新された日付と時刻。 |
| lastActivityTime  | 読み取り専用 | 前回デバイスが接続された、またはメッセージを送受信した日付と時刻。 |

> [AZURE.NOTE] 接続状態は、接続の状態の IoT Hub ビューを表すのみことができます。 ネットワークの状態と構成によっては、この状態が遅延することがあります。

### デバイス ID の操作

IoT Hub のデバイス ID レジストリでは、次の操作が公開されています。

* デバイス ID の作成
* デバイス ID の更新
* ID ごとのデバイス ID の取得
* デバイス ID の削除
* 最大 1000 個の ID の一覧表示

これらすべての操作で指定されているオプティミスティック同時実行制御の使用を許可する [RFC7232][lnk rfc7232]します。

> [AZURE.IMPORTANT] ハブの identity レジストリ内のすべての id を取得する唯一の方法が使用するには、 [エクスポート](#importexport) 機能します。

ハブのデバイスの id のレジストリのアプリケーションのメタデータが含まれていないを使用して、ディクショナリのようにアクセスできる、 **deviceId** 、キーとして表現できるクエリのサポートがないです。 IoT ソリューションには、スマート ビルディング ソリューションの温度センサーがデプロイされたルームなど、アプリケーション固有のメタデータを格納するソリューション専用ストアがあります。

### デバイスの無効化

更新することでデバイスを無効にすることができます、 **ステータス** レジストリ内で id のプロパティです。 通常これは、次の 2 つのシナリオで使用されます。

1. オーケストレーション プロセスのプロビジョニング中。 詳細については、次を参照してください。 [Azure IoT Hub ガイダンス - プロビジョニング][lnk ガイダンス プロビジョニング]します。
2. 何らかの理由でデバイスが侵害された、または一時的に許可されていないと考えられる場合。

### デバイス ID のエクスポート<a id="importexport"></a>

エクスポートは、顧客が指定する BLOB コンテナーを使用してデバイスの ID データを読み書きする、長時間実行されるジョブです。

IoT Hub リソース プロバイダーのエンドポイントで、非同期操作を使用して IoT hub の識別情報のレジストリから一括でのデバイス id をエクスポートすることができます ([エンドポイント](#endpoints))。

エクスポート ジョブで使用できる操作を次に示します。

* エクスポート ジョブの作成
* 実行中のジョブの状態の取得
* 実行中のジョブのキャンセル

> [AZURE.NOTE] 各ハブには、任意の時点で実行されている 1 つのジョブのみことができます。

インポートとエクスポートの Api の詳細については、次を参照してください。 [Azure IoT Hub - リソース プロバイダー Api][lnk リソース プロバイダー api]します。

#### ジョブ

エクスポート ジョブには次のプロパティがあります。

| プロパティ | オプション | 説明 |
| -------- | ------- | ----------- |
| jobId | システムにより生成、作成時は無視 | |
| creationTime | システムにより生成、作成時は無視 | |
| endOfProcessingTime | システムにより生成、作成時は無視 | |
| type | 読み取り専用 | **エクスポート** |
| status | システムにより生成、作成時は無視 | **キューに登録される**, 、**開始**, 、**完了**, 、**に失敗しました** |
| 進捗状況 | システムにより生成、作成時は無視 | 完了の割合を示す整数値。 |
| outputBlobContainerURI | すべてのジョブで必須 | Blob コンテナーに対する書き込みアクセスで共有アクセス署名 URI を blob (を参照してください [を作成し、Blob サービスによる SAS を使用して][lnk createuse-sas] と [Java で共有アクセス署名を作成する][lnk sas java])。 これは、ジョブの状態と結果の出力に使用されます。 |
| includeKeysInExport | 省略可能 | 場合 **true**, 、キーがエクスポート出力に含まれます。 としてキーをエクスポートするそれ以外の場合 **null**します。 既定値は **false**します。 |
| failureReason | システムにより生成、作成時は無視 | 状態が [場合 **失敗**, 、理由を含む文字列。 |

#### エクスポート ジョブ

エクスポート ジョブは、BLOB の Shared Access Signature URI をパラメーターとして取得します。 これには、blob コンテナーに対する書き込みアクセスが与えられます。 操作の結果を出力するために使用します。

出力結果は、`job_{job_id}_devices.txt` というファイル内の指定された BLOB コンテナーに書き込まれます。 このファイルには、デバイスの id で指定されているの JSON としてシリアル化が含まれています。 [デバイス id プロパティ](#deviceproperties)します。 設定されているセキュリティ マテリアル **null** 場合、 **includeKeysInExport** に設定されている **false**します。

**例**:

    {"deviceId":"devA","auth":{"symKey":{"primaryKey":"123"}},"status":"enabled"}
    {"deviceId":"devB","auth":{"symKey":{"primaryKey":"234"}},"status":"enabled"}
    {"deviceId":"devC","auth":{"symKey":{"primaryKey":"345"}},"status":"enabled"}
    {"deviceId":"devD","auth":{"symKey":{"primaryKey":"456"}},"status":"enabled"}


## セキュリティ<a id="security"></a>

このセクションでは、Azure IoT Hub をセキュリティで保護するためのオプションについて説明します。

### アクセス制御<a id="accesscontrol"></a>

IoT Hub は、次のセットを使用して *権限* 各 IoT hub のエンドポイントへのアクセスを付与します。 次のアクセス許可により、機能に応じて IoT Hub へのアクセスを制限します。

* **RegistryRead**します。 このアクセス許可により、デバイス ID レジストリへの読み取りアクセスを許可します。 詳細については、次を参照してください。 [デバイスの id のレジストリ](#device-identity-registry)します。
* **RegistryReadWrite**します。 デバイス ID レジストリへの読み取りと書き込みのアクセスを許可します。 詳細については、次を参照してください。 [デバイスの id のレジストリ](#device-identity-registry)します。
* **接続**します。 クラウド サービス向けの通信エンドポイントと監視エンドポイントへのアクセスを許可します。 たとえば、D2C メッセージの受信、C2D メッセージの送信、対応する配信確認メッセージの取得のアクセス許可をクラウド サービスに付与します。
* **DeviceConnect**します。 デバイス向けの通信エンドポイントへのアクセスを許可します。 たとえば、D2C メッセージの送信と、C2D メッセージの受信のアクセス許可を付与します。 ほとんどの場合、このアクセス許可はデバイスによって使用されます。

アクセス許可は次の方法で付与されます。

* **共有アクセス ポリシー] ハブ レベル**します。 *共有アクセス ポリシー* 前のセクションに示される権限の任意の組み合わせを与えることができます。 内のポリシーを定義する、 [Azure ポータル][lnk の管理ポータル] プログラムを使用するか、 [Azure IoT Hub リソース プロバイダー Api][lnk リソース プロバイダー api]します。 新しく作成された IoT Hub には、次の既定のポリシーがあります。

    - *iothubowner*: すべてのアクセス許可を持つポリシー
    - *サービス*: を使用してポリシー **接続** アクセス許可
    - *デバイス*: を使用してポリシー **DeviceConnect** アクセス許可
    - *registryRead*: を使用してポリシー **RegistryRead** アクセス許可
    - *registryReadWrite*: を使用してポリシー **RegistryRead** と **RegistryWrite** アクセス許可

* **デバイスごとのセキュリティ資格情報**します。 各 IoT Hub を含む、 [デバイス identity レジストリ](#device-identity-registry)します。 このレジストリ内の各デバイスを許可するセキュリティ資格情報を構成できます **DeviceConnect** アクセス許可の対応するデバイスのエンドポイントにスコープが設定されます。

**例**します。 IoT ソリューションでは通常デバイス管理のコンポーネントを使用する、 *registryReadWrite* ポリシー、およびイベント プロセッサ コンポーネント、およびランタイム デバイスのビジネス ロジック コンポーネント両方使用している、 *サービス* ポリシーです。 個々のデバイスは、IoT Hub の ID レジストリに格納されている資格情報を使用して接続します。

IoT Hub セキュリティ トピックに関するガイダンスについては、セキュリティ」セクションを参照してください。 [Azure IoT Hub ガイダンス][lnk ガイダンス セキュリティ]します。

### 認証

Azure IoT Hub では、共有アクセス ポリシーとデバイス ID レジストリのセキュリティ資格情報に対してトークンを確認することにより、エンドポイントへのアクセスを許可します。

対称キーなどのセキュリティの資格情報がネットワーク上で送信されることはありません。

> [AZURE.NOTE] Azure サブスクリプションを通じて Azure IoT Hub リソース プロバイダーはセキュリティで保護のすべてのプロバイダーにも、 [Azure リソース マネージャー][lnk azure リソース マネージャー]します。

#### セキュリティ トークンの形式<a id="tokenformat"></a>

セキュリティ トークンには、次の形式があります。

    SharedAccessSignature sig={signature-string}&se={expiry}&skn={policyName}&sr={URL-encoded-resourceURI}

考えられる値を次に示します。

| 値 | 説明 |
| ----- | ----------- |
| {signature} | フォームの HMAC-SHA256 署名文字列: `{URL-encoded-resourceURI} + "\n" + expiry` |
| {resourceURI} | このトークンを使用してアクセスできるエンドポイントの (セグメント単位の) URI プレフィックス。 たとえば、`/events` のように指定します。 |
| {expiry} | 1970 年 1 月 1 日の 00 時 00 分 00 秒 UTC からのエポック秒で表される UTF8 文字列。 |
| {URL-encoded-resourceURI} | URL でエンコードされたリソース URI (小文字) |
| {policyName} | このトークンの参照先となる共有アクセス ポリシーの名前。 デバイスとレジストリの資格情報を参照するトークンの場合は存在しません。 |

**プレフィックスに関する注意事項**: URI プレフィックスを計算すると、セグメント、および文字ではありません。 たとえば、`/a/b` は `/a/b/c` のプレフィックスであり、`/a/bc` のプレフィックスではありません。

#### プロトコルの詳細

(AMQP や HTTP など) サポートされているプロトコルごとに、さまざまな方法でトークンが転送されます。

HTTP 認証の実装で有効なトークンを含めることによって、 **承認** 要求ヘッダー。 クエリ パラメーターと呼ばれる **承認** トークンを転送できます。

使用する場合 [AMQP][lnk amqp], 、IoT Hub をサポートしています [SASL プレーン][lnk sasl 平文] と [AMQP クレーム ベースのセキュリティ][lnk cbs]します。

AMQP Claims-Based-Security の場合、標準でこれらのトークンの送信方法が指定されます。

SASL 形式の **username** を指定できます。

* ハブレベルのトークンの場合、`{policyName}&commat;sas.root.{iothubName}`
* デバイスを対象とするトークンの場合、`{deviceId}`

どちらの場合も、パスワード フィールドに含まれる、トークン」の説明に従って、 [トークン形式](#tokenformat) セクションです。

> [AZURE.NOTE]  [Azure IoT Hub Sdk][lnk の sdk の api] サービスに接続するときに自動的にトークンを生成します。 場合によっては、サポートするプロトコル、または使用可能な認証方法で SDK が制限されます。 詳細については、次を参照してください。、 [Azure IoT Hub Sdk][lnk の sdk の api] ドキュメントです。

#### SASL PLAIN と CBS の比較

SASL PLAIN を使用する場合、IoT Hub に接続するクライアントは、TCP 接続ごとにトークンを 1 つ使用できます。 トークンの有効期限が切れると、サービスから TCP 接続が切断され、再接続がトリガーされます。 この動作は、アプリケーション バックエンド コンポーネントの場合は問題ありませんが、デバイス側アプリケーションの場合は、次の理由から大きな損害を及ぼす可能性があります。

*  ゲートウェイは、通常多くのデバイスの代理として接続しています。 SASL PLAIN を使用する場合、IoT Hub に接続するデバイスごとに、個別の TCP 接続を作成する必要があります。 これにより、電源とネットワーク リソースの消費量が大幅に増大し、各デバイスの接続の待機時間が増加します。
* リソースが限られたデバイスは、各トークンの有効期限が切れた後に、再接続に使用するリソースの量が増加すると、多くの場合影響を受けます。

### ハブレベルの資格情報のスコープ

制限付きのリソース URI を持つトークンを作成することにより、ハブレベルのセキュリティ ポリシーのスコープを指定できます。 たとえば、デバイスからの D2C メッセージを送信するエンドポイントは `/devices/{deviceId}/events` になります。 使用してハブ レベルで共有アクセス ポリシーを使用することもできます **DeviceConnect** が resourceURI はトークンに署名するアクセス許可 `/devices/{deviceId}`, 、デバイスを送信するデバイスの代わりに使用可能なトークンを作成するは **deviceId**します。

このメカニズムに似ています、 [Event Hubs の発行者ポリシー][lnk-イベント-ハブ-発行者ポリシー] でき、独自の認証方式の実装のセキュリティのセクションで説明したよう [Azure IoT Hub ガイダンス][lnk ガイダンス セキュリティ]します。

## メッセージング

IoT Hub は、アプリケーションのバック エンドから通信するためにメッセージング プリミティブ (*サービス* または *クラウド*) デバイス、およびその逆にします。 これらの機能と呼ば [デバイスからクラウド](#d2c) と [クラウドとデバイス](#c2d)します。

IoT Hub のメッセージング機能の中心となる特性は、メッセージの信頼性と持続性です。 これにより、デバイス側では断続的な接続に対する復元性を、クラウド側ではイベント処理の負荷の急増に対する復元性を実現できます。 IoT Hub を実装して *を少なくとも 1 回* の配信の保証 D2C と C2D の両方のメッセージングします。

IoT Hub では、(AMQP や HTTP/1 などの) デバイス用のプロトコルが複数サポートされています。 プロトコル間でのシームレスな相互運用性をサポートするために、IoT Hub では、すべてのデバイス用プロトコルでサポートされる共通のメッセージ形式が定義されます。

### メッセージの形式<a id="messageformat"></a>

IoT Hub のメッセージは、次の要素で構成されています。

* 一連の *システム プロパティ*します。 これらは、IoT Hub によって解釈または設定されるプロパティです。 この設定は、事前に決定されています。
* 一連の *アプリケーション プロパティ*します。 これは、本文を逆シリアル化しなくてもアプリケーションが定義してアクセスできる、文字列プロパティのディクショナリです。 IoT Hub でこれらのプロパティが変更されることはありません。
* 非透過的なバイナリ本文。

参照してください [IoT Hub Api と Sdk][lnk の sdk の api] さまざまなプロトコルでメッセージをエンコードする方法の詳細についてです。

これは、IoT Hub メッセージ内の一連のシステム プロパティです。

| プロパティ | 説明 |
| -------- | ----------- |
| MessageId | 通常、要求/応答パターンに使用する、メッセージのユーザー設定 ID。 形式: ASCII 7 ビット英数字の大文字と小文字が区別される文字列 (最大 128 文字) + `{'-', ':',’.', '+', '%', '_', '#', '*', '?', '!', '(', ')', ',', '=', '@', ';', '$', '''}`。 |
| Sequence number | IoT Hub によって各 C2D メッセージに割り当てられる数値 (デバイスとキューごとに一意)。 |
| To | 使用される [クラウドとデバイス](#c2d) 、メッセージの送信先にします。|
| ExpiryTimeUtc | メッセージの有効期限の日時。 |
| EnqueuedTime | IoT Hub でメッセージを受信した時刻。 |
| CorrelationId | 通常、要求/応答パターンで要求のメッセージ ID を格納する文字列プロパティ。 |
| UserId | メッセージの送信元の指定に使用します。 IoT Hub でメッセージが生成されると、`{iot hub name}` に設定されます。 |
| Ack | デバイスがメッセージを使用した結果としてのフィードバック メッセージの生成を IoT Hub に要求するために、C2D メッセージで使用します。 使用可能な値: **なし** (既定値): フィードバック メッセージは生成されません **正**: メッセージが完了した場合、フィードバック メッセージを受信 **負**: フィードバック メッセージが表示されるメッセージの有効期限が切れて (または最大配信回数に達しました) 場合、デバイスで完了することがなく **完全**: 正と負の両方です。 詳細については、次を参照してください。 [フィードバック メッセージ](#feedback)します。 |
| ConnectionDeviceId | D2C メッセージで IoT Hub によって設定されます。 含まれている、 **deviceId** メッセージを送信したデバイスのです。 |
| ConnectionDeviceGenerationId | D2C メッセージで IoT Hub によって設定されます。 含まれている、 **generationId** (に従って [デバイス id プロパティ](#deviceproperties)) メッセージを送信したデバイスのです。 |
| ConnectionAuthMethod | D2C メッセージで IoT Hub によって設定されます。 メッセージを送信するデバイスの認証に使用する認証方法に関する情報。 詳細については、次を参照してください。 [D2C アンチ スプーフィング](#antispoofing)します。|

### 通信プロトコルの選択<a id="amqpvshttp"></a>

Iot Hub は、両方をサポート、 [AMQP][lnk amqp] とデバイス側の通信に HTTP/1 プロトコルです。 その使用方法に関する考慮事項の一覧を次に示します。

* **クラウドとデバイス パターン**します。 HTTP/1 には、サーバー プッシュを実装する効率的な方法がありません。 そのため、HTTP/1 を使用する場合、デバイスは、C2D メッセージの IoT Hub をポーリングします。 これは、デバイスと IoT Hub の両方できわめて非効率的です。 現在のガイドラインでは、HTTP/1 を使用する場合、各デバイスで 25 分に 1 回未満のポーリング間隔を設定するようになっています。 一方 AMQP では、C2D メッセージを受信する場合のサーバー プッシュがサポートされていて、IoT Hub からデバイスへのメッセージも即座にプッシュできます。 配信の待機時間が問題となる場合は、AMQP が使用に最適なプロトコルです。 一方、頻繁に接続されないデバイスの場合は、HTTP/1 でも機能します。
* **フィールド ゲートウェイ**します。 サーバー プッシュに関する HTTP/1 の制限を指定するには、これは適していませんで使用される [フィールド ゲートウェイ シナリオ][lnk azure ゲートウェイ ガイダンス]します。
* **リソースのデバイスを低**です。 HTTP/1 のライブラリは、AMQP のライブラリよりもはるかに小規模です。 そのため、リソースが少ないデバイス (RAM が 1 MB 未満など) の場合、HTTP/1 が実装可能な唯一のプロトコルとなります。
* **ネットワークのトラバーサル**します。 AMQP Standard は、ポート 5672 でリッスンします。 これにより、HTTP 以外のプロトコルに限定されているネットワークの場合は、問題が発生する可能性があります。
* **ペイロードのサイズ**します。 AMQP は、HTTP/1 よりもはるかに簡潔なバイナリ プロトコルです。

大まかに言うと、可能な限り AMQP の使用をお勧めします。また、デバイスのリソースやネットワーク構成の関係上、AMQP が許可されない場合は HTTP/1 の使用をお勧めします。 さらに、HTTP/1 を使用する場合は、各デバイスでポーリングの頻度が 25 分に 1 回未満になるように設定してください。 当然のことですが、開発段階では、より高いポーリングの頻度を指定できます。

最後の考慮事項とすることが重要を参照してください、 [Azure IoT プロトコル ゲートウェイ][lnk azure プロトコル ゲートウェイ], 、IoT Hub と直接やり取りするパフォーマンスの高い MQTT ゲートウェイを展開できます。 MQTT では、サーバー プッシュがサポートされています (したがって、デバイスに C2D メッセージを即座に配信できます)。また、リソースが非常に少ないデバイスでも使用できます。 このアプローチの主な短所は、プロトコル ゲートウェイの自己ホストと管理が必要な点です。

### D2C (デバイスからクラウド)<a id="d2c"></a>

詳しく説明したよう、 [エンドポイント](#endpoints) ] セクションで、デバイスに接続するエンドポイントを通じて、デバイスからクラウドへのメッセージが送信されます (具体的には `/devices/{deviceId}/messages/events`)、およびサービスに接続するエンドポイントを介して受信した (`/messages/events`)、つまりと互換性のある [Event Hubs][lnk event hub]します。 Standard Event Hubs の統合と SDK を使用してメッセージを受信できます。

IoT Hub は、クラウドへのデバイスは、次のような方法でメッセージングを実装する [Event Hubs][lnk event hub], 、Event Hubs のようにする IoT Hub のデバイスからクラウド メッセージ *イベント* より [Service Bus][lnk servicebus] *メッセージ*します。

この実装には、次のような意味があります。

* Event Hubs と同様に *イベント*, 、デバイスからクラウド メッセージは、永続的な IoT hub で保持されている最大 7 日間 (を参照してください [クラウドへのデバイスの構成オプション](#d2cconfiguration))。
* デバイスからクラウドへのメッセージが作成時に設定されているパーティションの固定セットでパーティション分割 (を参照してください [クラウドへのデバイスの構成オプション](#d2cconfiguration))。
* Event Hubs と同様に、D2C メッセージを読み取るクライアントでは、パーティションと、チェックポイントを処理する必要があります。 参照してください [Event Hubs のイベントの消費][lnk-イベント-ハブ--イベントの利用]します。
* Event Hubs のイベントと同様、D2C メッセージのサイズは最大 256 KB で、バッチとしてグループ化して送信を最適化できます。 バッチでも最大 256 KB、メッセージ数にして最大 500 個です。

ただし、IoT Hub の D2C と Event Hubs には、いくつかの重要な違いがあります。

* 説明に従って、 [セキュリティ](#security) ] セクションで、IoT Hub は、デバイスごとの認証とアクセス制御
* IoT Hub は、何百万もの同時に接続されているデバイス (を参照してください [クォータおよび調整](#throttling)) イベント ハブの名前空間ごとに 5000 の AMQP 接続に制限されますが、します。
* IoT Hub を使用してパーティション分割を任意にすることはできません、 **PartitionKey**します。 デバイスからクラウドへのメッセージがその作成元に関してパーティション分割されて **deviceId**します。
* IoT Hub のスケーリングは Event Hubs と若干異なります。 詳細については、次を参照してください。 [IoT Hub の拡大/縮小][lnk ガイダンス規模]します。

上記の説明は、IoT Hub がすべてのシナリオで Event Hubs に代わるという意味ではないので、ご注意ください。 たとえば、一部のイベントの計算処理では、データ ストリームを分析する前に、別のプロパティまたはフィールドを基準にイベントを再パーティション分割する必要があります。 その場合、Event Hub を使用して、ストリーム処理パイプラインの 2 つの部分を分離できます。

デバイスとクラウド メッセージングを使用する方法の詳細については、次を参照してください。 [IoT Hub Api と Sdk][lnk の sdk の api]します。

#### 非テレメトリ トラフィック

多くの場合、デバイスだけでなくテレメトリ データ ポイントを送信アプリケーションのバック エンドも *インタラクティブ* メッセージおよび要求を実行し、アプリケーションのビジネス ロジック層からの処理を必要とします。 バックエンドで特定のアクションをトリガーする必要がある重大なアラートや、コマンドに対するデバイスの応答などがその良い例です。

参照してください、 [デバイスからクラウド処理][lnk ガイダンス d2c 処理] このようなメッセージを処理する最善の方法の詳細については、"IoT Hub Guidance"のセクションです。

#### D2C の構成オプション<a id="d2cconfiguration"></a>

IoT Hub では、D2C メッセージングを制御する次のプロパティを公開しています。

* **カウントをパーティション分割**します。 このプロパティは作成時に設定し、D2C イベントを取り込む場合のパーティション数を定義します。
* **保存期間**します。 このプロパティでは、D2C メッセージのリテンション期間を指定します。 既定値は 1 日ですが、最大 7 日まで増やすことができます。

また Event Hubs と同様、IoT Hub でも、D2C の受信エンドポイントでコンシューマー グループを管理できます。

いずれかを使用してこれらすべてのプロパティを変更することができます、 [Azure ポータル][lnk の管理ポータル], 、または使用してプログラムによって、 [Azure IoT Hub - リソース プロバイダー Api][lnk リソース プロバイダー api]します。

#### なりすまし対策のプロパティ<a id="antispoofing"></a>

D2C メッセージでのデバイスのなりすましを回避するために、IoT Hub では、すべてのメッセージに次のプロパティを持つスタンプが使用されます。

* **ConnectionDeviceId**
* **ConnectionDeviceGenerationId**
* **ConnectionAuthMethod**

最初の 2 つを含む、 **deviceId** と **generationId** 元のデバイスのに従って [デバイス id プロパティ](#deviceproperties)します。

 **ConnectionAuthMethod** プロパティには、以下のプロパティをシリアル化された JSON オブジェクトが含まれています。

    {
        "scope": "{ hub | device}",
        "type": "{ symkey | sas}",
        "issuer": "iothub"
    }

### C2D (クラウドからデバイス) <a id="c2d"></a>

既にで詳細に説明、 [エンドポイント](#endpoints) ] セクションで、クラウドとデバイスのメッセージは、サービスに接続するエンドポイントを通じて送信されます (`/messages/devicebound`)、一連のデバイスに接続されたエンドポイントで受信されると (`/devices/{deviceId}/messages/devicebound`)。

各クラウドとデバイス間のメッセージが 1 つのデバイス設定を対象として、 **に** プロパティを `/devices/{deviceId}/messages/devicebound`します。

**重要な**: 各デバイスのキューが最大で 50 のクラウドとデバイス間メッセージを保持できます。 同じデバイスにそれ以上のメッセージを送信しようとすると、エラーが発生します。

#### メッセージのライフサイクル<a id="message lifecycle"></a>

実装するために *を少なくとも 1 回* 配信の保証、クラウドとデバイス間のメッセージは、デバイスごとのキューに保存されているし、デバイスを明示的に確認する必要があります *完了* IoT Hub はキューから削除するためにします。 そうすることで、接続とデバイスの障害に対する復元性が保証されます。

次の図に、C2D メッセージのライフサイクルの状態に関するグラフを示します。

![クラウドとデバイス間のメッセージのライフ サイクル][img-lifecycle]

サービスによってメッセージが送信されると、 *エンキュー*します。 デバイスがするときに *受信* メッセージ、IoT Hub *ロック* メッセージ (状態に設定 **不可視**)、その他のメッセージの受信を開始する同じデバイスで他のスレッドをできるようにするためにします。 IoT Hub によって通知デバイスのスレッドには、デバイスの処理が完了したら、 *完了* メッセージです。 こともできます *拒否* に送信されるメッセージ **配信不能な** 状態、または *破棄* 、メッセージ キューに戻さ級 (状態 **エンキュー**)。

メッセージが自動的に遷移させるため、スレッドは IoT Hub を通知することがなく、メッセージの処理に失敗する可能性 **不可視** に **エンキュー** 後、 *可視性 (またはロック) のタイムアウト* (既定: 1 分) です。 メッセージが遷移する **エンキュー** と **非表示** で指定した時刻の数が指定された最大の状態、 *最大配信数* IoT Hub のプロパティです。 上記の移行回数に達すると、メッセージは自動的に配信不能となります。 同様に、メッセージが自動的にされます配信不能な期限後に (を参照してください [有効期限](#ttl))。

クラウドとデバイス間のメッセージのチュートリアルについては、次を参照してください。 [Azure IoT Hub クラウドとデバイス間のメッセージを使ってみる][lnk getstarted c2d チュートリアル]します。 さまざまな Api と Sdk の参照トピックでは、クラウドとデバイスの機能を公開を参照してください [IoT Hub Api と Sdk][lnk の sdk の api]します。

> [AZURE.NOTE] 通常、たびに、メッセージの損失、アプリケーション ロジックには影響しませんは、クラウドとデバイス間のメッセージを完了する必要があります。 これに該当するシナリオはさまざまです。たとえば、メッセージの内容が正常にローカル ストレージに格納された場合、操作が正常に実行された場合、メッセージの損失がアプリケーションの機能に影響しないことを示す一時的な情報がメッセージに含まれている場合などがあります。 長時間実行されるタスクの場合、タスクの説明をローカル ストレージ上に保持した後で C2D メッセージを完了し、その後、タスクの進行状況のさまざまな段階で、1 つ以上の D2C メッセージによってアプリケーション バックエンドに通知するのが一般的です。

#### 有効期限<a id="ttl"></a>

すべての C2D メッセージに有効期限があります。 これは、サービスによって明示的に設定することができます (で、 **ExpiryTimeUtc** プロパティ)、または既定値を使用して IoT Hub で設定されて *有効期限* IoT Hub プロパティとして指定します。 参照してください [クラウドとデバイスの構成オプション](#c2dconfiguration)します。

#### メッセージのフィードバック<a id="feedback"></a>

C2D メッセージを送信するときに、サービスは、そのメッセージの最終状態に関するメッセージごとのフィードバックの配信を要求できます。 設定するときに、 **Ack** プロパティを **正**, 、IoT Hub がクラウドとデバイス間のメッセージに到達した場合に限り、フィードバック メッセージを生成、 **完了** 状態です。 設定して、 **Ack** プロパティを **負**, 、IoT Hub がクラウドとデバイス間のメッセージが到達した場合に限り、フィードバック メッセージを生成、 **Deadletterd** 状態です。 設定して、 **Ack** プロパティを **完全**, 、IoT Hub では、どちらの場合のフィードバック メッセージを生成します。

説明したよう [エンドポイント](#endpoints), 、フィードバックがサービスに接続されたエンドポイントで配信されます (`/messages/servicebound/feedback`) メッセージとして。 フィードバックの受信セマンティクスは、同じ[メッセージのライフサイクル](#message lifecycle)を持つ C2D メッセージの場合と同様です。 可能な限り、メッセージのフィードバックは、次の形式で 1 つのメッセージのバッチとして処理します。

フィードバックのエンドポイントから取得された各メッセージには、次のプロパティがあります。

| プロパティ | 説明 |
| -------- | ----------- |
| EnqueuedTime | バッチが作成された日時を示すタイムスタンプ。 |
| UserId | `{iot hub name}` |
| ContentType | `application/vnd.microsoft.iothub.feedback.json` |

本文はシリアル化された JSON レコードの配列で、それぞれ次のプロパティを持っています。

| プロパティ | 説明 |
| -------- | ----------- |
| EnqueuedTimeUtc | メッセージの結果が発生した日時を示すタイムスタンプ。 たとえば、デバイスの完了やメッセージの期限切れなどです。 |
| OriginalMessageId | **MessageId** このフィードバック情報に関連するクラウドとデバイス間のメッセージのです。 |
| 説明 | 前の結果の文字列の値。 |
| DeviceId | **DeviceId** フィードバックのこの部分に関連するクラウドとデバイス間のメッセージのターゲット デバイスのです。 |
| DeviceGenerationId | **DeviceGenerationId** フィードバックのこの部分に関連するクラウドとデバイス間のメッセージのターゲット デバイスのです。 |

**重要な**です。 サービスを指定する必要があります、 **MessageId** 、元のメッセージとそのフィードバックを関連付けるためにできるようにするためにクラウドとデバイス メッセージにします。

**例**します。 フィードバック メッセージの本文の例を次に示します。

    [
        {
            "OriginalMessageId": "0987654321",
            "EnqueuedTimeUtc": "2015-07-28T16:24:48.789Z",
            "Description": "Success",
            "DeviceId": "123",
            "DeviceGenerationId": "abcdefghijklmnopqrstuvwxyz"
        },
        {
            ...
        },
        ...
    ]

#### C2D の構成オプション<a id="c2dconfiguration"></a>

各 IoT Hub では、C2D メッセージング用に次の構成オプションを公開しています。

| プロパティ | 説明 | 範囲と既定値 |
| -------- | ----------- | ----------------- |
| defaultTtlAsIso8601 | C2D メッセージの TTL の既定値。 | 最大 2D の ISO_8601 書式による間隔 (最小 1 分)。 既定値: 1 時間。 |
| maxDeliveryCount | デバイスごとの C2D キューの最大配信数。 | 1 ～ 100。 既定値: 10。 |
| feedback.ttlAsIso8601 | サービス宛てのフィードバックのメッセージの保有期間。 | 最大 2D の ISO_8601 書式による間隔 (最小 1 分)。 既定値: 1 時間。 |
| feedback.maxDeliveryCount | フィードバック キューの最大配信数。 | 1 ～ 100。 既定値: 100。 |

## クォータとスロットル<a id="throttling"></a>

各 Azure サブスクリプションに最大 10 個の IoT Hub を割り当てることができます。

各 IoT hub がプロビジョニングされて特定の SKU の単位数 (詳細については、次を参照してください。 [IoT Hub の料金][lnk 料金])。 SKU とユニット数により、送信できるメッセージの 1 日あたりの最大クォータと、ID レジストリ内のデバイス ID の最大数が決まります。 同時に接続されるデバイスの数は、レジストリ内の ID の数によって制限されます。

また、IoT Hub によって操作に適用されるスロットルの制限も決まります。

### デバイス ID レジストリのクォータ

IoT Hub で許可される、1 日のユニットあたりの (SKU に関係なく) デバイスの更新 (作成、更新、削除) は、最大で 1100 個です。

### 操作のスロットル

操作のスロットルは、ごく限られた範囲に適用される、不正使用を回避するためのレート制限です。 IoT Hub は、可能な限りエラーを返さないようにしようとしますが、長時間にわたりスロットル違反が続く場合は、例外が返され始めます。

適用されるスロットルの一覧を次に示します。 値は個々のハブのものです。

| スロットル | ハブごとの値 |
| -------- | ------------- |
| ID レジストリの操作 (作成、取得、一覧表示、更新、削除)、個別または一括のインポートとエクスポート | 100/分/ユニット、最大 5000/分 |
| デバイスの接続 | 100/秒/ユニット |
| D2C の送信 | 2000/分/ユニット (S2 の場合)、60/分/ユニット (S1 の場合)。 最小 100/秒。 |
| C2D の操作 (送信、受信、フィードバック) | 100/分/ユニット |

**注**します。 任意の時点で、IoT Hub にプロビジョニングされたユニットを増やすことで、クォータやスロットルの制限値を増やすことができます。

## 次のステップ

IoT Hub の開発の概要については以上です。詳細については、以下のリンク先にアクセスしてください。

- [IoT Hub (チュートリアル) を使ってみる][lnk 取得開始]
- [OS プラットフォームとハードウェアの互換性][lnk 互換性]
- [Azure の IoT デベロッパー センター][lnk iotdev]
- [IoT 実装の計画][lnk ガイダンス]

[Event Hubs のイベント プロセッサ ホスト]: http://blogs.msdn.com/b/servicebus/archive/2015/01/16/event-processor-host-best-practices-part-1.aspx

[Azure ポータル]: https://portal.azure.com

[img-概要]: ./media/iot-hub-devguide/summary.png
[img エンドポイント]: ./media/iot-hub-devguide/endpoints.png
[img ライフ サイクル]: ./media/iot-hub-devguide/lifecycle.png
[img eventhubcompatible]: ./media/iot-hub-devguide/eventhubcompatible.png

[lnk 互換性]: https://github.com/Azure/azure-iot-sdks/blob/master/doc/tested_configurations.md
[lnk の sdk の api]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md
[lnk azure ハブ sdk]: https://msdn.microsoft.com/library/mt488521.aspx
[lnk 料金]: https://azure.microsoft.com/pricing/details/iot-hub
[lnk リソース プロバイダー api]: https://msdn.microsoft.com/library/mt548492.aspx
[lnk 参照アーキテクチャ]: iot-hub-what-is-azure-iot.md

[lnk azure ゲートウェイ ガイダンス]: iot-hub-guidance.md#fieldgateways
[lnk ガイダンス プロビジョニング]: iot-hub-guidance.md#provisioning
[lnk ガイダンス規模]: iot-hub-scaling.md
[lnk ガイダンス セキュリティ]: iot-hub-guidance.md#customauth

[lnk azure プロトコル ゲートウェイ]: iot-hub-protocol-gateway.md
[lnk 取得開始]: iot-hub-csharp-csharp-getstarted.md
[lnk ガイダンス]: iot-hub-guidance.md
[lnk getstarted c2d チュートリアル]: iot-hub-csharp-csharp-c2d.md

[lnk amqp]: https://www.amqp.org/
[lnk arm]: ../resource-group-overview.md
[lnk azure リソース マネージャー]: https://azure.microsoft.com/documentation/articles/resource-group-overview/
[lnk cbs]: https://www.oasis-open.org/committees/download.php/50506/amqp-cbs-v1%200-wd02%202013-08-12.doc
[lnk createuse-sas]: ../storage/storage-dotnet-shared-access-signature-part-2/
[lnk-イベント-ハブ-発行者ポリシー]: https://code.msdn.microsoft.com/Service-Bus-Event-Hub-99ce67ab
[lnk event hub]: http://azure.microsoft.com/services/event-hubs/
[lnk-イベント-ハブ--イベントの利用]: ../event-hubs/event-hubs-programming-guide.md#event-consumers
[lnk ガイダンス d2c 処理]: iot-hub-csharp-csharp-process-d2c.md
[lnk の管理ポータル]: https://portal.azure.com
[lnk rfc7232]: https://tools.ietf.org/html/rfc7232
[lnk sas java]: https://msdn.microsoft.com/library/azure/Hh875756.aspx
[lnk sasl 平文]: http://tools.ietf.org/html/rfc4616
[lnk servicebus]: http://azure.microsoft.com/services/service-bus/
[lnk tls]: https://tools.ietf.org/html/rfc5246
[lnk iotdev]: https://azure.microsoft.com/develop/iot/

<!--HONumber=Apr16_HO2-->
