<properties
    pageTitle="Azure リソース マネージャーのセキュリティに関する考慮事項"
    description="Azure リソース マネージャーでキーとシークレット、ロールベースのアクセス制御、ネットワーク セキュリティ グループを使用してリソースをセキュリティで保護するための推奨方法を示します。"
    services="azure-resource-manager"
    documentationCenter=""
    authors="george-moore"
    manager="georgem"
    editor="tysonn"/>

<tags
    ms.service="azure-resource-manager"
    ms.workload="multiple"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="08/13/2015"
    ms.author="georgem"/>


# Azure リソース マネージャーのセキュリティに関する考慮事項

キーとシークレット、ロールベースのアクセス制御、考慮する事項によっては、Azure リソース マネージャー テンプレートのセキュリティの側面を見てみると 
ネットワーク セキュリティ グループを選択します。

このトピックは、Azure リソース マネージャーのロールベースの Access Control (RBAC) に精通している読者を対象にしています。 詳細については、次をご覧ください。 
[Microsoft Azure ポータルでのロールベースのアクセス制御](role-based-access-control-configure.md) と 
[管理とリソースへのアクセスの監査](resource-group-rbac.md) 

このトピックは大型のホワイト ペーパーの一部です。 フルのペーパーを参照するには、ダウンロード [世界クラスの ARM テンプレートの考慮事項と実証済みプラクティス] (http://download.microsoft.com/download/8/E/1/8E1DBEFA-CECE-4DC9-A813-93520A5D7CFE/World クラス ARM テンプレートの考慮事項と実証済みの Practices.pdf)。

## シークレットと証明書

Azure の仮想マシン、Azure リソース マネージャーと Azure Key Vault がある証明書のセキュリティで保護された処理をサポートする完全に統合します。 
VM にデプロイされています。  ベスト プラクティスは、Azure Key Vault とリソース マネージャーの調整し、格納 VM シークレットと証明書を使用した、 
次の利点があります。

- テンプレートにはシークレットへの URI 参照のみが含まれます。つまり、実際のシークレットは、コード リポジトリ、構成リポジトリ、ソース コード リポジトリには存在しません。 これにより、 
GitHub での収集ボットなどの内部または外部のリポジトリのキー フィッシング攻撃します。
- Key Vault に格納されたシークレットは、厳密な RBAC により信頼されたオペレーターの手で制御されます。  信頼されたオペレーターが退職すれば、つまり内で転送する場合、 
会社の資格情報コンテナー内に作成したキーへのアクセスがある不要になった新しいグループにします。
- 資産はすべて、完全に区分されます。
      キーの展開テンプレート 
      -キーを参照して VM をデプロイするためのテンプレート 
      -コンテナー内の実際のキー マテリアル。  
  テンプレート (およびアクション) は、職務を完全に分離するため、担当の RBAC ロールをそれぞれ別にすることができます。
- Azure ファブリックと Microsoft の範囲内で Key Vault 間の直接チャネルを介して VM へ展開時に機密情報の読み込みが行われます 
データ センターです。  キーが Key Vault に格納されたら、データセンター外の信頼されていないチャネルを経由してキーを見ることはできません。  
- Key Vault は常に局所的であるため、シークレットは常に VM と同じローカリティ (および主権) を持ちます。 グローバルの Key Vault はありません。

### デプロイからのキーの分離

次のそれぞれに個別のテンプレートを維持することをお勧めします。

1.  資格情報コンテナー (キー マテリアルが格納されます) の作成
2.  VM のデプロイ (資格情報コンテナーに格納されたキーへの URI 参照を含みます)

一般的な企業シナリオがより広範なグループにデプロイされたワークロード内の重要なシークレットにアクセス権を持つ信頼されたオペレーターの小さなグループには 
開発者/運用担当者を作成したり、VM のデプロイを更新します。  作成して、コンテキストで新しい資格情報コンテナーを構成する ARM テンプレートの使用例を次に示します 
Azure Active Directory で現在認証されているユーザーの id。  このユーザーを作成する既定のアクセス許可を削除、一覧、更新、バックアップ、 
復元して、この新しい key vault でキーの公開を取得します。

このテンプレートでフィールドのほとんどは見ればわかるので、必要がありますが、 **enableVaultForDeployment** 設定にふさわしい背景情報について: 資格情報コンテナーには、既定値はありません。 
その他の Azure インフラストラクチャ コンポーネントでのアクセスを継続します。 この値を設定して、Azure コンピューティング インフラストラクチャ コンポーネント読み取り専用のアクセスを許可をこの 
指定した資格情報コンテナーの名前します。 したがって、企業の機密データを仮想マシンのシークレットとして同一の資格情報コンテナー内に混在させないことが推奨されます。

    {
        "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
            "keyVaultName": {
                "type": "string",
                "metadata": {
                    "description": "Name of the Vault"
                }
            },
            "location": {
                "type": "string",
                "allowedValues": ["East US", "West US", "West Europe", "East Asia", "South East Asia"],
                "metadata": {
                    "description": "Location of the Vault"
                }
            },
            "tenantId": {
                "type": "string",
                "metadata": {
                    "description": "Tenant Id of the subscription. Get using Get-AzureSubscription cmdlet or Get Subscription API"
                }
            },
            "objectId": {
                "type": "string",
                "metadata": {
                    "description": "Object Id of the AD user. Get using Get-AzureADUser cmdlet"
                }
            },
            "skuName": {
                "type": "string",
                "allowedValues": ["Standard", "Premium"],
                "metadata": {
                    "description": "SKU for the vault"
                }
            },
            "enableVaultForDeployment": {
                "type": "bool",
                "allowedValues": [true, false],
                "metadata": {
                    "description": "Specifies if the vault is enabled for a VM deployment"
                }
            }
        },
        "resources": [{
            "type": "Microsoft.KeyVault/vaults",
            "name": "[parameters('keyVaultName')]",
            "apiVersion": "2014-12-19-preview",
            "location": "[parameters('location')]",
            "properties": {
                "enabledForDeployment": "[parameters('enableVaultForDeployment')]",
                "tenantid": "[parameters('tenantId')]",
                "accessPolicies": [{
                    "tenantId": "[parameters('tenantId')]",
                    "objectId": "[parameters('objectId')]",
                    "permissions": {
                        "secrets": ["all"],
                        "keys": ["all"]
                    }
                }],
                "sku": {
                    "name": "[parameters('skuName')]",
                    "family": "A"
                }
            }
        }]
    }

資格情報コンテナーが作成されたら、次の手順は、新しい VM のデプロイ テンプレートでそのコンテナーを参照することです。  前述のようをお勧めして、 
異なる開発/運用グループは、資格情報コンテナーに格納されているキーへの直接アクセスを持たないグループ VM の展開を管理します。

テンプレートの下のフラグメントはで構成される高次のデプロイ コンストラクトに安全かつ確実に含まれていません非常に重要な機密情報を参照する各 
演算子の直接制御します。

    "vaultName": {
        "type": "string",
        "metadata": {
            "description": "Name of Key Vault that has a secret"
        }
    },
    {
        "apiVersion": "2015-05-01-preview",
        "type": "Microsoft.Compute/virtualMachines",
        "name": "[parameters('vmName')]",
        "location": "[parameters('location')]",
        "properties": {
            "osProfile": {
                "secrets": [{
                    "sourceVault": {
                        "id": "[resourceId('vaultrg', 'Microsoft.KeyVault/vaults', 'kayvault')]"
                    },
                    "vaultCertificates": [{
                        "certificateUrl": "[parameters('secretUrlWithVersion')]",
                        "certificateStore": "My"
                    }]
                }]
            }
        }
    }

## サブスクリプション間の対話のサービス プリンシパル

サービス ID は Active Directory 内でサービス プリンシパルによって表されます。 サービス プリンシパルは、企業の IT 組織、システム インテグレーター (SI)、クラウド サービス ベンダー (CSV) における主要なシナリオの有効化の中心になります。 具体的には、これらの組織のいずれかが、ある顧客のサブスクリプションとやり取りする必要があるユース ケースがあります。  

顧客の環境やサブスクリプションにデプロイされたソリューションを監視するサービスを提供できます。 この場合をする必要があります。 
ログと顧客のアカウント内の他のデータへのアクセスを取得し、監視ソリューションで使用するようにします。 企業の IT 組織やシステム インテグレーターをしている場合は、オファーを展開し、それらの機能の 1 つの管理は顧客に提供できます。 
データ分析プラットフォームなど、顧客独自のサブスクリプションの契約内容が存在します。

これらのユース ケースでは、顧客のサブスクリプションのコンテキスト内でこれらの操作を実行するためのアクセス許可を付与された ID が必要になります。  

これらのシナリオにより、顧客には次のような一連の考慮事項が発生します。

-   セキュリティ上の理由から、アクセスの範囲を特定の種類の操作 (読み取り専用アクセスなど) に設定することが必要になる場合があります。
-   デプロイされたリソースの提供にコストがかかるため、財務上の理由から、アクセスに対する同様の制約が必要になる場合があります。
-   セキュリティ上の理由から、アクセスの範囲を特定のリソース (ストレージ アカウント、環境またはソリューションを含むリソース グループ) のみに設定することが必要になる場合があります。
-   ベンダーとの関係が変わる可能性があるため、顧客は SI や CSV へのアクセスを有効または無効にする機能を希望します。
-   このアカウントに対する操作は課金に影響するため、顧客は課金の監査機能と説明責任のサポートを希望します。
-   コンプライアンスの観点から、顧客は自身の環境内でのシステム インテグレーターの動作を監査できることを希望します。

このような要件に対応するには、サービス プリンシパルと RBAC の組み合わせを使用します。

## ネットワーク セキュリティ グループ

多くのシナリオには、仮想ネットワーク内の 1 つ以上の VM インスタンスに対するトラフィックの制御方法を指定する要件があります。 ネットワーク セキュリティを使用することができます。 
グループ (NSG) この ARM テンプレートのデプロイの一部として実行します。

ネットワーク セキュリティ グループは、サブスクリプションに関連付けられている最上位レベルのオブジェクトです。 NSG には、許可またはへのトラフィックを拒否するアクセス制御ルールが含まれています。 
VM のインスタンス。 NSG のルールは、いつでも変更でき、変更は関連付けられているすべてのインスタンスに適用されます。 NSG を使用するには、仮想ネットワークを設定する必要があります。 
地域 (場所) に関連付けられています。 NSG は、アフィニティ グループに関連付けられている仮想ネットワークに対応していません。 ないかどうかは、 
エンドポイントへのトラフィックの制御を参照してくださいに地域仮想ネットワークしたい [はネットワーク アクセス制御リスト (Acl)](../virtual-network/virtual-networks-acl.md)します。

VM や仮想ネットワーク内のサブネットに NSG を関連付けることができます。 VM に関連付けられた、送信されるすべてのトラフィックに NSG が適用されます、。 
VM インスタンスで受信されます。 仮想ネットワーク内のサブネットに適用されるときにすべての VM インスタンスで送受信されるすべてのトラフィックに適用されます。 
サブネットです。 VM またはサブネットは、1 つの NSG のみに関連付けることができます。各 NSG には、最大 200 のルールを含めることができます。 サブスクリプションあたり 100 の NSG を割り当てることができます。

>[AZURE.NOTE]  エンドポイント ベースの Acl とネットワーク セキュリティ グループは、同じ VM インスタンスでサポートされていません。 エンドポイントの ACL が既に導入されている場合に NSG を使用するには、初めにエンドポイントの ACL を削除します。 これを行う方法については、次を参照してください。 [アクセス制御リスト (Acl) の管理を PowerShell を使用したエンドポイント](../virtual-network/virtual-networks-acl-powershell.md)します。

### ネットワーク セキュリティ グループのしくみ

ネットワーク セキュリティ グループは、エンドポイント ベースの ACL とは異なります。 エンドポイントの ACL は、入力エンドポイントによって公開されるパブリック ポートでのみ動作します。 この 
NSG は、1 つまたは複数の VM インスタンスで動作し、VM で送受信されるすべてのトラフィックを制御します。

ネットワーク セキュリティ グループには、 *名前*, に関連付けられている、 *地域* (サポートされている Azure の場所のいずれか)、わかりやすいラベルが付いているとします。 次の 2 種類が含まれています 
ルールでは、受信および送信します。 受信のルールは VM への受信パケットに適用され、送信のルールは、VM からの送信パケットに適用されます。 
ルールは、VM が配置されているサーバー コンピューターで適用されます。 受信または送信パケットが許可されるためには、許可ルールに一致している必要があります。一致しない場合は、パケットは削除されます。

ルールは、優先順位に従って処理されます。 たとえば、100 などの低い優先度番号を持つルールがより高い優先度番号を持つルールより前に処理します。 
200 など。 一致が見つかると、それ以上のルールは処理されません。

ルールでは、次のことを指定します。

-   名前: ルールの一意識別子
-   種類: 受信/送信
-   優先順位: 100 ～ 4096 の整数 (ルールは値が小さいものから値が大きいものの順に処理されます)
-   発信元 IP アドレス: 発信元 IP 範囲の CIDR
-   発信元ポート範囲: 0 ～ 65536 の整数 (範囲)
-   宛先 IP の範囲: 宛先 IP 範囲の CIDR
-   宛先ポートの範囲: 0 ～ 65536 の整数 (範囲)
-   プロトコル: TCP、UDP または ' \ *'
-   アクセス: 許可または拒否

### 既定のルール

NSG には、既定のルールが含まれています。 既定の規則を削除することはできませんが、最も低い優先順位が割り当てられているため、ルールで上書きできますを 
作成します。 既定のルールでは、プラットフォームによって推奨される既定の設定が指定されています。 次の既定のルールが示すようにトラフィックの発信および着信 
仮想ネットワークでは、受信方向と送信方向の両方で許可されます。

インターネットへの接続は送信方向で許可されていますが、既定で、受信方向はブロックされています。 既定のルールでは、Azure ロード バランサー 
VM の状態を検査します。 NSG の下の VM または一連の VM が負荷分散セットに参加しない場合は、このルールを上書きできます。

既定のルールを次の表に示します。

**受信の既定のルール**

名前 |  優先順位 |  発信元 IP | 発信元ポート |   宛先 IP |    宛先ポート |  プロトコル |  アクセス
--- | --- | --- | --- | --- | --- | --- | ---
ALLOW VNET INBOUND  | 65000 | VIRTUAL_NETWORK | \* |    VIRTUAL_NETWORK | \* |  \*  | ALLOW
ALLOW AZURE LOAD BALANCER INBOUND   | 65001 | AZURE_LOADBALANCER    | \*    | \*    | \*    | \*    | ALLOW
DENY ALL INBOUND    | 65500 | \*    | \*    | \*    | \*    | \*    | DENY

**送信の既定のルール**

名前 |  優先順位 |  発信元 IP | 発信元ポート |   宛先 IP |    宛先ポート |  プロトコル |  アクセス
--- | --- | --- | --- | --- | --- | --- | ---
ALLOW VNET OUTBOUND | 65000 | VIRTUAL_NETWORK   | \*    | VIRTUAL_NETWORK   | \*    | \*    | ALLOW
ALLOW INTERNET OUTBOUND | 65001 | \*    | \*    | INTERNET  | \*    | \*    | ALLOW
DENY ALL OUTBOUND   | 65500 | \*    | \*    | \*    | \*    | \*    | DENY

### インフラストラクチャの特別なルール

NSG ルールは、明示的です。 NSG ルールで指定されていない限り、いかなるトラフィックも許可または拒否されません。 ただし、2 種類のトラフィックは、すべてに関係なく、 
ネットワーク セキュリティ グループの指定があります。 インフラストラクチャをサポートするために、このように事前設定されています。

- **ホスト ノードの仮想 IP**: などの基本的なインフラストラクチャ サービス DHCP、DNS、および正常性の監視、仮想化されたホスト IP アドレスによって提供されます。 
168.63.129.16. このパブリック IP アドレスは Microsoft に属し、この目的のためにすべての地域で使用される唯一の仮想化 IP アドレスです。 この IP アドレスにマップします。 
VM をホストしているサーバー コンピューター (ホスト ノード) の物理 IP アドレス。 ホスト ノードは、DHCP リレー、DNS 再帰リゾルバー、およびのプローブ元として機能します 
ロード バランサー ヘルス プローブおよびマシン ヘルス プローブします。 この IP アドレスへの通信を攻撃と見なさないでください。
- **ライセンス (キー管理サービス)**: Vm で実行されている Windows イメージのライセンスを取得する必要があります。 キー管理サービスにこれを行うには、ライセンスの要求が送信されます。 
このようなクエリを処理するホスト サーバー。 これは、常に送信ポート 1688 上にあります。

### 既定のタグ

既定のタグは、IP アドレスのカテゴリに対応するシステム指定の識別子です。 ユーザー定義のルールで、既定のタグを指定できます。

**NSG の既定のタグ**

タグ |   説明
--- | ---
VIRTUAL_NETWORK |   ネットワーク アドレス空間のすべてを表します。 これには、仮想ネットワーク アドレス空間 (Azure での IP CIDR) だけでなく、すべての接続されているオンプレミス アドレス空間 (ローカル ネットワーク) が含まれます。 また、仮想ネットワーク間のアドレス空間も含まれています。
AZURE_LOADBALANCER | Azure インフラストラクチャの Load Balancer を表し、Azure の正常性プローブが開始される Azure データ センター IP に変換されます。 これは、NSG に関連付けられている VM または一連の VM が、負荷分散セットに参加している場合にのみ必要です。
INTERNET | パブリック インターネットによってアクセスできる仮想ネットワークの外部の IP アドレス空間を表します。 この範囲には、Azure に所有されているパブリック IP アドレス空間も含まれます。

### ポートおよびポート範囲

NSG のルールは、1 つの発信元/宛先ポートまたはポート範囲で指定できます。 この方法は、広い範囲のポートを開く場合に特に便利です。 
FTP などのアプリケーションです。 範囲は連続的に指定する必要があり、個々のポートの指定と混在させることはできません。
ポートの範囲を指定するには、ハイフン (–) を使用します。 たとえば、 **100-500**します。

### ICMP トラフィック

現在の NSG のルールでは、プロトコルとして TCP または UDP を指定できますが、ICMP は指定できません。 ただし、ICMP トラフィックが許可されて仮想ネットワーク内での既定 
トラフィックを任意のポートとプロトコルをサポートする受信の規則 (\ *)、仮想ネットワーク内です。

### NSG と VM の関連付け

NSG と VM を直接関連付けた場合、NSG のネットワーク アクセス ルールは、その VM を宛先とするすべてのトラフィックに直接適用されます。 NSG のときにします。 
ルールの変更を更新して、トラフィックの処理は数分で更新を反映します。 NSG には、VM から関連付けが解除され、状態に戻し、 
NSG 前の状態、つまり、NSG の前にシステムの既定値が導入されました。

### NSG とサブネットの関連付け

NSG をサブネットに関連付けた場合、NSG のネットワーク アクセス ルールは、サブネット内のすべての VM に適用されます。 ときに、NSG のアクセス ルールは、します。 
更新されると、変更は、サブネット内のすべての Vm 数分内に適用します。

### NSG とサブネットおよび VM の関連付け

1 つの NSG を VM に関連付け、別の NSG をその VM が存在するサブネットに関連付けることができます。 このシナリオは、2 つの保護レイヤーを持つ VM を提供するためにサポートされています。 
受信トラフィックの場合、パケットは、VM 内のルールの次に、サブネットで指定されたアクセス ルールに従います。 パケットが送信の場合に指定された規則に従います 
VM で最初に、後に続く次のように、サブネットで指定された規則。

![サブネットと VM に対する NSG の関連付け](./media/best-practices-resource-manager-security/nsg-subnet-vm.png)

VM またはサブネットに NSG を関連付ける場合、ネットワーク アクセス制御のルールは、きわめて明示的になります。 プラットフォームを許可する暗黙のルールは挿入されません。 
特定のポートへのトラフィック。 この場合、VM 内にエンドポイントを作成するときには、インターネットからのトラフィックを許可するルールも作成する必要があります。 そうしない場合 
これには、 *VIP: {port}* からアクセスできない外部です。

たとえば、新しい VM と新しい NSG を作成します。 NSG と VM を関連付けます。 VM が仮想ネットワーク経由で他の Vm と通信できます、 
ALLOW VNET INBOUND ルール。 VM は、ALLOW INTERNET OUTBOUND ルールを使用して、インターネットへの送信接続を確立することもできます。 ポート 80 でエンドポイントを作成した後で、 
VM で実行されている web サイトにトラフィックを受信します。 宛先ポート 80 VIP (パブリック仮想 IP アドレス) に、インターネットからのパケットはまで VM にアクセスできません。 
次の表のようなルールを NSG に追加します。

**特定のポートにトラフィックを許可する明示的なルール**

名前 |  優先順位 |  発信元 IP | 発信元ポート |   宛先 IP |    宛先ポート |  プロトコル |  アクセス
--- | --- | --- | --- | --- | --- | --- | ---
WEB | 100   | INTERNET | *  | * | 80    | TCP   | ALLOW

## ユーザー定義のルート

Azure では、IP トラフィックを各パケットの宛先に基づいて転送する方法がルート テーブルを使用して決定されます。 Azure に基づく既定のルート テーブルを提供します。 
仮想ネットワークの設定、そのテーブルにカスタム ルートを追加する必要があります。

ルート テーブルにカスタム エントリが必要となる最も一般的な状況は、Azure 環境で仮想アプライアンスを使用するケースです。 示されているシナリオを考慮します。 
次の図です。 フロント エンド サブネットから開始されたサブネットを通過するすべてのトラフィックは、中間層に送られ、バックアップすると、 
仮想ファイアウォール アプライアンスです。 そのアプライアンスを仮想ネットワークに追加して各サブネットに接続しただけでは、この機能を実現できません。 
仮想ファイアウォール アプライアンスに対してパケットが確実に転送されるように、サブネットに適用されたルーティング テーブルにも変更を加える必要があります。

同じことは、Azure Virtual Network とインターネット間のトラフィックを制御する仮想 NAT アプライアンスが導入されている場合にも当てはまります。 仮想ことを確認するには 
アプライアンスの使用をインターネット宛のすべてのトラフィックを仮想アプライアンスに転送する必要がありますルートを作成する必要があります。

### ルーティング

パケットは、物理ネットワーク上の各ノードに定義されているルート テーブルに基づき、TCP/IP ネットワークを介してルーティングされます。 ルート テーブルは 1 つのコレクション 
ルートの宛先 IP アドレスに基づいてパケットを転送する場所を決定するために使用します。 ルートの構成要素を次に示します。

- アドレス プレフィックス。 ルートの適用対象となる宛先の CIDR 表記 (例: 10.1.0.0/16)。
- 次ホップの種類。 パケットの送信先となる Azure ホップの種類。 次のいずれかの値になります。
  - Local。 ローカルの仮想ネットワークを表します。 たとえば、同じ仮想ネットワークに 10.1.0.0/16 と 10.2.0.0/16 の 2 つのサブネットがある場合、ルート テーブル内の各サブネットのルートは、次ホップの値が Local になります。
  - VPN Gateway。 Azure S2S VPN Gateway を表します。
  - Internet。 Azure インフラストラクチャによって提供される既定のインターネット ゲートウェイを表します。
  - Virtual Appliance。 Azure Virtual Network に追加した仮想アプライアンスを表します。
  - NULL。 ブラック ホールを表します。 ブラック ホールに転送されたパケットはまったく転送されません。
-   次ホップの値。 次ホップの値には、パケットの転送先となる IP アドレスが格納されます。 次ホップの値は次のホップの種類が、ルートでのみ許可 *仮想アプライアンス*します。 次ホップは、リモート サブネット上ではなくサブネット (ネットワーク ID にしたがった仮想アプライアンスのローカル インターフェイス) 上にある必要があります。 

![ルーティング](./media/best-practices-resource-manager-security/routing.png)

### 既定のルート

仮想ネットワークで作成されるすべてのサブネットは、次の既定のルート ルールを含むルート テーブルに自動的に関連付けられます。

- ローカル VNet ルール: このルールは、仮想ネットワーク内のすべてのサブネットに対して自動的に作成されます。 これは、VNet 内の VM 間に直接リンクがあり、中間次ホップがないことを指定します。 これにより、同じサブネット上の VM は、VM が存在するネットワーク ID に関係なく、既定のゲートウェイ アドレスを必要とせずに互いに通信できます。
- オンプレミス ルール: このルールは、オンプレミス アドレス範囲宛てのすべてのトラフィックに適用され、次ホップの宛先として VPN Gateway を使用します。
- インターネット ルール: このルールは、パブリック インターネット宛てのすべてのトラフィックを処理し、インターネット宛てのすべてのトラフィックの次ホップとしてインフラストラクチャ インターネット ゲートウェイを使用します。

### BGP のルート

このドキュメントの執筆時に [ExpressRoute](expressroute/expressroute-introduction.md) でサポートされていない、 [ネットワーク リソース プロバイダー](virtual-network/resource-groups-networking.md) Azure リソース マネージャーのです。  間に ExpressRoute 接続がある場合、 
内部設置型ネットワークと Azure では、NRP で ExpressRoute がサポートされたら、オンプレミス ネットワークから Azure へとルートを伝達する BGP を有効にすることができます。 それは、 
BGP のルートは、既定のルートと各 Azure サブネットでユーザー定義のルートと同じ方法で使用されます。 詳細については「 
[ExpressRoute の概要](expressroute/expressroute-introduction.md)します。

>[AZURE.NOTE] NRP で ExpressRoute がサポートされている場合は、次ホップの宛先として VPN ゲートウェイを使用するサブネット 0.0.0.0/0 宛てのユーザー定義のルートを作成することで、内部設置型ネットワークを強制トンネリングを使用するように Azure 環境を構成することができます。 ただし、この方法が利用できるのは、VPN Gateway を使用している場合に限られます。ExpressRoute では利用できません。 ExpressRoute の場合、強制トンネリングは BGP を介して構成します。

### ユーザー定義のルート

以上、Azure 環境の既定のルートについて述べてきましたが、それらのルートを表示することはできません。また、実際に必要となるのは、ほとんどの環境では既定のルートだけです。 
ただし、ある特定のケースにおいては、ルート テーブルを作成して独自にルートを追加する必要があります。その例を次に示します。

-   インターネットへのオンプレミス ネットワークを介した強制トンネリング。
-   Azure 環境での仮想アプライアンスの使用。

以上のシナリオでは、ルート テーブルを作成してユーザー定義のルートを追加する必要があります。 複数のルート テーブルを作成したり、同じルート テーブルのことができます。 
1 つまたは複数のサブネットに関連付けられます。 ただし、関連付けることができるルート テーブルは各サブネットにつき 1 つだけです。 すべての Vm とクラウド サービスのサブネットにルート テーブルを使用します。 
そのサブネットに関連付けられています。

サブネットにルート テーブルが関連付けられるまでは、既定のルートが使用されます。 アソシエーションが存在する場合は、ルーティングが行われるに基づいて [一致 LPM (Longest Prefix)](https://en.wikipedia.org/wiki/Longest_prefix_match) 
両方のユーザー間では、ルートと既定のルートを定義します。 同じ LPM マッチの複数のルートがある場合、そのルートが選択、次の発信元に基づいて 
順序:

1.  ユーザーの定義ルート
2.  BGP のルート (ExpressRoute を使用している場合)
3.  既定のルート

>[AZURE.NOTE] ユーザー定義のルートは、Azure Vm とクラウド サービスにのみ適用されます。 たとえば、オンプレミス ネットワークと Azure との間にファイアウォール仮想アプライアンスを追加する場合、オンプレミスのアドレス空間に向かうすべてのトラフィックを仮想アプライアンスに転送するユーザー定義のルートを Azure ルート テーブルに作成する必要があります。 一方、オンプレミスのアドレス空間から入ってくるトラフィックは、VPN Gateway または ExpressRoute 回線を経由し、仮想アプライアンスを飛び越えて直接 Azure 環境に向かいます。

### IP 転送

これまで説明してきたように、ユーザー定義のルートを作成する主な目的の 1 つは、トラフィックを仮想アプライアンスに転送することです。 仮想アプライアンスは、何も行われませんが、複数の 
ファイアウォールや NAT デバイスなどの何らかの方法でネットワーク トラフィックの処理に使用するアプリケーションを実行している VM です。

仮想アプライアンスとして機能するこの VM は、自分宛てではない着信トラフィックを受信できることが必要です。 VM が自分の他の宛先に向かうトラフィックを受信するため 
VM の IP 転送を有効にする必要があります。

## 次のステップ
- 組織内のリソースを使用する適切なアクセス権を持つセキュリティ プリンシパルを設定する方法については、「 [Azure リソース マネージャーでサービス プリンシパルの認証](resource-group-authenticate-service-principal.md)
- リソースへのアクセスをロックする必要がある場合は、管理ロックを使用できます。 参照してください [Azure リソース マネージャーによるリソースのロック](resource-group-lock-resources.md)
- 構成する [ルーティングと IP 転送を参照してください [ルートの作成と Azure での IP 転送を有効にする方法。](virtual-network/virtual-networks-udr-how-to.md) 
- 役割に基づいたアクセス制御の概要については、次を参照してください [Microsoft Azure ポータルでのロールベースのアクセス制御。](role-based-access-control-configure.md)

