<properties
    pageTitle="復旧計画の作成 | Microsoft Azure" 
    description="Azure Site Recovery は、オンプレミスのサーバーに配置されている仮想マシンの Azure またはセカンダリ データセンターへのレプリケーション、フェールオーバー、および復旧を調整します。" 
    services="site-recovery" 
    documentationCenter="" 
    authors="rayne-wiselman" 
    manager="jwhit" 
    editor=""/>

<tags 
    ms.service="site-recovery" 
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="storage-backup-recovery" 
    ms.date="12/14/2015" 
    ms.author="raynew"/>

# 復旧計画の作成

Site Recovery サービスは、Azure またはオンプレミスのセカンダリ データセンターへのレプリケーションとフェールオーバーを調整および自動化することにより、オンプレミスの物理サーバーおよび仮想マシンを保護する、堅牢なビジネス継続性と障害復旧 (BCDR) ソリューションを構築するのに役立ちます。 Site recovery デプロイの概要を参照して、 [Site Recovery の概要](site-recovery-overview.md)します。

## この記事の内容

この記事では、復旧計画を作成およびカスタマイズするための情報を提供します。 

質問内容がある場合は、この記事に投稿して、 [Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)します。

## 概要

復旧計画は、保護対象の仮想マシンまたはレプリケーション グループ (SAN レプリケーションの場合) を含む 1 つ以上の順序のあるグループで構成されます。 マシンは、それらが属するグループに従ってフェールオーバーします。 特定のグループに属する仮想マシンは、並列にフェールオーバーします。 復旧計画では、次のことを行います。

- 一緒にフェールオーバーし、起動するマシンのグループを定義します。
- マシンを復旧計画グループにまとめることにより、マシン間の依存関係をモデル化します。 たとえば、特定のアプリケーションをフェールオーバーし起動する必要がある場合、そのアプリケーション用の仮想マシンを同じ復旧計画グループに含めます。
- フェールオーバーを自動化および拡張します。 復旧計画で、テスト フェールオーバー、計画されたフェールオーバー、または計画されていないフェールオーバーを実行できます。 復旧計画は、スクリプト、Azure Automation、および手動アクションを使用して、カスタマイズできます。

復旧計画が表示される、 **復旧計画** Site Recovery ポータルで。


## 復旧計画の作成

復旧計画を作成する方法は、Site Recovery デプロイの方法により異なります。

- **HYPER-V レプリケーション (VMM)**-レプリケートする場合、VMM からにして、セカンダリ サイト、オンプレミス サイト、または HYPER-V を使用して Azure にレプリケーションを追加する保護されている HYPER-V 仮想マシンを VMM クラウドから復旧計画にします。
- **HYPER-V レプリケーション (HYPER-V サイト)**— 復旧計画に、保護グループから、保護された HYPER-V 仮想マシンを追加する (VMM サーバー) がない場合、HYPER-V サイトから Azure にレプリケートする場合。
- **SAN レプリケーション**— 復旧計画に仮想マシンを含むレプリケーション グループを追加する SAN レプリケーションを使用してセカンダリ オンプレミス サイトにレプリケートする場合。 レプリケーション グループ内のすべての仮想マシンを一緒にフェールオーバーする必要があるため (フェールオーバーはストレージ レイヤーで最初に発生します)、特定の仮想マシンではなくレプリケーション グループを選択します。
- **VMware レプリケーション**— VMware 仮想マシンを Azure にレプリケートする場合は、復旧計画に仮想マシンを含むレプリケーション グループが追加されます。

次の手順に従って、復旧計画を作成します。

1. [復旧計画] タブで、[復旧計画の作成] をクリックします。
復旧計画の名前、およびソースとターゲットを指定します。 ソース サーバーには、フェールオーバーと復旧が有効になった仮想マシンが必要になります。

    - VMM から VMM にレプリケートする場合は、VMM でを選択します。 **ソースの種類**, 、およびソースとターゲット VMM サーバー。 クリックして **HYPER-V** HYPER-V レプリカを使用するように構成されているクラウドを表示します。 
    - Select の VMM で SAN を使用して、VMM に VMM からレプリケートするかどうかは **ソースの種類**, 、およびソースとターゲット VMM サーバー。 クリックして **SAN** SAN レプリケーション用に構成されているクラウドを表示します。
    - VMM から Azure にレプリケートする場合は、VMM でを選択します。 **ソースの種類**します。  ソース VMM サーバーを選択し、 **Azure** ターゲットとして。
    - Hyper-V サイトからレプリケートする場合、[ソースの種類] で Hyper-V サイトを選択します。 そのサイトをソースとして選択し、**Azure **をターゲットとして選択します。
    - VMware またはオンプレミスの物理サーバーから Azure にレプリケートする、構成サーバーをソースとして選択し、 **Azure** ターゲットとして

2. で **仮想マシンを選択して** 、復旧計画で、既定のグループ (グループ 1) に追加する仮想マシン (またはレプリケーション グループ) を選択します。

## 復旧計画のカスタマイズ

保護対象の仮想マシンまたはレプリケーション グループを既定の復旧計画グループに追加して復旧計画を作成している場合、その復旧計画をカスタマイズできます。

- **新しいグループを追加**— 復旧計画グループを追加することができます。 追加されたグループには、追加順を示す番号が割り当てられます。 最大 7 つのグループを追加できます。 さらに多くのマシンまたはレプリケーション グループをこれらの新しいグループに追加できます。 仮想マシンまたはレプリケーション グループは、1 つの復旧計画グループのみに含めることができることに注意してください。
- **スクリプトを追加する** — 復旧計画グループの前後にスクリプトを追加できます。 スクリプトを追加すると、グループに対して新しい一連のアクションが追加されます。 たとえば、グループ 1 の前処理ステップ セットが、「グループ 1: 前処理ステップ」という名前で作成されます。 すべての前処理ステップはこのセット内に一覧表示されます。 VMM サーバーがデプロイされている場合は、プライマリ サイトのみにスクリプトを追加できることに注意してください。
- **手動アクションを追加**— 復旧計画グループの前後に実行する手動アクションを追加することができます。 復旧計画を実行すると、手動アクションが挿入された位置で停止し、ダイアログ ボックスが表示されて、手動アクションを完了するかどうかを指定できます。

### スクリプトを使用することによる復旧計画の拡張

スクリプトを復旧計画に追加できます。

VMM ソース サイトが存在する場合、スクリプトをその VMM サーバーで作成し、復旧計画に含めることができます。
Azure にレプリケートする場合、Azure Automation Runbook を復旧計画に組み込むことができます。

#### VMM スクリプトの作成

作業を行う際には、以下の点に注意してください。

- スクリプトは、Windows PowerShell を使用して記述します。
- VMM コマンドレットは、Windows PowerShell モジュール内で配布されます。 VMM Windows PowerShell モジュールは、VMM コンソールと一緒にインストールされます。 VMM モジュールは、スクリプト内のコマンド (Import-Module -Name virtualmachinemanager) を使用して読み込まれます。 [詳細を表示](hhttps://technet.microsoft.com/library/hh875013.aspx)します。
- VMM デプロイに 1 つ以上のライブラリ サーバーが存在することを確認します。 既定では、VMM サーバーのライブラリ共有パスは、VMM サーバーにローカルに配置され、MSCVMMLibrary のフォルダー名を持ちます。
- ライブラリ共有のパスがリモートである場合 (またはローカルであるが MSCVMMLibrary と共有されない、(たとえば \\libserver2.contoso.com\share\ を使用して) 次のよう: に共有を構成します。
    - レジストリ エディターを開きます。
    - HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft System Center Virtual Machine Manager Server\DRAdapter\Registration に移動します。
    - 値 ScriptLibraryPath を編集します。
    - \\Libserver2.contoso.com\share\ として値を配置します。 完全な FQDN を指定します。
    - 共有場所にアクセス許可を設定します。

- 復旧計画のスクリプトは VMM サービス アカウントのコンテキストで実行されます。 このアカウントに、スクリプトが配置されているリモート共有に対する読み取りアクセス許可が付与されていることを確認します。また、スクリプトが VMM サービス アカウント権限レベルで実行されることをテストします。
-   VMM サービス アカウントと同じアクセス許可が付与されているユーザー アカウントを使用してスクリプトをテストし、スタンドアロンのテスト済みスクリプトが、復旧計画で実行されるのと同じ方法で実行されることを確認します。
-   VMM サーバーで、次の手順を実行して、実行ポリシーを bypass に設定します。
    - 昇格された特権を使用して、64 ビット Windows PowerShell コンソールを開きます。
    - 型: **で set-executionpolicy bypass**します。 [詳細を表示](https://technet.microsoft.com/library/ee176961.aspx)します。
- try-catch ブロックを使用して、例外を適切に処理するようにしてください。 スクリプト内で例外が発生すると、実行が停止し、タスクが失敗したことが表示されます。  エラーが発生すると、スクリプトの残りの部分は実行されません。 計画されていないフェールオーバーの実行時にエラーが発生した場合、復旧計画は続行します。 計画されたフェールオーバーの実行時にエラーが発生した場合、復旧計画は停止します。 復旧計画が停止したら、スクリプトを修正し、想定どおりに実行されることを確認して、復旧計画を再び実行します。
- Write-Host コマンドは、復旧計画スクリプトで動作しないので、このコマンドが含まれていると、スクリプトは失敗します。 出力を作成する必要がある場合、メイン スクリプトとして動作するプロキシ スクリプトを作成し、すべての出力が、>> コマンドを使用することによりパイプを通して作成されることを確認します。
- スクリプトは、600 秒以内に実行制御を戻さないとタイムアウトとなります。
- STDERR に何かが書き出されると、スクリプトは "失敗" と分類されます。 この情報は、スクリプト実行についての詳細画面に表示されます。

次の手順に従って、スクリプトを作成します。

1. たとえば、ライブラリ共有に新しいフォルダーを作成 \ < VMMServerName > \MSSCVMMLibrary\RPScripts です。 このフォルダーを、ソース VMM サーバーとターゲット VMM サーバーに配置します。
2. スクリプト (たとえば、RPScript) を作成し、期待どおりに動作することを確認します。
3. 場所にスクリプトを保存 \ < VMMServerName > \MSSCVMMLibrary ソースとターゲット VMM サーバーにします。

#### Azure Automation Runbook の作成

復旧計画の一部として Azure Automation Runbook を実行することにより、計画を拡張できます。 [詳細](site-recovery-runbook-automation.md)します。


### 復旧計画へのカスタム設定の追加

1. カスタマイズする復旧計画を開きます。
2. 仮想マシンまたは新しいグループをクリックして追加します。
3. アクションを手動またはスクリプトを追加するには任意の項目] をクリックして、 **ステップ** を一覧表示し、クリックして **スクリプト** または **手動アクション**します。 選択した項目の前または後のどちらにスクリプトまたはアクションを追加するかを指定します。 使用して、 **上へ移動** と **下へ移動** コマンド、スクリプトの位置を上下に移動するボタンです。
4. VMM スクリプトを追加する場合は、選択 **VMM スクリプトへのフェイル オーバー**, 、およびで **スクリプトのパス** 共有への相対パスを入力します。 そのため、共有はある \\<VMMServerName>\MSSCVMMLibrary\RPScripts、パスを指定します。 \RPScripts\RPScript.PS1 します。
5. Azure automation runbook を追加する場合は、指定、 **Azure Automation アカウント** 置かれているがあり、適切な runbook である **Azure Runbook スクリプト**します。
5. 復旧計画のフェールオーバーを実行して、スクリプトが期待どおりに動作することを確認します。


## フェールオーバーの実行

さまざまな種類のフェールオーバー復旧計画を実行できます。このような種類としては、環境を確認するためのテスト フェールオーバー、計画されたフェールオーバー、計画されていないフェールオーバーなどがあります。 さまざまな種類のフェールオーバーを実行するためのフェールオーバーと get 手順の詳細を参照 [ここ](site-recovery-failover.md) のフェールオーバーについてです。


 

