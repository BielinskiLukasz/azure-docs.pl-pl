<properties 
   pageTitle="ネットワーク セキュリティ グループ (NSG)"
   description="ネットワーク セキュリティ グループ (NSG) の詳細"
   services="virtual-network"
   documentationCenter="na"
   authors="telmosampaio"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="12/11/2015"
   ms.author="telmos" />

# ネットワーク セキュリティ グループ (NSG) について

ネットワーク セキュリティ グループ (NSG) には、Virtual Network の VM インスタンスに対するネットワーク トラフィックを許可または拒否する一連のアクセス制御リスト (ACL) 規則が含まれています。 NSG は、サブネットまたはそのサブネット内の個々の VM インスタンスと関連付けることができます。 NSG がサブネットに関連付けられている場合、ACL 規則はそのサブネット内のすべての VM インスタンスに適用されます。  また、NSG を直接 VM に関連付けることにより、その個々の VM に対するトラフィックをさらに制限できます。

NSG には、次のプロパティが含まれています。

|プロパティ|説明|制約|考慮事項|
|---|---|---|---|
|名前|NSG の名前|領域内で一意である必要があります。<br/>文字、数字、アンダー スコア、ピリオド、ハイフンを含めることができます。<br/>文字または数字で始める必要があります。<br/>英字、数字、またはアンダー スコアで終了する必要があります。<br/>最大 80 文字|複数の NSG の作成が必要になることがあるため、NSG の機能が識別しやすくなる名前付け規則を用意してください。|
|リージョン|NSG がホストされる Azure リージョン|NSG は NSG が作成されたリージョン内のリソースにのみ適用できます。|参照してください [制限](#Limits) 下数 Nsg を理解することができますがある領域内|
|リソース グループ|NSG が属するリソース グループ|NSG はリソース グループに属しますが、リソースが NSG と同じ Azure リージョン内にあれば、任意のリソース グループ内のリソースに関連付けることができます。|複数のリソースをまとめて、デプロイ単位として管理するリソース グループを使用します。<br/>NSG に関連付けられたリソースをグループ化を検討してください。|
|ルール|許可または拒否するトラフィックを定義するルール||参照してください [NSG ルール](#Nsg-rules) 下| 

>[AZURE.NOTE] エンドポイント ベースの Acl とネットワーク セキュリティ グループは、同じ VM インスタンスでサポートされていません。 エンドポイントの ACL が既に導入されている場合に NSG を使用するには、初めにエンドポイントの ACL を削除します。 これを行う方法については、次を参照してください。 [アクセス制御リスト (Acl) の管理を PowerShell を使用したエンドポイント](virtual-networks-acl-powershell.md)します。

### NSG ルール

NSG ルールには、次のプロパティが含まれています。

|プロパティ|説明|制約|考慮事項|
|---|---|---|---|
|**名前**|ルールの名前|領域内で一意である必要があります。<br/>文字、数字、アンダー スコア、ピリオド、ハイフンを含めることができます。<br/>文字または数字で始める必要があります。<br/>英字、数字、またはアンダー スコアで終了する必要があります。<br/>最大 80 文字|1 つの NSG 内に複数のルールを作成することがあるため、ルールの機能を識別できる名前付け規則に準拠してください。|
|**プロトコル**|規則に関して一致するプロトコル|TCP、UDP、または \ *|使用して \ * とプロトコル ICMP (東西トラフィックのみ) が含まれ UDP および TCP もする必要があるルールの数を減らすことがあります<br/>同時に時間を使用して \ * ことを確認する場合にのみ使用本当に必要なのでアプローチ、広すぎる可能性があります|
|**発信元ポート範囲**|規則に関して一致するソース ポート範囲|1 ~ 65535 で、ポートの範囲 (つまり 100-2000) ポート番号を 1 つまたは \ * (すべてのポートの)|複数のルールを設定する必要がないように、できるだけポート範囲を使用してください。|
|**宛先ポート範囲**|規則に関して一致する宛先ポート範囲|1 ~ 65535 で、ポートの範囲 (つまり 100-2000) ポート番号を 1 つまたは \ * (すべてのポートの)|複数のルールを設定する必要がないように、できるだけポート範囲を使用してください。|
|**発信元アドレスのプレフィックス**|規則に関して一致する発信元アドレスのプレフィックスまたはタグ|単一の IP サブネット (192.168.1.0/24 など) の IP アドレス (つまり 10.10.10.10) [既定のタグ](#Default-Tags), 、または * (すべてのアドレス)|ルールの数を減らすには、範囲、タグ、* の使用を検討してください。|
|**宛先アドレスのプレフィックス**|規則に関して一致する宛先アドレスのプレフィックスまたはタグ|単一の IP サブネット (192.168.1.0/24 など) の IP アドレス (つまり 10.10.10.10) [既定のタグ](#Default-Tags), 、または * (すべてのアドレス)|ルールの数を減らすには、範囲、タグ、* の使用を検討してください。|
|**方向**|規則に関して一致するトラフィックの方向|受信または送信|受信ルールと送信ルールは方向に基づいて個別に処理されます。|
|**優先順位**|ルールは優先度の順序でチェックされます。ルールが適用されると、それ以上はルールの一致テストが行われなくなります。|100 ～ 65535 の数値|既存のルールの間に新しいルールを追加する余地を残すために、各ルールの優先度の数値を 100 ずつ飛ばして設定することを検討してください。|
|**Access (アクセス)**|規則が一致した場合に適用されるアクセスの種類|許可または拒否|パケットに一致する許可ルールが見つからない場合はパケットが削除されることに留意してください。|

### 既定のタグ

既定のタグは、IP アドレスのカテゴリに対応するシステム指定の識別子です。 既定のタグを使用する、 **発信元アドレス プレフィックス** と **宛先アドレス プレフィックス** いずれかの規則のプロパティです。 使用できる既定のタグは 3 種類あります。

- **VIRTUAL_NETWORK:** この既定のタグは、ネットワーク アドレス空間のすべてを表します。 これには、仮想ネットワーク アドレス空間 (Azure で定義されている CIDR 範囲) だけでなく、すべての接続されているオンプレミス アドレス空間および接続されている Azure VNet (ローカル ネットワーク) が含まれます。

- **AZURE_LOADBALANCER:** この既定のタグは Azure のインフラストラクチャ ロード バランサーを表します。 これは、Azure の正常性プローブが開始される Azure データ センター IP に変換されます。

- **インターネット:** この既定のタグは、仮想ネットワークの外部で、パブリック インターネットで到達可能である IP アドレス空間を表します。 この範囲に含まれる [Azure に所有するパブリック IP 空間](https://www.microsoft.com/download/details.aspx?id=41653) もします。

### 既定のルール

すべての NSG に既定のルール一式が含まれています。 既定のルールは削除できませんが、これには最も低い優先順位が割り当てられているため、ルールを作成することで上書きできます。 

次の既定のルールが示すように、受信方向と送信方向の両方につき、 VNet 内で発信および着信するトラフィックは許可されます。 インターネットへの接続は送信方向で許可されていますが、既定で、受信方向はブロックされています。 既定のルールでは、Azure のロード バランサーによる VM とロール インスタンスの正常性プローブが許可されます。 負荷分散セットを使用していない場合は、このルールを上書きできます。

**受信の既定のルール**

| 名前                              | 優先順位 | 発信元 IP          | 発信元ポート | 宛先 IP  | 宛先ポート | プロトコル | アクセス |
|-----------------------------------|----------|--------------------|-------------|-----------------|------------------|----------|--------|
| ALLOW VNET INBOUND                | 65000    | VIRTUAL_NETWORK    | *           | VIRTUAL_NETWORK | *                | *        | ALLOW  |
| ALLOW AZURE LOAD BALANCER INBOUND | 65001    | AZURE_LOADBALANCER | *           | *               | *                | *        | ALLOW  |
| DENY ALL INBOUND                  | 65500    | *                  | *           | *               | *                | *        | DENY   |

**送信の既定のルール**

| 名前                    | 優先順位 | 発信元 IP       | 発信元ポート | 宛先 IP  | 宛先ポート | プロトコル | アクセス |
|-------------------------|----------|-----------------|-------------|-----------------|------------------|----------|--------|
| ALLOW VNET OUTBOUND     | 65000    | VIRTUAL_NETWORK | *           | VIRTUAL_NETWORK | *                | *        | ALLOW  |
| ALLOW INTERNET OUTBOUND | 65001    | *               | *           | INTERNET        | *                | *        | ALLOW  |
| DENY ALL OUTBOUND       | 65500    | *               | *           | *               | *                | *        | DENY   |

## NSG の関連付け

NSG は、使用しているデプロイ モデルに応じて、VM、NIC、およびサブネットに関連付けることができます。

[AZURE.INCLUDE [learn-about-deployment-models-both-include.md](../../includes/learn-about-deployment-models-both-include.md)]
 
- **VM に対する NSG の関連付け (クラシック デプロイメントのみ)。** VM に対して NSG を関連付ける場合、NSG のネットワーク アクセス ルールが、その VM を宛先とするすべてのトラフィックに適用されます。 

- **NIC に対する NSG の関連付け (リソース マネージャー デプロイメントのみ)。** NIC に対して NSG を関連付ける場合、NSG のネットワーク アクセス ルールが、その NIC にのみ適用されます。 これは、複数 NIC の VM で、NSG が 1 つの NIC に適用されている場合、その NIC を宛先とするトラフィックに影響がないことを意味します。 

- **Nsg のサブネット (すべての展開)**します。 NSG をサブネットに関連付けた場合、NSG のネットワーク アクセス ルールは、サブネット内のすべての IaaS リソースと PaaS リソースに適用されます。 

さまざまな NSG を VM (デプロイメント モデルによっては NIC) および NIC や VM の宛先のサブネットに関連付けることができます。 この場合、すべてのネットワーク アクセス ルールが、次の順番でトラフィックに適用されます。

- **受信トラフィック**
    1. サブネットに適用される NSG
    2. NIC (リソース マネージャー) または VM (クラシック) に適用される NSG
- **送信トラフィック**
    1. NIC (リソース マネージャー) または VM (クラシック) に適用される NSG
    3. サブネットに適用される NSG

![NSG ACL](./media/virtual-network-nsg-overview/figure2.png)

>[AZURE.NOTE] サブネット、VM、または NIC; に単一の NSG を関連付けることのみできます。必要に応じて多くのリソースを同じ NSG を関連付けることができます。

## 計画

NSG を実装する前に、次の質問への回答を用意する必要があります。   

1. どのような種類のリソース間のトラフィックをフィルター処理する必要があるか (同じ VM 内の NIC 間、同じサブネットに接続されている VM 間またはクラウド サービスやアプリケーション サービス環境などのリソース間、異なるサブネットに接続されているリソース間のいずれか)。

2. トラフィックをフィルター処理するリソースは、既存の VNet 内のサブネットに接続されているか、新しい VNet またはサブネットに接続されているか。
 
Azure のネットワーク セキュリティの計画に関する詳細については、読み取り、 [colud サービスのベスト プラクティスと、ネットワークのセキュリティ](best-practices-network-security.md)します。 

## 設計上の考慮事項

疑問に対する答えがわかると、 [計画](#Planning) セクションで、Nsg を定義する前に、次を確認します。

### 制限

NSG の設計時には、次の制限事項を考慮する必要があります。

|**説明**|**既定の制限**|**説明**|
|---|---|---|
|サブネット、VM、または NIC に関連付けられる NSG の数|1|NSG を組み合わせることはできません。 特定のリソース セットに必要なすべてのルールが 1 つの NSG に含まれるようにしてください。|
|サブスクリプションあたりのリージョンごとの NSG 数|100|既定では、Azure ポータルで作成する各 VM に新しい NSG が 1 つ作成されます。 この既定の動作を許可すると、NSG はすぐに上限に達します。 設計時はこの制限に留意し、必要に応じてリソースを複数のリージョンまたはサブスクリプションに分割してください。 |
|NSG あたりの NSG ルール数|200|この上限を超えないように IP とポートの広い範囲を使用してください。 |

>[AZURE.IMPORTANT] すべてを表示するかどうかを確認、 [Azure でのネットワーク サービスに関連する制限](../azure-subscription-service-limits/#networking-limits) ソリューションを設計する前にします。 一部の制限は、サポート チケットを開いて引き上げることができます。

### VNet とサブネットの設計

NSG はサブネットに適用できるため、リソースをサブネットごとにグループ化し、NSG をサブネットに適用することで、NSG の数を最小限に抑えることができます。  NSG をサブネットに適用することにしたものの、既存の VNet とサブネットが NSG のことを考えて定義されていないことがあります。 用意した NSG 設計をサポートするために、VNet とサブネットを新たに定義する必要が生じる場合があります。 このようなときは、新しいサブネットを作成して、新しいリソースをデプロイします。 その後、新しいサブネットに既存のリソースを移動する移行戦略を定義できます。 

### 特殊なルール

次に示す特殊なルールを考慮する必要があります。 これらのルールで許可されるトラフィックをブロックしないでください。ブロックすると、インフラストラクチャが Azure の重要なサービスと通信できなくなります。

- **ホスト ノードの仮想 IP:** などの基本的なインフラストラクチャ サービス DHCP、DNS、および正常性の監視、仮想化されたホスト IP アドレス 168.63.129.16 を通じて提供されます。 このパブリック IP アドレスは Microsoft に属し、この目的のためにすべてのリージョンで使用される唯一の仮想化 IP アドレスです。 この IP アドレスは、仮想マシンをホストしているサーバー マシン (ホスト ノード) の物理 IP アドレスにマッピングされます。 ホスト ノードは、DHCP リレー、DNS の再帰的リゾルバー、および Load Balancer の正常性プローブとマシンの正常性プローブのプローブ元として機能します。 この IP アドレスへの通信を攻撃と見なさないでください。

- **ライセンス (キー管理サービス):** の仮想マシンで実行されている Windows イメージのライセンスを取得する必要があります。 このためには、要求を処理するキー管理サービスのホスト サーバーにライセンス要求を送信します。 これは、常に送信ポート 1688 上にあります。

### ICMP トラフィック

現在の NSG ルールのみのプロトコルを許可する *TCP* または *UDP*します。 特定のタグがない *ICMP*します。 ただし、ICMP トラフィックは、VNet 内で任意のポートおよびプロトコル間のトラフィックを許可する受信 VNet ルールを通じて、既定で Virtual Network 内で許可されます。

### サブネット

- ワークロードに必要な階層の数を考慮してください。 サブネットを使用して各層を分離し、NSG をそのサブネットに適用できます。 
- VPN ゲートウェイまたは ExpressRoute 回線のサブネットを実装する必要がある場合は、操作を行うことを確認してください **いない** そのサブネットに NSG を適用します。 適用すると、VNet 間接続またはクロス プレミス接続が機能しません。
- 仮想アプライアンスを実装する必要がある場合は、ユーザー定義のルート (UDR) が正しく機能するように、必ず専用のサブネットに仮想アプライアンスをデプロイしてください。 サブネット レベルの NSG を実装して、このサブネットに出入りするトラフィックをフィルター処理できます。 詳細について [トラフィック フローを制御して、仮想アプライアンスを使用する方法](virtual-networks-udr-overview.md)します。

### ロード バランサー

- 各ワークロードで使用されているロード バランサーごとに負荷分散と NAT に関するルールを検討してください。これらのルールは、NIC (リソース マネージャー デプロイ) または VM/ロール インスタンス (クラシック デプロイ) が属しているバックエンド プールにバインドされています。 ロード バランサーに実装されたルールでマップされたトラフィックのみを許可する NSG をバックエンド プールごとに作成することを検討してください。 これにより、ロード バランサーを経由せずにバックエンド プールに直接送信されるトラフィックも確実にフィルター処理されます。
- クラシック デプロイでは、ロード バランサーのポートを VM またはロール インスタンスのポートにマップするエンドポイントを作成します。 リソース マネージャー デプロイでは、パブリックに公開されたロード バランサーを自分で個別に作成することもできます。 ロード バランサー内のバックエンド プールに属する VM とロール インスタンスへのトラフィックを NSG で制限している場合は、受信トラフィックの宛先ポートが、ロード バランサーによって公開されているポートではなく、VM またはロール インスタンスの実際のポートであることに注意してください また、VM への接続用の発信元ポートとアドレスは、ロード バランサーによって公開されているポートとアドレスではなく、インターネット上にあるリモート コンピューターの発信元ポートとアドレスであることに注意してください。
- パブリックに公開されたロード バランサーと同様に、内部ロード バランサー (ILB) を経由するトラフィックをフィルター処理する NSG を作成する場合は、適用される発信元ポートとアドレス範囲が、ロード バランサーではなく、呼び出しを開始するコンピューターのものであることを理解しておく必要があります。 宛先ポートとアドレス範囲は、ロード バランサーではなく、トラフィックを受信するコンピューターに関連付けられています。

### その他

- エンドポイント ベースの ACL と NSG は、同じ VM インスタンスではサポートされません。 エンドポイントの ACL が既に導入されている場合に NSG を使用するには、初めにエンドポイントの ACL を削除します。 これを行う方法については、次を参照してください。 [エンドポイントの Acl を管理](virtual-networks-acl-powershell.md)します。
- リソース マネージャー デプロイ モデルの場合、複数の NIC を持つ VM で 1 つの NIC に 1 つの NSG を関連付けて、NIC ごとの管理 (リモート アクセス) を有効にし、トラフィックを分離できます。
- ロード バランサーを使用する場合と同様に、他の VNet からのトラフィックをフィルター処理する際は、VNet に接続しているゲートウェイではなく、リモート コンピューターの発信元アドレス範囲を使用する必要があります。
- 多くの Azure サービスは、Azure Virtual Network に接続することはできないため、NSG を使用してそれらの間のトラフィックをフィルター処理することはできません。  VNet に接続できるかどうかを判断するには、使用しているサービスのドキュメントを参照してください。

## サンプル デプロイメント

この記事の内容の応用例を示すために、次の要件を持つ 2 層構成のワークロード ソリューションについてネットワーク トラフィックをフィルター処理する NSG を定義します。

1. フロントエンド (Windows Web サーバー) とバックエンド (SQL Database サーバー) の間のトラフィックを分離
2. トラフィックをロード バランサーを経由してすべての Web サーバーのポート 80 に転送する負荷分散ルール
3. ロード バランサーのポート 50001 に送信されるトラフィックをフロント エンド内の 1 つの VM のポート 3389 に転送する NAT ルール
4. 要件番号 1 を除き、インターネットからフロントエンドまたはバックエンドの VM へのアクセスを拒否
5. フロントエンドまたはバックエンドからインターネットへのアクセスを拒否
6. フロントエンドのサブネットから送信されたトラフィックに対して、フロントエンドにある任意の Web サーバーのポート 3389 へのアクセスを許可
7. フロントエンドのサブネットのみからバックエンドのすべての SQL Server VM のポート 3389 へのアクセスを許可
8. フロントエンドのサブネットのみからバックエンドのすべての SQL Server VM のポート 1433 へのアクセスを許可
9. バックエンド VM の複数の NIC で管理トラフィック (ポート 3389) とデータベース トラフィック (ポート 1433) を分離

![NSG](./media/virtual-network-nsg-overview/figure1.png)

上記の図に示すように、 *Web1* と *Web2* に Vm が接続されている、 *フロント エンド* サブネット、および *DB1* と *DB2* に Vm が接続されている、 *バックエンド* サブネットです。  両方のサブネットの一部である、 *TestVNet* VNet します。 すべてのリソースを割り当て、 *米国西部* Azure リージョンです。

上記の要件 1 ～ 6 (3 を除く) は、すべてサブネット空間に限定されます。 次のサブネット レベル NSG を実装すると、各 NSG で必要となるルールの数を最小限に抑えることができ、既存の VM と同じ種類のワークロードを実行している VM をサブネットに容易に追加できます。

### フロントエンド サブネット向けの NSG

**受信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|HTTP を許可する|許可|100|INTERNET|\*|\*|80|TCP|
|フロントエンドからの RDP を許可する|許可|200|192.168.1.0/24|\*|\*|3389|TCP|
|インターネットからのすべてのアクセスを拒否する|拒否|300|INTERNET|\*|\*|\*|TCP|

**送信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|インターネットを拒否する|拒否|100|\*|\*|INTERNET|\*|\*|

### バックエンド サブネット向けの NSG

**受信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|インターネットを拒否する|拒否|100|INTERNET|\*|\*|\*|\*|

**送信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|インターネットを拒否する|拒否|100|\*|\*|INTERNET|\*|\*|

### インターネットからの RDP に対するフロントエンド内の単一 VM (NIC) 向けの NSG

**受信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|インターネットからの RDP を許可する|許可|100|INTERNET|*|\*|3389|TCP|

>[AZURE.NOTE] この規則のソース アドレスの範囲は、どのように注意してください **インターネット**, とは、ロード バランサーの VIP いない送信元ポート **\ ***, いない 500001、します。 NAT ルール/負荷分散ルールと NSG ルールを混同しないようにしてください。 NSG ルールは常に、元のソースと、トラフィックの最終的な送信先に関連する **いない** 2 つのロード バランサーです。 

### バックエンドの管理 NIC 向けの NSG

**受信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|フロント エンドからの RDP を許可する|許可|100|192.168.1.0/24|*|\*|3389|TCP|

### バック エンドのデータベース アクセス NIC 向けの NSG

**受信ルール**

|ルール|Access (アクセス)|優先順位|発信元アドレス範囲|発信元ポート|宛先アドレス範囲|宛先ポート|プロトコル|
|---|---|---|---|---|---|---|---|
|フロント エンドからの SQL を許可する|許可|100|192.168.1.0/24|*|\*|1433|TCP|

上記の NSG のいくつかは個々の NIC に関連付ける必要があるため、このシナリオはリソース マネージャー デプロイとしてデプロイする必要があります。 サブネット レベルのルールと NIC レベルのルールが、それぞれに必要な適用方法に応じて、どのように組み合わされているかに注目してください。 

## 次のステップ

- [従来のデプロイ モデルに Nsg を展開](virtual-networks-create-nsg-classic-ps.md)します。
- [Nsg リソース マネージャーでの展開](virtual-networks-create-nsg-arm-pportal.md)します。
- [NSG のログを管理](virtual-network-nsg-manage-log.md)します。


