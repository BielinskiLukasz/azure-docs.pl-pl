<properties
    pageTitle="Site Recovery でのフェールオーバー | Microsoft Azure" 
    description="Azure Site Recovery は、仮想マシンと物理サーバーのレプリケーション、フェールオーバー、回復を調整します。 Azure またはセカンダリ データセンターへのフェールオーバーについて説明します。" 
    services="site-recovery" 
    documentationCenter="" 
    authors="rayne-wiselman" 
    manager="jwhit" 
    editor=""/>

<tags 
    ms.service="site-recovery" 
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="storage-backup-recovery" 
    ms.date="12/14/2015" 
    ms.author="raynew"/>

# Site Recovery でのフェールオーバー

 [Azure Site Recovery サービス](site-recovery-overview.md) 、堅牢なビジネス継続性と障害復旧 (BCDR) ソリューションを調整し、azure、またはセカンダリ オンプレミス データ センターにレプリケーションとフェールオーバーを自動化することにより、オンプレミスの物理サーバーおよび仮想マシンを保護するに貢献します。 この記事は、Site Recovery を使用して保護されている仮想マシンと物理サーバーを復旧するプロセス (フェールオーバーおよびフェールバック) に関する情報とその手順を示しています。 

質問内容がある場合は、この記事に投稿して、 [Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)します。


## 概要

仮想マシンと物理サーバーに対して保護を設定すると、セカンダリの場所へのレプリケーションが開始されます。 レプリケーションが稼働状態になると、必要に応じてフェールオーバーを実行することができます。 Site Recovery は、さまざまな種類のフェールオーバーをサポートします。

**フェールオーバー** | **実行する状況** | **詳細** | **Process**
---|---|---|---
**テスト フェールオーバー** | レプリケーション戦略を検証するか、または障害復旧の訓練を行うために実行します。 | <p>データの損失やダウンタイムはありません。</p><p>レプリケーションに影響はありません。</p><p>運用環境に影響はありません。</p> | <p>フェールオーバーを開始します</p><p>テスト マシンが接続する方法をネットワークにフェールオーバー後に指定します。</p><p>進行状況を追跡、 **ジョブ** ] タブをクリックします。 テスト マシンが作成され、セカンダリの場所で起動</p><p>Azure - Azure ポータルでマシンに接続します。</p><p>セカンダリ サイト - 同じホスト上のクラウド マシンへのアクセス</p><p>テストを完了し、テスト フェールオーバーの設定を自動的にクリーンアップします。</p>
**計画されたフェールオーバー** | <p>コンプライアンス要件を満たすまで実行します。</p><p>計画的なメンテナンスを実行します。</p><p>計画された停止期間 for - 予想される電源障害や重大な天気予報などを実行しているワークロードを保持するデータのフェイル オーバーを実行します。</p> <p>フェールオーバー後にプライマリからセカンダリをフェールバックを実行します。 | <p>データ損失なし</p><p>プライマリ上のバーチャル マシンをシャット ダウンし、2 次拠点で起動にかかる時間中には、ダウンタイムが発生します。</p><p>仮想マシンにはターゲット マシンがフェールオーバー後にソース マシンが影響を受けます。</p> | <p>フェールオーバーを開始します</p><p>進行状況を追跡、 **ジョブ** ] タブをクリックします。 ソース マシンのシャット ダウン</p><p>レプリカのマシンがセカンダリの場所で起動します。</p><p>Azure - Azure ポータルでのレプリカ マシンに接続します。</p><p>セカンダリ サイト - 同じホスト上と同じクラウド内のマシンへのアクセス</p><p>フェールオーバーをコミットします</p>
**計画されていないフェールオーバー** | <p>停電やウイルスの攻撃などの予期しないインシデントが原因のプライマリ サイトにアクセスできなくなったときにこのような事後対応方式のフェールオーバーを実行します。</p><p>計画されていないを実行するプライマリ サイトが利用できない場合でも、フェールオーバーを実行できます。<p> | <p>レプリケーション頻度の設定に依存するデータが失われる</p> <p>データは、同期が最後に合わせて最新状態になります</p> | <p>フェールオーバーを開始します</p><p>進行状況を追跡、 **ジョブ** ] タブをクリックします。 必要に応じて仮想マシンをシャット ダウンし、最新のデータの同期を試行します。</p><p>レプリカのマシンがセカンダリの場所で起動します。</p><p>Azure - Azure ポータルでのレプリカ マシンに接続します。</p><p>セカンダリ サイトが同じホスト上と同じクラウド内のマシンにアクセスします。</p><p>フェールオーバーをコミットします</p>


サポートされるフェールオーバーの種類は、デプロイ シナリオに応じて異なります。

**フェールオーバーの方向** | **テスト フェールオーバー** | **計画されたフェールオーバー** | **計画されていないフェールオーバー**
---|---|---|---
プライマリ VMM サイトからセカンダリ VMM サイト | サポートされています | サポートされています | サポートされています 
セカンダリ VMM サイトからプライマリ VMM サイト | サポートされています | サポートされています | サポートされています
クラウド間 (単一の VMM サーバー) |  サポートされています | サポートされています | サポートされています
VMM サイトから Azure | サポートされています | サポートされています | サポートされています 
Azure から VMM サイト | サポートされていません | サポートされています | サポートされていません 
Hyper-V サイトから Azure | サポートされています | サポートされています | サポートされています
Azure から Hyper-V サイト | サポートされていません | サポートされています | サポートされていません
VMware サイトから Azure | サポートされていません |このシナリオでは連続レプリケーションを使用するため、計画されたフェールオーバーと計画されていないフェールオーバーの間に違いはありません。 選択した **フェールオーバー** | 該当なし
物理サーバーから Azure | サポートされていません | このシナリオでは連続レプリケーションを使用するため、計画されたフェールオーバーと計画されていないフェールオーバーの間に違いはありません。 選択した **フェールオーバー** | 該当なし

## フェールオーバーとフェールバック

デプロイの種類に応じて、仮想マシンをセカンダリ オンプレミス サイトまたは Azure にフェールオーバーします。 Azure にフェールオーバーするマシンは、Azure 仮想マシンとして作成されます。 フェールオーバーできるのは、単一の仮想マシン、単一の物理サーバー、または復旧計画です。 復旧計画は、保護対象の仮想マシンまたは物理サーバーを含む、順序のある 1 つ以上のグループで構成されます。 復旧計画は、所属するグループに従ってフェールオーバーする複数のマシンのフェールオーバーを調整するために使用されます。 [詳細](site-recovery-create-recovery-plans.md) 復旧計画についてです。 

フェールオーバーが完了し、マシンがセカンダリの場所で稼働している場合は、次のことに注意してください。

- Azure にフェールオーバーした場合は、フェールオーバー後に、プライマリまたはセカンダリの場所でマシンは保護されたりレプリケートされたりしません。 Azure では、仮想マシンは、回復性は提供してもレプリケートされない、geo レプリケートされたストレージに格納されます。
- セカンダリ サイトへの計画されていないフェールオーバーを実行した場合、フェールオーバー後に、セカンダリの場所のマシンは保護されたりレプリケートされたりしません。
- セカンダリ サイトへの計画されたフェールオーバーを実行した場合、フェールオーバー後に、セカンダリの場所のマシンは保護されます。
 

### セカンダリ サイトからのフェールバック

セカンダリ サイトからプライマリ サイトへのフェールバックは、プライマリからセカンダリへのフェールオーバーと同じプロセスを使用します。 プライマリからセカンダリのデータセンターへのフェールオーバーがコミットされて完了した後は、プライマリ サイトが使用可能になったときに、レプリケーションの反転を開始することができます。 レプリケーションの反転は、差分データを同期することによって、セカンダリ サイトとプライマリ サイトの間のレプリケーションを開始します。 レプリケーションの反転により、仮想マシンは保護された状態になりますが、セカンダリ データセンターは引き続きアクティブな場所です。 プライマリ サイトをアクティブな場所にするには、セカンダリからプライマリへの計画されたフェールオーバーを開始し、続いて別のレプリケーションの反転を実行します。

### Azure からのフェールバック

Azure にフェールオーバーした場合、仮想マシンは、仮想マシンのための Azure 回復性機能によって保護されます。 元のプライマリ サイトをアクティブな場所にするには、計画されたフェールオーバーを実行します。 元の場所にフェールバックすることも、元のサイトが利用できない場合には別の場所にフェールバックすることもできます。 プライマリの場所へのフェールバック後にレプリケートを再び開始するには、レプリケーションの反転を開始します。

### フェールオーバーの考慮事項

- **フェールオーバー後に IP アドレス**-既定で、障害が発生したフェールオーバー マシンは、ソース マシンと異なる IP アドレスになります。 同じ IP アドレスを保持する場合は、次の説明を参照してください。 
    - **セカンダリ サイト**-セカンダリ サイトにフェールオーバーすると、IP アドレスを保持する [読み取り](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx) この記事です。 ISP がサポートする場合は、パブリック IP アドレスを保持できることに注意してください。
    - **Azure**— Azure にフェールオーバーしている場合に割り当てる IP アドレスを指定できます、 **構成** 、仮想マシンのプロパティ] タブをクリックします。 Azure へのフェールオーバー後にパブリック IP アドレスを保持することはできません。 内部アドレスとして使用されている RFC 1918 非準拠のアドレス空間は保持することができます。
- **部分的なフェールオーバー**— かどうかは、サイトの一部をフェールオーバーするではなくサイト全体に注意してください。 
    - **セカンダリ サイト**-セカンダリ サイトにプライマリ サイトの一部をフェールオーバーすると、プライマリ サイトに再び接続する場合は、サイト間 VPN 接続を使用して、プライマリ サイトで実行するインフラストラクチャ コンポーネントに、セカンダリ サイトにアプリケーションで障害が発生した接続します。 サブネット全体をフェールオーバーする場合は、仮想マシンの IP アドレスを保持できます。 部分的なサブネットをフェールオーバーする場合は、サブネットはサイト間で分割できないので、仮想マシンの IP アドレスを保持することはできません。
    - **Azure**— プライマリ サイトで実行するインフラストラクチャ コンポーネントに Azure 内のアプリケーション フェールオーバーをサイト間 VPN を使用するには、部分的なサイトを Azure にフェールオーバーしてプライマリ サイトに再び接続する場合。 サブネット全体をフェールオーバーする場合は、仮想マシンの IP アドレスを保持できることに注意してください。 部分的なサブネットをフェールオーバーする場合は、サブネットはサイト間で分割できないので、仮想マシンの IP アドレスを保持することはできません。
 
- **ドライブ文字**— フェールオーバー後に仮想マシン上のドライブ文字を保持する場合は、仮想マシンの SAN のポリシーを設定できます **に**します。 仮想マシンのディスクは自動的にオンラインになります。 [詳細](https://technet.microsoft.com/library/gg252636.aspx)します。
- **クライアント要求をルーティング**— Site Recovery は、Azure Traffic Manager による、アプリケーションのフェールオーバー後にクライアント要求をルーティングします。




## テスト フェールオーバーの実行

テスト フェールオーバーの実行時には、テスト レプリカ マシン用のネットワーク設定を選択することが求められます。 これには多数のオプションがあります。  

**テスト フェールオーバーのオプション** | **説明** | **フェールオーバーの確認** | **詳細**
---|---|---|---
**Azure へのフェールオーバー — ネットワークなし** | ターゲットの Azure ネットワークを選択しません。 | フェールオーバーでは、Azure で想定どおりにテスト仮想マシンが起動していることが確認されます。 | <p>復旧計画内のすべてのテスト仮想マシンが 1 つのクラウド サービスに追加し、相互に接続できます。</p><p>マシンはフェールオーバー後に Azure ネットワークに接続していません。</p><p>ユーザーがパブリック IP アドレスを使用してテスト マシンに接続できます。</p>
**Azure へのフェールオーバー — ネットワークあり** | ターゲットの Azure ネットワークを選択します。 | フェールオーバーでは、テスト マシンがネットワークに接続されていることが確認されます。 | <p>Azure 運用ネットワークから分離されてがあり、期待どおりにレプリケートされた仮想マシンのインフラストラクチャを設定している Azure ネットワークを作成します。</p><p>テスト仮想マシンのサブネットがいるサブネットに基づいて、障害が発生したの仮想マシンを計画または計画外のフェールオーバーが発生した場合に接続が必要です。</p>
**セカンダリ VMM サイトへのフェールオーバー — ネットワークなし** | VM ネットワークを選択しません。 | フェールオーバーでは、テスト マシンが作成されることを確認します。 <p>レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。 これは、レプリカ仮想マシンが配置されているクラウドには追加されません。</p></p>| <p>失敗したコンピューターには、任意のネットワークに接続されません。</p><p>作成された後、マシンは VM ネットワークに接続できます。</p>
**セカンダリ VMM サイトへのフェールオーバー — ネットワークあり** | 既存の VM ネットワークを選択します。 | フェールオーバーでは、仮想マシンが作成されることが確認されます。 | <p>レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。 これは、レプリカ仮想マシンが配置されているクラウドには追加されません。</p><p>運用ネットワークから分離されている VM ネットワークを作成します。</p><p>VLAN ベースのネットワークを使用している場合は、VMM をお勧め (実稼働環境では使用されない) 独立した論理ネットワークを作成するこの目的のためです。 この論理ネットワークを使用して、テスト フェールオーバー用に VM ネットワークを作成します。</p><p>論理ネットワークは、少なくとも 1 つの仮想マシンをホストしているすべての HYPER-V サーバーのネットワーク アダプターに関連付けする必要があります。</p><p>論理ネットワークが VLAN で論理ネットワークに追加するネットワーク サイトを分離する必要があります。</p><p>Windows ネットワーク仮想化ベースの論理ネットワークを使用している場合は、Azure Site Recovery は分離された VM ネットワークを自動的に作成します。</p>
**セカンダリ VMM サイトへのフェールオーバー — ネットワークの作成** | 一時的なテスト ネットワークで指定した設定に基づいて自動的に作成されます **論理ネットワーク** とそれに関連するネットワーク サイト | フェールオーバーでは、仮想マシンが作成されることが確認されます。 | <p>このオプションは、復旧計画で複数の VM ネットワークを使用する場合に使用します。 Windows ネットワーク仮想化ネットワークを使用する場合には、このオプションにより、レプリカ仮想マシンのネットワーク内に同じ設定 (サブネットおよび IP アドレス プール) を持つ VM ネットワークを自動的に作成できます。 これらの VM ネットワークは、テスト フェールオーバーの完了後に自動的にクリーンアップされます。</p><p>レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。 これは、レプリカ仮想マシンが配置されているクラウドには追加されません。</p>

>[AZURE.NOTE] テスト フェールオーバー時にバーチャル マシンに与える IP は、この IP は、テスト フェールオーバーのネットワークで使用できる計画または計画外のフェールオーバーを実行することでしょう IP と同じです。 テスト フェールオーバー ネットワークで同じ IP が使用できない場合、テスト フェールオーバー ネットワークで利用できる IP が仮想マシンによって取得されます。



### オンプレミスから Azure へのテスト フェールオーバーの実行

この手順では、復旧計画のテスト フェールオーバーを実行する方法について説明します。 1 台のマシンのフェールオーバーを実行する別の方法として、 **仮想マシン** ] タブをクリックします。

1. 選択 **復旧計画** > *[recoveryplan_name]*します。 クリックして **フェールオーバー** > **フェールオーバーをテストする**です。
2.  **テスト フェールオーバーの確認** ] ページで、レプリカ マシンが接続する方法 Azure ネットワークにフェールオーバー後に指定します。
3. Azure にフェールオーバーするで、クラウドのデータの暗号化が有効になっている **暗号化キー** プロバイダーのインストール中にデータ暗号化を有効になっているときに発行された証明書を選択します。 
4. フェールオーバーの進行状況を追跡、 **ジョブ** ] タブをクリックします。 テスト レプリカ マシンも Azure ポータルで確認できます。
5. マシンにアクセスできますレプリカで、Azure、内部設置型サイトの開始からの RDP 接続、仮想マシンにします。 ポート 3389 は、仮想マシンのエンドポイント上で開いている必要があります。
5. 手順を実行し、フェールオーバーに達したとき、 **包括的なテスト** フェーズ] をクリックして **完全なテスト** を完了します。
5.  **ノート** 記録し、テスト フェールオーバーに関連する監察結果をすべてを保存します。
8. クリックして **テスト フェールオーバーが完了** を自動的にテスト環境をクリーンアップします。 テスト フェールオーバーで、C を表示する追加が完了したら**完全** 状態です。

> [AZURE.NOTE] テスト フェールオーバーが 2 週間を超えても続行する場合は、強制的に終了します。 テスト フェールオーバー中に自動的に作成されたすべての要素または仮想マシンは削除されます。
  

### プライマリ オンプレミス サイトからセカンダリ オンプレミス サイトへのテスト フェールオーバーの実行

テスト フェールオーバーを実行するには、ドメイン コントローラーのコピーの作成や、テスト環境内でのテスト用の DHCP サーバーと DNS サーバーの配置などの、いくつかの項目を実行する必要があります。 これは、次のような何とおりかの方法で実行できます。

- 既存のネットワークを使用してテスト フェールオーバーを実行する場合は、そのネットワーク内に Active Directory、DHCP、および DNS を準備します。
- VM ネットワークを自動的に作成するオプションを使用してテスト フェールオーバーを実行する場合は、テスト フェールオーバーを実行する前に、テスト フェールオーバーに使用する復旧計画の Group-1 の前に手動の手順を追加し、自動的に作成されたネットワークにインフラストラクチャ リソースを追加します。

#### 注意する点

- セカンダリ サイトにレプリケートする場合、レプリカ マシンにより使用されるネットワークの種類は、テスト フェールオーバーに使用される論理ネットワークの種類と必ずしも一致している必要はありません。ただし、組み合わせによっては動作しない可能性があります。 レプリカが DHCP と VLAN ベースの分離を使用する場合、レプリカの VM ネットワークには、静的 IP アドレス プールは必要ありません。 このため、Windows ネットワーク仮想化を使用してテスト フェールオーバーを実行しようとすると、使用できるアドレス プールがないため失敗します。 さらに、レプリカ ネットワークが分離なしであり、テスト ネットワークが Windows ネットワーク仮想化の場合、テスト フェールオーバーは失敗します。 これは、分離なしのネットワークには、Windows ネットワーク仮想化ネットワークの作成に必要なサブネットがないためです。
- フェールオーバー後にマップされた VM ネットワークにレプリカ仮想マシンが接続される方法は、VMM コンソールでの VM ネットワークの構成方法によって異なります。
    - **分離なしまたは VLAN 分離で構成された VM ネットワーク**— VM ネットワークの場合の DHCP が定義されている、レプリカ仮想マシンが VLAN ID が指定されている設定を使用して、関連する論理ネットワーク内のネットワーク サイトに接続されます。 仮想マシンは、使用可能は DHCP サーバーから IP アドレスを受け取ります。 ターゲットの VM ネットワークに対して静的 IP アドレス プールを定義する必要はありません。 VM ネットワークに静的 IP アドレス プールが使用されている場合、レプリカ仮想マシンは、関連する論理ネットワーク内のネットワーク サイトに指定されている設定を使用して、VLAN ID に接続されます。 仮想マシンは、VM ネットワークに定義されているプールから IP アドレスを受け取ります。 静的 IP アドレス プールがターゲット VM ネットワーク上で定義されていない場合、IP アドレスの割り当ては失敗します。 IP アドレス プールは、保護と復旧に使用するソースとターゲットの両方の VMM サーバー上で作成する必要があります。
    - **Windows ネットワーク仮想化の VM ネットワーク**— VM ネットワークがターゲット VM ネットワークに対して静的プールを定義する必要があります、この設定で構成されている場合、ソース VM ネットワークが構成されているかどうかに関係なく使用する DHCP または静的 IP アドレス プール。 DHCP を定義する場合、ターゲット VMM サーバーは、DHCP サーバーとして機能し、ターゲット VM ネットワークに対して定義されているプールから IP アドレスを提供します。 ソース サーバーに静的 IP アドレス プールの使用が定義されている場合、ターゲット VMM サーバーは、プールから IP アドレスを割り当てます。 どちらの場合も、静的 IP アドレス プールが定義されていないと、IP アドレスの割り当ては失敗します。

#### テストの実行

この手順では、復旧計画のテスト フェールオーバーを実行する方法について説明します。 単一の仮想マシンまたは物理サーバーのフェールオーバーを実行する別の方法として、 **仮想マシン** ] タブをクリックします。

1. 選択 **復旧計画** > *[recoveryplan_name]*します。 クリックして **フェールオーバー** > **フェールオーバーをテストする**です。
2.  **テスト フェールオーバーの確認** ページで、テスト フェールオーバー後の仮想マシン接続のネットワークに使用する方法を指定します。
3. フェールオーバーの進行状況を追跡、 **ジョブ** ] タブをクリックします。 フェールオーバーが、* * 包括的なテスト * * フェーズをクリックして **テストの完了** テスト フェールオーバーを完了します。
4. クリックして **ノート** を記録して、テスト フェールオーバーに関連する監察結果をすべてを保存します。
4. 完了後に、仮想マシンが正常に起動することを確認します。
5. 仮想マシンが正常に起動することを確認したら、テスト フェールオーバーを完了して、孤立した環境をクリーンアップします。 VM ネットワークの自動作成を選択した場合は、クリーンアップにより、すべてのテスト仮想マシンとテスト ネットワークが削除されます。

> [AZURE.NOTE] テスト フェールオーバーが 2 週間を超えても続行する場合は、強制的に終了します。 テスト フェールオーバー中に自動的に作成されたすべての要素または仮想マシンは削除されます。


#### DHCP の準備

テスト フェールオーバーに関係している仮想マシンが DHCP を使用する場合、テスト DHCP サーバーは、テスト フェールオーバー用に作成された、分離したネットワーク内で作成する必要があります。


### Active Directory の準備
アプリケーションのテストのためにテスト フェールオーバーを実行するには、テスト環境内に Active Directory 運用環境のコピーが必要です。 災害復旧について [active directory のフェールオーバーの考慮事項をテスト](site-recovery-active-directory.md#considerations-for-test-failover]) 詳細についてです。 


### DNS の準備

次のように、テスト フェールオーバー用の DNS サーバーを準備します。

- **DHCP**-テスト DNS の IP アドレスをテスト DHCP サーバーで更新する場合は、仮想マシンが DHCP を使用します。 Windows ネットワーク仮想化のネットワーク タイプを使用している場合、VMM サーバーは DHCP サーバーとして機能します。 したがって、テスト フェールオーバー ネットワークの DNS の IP アドレスを更新する必要があります。 この場合、仮想マシンは関連する DNS サーバーに自身を登録します。
- **静的アドレス**— テスト フェールオーバーのネットワークでテスト DNS サーバーの IP アドレスを更新する必要がある場合は、仮想マシンが静的 IP アドレスを使用します。 場合によっては、テスト仮想マシンの IP アドレスを DNS に反映することも必要です。 この目的のために、次のサンプル スクリプトを使用することができます。 

        Param(
        [string]$Zone,
        [string]$name,
        [string]$IP
        )
        $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
        $newrecord = $record.clone()
        $newrecord.RecordData[0].IPv4Address  =  $IP
        Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord



## 計画されたフェールオーバーの実行 (プライマリからセカンダリ)

 この手順では、復旧計画の、計画されたフェールオーバーを実行する方法について説明します。 単一の仮想マシンのフェールオーバーを実行する別の方法として、 **仮想マシン** ] タブをクリックします。

1. 開始する前に、フェールオーバーするすべての仮想マシンが、初期レプリケーションを完了していることを確認します。
2. 選択 **復旧計画** > *[recoveryplan_name]*します。 クリックして **フェールオーバー** > **計画されたフェールオーバー**します。 
3. **[計画されたフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。 フェールオーバーの方向に注意してください。

    - 以前のフェールオーバーが想定どおりに実行されており、すべての仮想マシン サーバーが、ソースの場所とターゲットの場所のいずれかに配置されている場合、フェールオーバーの方向の詳細は、情報の提供のみを目的としています。 
    - ソースとターゲットの両方の場所で仮想マシンがアクティブな場合、 **方向の変更]** ボタンが表示されます。 このボタンを使って、フェールオーバーが実行される方向を変更し、指定します。

5. Azure にフェールオーバーするで、クラウドのデータの暗号化が有効になっている **暗号化キー** VMM サーバー上のプロバイダーのインストール中にデータ暗号化を有効になっているときに発行された証明書を選択します。 
6. データ損失を確実に防ぐために、計画されたフェールオーバーの開始時の最初のステップとして、仮想マシンをシャットダウンします。 フェールオーバーの進行状況を行うことができる、 **ジョブ** ] タブをクリックします。 フェールオーバーで (仮想マシン、または復旧計画に含まれているスクリプトのいずれかにおいて) エラーが発生した場合は、復旧計画の計画されたフェールオーバーは停止します。 フェールオーバーは、もう一度開始することができます。
8. レプリカ仮想マシンは、作成後にコミット保留中の状態になります。 クリックして **コミット** 、フェールオーバーをコミットします。 
9. レプリケーションが完了すると、仮想マシンがセカンダリの場所で起動します。 

## 計画されていないフェールオーバーの実行

この手順では、復旧計画の、計画されていないフェールオーバーを実行する方法について説明します。 単一の仮想マシンまたは物理サーバーのフェールオーバーを実行する別の方法として、 **仮想マシン** ] タブをクリックします。

1. 選択 **復旧計画** > *[recoveryplan_name]*します。 クリックして **フェールオーバー** > **計画外のフェールオーバー**します。 
3. **[計画されていないフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。 フェールオーバーの方向に注意してください。

    - 以前のフェールオーバーが想定どおりに実行されており、すべての仮想マシン サーバーが、ソースの場所とターゲットの場所のいずれかに配置されている場合、フェールオーバーの方向の詳細は、情報の提供のみを目的としています。 
    - ソースとターゲットの両方の場所で仮想マシンがアクティブな場合、 **方向の変更]** ボタンが表示されます。 このボタンを使って、フェールオーバーが実行される方向を変更し、指定します。

4. Azure にフェールオーバーするで、クラウドのデータの暗号化が有効になっている **暗号化キー** VMM サーバー上のプロバイダーのインストール中にデータ暗号化を有効になっているときに発行された証明書を選択します。 
5. 選択 **仮想マシンをシャット ダウンし、最新のデータを同期** を Site Recovery が保護された仮想マシンをシャット ダウンし、データを同期するため、最新バージョンのデータをフェールオーバーする試してみることを指定します。 このオプションを選択しないか、または試行が成功しない場合、仮想マシンのフェールオーバーは、利用可能な最新の回復ポイントから実行されます。
6. フェールオーバーの進行状況を行うことができる、 **ジョブ** ] タブをクリックします。 計画されていないフェールオーバーの実行中にエラーが発生しても、復旧計画は最後まで実行されることに注意してください。
7. フェールオーバーの後、仮想マシンは、 **保留中のコミット** 状態です。 クリックして **コミット** 、フェールオーバーをコミットします。
8. レプリケーションで複数の回復ポイントを使用するように設定している場合は、[回復ポイントの変更 (Change Recovery Point)] で、最新のものではない回復ポイントを使用するように選択できます (既定では最新のものが使用されます)。 コミット後には、その他の回復ポイントは削除されます。
9. レプリケーションが完了すると、仮想マシンがセカンダリの場所で起動し、稼働状態になります。 ただし、それらは保護されたりレプリケートされたりしません。 プライマリ サイトが同じ基になるインフラストラクチャで再び使用可能] をクリックして **[レプリケーションの反転** をレプリケーションの反転を開始します。 これによって、すべてのデータがプライマリ サイトに確実にレプリケートされ、仮想マシンがフェールオーバー可能な状態に戻ります。 計画されていないフェールオーバー後のレプリケーションの反転では、データ転送のオーバーヘッドが発生します。 転送は、クラウドの初期レプリケーション設定で構成されているものと同じ方法で行われます。

## セカンダリからプライマリへのフェールバック

 プライマリからセカンダリの場所へのフェールオーバー後は、レプリケートされた仮想マシンは Site Recovery では保護されず、セカンダリの場所はプライマリとして機能するようになります。 元のプライマリ サイトにフェールバックするには、次の手順に従います。 この手順では、復旧計画の、計画されたフェールオーバーを実行する方法について説明します。 単一の仮想マシンのフェールオーバーを実行する別の方法として、 **仮想マシン** ] タブをクリックします。

1. 選択 **復旧計画** > *[recoveryplan_name]*します。 クリックして **フェールオーバー** > **計画されたフェールオーバー**します。
2. **[計画されたフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。 フェールオーバーの方向に注意してください。 プライマリからのフェールオーバーが想定どおりに機能し、すべての仮想マシンがセカンダリの場所にある場合には、これは情報の提供のみを目的としています。
3. Azure からフェールバックする場合は、設定を選択して **データの同期**:

    - **フェールオーバー前に、のデータを同期**— このオプションは、シャット ダウンせずに同期するようにバーチャル マシンのダウンタイムを最小化します。 その内容は次のとおりです。
        - フェーズ 1: Azure で仮想マシンのスナップショットを取得し、それをオンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
        - フェーズ 2: Azure で仮想マシンをシャットダウンします。これでその仮想マシンでは新しい変更は発生しません。 変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。
    
    > [AZURE.NOTE] しばらくの Azure で実行されている場合、このオプションを使用することをお勧めします。 このオプションが仮想マシンをシャット ダウンせずに同期を実行 (1 か月以上)。 再同期は実行しませんが、完全フェールバックを実行します。 このオプションは、チェックサム計算は実行しません。

    - **のみのフェールオーバー中にデータを同期**-のみで実行されて Azure での短い時間の場合は、このオプションを使用します。 このオプションは、完全フェールバックではなく再同期するために高速です。 高速なチェックサム計算を実行し、変更されたブロックのみをダウンロードします。

5. Azure にフェールオーバーするで、クラウドのデータの暗号化が有効になっている **暗号化キー** VMM サーバー上のプロバイダーのインストール中にデータ暗号化を有効になっているときに発行された証明書を選択します。 
5. 既定では前回の回復ポイントが使用されますが、 **回復ポイントの変更** 別の回復ポイントを指定することができます。 
6. チェックマークをクリックして、フェールバックを開始します。  フェールオーバーの進行状況を行うことができる、 **ジョブ** ] タブをクリックします。 
7. 初期データの同期が完了して、Azure で仮想マシンをシャット ダウンする準備ができたら、フェールオーバーの前にデータを同期するオプションを選択した場合のクリックして **ジョブ** > <planned failover job name> **フェールオーバーを完了**します。 これにより Azure で仮想マシンがシャットダウンされ、最新の変更がオンプレミスの仮想マシンに転送され、オンプレミスの仮想マシンが起動します。
8. これで仮想マシンにログオンして、それが想定どおりに使用できるかを検証できます。 
9. 仮想マシンは、コミット保留中の状態になります。 クリックして **コミット** 、フェールオーバーをコミットします。
10. フェールバックのクリックを完了するために **レプリケーションの反転** 、プライマリ サイトの仮想マシンの保護を開始します。



## 別の場所へのフェールバック

間の保護をデプロイした場合、 [HYPER-V サイトと Azure](site-recovery-hyper-v-site-to-azure.md) に代わる社内の場所に Azure からフェールバックする機能がある場合。 これは、新しいオンプレミス ハードウェアを設定する必要がある場合に便利です。 これを行うには、次の手順を実行します。

1. 新しいハードウェアを設定する場合は、Windows Server 2012 R2 および Hyper-V のロールをサーバーにインストールします。
2. 元のサーバーに保存していたものと同じ名前を使用して、仮想ネットワーク スイッチを作成します。
3. 選択 **保護されている項目** ]-> [ **保護グループ** -> <ProtectionGroupName> -> <VirtualMachineName> フェールバックを選択する **計画されたフェールオーバーの**です。
4.  **計画されたフェールオーバーの確認** 選択 **作成内部設置型仮想マシンが存在しない場合**します。 
5.  **ホスト名** バーチャル マシンを配置する新しい HYPER-V ホスト サーバーを選択します。
6. データ同期のことをお勧めオプションを選択する **フェイル オーバーする前にデータを同期**します。 このオプションを指定すると、仮想マシンをシャットダウンせずに同期するため、ダウンタイムを最小限に抑えることができます。 その内容は次のとおりです。

    - フェーズ 1: Azure で仮想マシンのスナップショットを取得し、それをオンプレミスの Hyper-V ホストにコピーします。 マシンは Azure での実行を継続します。
    - フェーズ 2: Azure で仮想マシンをシャットダウンします。これでその仮想マシンでは新しい変更は発生しません。 変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。
    
7. チェックマークをクリックして、フェールオーバー (フェールバック) を開始します。
8. 初期同期が終了し、Azure の仮想マシンをシャット ダウン] をクリックする準備ができたら **ジョブ** > <planned failover job> > **フェールオーバーを完了**します。 これにより Azure で仮想マシンがシャットダウンされ、最新の変更がオンプレミスの仮想マシンに転送され、オンプレミスの仮想マシンが起動します。
9. これでオンプレミスの仮想マシンにログオンして、すべてが想定どおりに動作するかどうかを検証できます。 クリックして **コミット** 、フェールオーバーを完了します。
10. クリックして **レプリケーションの反転** 内部設置型仮想マシンの保護を開始します。

 

